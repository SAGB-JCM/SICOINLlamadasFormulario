<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noticias Sobre los Trenes de México</title>
    
    <!-- jQuery (requerido para Select2) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- js-xlsx para leer archivos de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Select2 for searchable dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- html2pdf para generar reportes en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Librerías para manipulación de .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.34.1/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- SunEditor (Rich Text Editor) -->
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>

    <!-- Firebase App (el módulo principal de Firebase) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #9C2348;
            --secondary-color: #A6802D;
            --accent-color: #1E5B4F;
            --success-color: #10B981;
            --danger-color: #EF4444;
        }
        
        html { font-size: 60%; }
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        
        .bg-primary { background-color: var(--primary-color); }
        .text-primary { color: var(--primary-color); }
        .border-primary { border-color: var(--primary-color); }
        .focus\:ring-primary:focus { --tw-ring-color: var(--primary-color); }
        
        .bg-secondary { background-color: var(--secondary-color); }
        .text-secondary { color: var(--secondary-color); }
        .border-secondary { border-color: var(--secondary-color); }
        
        .bg-accent { background-color: var(--accent-color); }
        .text-accent { color: var(--accent-color); }
        .border-accent { border-color: var(--accent-color); }
        
        .bg-success { background-color: var(--success-color); }
        .hover\:bg-success-dark:hover { background-color: #059669; }
        
        .bg-danger { background-color: var(--danger-color); }
        .hover\:bg-danger-dark:hover { background-color: #DC2626; }
        
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        .hidden { display: none; }
        .tab-btn.active { border-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        
        .loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(255, 255, 255, 0.9); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .loader .spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; 
            border-left-color: var(--primary-color); animation: spin 1s ease infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .table-container { 
            overflow-x: auto; 
            max-height: 455px;
            overflow-y: auto;
        }

        /* Estilo específico para la altura de la tabla de histórico */
        #historical-table-container {
            max-height: 510px; /* <-- Puedes ajustar este valor a tu preferencia */
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Mejora para encabezados de tabla fijos */
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f1f5f9; /* Color de bg-slate-100 para evitar transparencia */
        }

        .sortable-header { cursor: pointer; }
        .sortable-header .sort-icon { display: none; }
        .sortable-header.asc .sort-icon.asc,
        .sortable-header.desc .sort-icon.desc { display: inline-block; }
        .filterable-header { 
            cursor: pointer; 
            position: relative;
        }
        .filterable-header .filter-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .filterable-header:hover .filter-icon,
        .filterable-header.active .filter-icon {
            opacity: 1;
            color: var(--primary-color);
        }

        .filter-dropdown {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 6px;
            z-index: 20;
            max-height: 250px;
            overflow-y: auto;
            min-width: 200px;
        }
        
        input:invalid, select:invalid { border-color: #ef4444; }
        
        .section-title { font-weight: bold; color: var(--primary-color); margin-bottom: 1rem; }
        
        .max-w-7xl {
            max-width: 100% !important;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .table-container table {
            width: 100%;
            min-width: 1200px;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            align-items: end;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-field {
            margin-bottom: 0.5rem;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* --- Reglas para restaurar el tamaño original de Resumen, Comentario y Fuente --- */

        /* 1. Hacer que el contenedor del campo ocupe todo el ancho del grid */
        .form-field.full-width {
            grid-column: 1 / -1; /* Ocupa todas las columnas del grid */
        }

        /* 2. Anular el ancho fijo del contenedor interno para los textareas */
        .form-field.full-width .flex-with-buttons {
            min-width: 100%;
            max-width: 100%;
        }

        /* Anular ancho fijo para el campo de fuente también */
        .form-field:has(#news-source) .flex-with-buttons, .form-field:has(#edit-news-source) .flex-with-buttons {
            min-width: 100%;
            max-width: 100%;
        }

        /* 3. Ocultar los botones de edición para los campos de texto libre */
        .form-field:has(textarea) .edit-btn,
        .form-field:has(#news-source) .edit-btn,
        .form-field:has(#edit-news-source) .edit-btn,
        .form-field:has(#news-summary) .edit-btn,
        .form-field:has(#edit-news-summary) .edit-btn {
            display: none;
        }

        .news-form-container {
            max-height: 75vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .news-form-container::-webkit-scrollbar {
            width: 6px;
        }

        .news-form-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .news-form-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .news-form-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .flex-with-buttons {
            display: flex;
            align-items: flex-end; /* Alinea el botón con la base del campo */
            /* Clave: Establece un tamaño fijo para el contenedor del campo y el botón */
            min-width: 340px;
            max-width: 340px;
        }

        .flex-with-buttons .select2-container {
            flex-grow: 1;
            margin-bottom: 1px;
            min-width: 0; /* Permite que el select se encoja y no se desborde */
        }

        .flex-with-buttons input,
        .flex-with-buttons textarea {
            min-width: 0; /* Permite que el campo se encoja y no se desborde */
        }

        .flex-with-buttons button {
            height: 38px;
            width: 38px;
            margin-bottom: 1px;
            flex-shrink: 0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        .flex-with-buttons button.edit-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .flex-with-buttons button.paste-btn:hover {
            background-color: #16463c;
        }
        
        .select2-container--default .select2-selection--single {
            height: 38px;
            padding: 5px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 26px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        .select2-container {
            width: 100% !important;
        }

        /* Regla clave para truncar el texto dentro del campo de selección */
        .select2-container .select2-selection--single .select2-selection__rendered {
            display: block;
            padding-left: 8px;
            padding-right: 20px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .link-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #1a56db;
            text-decoration: underline;
            cursor: pointer;
        }

        .wide-modal .relative {
            max-width: 76rem !important;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .dynamic-chart-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dynamic-chart-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        
        .dynamic-chart-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .dynamic-table-container {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .dynamic-table th, .dynamic-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .dynamic-table th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .dynamic-table tr:nth-child(even) {
            background-color: #f3f4f6;
        }
        
        #toggle-labels-btn {
            transition: all 0.3s ease;
        }

        #toggle-labels-btn.bg-primary {
            background-color: var(--primary-color) !important;
        }

        .webview-modal {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .webview-container {
            width: 90vw;
            height: 90vh;
            max-width: 1200px;
        }

        .webview-modal iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 0.5rem;
        }

        /* Estilos para el modal de detalles de la noticia */
        .details-modal-content {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 2rem;
            background-color: #f9fafb;
        }
        .details-header {
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        .details-header .date {
            font-size: 1rem;
            color: #6b7280;
            font-weight: 500;
        }
        .details-header .project {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-top: 0.25rem;
        }
        .details-section {
            margin-bottom: 1.5rem;
        }
        .details-section h4 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.75rem;
        }

        .contenteditable {
            min-height: 100px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem;
            overflow-wrap: break-word; /* Evita el desbordamiento horizontal con texto largo */
            background-color: white;
            overflow-y: auto;
        }

        .contenteditable:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(156, 35, 72, 0.2);
        }

        .formatted-content {
            font-size: 1rem;
            line-height: 1.5;
            overflow-wrap: break-word; /* Evita que el texto largo se desborde del contenedor */
        }

        .formatted-content p {
            margin-bottom: 0.5rem;
        }

        .formatted-content ul, .formatted-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Regla mejorada para la sangría de las listas */
        .formatted-content ul li, .formatted-content ol li {
            list-style-position: outside !important; /* Asegura que la viñeta esté fuera del flujo de texto */
            padding-left: 1.5em; /* Espacio para la viñeta y un poco más */
            text-indent: -1.5em; /* Sangría negativa para alinear el texto de las siguientes líneas */
            margin-left: 1.5em; /* Empuja todo el elemento a la derecha para crear el espacio de la sangría */
        }

        .formatted-content strong, .formatted-content b {
            font-weight: bold;
        }

        .formatted-content em, .formatted-content i {
            font-style: italic;
        }

        .formatted-content u {
            text-decoration: underline;
        }

        /* Clase para bloquear el scroll del body cuando un modal está abierto */
        body.modal-open {
            overflow: hidden;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#9C2348',
                            light: '#b52e5a',
                            dark: '#7d1c3a'
                        },
                        secondary: {
                            DEFAULT: '#A6802D',
                            light: '#bf9a41',
                            dark: '#8a6b22'
                        },
                        accent: {
                            DEFAULT: '#1E5B4F',
                            light: '#267c6c',
                            dark: '#16463c'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased text-slate-700">

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-slate-600">Cargando datos, por favor espera...</p>
    </div>

    <div id="app" class="min-h-screen hidden">

        <header class="bg-primary shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://github.com/SAGB-JCM/NoticiasTrenesM-xico/blob/main/Trenes%20de%20M%C3%A9xico%20-%20LOGO.png?raw=true" alt="Logo Tren México" class="h-16 w-auto">
                    <h1 class="text-xl sm:text-2xl font-bold text-white tracking-tight">Noticias Sobre los Trenes de México</h1>
                </div>
                <div id="user-info" class="text-white text-sm font-mono"></div>
            </div>
        </header>

        <div class="bg-white shadow-sm sticky top-[56px] z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="tabs" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="noticias" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Noticias</button>
                        <button data-tab="historico" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Reportes</button>
                    </nav>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

            <main id="tab-content-noticias" class="tab-content">
                <section class="bg-white p-6 rounded-xl shadow-md mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="text-center md:text-left">
                        <h3 class="text-xl font-semibold text-slate-800">Gestión de Noticias</h3>
                        <p class="text-slate-500">Registra nuevas noticias sobre los trenes de México.</p>
                    </div>
                    <div class="flex items-center gap-6">
                        <button id="add-news-btn" class="bg-success hover:bg-success-dark text-white font-bold py-4 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center space-x-3">
                            <i class="fa-solid fa-plus h-6 w-6"></i>
                            <span>Registrar Nueva Noticia</span>
                        </button>
                    </div>
                </section>
                
                <section id="news-log">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Registro de Noticias</h2>
                        <div class="flex items-center space-x-2">
                            <div class="relative w-full">
                                <input type="text" id="filter-input-main" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                <button id="clear-filter-btn-main" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i class="fa-solid fa-times-circle"></i>
                                </button>
                            </div>
                            <button id="download-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-file-excel"></i>
                                <span>Descargar Excel</span>
                            </button>
                            <button id="migrate-news-btn" class="migrate-btn bg-accent hover:bg-accent-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-database"></i>
                                <span>Migrar a Histórico</span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="main-table-header">
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fecha">Fecha <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fuente">Fuente <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="proyecto">Proyecto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="subproyecto">Subproyecto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="comentario">Título <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="cita">Cita <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="resumen">Resumen <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="categoria">Categoría <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="medio">Medio <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="news-table-body"></tbody>
                        </table>
                        <div id="no-news-message" class="p-6 text-center text-slate-500 hidden">
                            <p>No hay noticias registradas en la base de datos.</p>
                        </div>
                    </div>
                </section>
            </main>

            <div id="tab-content-historico" class="tab-content hidden">
                <section id="historical-log">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Registro Histórico</h2>
                        <div class="flex items-center space-x-2">
                            <div class="relative w-full">
                                <input type="text" id="filter-input-historical" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                                <button id="clear-filter-btn-historical" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden">
                                    <i class="fa-solid fa-times-circle"></i>
                                </button>
                            </div>
                            <button id="download-historical-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-file-excel"></i>
                                <span>Descargar Excel</span>
                            </button>
                            <label for="historical-file-input" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg shadow-sm transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap"><i class="fa-solid fa-file-upload"></i><span>Subir Excel</span><input type="file" id="historical-file-input" class="hidden" accept=".xlsx, .xls"></label>
                            <button id="import-historical-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-200 ease-in-out hidden items-center space-x-2 whitespace-nowrap" disabled><i class="fa-solid fa-database"></i><span>Subir Excel</span></button>
                        </div>
                    </div>
                    <div id="historical-table-container" class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="historical-table-header">
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fecha">Fecha <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fuente">Fuente <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="proyecto">Proyecto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="subproyecto">Subproyecto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="comentario">Título <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="cita">Cita <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="resumen">Resumen <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="categoria">Categoría <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="medio">Medio <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historical-table-body"></tbody>
                        </table>
                        <div id="no-historical-message" class="p-6 text-center text-slate-500 hidden">
                            <p>No hay datos históricos cargados.</p>
                        </div>
                    </div>
                </section>
            </div>

            <div id="tab-content-reportes" class="tab-content hidden">
                <section id="reportes" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Reportes</h2>
                        <div class="flex items-center space-x-4">
                            <button id="upload-template-btn" class="bg-secondary hover:bg-secondary-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2">
                                <i class="fa-solid fa-file-word"></i>
                                <span>Cargar Plantilla Word</span>
                            </button>
                            <div class="flex items-center space-x-2">
                                <label for="reportes-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                                <select id="reportes-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                    <option value="historico">Histórico</option>
                                    <option value="noticias">Noticias</option>
                                    <option value="combinado">Noticias + Histórico</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    
                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Noticias por</h3>
                            <select id="dynamic-chart-variable" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="proyecto">Proyecto</option>
                                <option value="subproyecto">Subproyecto</option>
                                <option value="categoria">Categoría</option>
                                <option value="medio">Medio</option>
                            </select>
                            <button id="toggle-labels-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded ml-2">
                                <i class="fa-solid fa-tag"></i>
                            </button>
                        </div>
                        <div class="dynamic-chart-content">
                            <div class="chart-wrapper">
                                <canvas id="dynamicChart"></canvas>
                            </div>
                            <div class="dynamic-table-container">
                                <h4 class="text-lg font-semibold text-slate-800 mb-2 text-center">Distribución</h4>
                                <table class="dynamic-table">
                                    <thead>
                                        <tr>
                                            <th id="dynamic-table-header">Variable</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dynamic-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <div id="news-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold text-primary mb-6">Registrar Nueva Noticia</h3>
            <div class="news-form-container">
                <form id="news-form" class="space-y-6" novalidate>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field ">
                            <label for="news-date">Fecha de la Noticia</label>
                            <input type="date" id="news-date" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                        </div>
                        <div class="form-field sm:col-span-2">
                            <label for="news-source">Fuente de la Noticia (URL)</label>
                            <div class="flex-with-buttons">
                                <input type="url" id="news-source" name="fuente" placeholder="https://ejemplo.com/noticia" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                                <button type="button" id="edit-source-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="news-project">Proyecto</label>
                            <div class="flex-with-buttons">
                                <select id="news-project" name="proyecto" required></select>
                                <button type="button" id="edit-project-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="news-subproject">Subproyecto</label>
                            <div class="flex-with-buttons">
                                <select id="news-subproject" name="subproyecto"></select>
                                <button type="button" id="edit-subproject-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="news-category">Categoría</label>
                            <div class="flex-with-buttons">
                                <select id="news-category" name="categoria" required></select>
                                <button type="button" id="edit-category-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="news-medio">Medio</label>
                            <div class="flex-with-buttons">
                                <select id="news-medio" name="medio" required></select>
                                <button type="button" id="edit-medio-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="news-comment">Título de la Noticia</label>
                        <div class="flex-with-buttons">
                            <textarea id="news-comment" name="comentario" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                            <button type="button" id="edit-comment-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="news-cita">Cita de la Noticia</label>
                        <div class="flex-with-buttons">
                            <textarea id="news-cita" name="cita" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                            <button type="button" id="edit-cita-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="news-summary">Resumen de la Noticia</label>
                        <div class="flex-with-buttons">
                            <div id="news-summary" name="resumen" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 contenteditable" contenteditable="true"></div>
                            <button type="button" id="edit-summary-btn" class="edit-btn">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Noticia</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <h3 class="text-2xl font-bold text-primary mb-6">Editar Noticia</h3>
            <div class="news-form-container">
                <form id="edit-form" class="space-y-6" novalidate>
                    <input type="hidden" id="edit-id">
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="edit-news-date">Fecha de la Noticia</label>
                            <input type="date" id="edit-news-date" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                        </div>
                        <div class="form-field sm:col-span-2">
                            <label for="edit-news-source">Fuente de la Noticia (URL)</label>
                            <div class="flex-with-buttons">
                                <input type="url" id="edit-news-source" name="fuente" placeholder="https://ejemplo.com/noticia" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required>
                                <button type="button" id="edit-source-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-grid grid-cols-1 sm:grid-cols-2">
                        <div class="form-field">
                            <label for="edit-news-project">Proyecto</label>
                            <div class="flex-with-buttons">
                                <select id="edit-news-project" name="proyecto" required></select>
                                <button type="button" id="edit-project-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-news-subproject">Subproyecto</label>
                            <div class="flex-with-buttons">
                                <select id="edit-news-subproject" name="subproyecto"></select>
                                <button type="button" id="edit-subproject-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-news-category">Categoría</label>
                            <div class="flex-with-buttons">
                                <select id="edit-news-category" name="categoria" required></select>
                                <button type="button" id="edit-category-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="edit-news-medio">Medio</label>
                            <div class="flex-with-buttons">
                                <select id="edit-news-medio" name="medio" required></select>
                                <button type="button" id="edit-medio-edit-btn" class="edit-btn">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-news-comment">Título de la Noticia</label>
                        <div class="flex-with-buttons">
                            <textarea id="edit-news-comment" name="comentario" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                            <button type="button" id="edit-comment-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-news-cita">Cita de la Noticia</label>
                        <div class="flex-with-buttons">
                            <textarea id="edit-news-cita" name="cita" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2"></textarea>
                            <button type="button" id="edit-cita-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                        </div>
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-news-summary">Resumen de la Noticia</label>
                        <div class="flex-with-buttons">
                            <div id="edit-news-summary" name="resumen" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2 contenteditable" contenteditable="true"></div>
                            <button type="button" id="edit-summary-edit-btn" class="edit-btn">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4">
                        <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Confirmar Eliminación</h3>
            <p class="text-slate-600 mb-6">¿Estás seguro de que deseas eliminar este registro?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg">Eliminar</button>
            </div>
        </div>
    </div>
    
    <div id="replace-historical-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Reemplazar Histórico</h3>
            <p class="text-slate-600 mb-6">¿Desea reemplazar el histórico actual?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-replace-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">No</button>
                <button id="confirm-replace-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Sí</button>
            </div>
        </div>
    </div>
    
    <div id="edit-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Editar Opción</h3>
            <input type="text" id="edit-option-input" placeholder="Edite la opción" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-edit-option-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-edit-option-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Verificación de Seguridad</h3>
            <p class="text-slate-600 mb-4">Esta acción requiere autenticación. Por favor, ingrese la contraseña.</p>
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-password-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-password-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Verificar</button>
            </div>
        </div>
    </div>

    <div id="webview-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center webview-modal">
        <div class="relative bg-white rounded-lg shadow-xl webview-container">
            <button id="close-webview-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors z-10 bg-white rounded-full p-1">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <iframe id="webview-frame" src="about:blank"></iframe>
        </div>
    </div>

    <div id="migrate-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Migrar Noticias</h3>
            <p class="text-slate-600 mb-6">¿Está seguro de que desea migrar todas las noticias al Histórico? Esta acción no se puede deshacer.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-migrate-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-migrate-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Migrar</button>
            </div>
        </div>
    </div>

    <div id="view-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-details-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <div class="flex items-center space-x-4 mb-6">
                <img src="https://github.com/SAGB-JCM/NoticiasTrenesM-xico/blob/main/Trenes%20de%20M%C3%A9xico%20-%20LOGO.png?raw=true" alt="Logo Tren México" class="h-16 w-auto">
                <h3 class="text-2xl font-bold text-primary">Detalle de la Noticia</h3>
            </div>
            <div class="news-form-container">
                <div id="details-modal-content" class="details-modal-content">
                    <!-- El contenido se generará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // MÓDULO: Verificación de dependencias
        // =============================================
        
        function checkRequiredLibraries() {
            // Retrocompatibilidad: si PizZip se carga como PizZipUtils, asignarlo.
            if (typeof window.PizZip === 'undefined' && typeof window.PizZipUtils !== 'undefined') {
                window.PizZip = window.PizZipUtils;
            }

            const libraries = {
                'PizZip': typeof window.PizZip,
                'docxtemplater': typeof window.docxtemplater,
                'saveAs': typeof window.saveAs,
                'XLSX': typeof window.XLSX,
                'firebase': typeof firebase,
                'Chart': typeof Chart,
                '$': typeof window.$,
                'select2': typeof $.fn.select2
            };
            
            const missing = Object.entries(libraries)
                .filter(([lib, type]) => type === 'undefined')
                .map(([lib]) => lib);
            
            return missing;
        }
        
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.head.appendChild(script);
            });
        }

        function loadFallbackLibraries(missingLibs) {
            const fallbacks = {
                'PizZip': 'https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js',
                'docxtemplater': 'https://cdn.jsdelivr.net/npm/docxtemplater@3.34.1/build/docxtemplater.min.js'
            };
            return Promise.all(missingLibs.filter(lib => fallbacks[lib]).map(lib => loadScript(fallbacks[lib])));
        }

        // =============================================
        // MÓDULO: Configuración de Firebase
        // =============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbvGa-79AsyP1KJv78YzKoTSBhF-1iDYU",
            authDomain: "noticiastrenesm-xico.firebaseapp.com",
            projectId: "noticiastrenesm-xico",
            storageBucket: "noticiastrenesm-xico.firebasestorage.app",
            messagingSenderId: "566647349885",
            appId: "1:566647349885:web:1ebf1d30757eadf1494714",
            measurementId: "G-NTHDMJV2EM"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const templateDocRef = db.collection('config').doc('wordTemplate');

        // =============================================
        // MÓDULO: Variables globales y estado de la aplicación
        // =============================================
        let news = [];
        let historicalNews = [];
        let userId;

        // Referencias a colecciones de Firebase
        const newsCollectionRef = db.collection("news");
        const historicalNewsCollectionRef = db.collection("historicalNews");

        // Variables de estado de la aplicación
        let loader, appContainer, userInfo, tabsContainer, tabContents, addNewsBtn, downloadExcelBtn, migrateNewsBtn, newsTableBody, noNewsMessage, historicalTableBody, noHistoricalMessage, historicalFileInput, historicalFileName, importHistoricalBtn, reportesDataSource, dynamicChartCanvas, dynamicChartVariable, toggleLabelsBtn, dynamicTableBody, dynamicTableHeader, dynamicChart, newsModal, newsForm, closeModalBtn, editModal, editForm, closeEditModalBtn, confirmModal, cancelDeleteBtn, confirmDeleteBtn, replaceHistoricalModal, cancelReplaceBtn, confirmReplaceBtn, editOptionModal, editOptionInput, cancelEditOptionBtn, confirmEditOptionBtn, passwordModal, passwordInput, cancelPasswordBtn, confirmPasswordBtn, webviewModal, webviewFrame, closeWebviewBtn, migrateModal, cancelMigrateBtn, confirmMigrateBtn, uploadTemplateBtn, viewDetailsModal, closeDetailsModalBtn, detailsModalContent;
        
        let currentEditIsHistorical = false;
        
        let newsSummaryEditor, editNewsSummaryEditor;
        let fieldOptions = {
            proyectos: [],
            categorias: [],
            medios: [],
            subproyectos: []
        };

        let currentEditingField = null;
        let currentEditingValue = null;
        let pendingAction = null;
        let showChartLabels = true;
        let activeFilters = {
            main: {},
            historical: {}
        };
        let currentFilterDropdown = null;
        let activeSelectElement = null;

        // =============================================
        // MÓDULO: Utilidades
        // =============================================
        
        function showApp() {
            loader.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-gray-500' };
            alertContainer.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 z-[60] ${colors[type]}`;
            alertContainer.textContent = message;
            document.body.appendChild(alertContainer);
            setTimeout(() => { alertContainer.remove(); }, 3000);
        }

        function openModal(modal) {
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
            document.body.classList.add('modal-open');
        }

        function closeModal(modal) {
            modal.classList.remove('modal-enter');
            modal.classList.add('modal-leave');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }, 300);
        }

        function openModalWithFocus(modal, elementToFocus) {
            openModal(modal);
            setTimeout(() => elementToFocus.focus(), 150); // Pequeño delay para la animación
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                // Tratar la fecha como UTC para evitar problemas de zona horaria.
                // new Date('2024-01-15') se interpreta como UTC midnight.
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                return date.toLocaleDateString('es-ES', { timeZone: 'UTC' });
            } catch (e) {
                return dateString;
            }
        }

        function truncateText(text, maxLength = 50) {
            if (!text) return 'N/A';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function stripHtml(html) {
            if (!html) return '';
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        }

        function formatLongDate(dateString) {
            if (!dateString) return 'Fecha no disponible';
            try {
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    timeZone: 'UTC'
                };
                return new Intl.DateTimeFormat('es-ES', options).format(date);
            } catch (e) { return dateString; }
        }

        function getMonthName(dateString) {
            if (!dateString) return 'Mes no disponible';
            try {
                const [year, month, day] = dateString.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                
                const monthName = new Intl.DateTimeFormat('es-ES', { 
                    month: 'long',
                    timeZone: 'UTC'
                }).format(date);

                // Capitalizar la primera letra
                return monthName.charAt(0).toUpperCase() + monthName.slice(1);
            } catch (e) { return 'Error de mes'; }
        }

        function base64ToArrayBuffer(base64) {
            // Primero, removemos el prefijo "data:application/..." si existe
            const base64Data = base64.substring(base64.indexOf(',') + 1);
            const binary_string = window.atob(base64Data);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function cleanWordHTML(html) {
            if (!html) return '';

            // 1. Eliminar comentarios, metadatos y namespaces de Word
            html = html.replace(/<!--[\s\S]*?-->/gi, '');
            html = html.replace(/<meta[\s\S]*?>/gi, '');
            html = html.replace(/<link[\s\S]*?>/gi, '');
            html = html.replace(/<style[\s\S]*?<\/style>/gi, '');
            html = html.replace(/<o:p>[\s\S]*?<\/o:p>/gi, '');
            html = html.replace(/<w:[\s\S]*?<\/w:[\s\S]*?>/gi, ''); // Elimina nodos de Word
            html = html.replace(/\s*xmlns:?[^=]*="[^"]*"/gi, ''); // Elimina atributos xmlns

            // 2. Reemplazar múltiples <br> por párrafos para mejor estructura
            html = html.replace(/<br\s*\/?>\s*<br\s*\/?>/gi, '</p><p>');

            return html;
        }

        function normalizeFontSizes(html) {
            if (!html) return '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Recorrer todos los elementos para limpiar estilos
            tempDiv.querySelectorAll('*').forEach(el => {
                if (el.style) {
                    // Conservar solo el margen izquierdo para la indentación
                    const marginLeft = el.style.marginLeft;
                    
                    // Limpiar todos los estilos en línea
                    el.removeAttribute('style');
                    
                    // Si había un margen, volver a aplicarlo
                    if (marginLeft) {
                        el.style.marginLeft = marginLeft;
                    }
                }
                // Eliminar otros atributos que no sean de estilo (class, id, etc.)
                ['class', 'id', 'lang', 'dir'].forEach(attr => el.removeAttribute(attr));
            });

            return tempDiv.innerHTML;
        }
        // =============================================
        // MÓDULO: Interfaz de usuario
        // =============================================
        
        function setupTabs() {
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
                    if (tabName === 'reportes') {
                        setTimeout(updateCharts, 50);
                    }
                }
            });
        }

        function renderTable(tableBody, data, isHistorical = false) {
            const noDataMessage = isHistorical ? noHistoricalMessage : noNewsMessage;
            tableBody.innerHTML = '';
            noDataMessage.classList.toggle('hidden', data.length > 0);

            data.forEach((newsItem, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                
                row.innerHTML = `
                    <td class="py-4 px-6">${index + 1}</td>
                    <td class="py-4 px-6">${formatDate(newsItem.fecha)}</td>
                    <td class="py-4 px-6">
                        ${newsItem.fuente && isValidUrl(newsItem.fuente) 
                            ? `<span class="link-cell" data-url="${newsItem.fuente}">${truncateText(newsItem.fuente, 30)}</span>` 
                            : truncateText(newsItem.fuente, 30)}
                    </td>
                    <td class="py-4 px-6">${truncateText(newsItem.proyecto, 30)}</td>
                    <td class="py-4 px-6">${truncateText(newsItem.subproyecto, 30)}</td>
                    <td class="py-4 px-6">${truncateText(newsItem.comentario, 30)}</td>
                    <td class="py-4 px-6">${truncateText(newsItem.cita, 30)}</td>
                    <td class="py-4 px-6">${truncateText(stripHtml(newsItem.resumen), 50)}</td>
                    <td class="py-4 px-6">${truncateText(newsItem.categoria, 30)}</td>
                    <td class="py-4 px-6">${truncateText(newsItem.medio, 30)}</td>
                    <td class="py-4 px-6 flex space-x-2">
                        <button data-id="${newsItem.id}" data-is-historical="${isHistorical}" class="generate-doc-btn text-blue-600 hover:text-blue-800" title="Generar Reporte Individual">
                            <i class="fa-solid fa-file-word"></i>
                        </button>
                        <button data-id="${newsItem.id}" data-is-historical="${isHistorical}" class="edit-btn text-blue-500 hover:text-blue-700">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button data-id="${newsItem.id}" data-is-historical="${isHistorical}" class="delete-btn text-red-500 hover:text-red-700">
                            <i class="fa-solid fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            // Add event listeners to link cells
            document.querySelectorAll('.link-cell').forEach(link => {
                link.addEventListener('click', (e) => {
                    const url = e.target.getAttribute('data-url');
                    if (url && isValidUrl(url)) {
                        openWebviewModal(url);
                    }
                });
            });
        }

        function applyAllFilters(data, filterKey) {
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = activeFilters[filterKey];

            return data.filter(item => {
                // 1. Check search box filter
                const matchesSearch = searchText === '' || Object.values(item).some(value => 
                    String(value).toLowerCase().includes(searchText)
                );
                if (!matchesSearch) return false;

                // 2. Check column filters
                for (const col in columnFilters) {
                    if (columnFilters[col].length > 0) {
                        const itemValue = col === 'fecha' ? formatDate(item[col]) : (item[col] || 'N/A');
                        if (!columnFilters[col].includes(itemValue)) {
                            return false;
                        }
                    }
                }
                return true;
            });
        }

        /**
         * Obtiene los datos pre-filtrados por todas las columnas excepto la especificada.
         * Esto es crucial para que los dropdowns de filtro muestren solo opciones relevantes.
         * @param {function} dataProvider - Función que devuelve el conjunto de datos completo.
         * @param {string} filterKey - 'main' o 'historical'.
         * @param {string} excludeColumn - La clave de la columna a excluir del filtrado.
         * @returns {Array} - Los datos filtrados.
         */
        function getPreFilteredData(dataProvider, filterKey, excludeColumn) {
            const allData = dataProvider() || [];
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = activeFilters[filterKey];

            return allData.filter(item => {
                const matchesSearch = searchText === '' || Object.values(item).some(value => String(value).toLowerCase().includes(searchText));
                if (!matchesSearch) return false;

                return Object.entries(columnFilters).every(([col, values]) => {
                    if (col === excludeColumn || values.length === 0) return true;
                    const itemValue = col === 'fecha' ? formatDate(item[col]) : (item[col] || 'N/A');
                    return values.includes(itemValue);
                });
            });
        }

        function setupColumnFilters(headerId, dataProvider, renderFunc, filterKey) {
            const headerRow = document.getElementById(headerId);
            headerRow.addEventListener('click', e => {
                const header = e.target.closest('.filterable-header');
                if (!header) return;

                if (currentFilterDropdown) {
                    currentFilterDropdown.remove();
                    currentFilterDropdown = null;
                }

                const filterBy = header.dataset.filterBy;
                // Usar los datos pre-filtrados para generar las opciones del dropdown.
                const preFilteredData = getPreFilteredData(dataProvider, filterKey, filterBy);

                const uniqueValues = [...new Set(preFilteredData.map(item => {
                    let value = item[filterBy] || 'N/A';
                    // Normalización para campos de texto (proyecto, resumen, etc.)
                    if (typeof value === 'string') {
                        // Para la fecha, usamos el formato específico.
                        if (filterBy === 'fecha') return formatDate(value);
                        // Para otros strings, normalizamos eliminando espacios al inicio y final.
                        return value.trim();
                    }
                    return value;
                }))].sort((a, b) => {
                    // Lógica de ordenamiento personalizada para fechas en el filtro
                    if (filterBy === 'fecha') {
                        try {
                            const dateA = new Date(a.split('/').reverse().join('-'));
                            const dateB = new Date(b.split('/').reverse().join('-'));
                            return dateA - dateB; // Orden ascendente
                        } catch (err) { return a.localeCompare(b); }
                    }
                    return a.localeCompare(b, 'es', { numeric: true });
                });

                const dropdown = document.createElement('div');
                dropdown.className = 'filter-dropdown p-2 space-y-1';
                
                const activeColumnFilters = activeFilters[filterKey][filterBy] || [];

                dropdown.innerHTML = `
                    <div class="p-1 border-b border-gray-200">
                        <input type="text" placeholder="Buscar opciones..." class="filter-search-input w-full text-xs p-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div class="filter-options-container max-h-48 overflow-y-auto">
                        ${uniqueValues.map(value => `
                            <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded cursor-pointer filter-option-label">
                                <input type="checkbox" class="filter-checkbox" value="${value}" ${activeColumnFilters.includes(value) ? 'checked' : ''}>
                                <span class="text-sm text-gray-700">${truncateText(value, 40)}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="border-t my-1"></div>
                    <div class="p-1"><button class="clear-filter-btn text-blue-500 hover:underline text-xs" data-filter-by="${filterBy}">Limpiar filtro</button></div>
                `;

                document.body.appendChild(dropdown);
                const rect = header.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom + window.scrollY}px`;
                dropdown.style.left = `${rect.left + window.scrollX}px`;
                currentFilterDropdown = dropdown;

                // Lógica para el buscador dentro del filtro
                const searchInput = dropdown.querySelector('.filter-search-input');
                const labels = dropdown.querySelectorAll('.filter-option-label');
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    labels.forEach(label => {
                        const text = label.textContent.toLowerCase();
                        const isVisible = text.includes(searchTerm);
                        label.style.display = isVisible ? 'flex' : 'none';
                    });
                });

                dropdown.addEventListener('change', e => {
                    if (e.target.classList.contains('filter-checkbox')) {
                        const checkedValues = Array.from(dropdown.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
                        activeFilters[filterKey][filterBy] = checkedValues;
                        
                        header.classList.toggle('active', checkedValues.length > 0);

                        const filteredData = applyAllFilters(dataProvider(), filterKey);
                        renderFunc(document.getElementById(filterKey === 'main' ? 'news-table-body' : 'historical-table-body'), filteredData, filterKey === 'historical');
                    }
                });

                dropdown.querySelector('.clear-filter-btn').addEventListener('click', () => {
                    activeFilters[filterKey][filterBy] = [];
                    header.classList.remove('active');
                    const filteredData = applyAllFilters(dataProvider(), filterKey);
                    renderFunc(document.getElementById(filterKey === 'main' ? 'news-table-body' : 'historical-table-body'), filteredData, filterKey === 'historical');
                    if (currentFilterDropdown) currentFilterDropdown.remove();
                });
            });

            // Close dropdown if clicked outside
            document.addEventListener('click', (e) => {
                if (currentFilterDropdown && !currentFilterDropdown.contains(e.target) && !e.target.closest('.filterable-header')) {
                    currentFilterDropdown.remove();
                    currentFilterDropdown = null;
                }
            }, true);
        }
        
        function setupFiltering(inputId, dataProvider, renderFunc, isHistorical = false) {
            const filterInput = document.getElementById(inputId);
            const filterKey = isHistorical ? 'historical' : 'main';
            const clearFilterBtn = document.getElementById(`clear-filter-btn-${filterKey}`);
            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                clearFilterBtn.classList.toggle('hidden', !filterText);
                const filteredData = applyAllFilters(dataProvider(), filterKey);
                renderFunc(document.getElementById(isHistorical ? 'historical-table-body' : 'news-table-body'), filteredData, isHistorical);
            });
            clearFilterBtn.addEventListener('click', () => {
                filterInput.value = ''; filterInput.dispatchEvent(new Event('input'));
            });
        }

        function sortAndRenderTable(tableBody, data, isHistorical) {
            // Lógica de ordenamiento corregida y definitiva:
            // 1. Criterio principal: Fecha de la noticia (descendente).
            // 2. Criterio de desempate: Fecha de creación del registro (descendente).
            data.sort((a, b) => {
                try {
                    // Normalizar fechas para evitar errores. Se usa una fecha muy antigua como fallback.
                    const dateA = a.fecha ? new Date(a.fecha) : new Date(0);
                    const dateB = b.fecha ? new Date(b.fecha) : new Date(0);

                    // 1. Comparar por fecha de la noticia (descendente).
                    const dateComparison = dateB.getTime() - dateA.getTime();
                    if (dateComparison !== 0) return dateComparison;

                    // 2. Si las fechas son iguales, desempatar por fecha de creación (descendente).
                    const timeB = b.createdAt?.toMillis() || 0;
                    const timeA = a.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                } catch (e) {
                    return 0; // Fallback si alguna fecha no es válida
                }
            });

            const filterKey = isHistorical ? 'historical' : 'main';
            const filteredData = applyAllFilters(data, filterKey);
            renderTable(tableBody, filteredData, isHistorical);
        }

        function openWebviewModal(url) {
            webviewFrame.src = url;
            openModal(webviewModal);
        }

        // =============================================
        // MÓDULO: Gestión de noticias
        // =============================================
        
        async function saveNews(newsData) {
            try {
                await newsCollectionRef.add({ 
                    ...newsData, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                });
                showAlert("Noticia guardada con éxito!", "success");
            } catch (error) {
                console.error("Error al guardar la noticia:", error);
                showAlert(`Error al guardar: ${error.message}`, "error");
            }
        }

        async function updateNews(id, updateData, isHistorical) {
            if (!id) {
                console.error("ID no válido para actualización");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalNewsCollectionRef : newsCollectionRef;
                const newsDocRef = collectionRef.doc(id);
                
                const docSnapshot = await newsDocRef.get();
                if (!docSnapshot.exists) {
                    showAlert("El registro que intentas actualizar no existe", "error");
                    return;
                }
                
                await newsDocRef.update({ ...updateData, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                showAlert("Noticia actualizada con éxito!", "success");
            } catch (error) {
                console.error("Error al actualizar la noticia:", error);
                showAlert(`Error al actualizar: ${error.message}`, "error");
            }
        }

        async function deleteNews(id, isHistorical) {
            if (!id) {
                console.error("ID no válido para eliminación");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalNewsCollectionRef : newsCollectionRef;
                const newsDocRef = collectionRef.doc(id);
                
                const docSnapshot = await newsDocRef.get();
                if (!docSnapshot.exists) {
                    showAlert("El registro que intentas eliminar no existe", "error");
                    return;
                }
                
                await newsDocRef.delete();
                showAlert("Noticia eliminada con éxito!", "success");
            } catch (error) {
                console.error("Error al eliminar la noticia:", error);
                showAlert(`Error al eliminar: ${error.message}`, "error");
            }
        }

        function handleEditClick(button) {
            requirePassword(() => {
                const newsId = button.getAttribute('data-id');
                const isHistorical = button.getAttribute('data-is-historical') === 'true';

                if (!newsId) {
                    console.error("ID de noticia no encontrado para edición");
                    return;
                }

                currentEditIsHistorical = isHistorical;
                const allData = isHistorical ? historicalNews : news;
                const newsToEdit = allData.find(item => item.id === newsId);

                if (!newsToEdit) {
                    showAlert("No se pudo encontrar la noticia para editar", "error");
                    return;
                }

                document.getElementById('edit-id').value = newsId;

                // Set form values
                document.getElementById('edit-news-date').value = newsToEdit.fecha || ''; // ... (resto de campos)
                document.getElementById('edit-news-source').value = newsToEdit.fuente || '';
                document.getElementById('edit-news-summary').value = newsToEdit.resumen || '';
                document.getElementById('edit-news-comment').value = newsToEdit.comentario || '';
                document.getElementById('edit-news-cita').value = newsToEdit.cita || '';
                document.getElementById('edit-news-summary').innerHTML = newsToEdit.resumen || '';
                // Set select values
                $('#edit-news-project').val(newsToEdit.proyecto || '').trigger('change');
                $('#edit-news-subproject').val(newsToEdit.subproyecto || '').trigger('change');
                $('#edit-news-category').val(newsToEdit.categoria || '').trigger('change');
                $('#edit-news-medio').val(newsToEdit.medio || '').trigger('change');

                // Cargar contenido HTML en el editor de edición
                // if (editNewsSummaryEditor) editNewsSummaryEditor.setContents(newsToEdit.resumen || '');

                openModal(editModal);
            });
        }

        function handleDeleteClick(button) {
            requirePassword(() => {
                newsToDeleteId = button.getAttribute('data-id');
                newsToDeleteIsHistorical = button.getAttribute('data-is-historical') === 'true';
                
                if (!newsToDeleteId) {
                    console.error("ID de noticia no encontrado para eliminación");
                    return;
                }
                
                openModal(confirmModal);
            });
        }

        function showDetailsModal(newsItem) {
            if (!newsItem) return;

            const sourceLink = newsItem.fuente && isValidUrl(newsItem.fuente) 
                ? `<a href="${newsItem.fuente}" target="_blank" class="text-blue-600 hover:underline break-all">${newsItem.fuente}</a>` 
                : `<p class="text-gray-700">${newsItem.fuente || 'N/A'}</p>`;

            detailsModalContent.innerHTML = `
                <div class="details-header">
                    <p class="date">${formatLongDate(newsItem.fecha)}</p>
                    <h3 class="project">${newsItem.proyecto || 'Proyecto no especificado'}</h3>
                </div>

                <div class="details-section">
                    <h4>Subproyecto</h4>
                    <p class="text-gray-800 text-base leading-relaxed">${newsItem.subproyecto || 'No especificado.'}</p>
                </div>

                <div class="details-section">
                    <h4>Resumen de la Noticia</h4>
                    <p class="text-gray-800 text-lg leading-relaxed font-bold mb-2">${newsItem.comentario || 'Sin título.'}</p>
                    <p class="text-gray-600 text-base italic leading-relaxed mb-4">${newsItem.cita || ''}</p>
                    <div class="formatted-content">${newsItem.resumen || 'No hay resumen disponible.'}</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="details-section">
                        <h4>Categoría</h4>
                        <p class="text-gray-700">${newsItem.categoria || 'N/A'}</p>
                    </div>
                    <div class="details-section">
                        <h4>Medio de Difusión</h4>
                        <p class="text-gray-700">${newsItem.medio || 'N/A'}</p>
                    </div>
                </div>

                <div class="details-section">
                    <h4>Fuente Original (URL)</h4>
                    ${sourceLink}
                </div>
            `;

            openModal(viewDetailsModal);
        }

        /**
         * Genera un documento .docx a partir de una plantilla en Firebase Storage.
         * @param {string} newsId - El ID del registro de la noticia.
         * @param {boolean} isHistorical - Indica si el registro es del histórico.
         */
        async function generateDoc(newsId, isHistorical) {
            // Módulo para manejar HTML en docxtemplater
            const HTMLModule = {
                name: "HTMLModule",
                set: function(options) { this.options = options; },
                get: function(scope, context) { if (scope.startsWith('@')) { return { _type: "html", value: context.scopeList[context.scopeList.length - 1] }; } },
                render: function(part, scope) { if (part.type === "html") { return { value: part.value }; } }
            };

            // 1. Verificar que las librerías necesarias estén cargadas y cargar fallbacks si es necesario
            let missingLibs = checkRequiredLibraries();
            if (missingLibs.includes('PizZip') || missingLibs.includes('docxtemplater')) {
                showAlert("Cargando librerías necesarias...", "info");
                try {
                    await loadFallbackLibraries(missingLibs);
                    // Verificar nuevamente después de cargar los fallbacks
                    missingLibs = checkRequiredLibraries();
                    if (missingLibs.includes('PizZip') || missingLibs.includes('docxtemplater')) {
                        const errorMessage = `No se pudieron cargar las librerías: ${missingLibs.join(', ')}. Verifique su conexión.`;
                        console.error(errorMessage);
                        return showAlert(errorMessage, "error");
                    }
                } catch (error) {
                    const errorMessage = "Error al cargar librerías para generar documentos.";
                    console.error(errorMessage, error);
                    return showAlert(errorMessage, "error");
                }
            } else if (missingLibs.includes('saveAs')) {
                 return showAlert("Error: La librería FileSaver.js no se cargó correctamente.", "error");
            }

            showAlert("Generando reporte...", "info");
            const dataSet = isHistorical ? historicalNews : news;
            const record = dataSet.find(item => item.id === newsId);

            if (!record) {
                return showAlert("No se encontró el registro de la noticia.", "error");
            }

            try {
                // 2. Obtener la plantilla desde Firestore
                const templateDoc = await templateDocRef.get();
                if (!templateDoc.exists || !templateDoc.data().templateData) {
                    return showAlert("No se encontró la plantilla. Por favor, cárguela en la pestaña de Reportes.", "error");
                }
                const base64String = templateDoc.data().templateData;

                // Convertir la plantilla de Base64 a un formato que docxtemplater pueda usar
                const templateBlob = base64ToArrayBuffer(base64String);

                // 3. Procesar la plantilla con docxtemplater
                // Usamos PizZip directamente desde el objeto window
                const zip = new PizZip(templateBlob);
                const doc = new window.docxtemplater(zip, {
                    modules: [HTMLModule], // Cargar el módulo HTML
                    paragraphLoop: true,
                    linebreaks: true
                });

                // 4. Mapeo de datos (asegurando que no haya valores nulos)
                const dataForTemplate = {
                    palabra_clave_0: getMonthName(record.fecha),
                    palabra_clave_1: formatLongDate(record.fecha),
                    palabra_clave_2: record.fuente || 'No especificado',
                    palabra_clave_3: record.proyecto || 'No especificado',
                    palabra_clave_4: record.subproyecto || 'No especificado',
                    palabra_clave_5: record.resumen || 'No hay resumen disponible.',
                    palabra_clave_6: record.categoria || 'No especificado',
                    palabra_clave_7: record.medio || 'No especificado',
                    palabra_clave_8: record.comentario || 'No especificado', // Este es ahora el Título
                    palabra_clave_9: record.cita || 'No especificado',
                };

                doc.setData(dataForTemplate);
                doc.render();

                // 5. Generar y descargar el archivo
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                const fileName = `Reporte-${(record.proyecto || 'Noticia').replace(/ /g, '_')}.docx`;
                saveAs(out, fileName);
                showAlert("¡Reporte generado con éxito!", "success");

            } catch (error) {
                console.error("Error en docxtemplater:", error);
                // Error mejorado para distinguir problemas de plantilla
                if (error.properties && error.properties.errors) {
                    showAlert("Error en la plantilla: " + error.properties.errors[0].message, "error");
                } else {
                    showAlert("Error al generar el reporte. Revise la consola.", "error");
                }
            }
        }

        // =============================================
        // MÓDULO: Gestión de datos históricos
        // =============================================
        
        async function deleteAllHistorical() {
            const batch = db.batch();
            historicalNews.forEach(newsItem => {
                const ref = historicalNewsCollectionRef.doc(newsItem.id);
                batch.delete(ref);
            });
            await batch.commit(); 
        }

        async function importHistoricalData(data) {
            try {
                const batch = db.batch();
                data.forEach(item => {
                    const docRef = historicalNewsCollectionRef.doc();
                    batch.set(docRef, { ...item, importedAt: firebase.firestore.FieldValue.serverTimestamp() });
                });
                await batch.commit();
                showAlert(`Se han importado ${data.length} registros históricos.`, "success");
                
                updateDynamicSelectOptions();
                renderTable(historicalTableBody, historicalNews, true);

            } catch (error) {
                console.error("Error al importar datos históricos:", error);
                showAlert(`Error al importar: ${error.message}`, "error");
            }
        }

        // =============================================================
        // MÓDULO: Catálogos de opciones dinámicas (Actualizado)
        // =============================================================

        // Catálogo de proyectos ferroviarios
        const catalogoProyectos = [
            "PLAN MÉXICO PARA REHABILITAR LINEAS FÉRREAS",
            "TREN MÉXICO - PACHUCA",
            "TREN SALTILLO - NUEVO LAREDO",
            "TREN MÉXICO - QUERÉTARO",
            "TREN MÉXICO - PACHUCA, TREN MÉXICO QUERÉTARO, QUERÉTARO IRAPUATO",
            "TREN MAYA",
            "TREN MÉXICO - QUERÉTARO, TREN QUERÉTARO - IRAPUATO",
            "TREN QUERÉTARO - IRAPUATO",
            "TREN HERMOSILLO - NOGALES"
        ];

        // Catálogo de subproyectos, actualizado con las nuevas opciones
        const catalogoSubproyectos = [
            "TREN INTERURBANO MÉXICO - TOLUCA",
            "TRAMO AIFA - PACHUCA",
            "TRENES DE MÉXICO",
            "TRAMO MÉXICO - AIFA",
            "TREN INTEROCEÁNICO",
            "TRAMO III",
            "TRAMO XII",
            "TRAMO MURIS - NOGALES",
            "TRAMO NUEVO LEÓN - TAMAULIPAS",
            "TRAMO II",
            "TREN INTERURBANO GUANAJUATO",
            "TREN PUEBLA - ATLIXCO",
            "TREN AIFA - PACHUCA",
            "TREN MÉXICO - PUEBLA - VERACRUZ",
            "TREN INTERURBANO MÉXICO - PACHUCA",
            "TRAMO I",
            "TREN MÉXICO - QUERÉTARO, TRAMOS QUERÉTARO - IRAPUATO, QUERÉTARO - NUEVO LEÓN",
            "TREN MÉXICO - PACHUCA, TREN MÉXICO QUERÉTARO, QUERÉTARO IRAPUATO, TREN SALTILLO - NUEVO LAREDO",
            "TREN INTEROCEÁNICO, TREN MÉXICO - QUERÉTARO"
        ];

        // Catálogo de categorías
        const catalogoCategorias = [
            "INFORMACIÓN GENERAL DEL PROGRAMA",
            "AVANCES FÍSICOS",
            "EJECUCIÓN",
            "LICITACIÓN",
            "PRESUPUESTO"
        ];

        // Catálogo de medios de difusión
        const catalogoMedios = [
            "AL MOMENTO",
            "AMBAS MANOS",
            "ANIMAL POLÍTICO",
            "CAPITAL COAHUILA",
            "CARIBE EMPRESARIAL",
            "DIARIO DE QUERÉTARO",
            "DIARIO DEL SUR",
            "DOF",
            "EFFETA",
            "EL CEO",
            "EL CRONISTA",
            "EL ECONOMISTA",
            "EL FINANCIERO",
            "EL NORTE",
            "EL SALMANTINO",
            "EL SOL DE MÉXICO",
            "EL SOL DE SAN JUAN DEL RIO",
            "EL UNIVERSAL",
            "EN EL SUBTE",
            "EXILIO",
            "EXPANSIÓN",
            "GREEN PEACE",
            "HORA CERO",
            "INFOBAE",
            "LA RAZÓN DE MÉXICO",
            "LA VERDAD DE LAS NOTICIAS",
            "LIDER EMPRESARIAL",
            "LUZ NOTICIAS",
            "MEGA NOTICIAS",
            "MGM NOTICIAS",
            "MILENIO",
            "MVS NOTICIAS",
            "NEWS DAY CARIBE",
            "NOTICIAS DE QUERÉTARO",
            "OBRAS EXPANSIÓN",
            "PLAZA DE ARMAS",
            "PRESIDENCIA",
            "PROCESO",
            "PUENTE LIBRE MX",
            "QUADRATIN",
            "REFORMA",
            "REPORTE ÍNDIGO",
            "REPORTUR",
            "S1E",
            "SDP NOTICIAS",
            "T21",
            "TELEDIARIO",
            "TRAMO MÉXICO - AIFA",
            "TRANSPORTE MX",
            "VANGUARDIA",
            "Conferencia de prensa matutina"
        ];



        function updateDynamicSelectOptions() {
            const allData = [...news, ...historicalNews];
            
            // Proyectos - combinar catálogo con datos existentes
            const historicalProyectos = allData.map(c => c.proyecto).filter(Boolean).map(p => p.trim());
            const combinedProyectos = [...new Set([...catalogoProyectos, ...historicalProyectos])].sort();
            fieldOptions.proyectos = combinedProyectos;
            updateSelectOptions('proyectos', fieldOptions.proyectos);
        
            // Categorías - combinar catálogo con datos existentes
            const historicalCategorias = allData.map(c => c.categoria).filter(Boolean).map(c => c.trim());
            const combinedCategorias = [...new Set([...catalogoCategorias, ...historicalCategorias])].sort();
            fieldOptions.categorias = combinedCategorias;
            updateSelectOptions('categorias', fieldOptions.categorias);

            // Medios - combinar catálogo con datos existentes
            const historicalMedios = allData.map(c => c.medio).filter(Boolean).map(m => m.trim());
            const combinedMedios = [...new Set([...catalogoMedios, ...historicalMedios])].sort();
            fieldOptions.medios = combinedMedios;
            updateSelectOptions('medios', fieldOptions.medios);

            // Subproyectos - solo datos existentes
            const historicalSubproyectos = allData.map(c => c.subproyecto).filter(Boolean).map(s => s.trim());
            const combinedSubproyectos = [...new Set([...catalogoSubproyectos, ...historicalSubproyectos])].sort();
            fieldOptions.subproyectos = combinedSubproyectos;
            updateSelectOptions('subproyectos', fieldOptions.subproyectos);
        }

        function updateSelectOptions(field, options, selectedId = null) {
            const fieldToSelectMap = {
                'proyectos': ['news-project', 'edit-news-project'],
                'subproyectos': ['news-subproject', 'edit-news-subproject'],
                'categorias': ['news-category', 'edit-news-category'],
                'medios': ['news-medio', 'edit-news-medio']
            };

            const normalizedOptions = options.map(opt => ({id: opt, text: opt}));
            
            if (fieldToSelectMap[field]) {
                fieldToSelectMap[field].forEach(selectId => {
                    const select = $(`#${selectId}`);
                    if (select.length) {
                        const currentValue = select.val();
                        
                        select.empty().select2({
                            data: normalizedOptions,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });

                        if (currentValue && normalizedOptions.some(o => o.id === currentValue)) {
                            select.val(currentValue).trigger('change.select2');
                        }
                        else if (selectedId && normalizedOptions.some(o => o.id === selectedId)) {
                            select.val(selectedId).trigger('change.select2');
                        }
                    }
                });
            }
        }



        async function findAndReplaceInDatabase(field, oldValue, newValue, activeFormId, formStateBeforeEdit) {
            const fieldToDbFieldMap = {
                'proyectos': 'proyecto', 
                'categorias': 'categoria',
                'medios': 'medio',
                'subproyectos': 'subproyecto'
            };
            
            const dbField = fieldToDbFieldMap[field];
            if (!dbField) return;
            
            try {
                const newsQuery = newsCollectionRef.where(dbField, '==', oldValue);
                const newsSnapshot = await newsQuery.get();
                
                const batch = db.batch();
                newsSnapshot.forEach(doc => {
                    batch.update(doc.ref, { [dbField]: newValue });
                });
                
                const historicalQuery = historicalNewsCollectionRef.where(dbField, '==', oldValue);
                const historicalSnapshot = await historicalQuery.get();
                
                historicalSnapshot.forEach(doc => {
                    batch.update(doc.ref, { [dbField]: newValue });
                });
                
                await batch.commit();
                
                // 1. Actualizar las opciones globales y redibujar los selects
                fieldOptions[field] = [...new Set([...fieldOptions[field].filter(opt => opt !== oldValue), newValue])].sort();
                updateSelectOptions(field, fieldOptions[field]);
                
                // 2. Restaurar el estado del formulario
                if (formStateBeforeEdit) {
                    restoreFormState(activeFormId, formStateBeforeEdit);
                }

                // 3. Asegurarse de que el campo editado tenga el nuevo valor seleccionado
                if (activeSelectElement) {
                    $(activeSelectElement).val(newValue).trigger('change.select2');
                }
                
                showAlert(`Se actualizaron ${newsSnapshot.size + historicalSnapshot.size} registros.`, "success");
            } catch (error) {
                console.error("Error al actualizar registros:", error);
                showAlert("Error al actualizar registros existentes", "error");
            }
        }

        function getFormState(formId) {
            const form = document.getElementById(formId);
            if (!form) return null;
            const state = {};
            
            // Guardar estado de inputs y textareas
            $(form).find('input, textarea').each(function() {
                const input = $(this);
                const inputName = input.attr('name');
                if (inputName) {
                    state[inputName] = { value: input.val() };
                }
            });

            // Guardar estado de selects (incluyendo tags)
            $(form).find('select').each(function() {
                const select = $(this);
                const selectName = select.attr('name');
                if (selectName) {
                    const select2Data = select.select2('data') || [];
                    state[selectName] = {
                        value: select.val(),
                        tags: select2Data.filter(item => item.element === undefined || $(item.element).data('select2-tag') === true)
                    };
                }
            });
            
            return state;
        }

        function restoreFormState(formId, state) {
            const form = document.getElementById(formId);
            if (!form || !state) return;
            
            Object.entries(state).forEach(([fieldName, fieldState]) => {
                const element = $(form).find(`[name="${fieldName}"]`);
                if (element.is('select')) {
                    // Restaurar tags para selects
                    if (fieldState.tags) {
                        fieldState.tags.forEach(tag => {
                            if (!element.find(`option[value="${tag.id}"]`).length) {
                                element.append(new Option(tag.text, tag.id));
                            }
                        });
                    }
                    element.val(fieldState.value).trigger('change.select2');
                } else if(element.is('input') || element.is('textarea')) {
                    element.val(fieldState.value);
                }
            });
        }

        function setupAddEditButtons() {
            const buttonToFieldMap = {
                'edit-project-btn': 'proyectos',
                'edit-subproject-btn': 'subproyectos',
                'edit-category-btn': 'categorias',
                'edit-medio-btn': 'medios',
                'edit-source-btn': 'fuente',
                'edit-cita-btn': 'cita',
                'edit-summary-btn': 'resumen',
                'edit-comment-btn': 'comentario',
                'edit-project-edit-btn': 'proyectos',
                'edit-subproject-edit-btn': 'subproyectos',
                'edit-category-edit-btn': 'categorias',
                'edit-source-edit-btn': 'fuente',
                'edit-summary-edit-btn': 'resumen',
                'edit-cita-edit-btn': 'cita',
                'edit-comment-edit-btn': 'comentario',
                'edit-medio-edit-btn': 'medios'
            };
            
            Object.entries(buttonToFieldMap).forEach(([buttonId, field]) => {
                const button = document.getElementById(buttonId);
                if (!button) return;

                button.addEventListener('click', (e) => {
                    let inputElement;
                    
                    if (['fuente', 'resumen', 'comentario', 'cita'].includes(field)) {
                        inputElement = e.currentTarget.parentElement.querySelector('input') || 
                                      e.currentTarget.parentElement.querySelector('textarea') ||
                                      e.currentTarget.parentElement.querySelector('.contenteditable');
                    } else {
                        inputElement = e.currentTarget.parentElement.querySelector('select');
                        activeSelectElement = inputElement;
                    }
                    
                    const currentValue = inputElement.value;
                        
                    if (!currentValue) {
                        return showAlert("Por favor, ingrese un valor para editar.", "warning");
                    }
                       
                    currentEditingField = field;
                    currentEditingValue = currentValue;
                    editOptionInput.value = currentValue;
                    editOptionInput.placeholder = `Edite la opción para ${field}`;
                    openModalWithFocus(editOptionModal, editOptionInput);
                });
            });
            
            confirmEditOptionBtn.addEventListener('click', () => {
                const newValue = editOptionInput.value.trim();

                if (!newValue || !currentEditingField || !currentEditingValue) {
                    return;
                }

                closeModal(editOptionModal);
                
                const activeFormId = !newsModal.classList.contains('hidden') ? 'news-form' : 
                                     !editModal.classList.contains('hidden') ? 'edit-form' : null;
                
                const formStateBeforeEdit = activeFormId ? getFormState(activeFormId) : null;
                requirePassword(async () => {
                    try {
                        if (['proyectos', 'categorias', 'medios', 'subproyectos'].includes(currentEditingField)) {
                            await findAndReplaceInDatabase(currentEditingField, currentEditingValue, newValue, activeFormId, formStateBeforeEdit);
                        } else {
                            // Lógica para campos de texto (no afecta a otros campos)
                            let inputElement;
                            if (currentEditingField === 'fuente') {
                                inputElement = document.getElementById(activeFormId === 'news-form' ? 'news-source' : 'edit-news-source');
                            } else if (currentEditingField === 'cita') {
                                inputElement = document.getElementById(activeFormId === 'news-form' ? 'news-cita' : 'edit-news-cita');
                            } else if (currentEditingField === 'comentario') {
                                inputElement = document.getElementById(activeFormId === 'news-form' ? 'news-comment' : 'edit-news-comment');
                            } else if (currentEditingField === 'resumen') {
                                inputElement = document.getElementById(activeFormId === 'news-form' ? 'news-summary' : 'edit-news-summary');
                            }
                            
                            if (inputElement) {
                                inputElement.value = newValue;
                            }
                        }
                    } catch (dbErr) {
                        console.error('Error al actualizar la base de datos:', dbErr);
                        showAlert("Error al actualizar la opción", "error");
                    } finally {
                        activeSelectElement = null; // Limpiar el elemento activo
                    }
                });
            });
            cancelEditOptionBtn.addEventListener('click', () => {
                closeModal(editOptionModal);
                activeSelectElement = null;
            });
        }


        // =============================================
        // MÓDULO: Autenticación y seguridad
        // =============================================

        function verifyPassword() {
            const password = passwordInput.value;
            
            if (password === 'admin') {
                // Cierre manual del modal para evitar quitar la clase 'modal-open' del body
                // durante la transición al siguiente modal (ej. editar).
                passwordModal.classList.remove('modal-enter');
                passwordModal.classList.add('modal-leave');
                setTimeout(() => passwordModal.classList.add('hidden'), 300);

                passwordInput.value = '';
                if (pendingAction) {
                    pendingAction();
                    pendingAction = null;
                }
            } else {
                showAlert("Contraseña incorrecta", "error");
                passwordInput.value = '';
            }
        }

        function setupPasswordVerification() {
            confirmPasswordBtn.addEventListener('click', verifyPassword);
            cancelPasswordBtn.addEventListener('click', () => {
                closeModal(passwordModal);
                pendingAction = null;
            });
            
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
        }


        function requirePassword(action, isAsync = false) {
            pendingAction = action;
            openModal(passwordModal); // Se corregirá a openModalWithFocus más adelante
            openModalWithFocus(passwordModal, passwordInput);
            
            if (isAsync) {
                return new Promise((resolve, reject) => {
                    const originalAction = pendingAction;
                    pendingAction = async () => {
                        try {
                            const result = await originalAction();
                            resolve(result);
                        } catch (error) {
                            reject(error);
                        }
                    };
                });
            }
        }

        async function initializeAppWithAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    userId = user.uid;
                    userInfo.textContent = `Usuario Anónimo: ${userId.substring(0, 8)}...`;
                    setupRealtimeListeners();
                    showApp();
                } else {
                    try {
                        await auth.signInAnonymously();
                    } catch (error) {
                        console.error("Error en autenticación anónima:", error);
                        showAlert("Error de conexión. Algunas funciones pueden no estar disponibles.", "warning");
                        // Mostrar la app de todos modos en modo offline
                        showApp();
                    }
                }
            });
        }
        
        function setupRealtimeListeners() {
            newsCollectionRef.onSnapshot((snapshot) => {
                news = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(newsTableBody, news, false);
                updateCharts();
                updateDynamicSelectOptions();
            }, (error) => console.error("Error en listener de noticias:", error));
            
            historicalNewsCollectionRef.onSnapshot((snapshot) => {
                historicalNews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(historicalTableBody, historicalNews, true);
                updateCharts();
                updateDynamicSelectOptions();
            }, (error) => console.error("Error en listener de histórico:", error));
        }

        // =============================================
        // MÓDULO: Gráficos y reportes
        // =============================================
        
        function updateCharts() {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'noticias') data = news;
            else if (source === 'historico') data = historicalNews;
            else data = [...news, ...historicalNews];
            
            const proyectoCounts = {}, categoriaCounts = {};
        
            if (dynamicChart) dynamicChart.destroy();

            // Update dynamic chart
            updateDynamicChart();
        }

        function updateDynamicChart() {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'noticias') data = news;
            else if (source === 'historico') data = historicalNews;
            else data = [...news, ...historicalNews];
            
            const selectedVariable = dynamicChartVariable.value;
            const variableCounts = {};
            
            data.forEach(newsItem => {
                const value = newsItem[selectedVariable] || 'N/A';
                variableCounts[value] = (variableCounts[value] || 0) + 1;
            });
            
            // Update dynamic table
            dynamicTableBody.innerHTML = '';
            dynamicTableHeader.textContent = selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1);
            
            let total = 0;

            Object.entries(variableCounts).forEach(([value, count]) => {
                total += count;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value}</td>
                    <td>${count}</td>
                `;
                dynamicTableBody.appendChild(row);
            });

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'bg-slate-200 font-bold';
            totalRow.innerHTML = `
                <td>Total</td>
                <td>${total}</td>
            `;
            dynamicTableBody.appendChild(totalRow);
            
            // Update dynamic chart
            if (dynamicChart) dynamicChart.destroy();
            
            const labels = Object.keys(variableCounts);
            const chartData = Object.values(variableCounts);
            
            dynamicChart = new Chart(dynamicChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: chartData,
                        backgroundColor: '#9C2348'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                display: showChartLabels,
                                maxRotation: showChartLabels ? 90 : 0,
                                minRotation: showChartLabels ? 45 : 0
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // MÓDULO: Exportación/Importación
        // =============================================

        const exportHeaders = [
            "No.", "Fecha", "Fuente", "Proyecto", "Subproyecto", "Título", "Cita", "Resumen", "Categoría", "Medio"
        ];

        function prepareExportData(data) {
            return data.map((newsItem, index) => ({
                "No.": index + 1, 
                "Fecha": formatDate(newsItem.fecha), 
                "Fuente": newsItem.fuente || "",
                "Proyecto": newsItem.proyecto || "", 
                "Subproyecto": newsItem.subproyecto || "",
                "Título": newsItem.comentario || "",
                "Cita": newsItem.cita || "",
                "Resumen": stripHtml(newsItem.resumen) || "",
                "Categoría": newsItem.categoria || "",
                "Medio": newsItem.medio || ""
            }));
        }

        // =============================================
        // MÓDULO: Migración de datos
        // =============================================
        
        async function migrateNewsToHistorical() {
            try {
                if (news.length === 0) {
                    showAlert("No hay noticias para migrar.", "warning");
                    return;
                }
                
                const batch = db.batch();
                const newsCount = news.length;
                
                news.forEach(newsItem => {
                    const historicalDocRef = historicalNewsCollectionRef.doc();
                    const { id, ...newsData } = newsItem;
                    batch.set(historicalDocRef, { 
                        ...newsData,
                        migratedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        originalId: id
                    });
                });
                
                news.forEach(newsItem => {
                    const newsDocRef = newsCollectionRef.doc(newsItem.id);
                    batch.delete(newsDocRef);
                });
                
                await batch.commit();
                
                news = [];
                sortAndRenderTable(newsTableBody, news, false);
                
                showAlert(`Se migraron ${newsCount} noticias al histórico.`, "success");
            } catch (error) {
                console.error("Error al migrar noticias:", error);
                showAlert(`Error al migrar: ${error.message}`, "error");
            }
        }

        function handleRowDoubleClick(e, isHistorical) {
            const row = e.target.closest('tr');
            if (!row || e.target.closest('button') || e.target.closest('.link-cell')) {
                return; // No hacer nada si se hace clic en un botón o en el enlace
            }
            const newsId = row.querySelector('.edit-btn')?.dataset.id;
            if (!newsId) return;

            const data = isHistorical ? historicalNews : news;
            const newsItem = data.find(item => item.id === newsId);
            showDetailsModal(newsItem);
        }

        function handleGenerateDocClick(button) {
            const newsId = button.dataset.id;
            const isHistorical = button.dataset.isHistorical === 'true';
            // Llamada directa a la función de generación de documento, sin contraseña.
            generateDoc(newsId, isHistorical);
        }

        // =============================================
        // MÓDULO: Configuración de eventos
        // =============================================
        
        function setupEventListeners() {
            setupTabs();
            setupColumnFilters('main-table-header', () => news, renderTable, 'main');
            setupColumnFilters('historical-table-header', () => historicalNews, renderTable, 'historical');
            setupFiltering('filter-input-main', () => news, renderTable, false);
            setupFiltering('filter-input-historical', () => historicalNews, renderTable, true);
            setupAddEditButtons();
            setupPasswordVerification();
            
            reportesDataSource.addEventListener('change', updateCharts);
            dynamicChartVariable.addEventListener('change', updateDynamicChart);
            
            toggleLabelsBtn.addEventListener('click', () => {
                showChartLabels = !showChartLabels;
                toggleLabelsBtn.classList.toggle('bg-primary', showChartLabels);
                toggleLabelsBtn.classList.toggle('text-white', showChartLabels);
                updateDynamicChart();
            });
            
            addNewsBtn.addEventListener('click', () => {
                // Clear form
                newsForm.reset();
                $('#news-project, #news-subproject, #news-category, #news-medio').val(null).trigger('change');

                // Limpiar el editor de texto
                document.getElementById('news-summary').innerHTML = '';

                // Establecer la fecha de hoy DESPUÉS de resetear el formulario
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('news-date').value = today;
                
                openModalWithFocus(newsModal, document.getElementById('news-source'));
            });
            
            closeModalBtn.addEventListener('click', () => closeModal(newsModal));
            
            newsForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!newsForm.checkValidity()) {
                    return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                }
                
                const formData = new FormData(newsForm);
                const newsData = Object.fromEntries(formData.entries());

                // Obtener el contenido HTML del editor y sobrescribir el resumen
                newsData.resumen = document.getElementById('news-summary').innerHTML;
                
                saveNews(newsData);
                closeModal(newsModal);
            });
            
            closeEditModalBtn.addEventListener('click', () => closeModal(editModal));
            
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!editForm.checkValidity()) {
                    return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                }
                
                const formData = new FormData(editForm);
                const updateData = Object.fromEntries(formData.entries());
                const id = document.getElementById('edit-id').value;

                // Obtener el contenido HTML del editor y sobrescribir el resumen
                updateData.resumen = document.getElementById('edit-news-summary').innerHTML;
                
                await updateNews(id, updateData, currentEditIsHistorical);
                closeModal(editModal);
            });

            let newsToDeleteId = null;
            let newsToDeleteIsHistorical = false;

            function handleDeleteClick(button) {
                requirePassword(() => {
                    newsToDeleteId = button.dataset.id;
                    newsToDeleteIsHistorical = button.dataset.isHistorical === 'true';
                    openModal(confirmModal);
                });
            }

            newsTableBody.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('edit-btn')) handleEditClick(target);
                if (target.classList.contains('delete-btn')) handleDeleteClick(target);
                if (target.classList.contains('generate-doc-btn')) handleGenerateDocClick(target);
            });

            uploadTemplateBtn.addEventListener('click', () => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.docx';
                fileInput.style.display = 'none';

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        requirePassword(async () => {
                            showAlert("Subiendo plantilla...", "info");
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                const base64String = event.target.result;
                                try {
                                    await templateDocRef.set({ 
                                        templateData: base64String,
                                        updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                                    });
                                    showAlert("¡Plantilla actualizada con éxito!", "success");
                                } catch (dbError) {
                                    console.error("Error al guardar plantilla en Firestore:", dbError);
                                    showAlert("Error al guardar la plantilla.", "error");
                                }
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                });
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            });

            document.querySelectorAll('#news-summary, #edit-news-summary').forEach(el => {
                el.addEventListener('paste', function(e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    const html = (e.clipboardData || window.clipboardData).getData('text/html');
                    const cleanedHTML = normalizeFontSizes(cleanWordHTML(html || text));
                    document.execCommand('insertHTML', false, cleanedHTML);
                });
            });

        newsTableBody.addEventListener('dblclick', (e) => handleRowDoubleClick(e, false));

            historicalTableBody.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('edit-btn')) handleEditClick(target);
                if (target.classList.contains('delete-btn')) handleDeleteClick(target);
                if (target.classList.contains('generate-doc-btn')) handleGenerateDocClick(target);
            });

        historicalTableBody.addEventListener('dblclick', (e) => handleRowDoubleClick(e, true));

            cancelDeleteBtn.addEventListener('click', () => {
                closeModal(confirmModal);
                newsToDeleteId = null;
            });
            
            confirmDeleteBtn.addEventListener('click', async () => {
                if (newsToDeleteId) {
                    await deleteNews(newsToDeleteId, newsToDeleteIsHistorical);
                    closeModal(confirmModal);
                }
            });

            historicalFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importHistoricalBtn.classList.remove('hidden');
                    importHistoricalBtn.disabled = false;
                } else {
                    importHistoricalBtn.classList.add('hidden');
                    importHistoricalBtn.disabled = true;
                }
            });



            // =============================================
            // MÓDULO: Importación de datos históricos (mejorado)
            // =============================================

            importHistoricalBtn.addEventListener('click', () => {
                requirePassword(async () => {
                    const file = historicalFileInput.files[0];
                    if (!file) {
                        showAlert("Por favor, selecciona un archivo Excel primero.", "warning");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            if (jsonData.length === 0) return showAlert("El archivo no contiene datos válidos.", "warning");

                            const processedData = jsonData.map(row => {
                                const mapKeys = (obj, keyMap) => Object.keys(obj).reduce((acc, key) => {
                                    const newKey = keyMap[key.toLowerCase().trim()] || key.toLowerCase().trim();
                                    acc[newKey] = obj[key];
                                    return acc;
                                }, {});

                                const keyMapping = { 
                                    'no.': 'no', 
                                    'fuente de la noticia': 'fuente',
                                    'resumen de la noticia': 'resumen'
                                };
                                const mappedRow = mapKeys(row, keyMapping);

                                // Procesamiento robusto de fecha
                                let fecha = mappedRow.fecha;
                                
                                if (fecha instanceof Date) {
                                    // Convertir objeto Date a formato YYYY-MM-DD
                                    const year = fecha.getFullYear();
                                    const month = (fecha.getMonth() + 1).toString().padStart(2, '0');
                                    const day = fecha.getDate().toString().padStart(2, '0');
                                    fecha = `${year}-${month}-${day}`;
                                } else if (typeof fecha === 'number') {
                                    // Convertir serial de Excel a formato YYYY-MM-DD
                                    // Excel cuenta desde 1900-01-01, pero con error en 1900 (no bisiesto)
                                    const excelEpoch = new Date(1900, 0, 1);
                                    const jsDate = new Date(excelEpoch.getTime() + (fecha - 2) * 24 * 60 * 60 * 1000);
                                    const year = jsDate.getFullYear();
                                    const month = (jsDate.getMonth() + 1).toString().padStart(2, '0');
                                    const day = jsDate.getDate().toString().padStart(2, '0');
                                    fecha = `${year}-${month}-${day}`;
                                } else if (typeof fecha === 'string') {
                                    // Intentar parsear string en varios formatos
                                    // Formato DD/MM/YYYY
                                    if (fecha.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                                        const [day, month, year] = fecha.split('/');
                                        fecha = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                    } 
                                    // Formato MM/DD/YYYY
                                    else if (fecha.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                                        const [month, day, year] = fecha.split('/');
                                        fecha = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                                    }
                                    // Formato YYYY-MM-DD (ya correcto)
                                    else if (fecha.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                                        // Ya está en el formato correcto
                                    }
                                    // Otros formatos - intentar crear fecha
                                    else {
                                        try {
                                            const parsedDate = new Date(fecha);
                                            if (!isNaN(parsedDate)) {
                                                const year = parsedDate.getFullYear();
                                                const month = (parsedDate.getMonth() + 1).toString().padStart(2, '0');
                                                const day = parsedDate.getDate().toString().padStart(2, '0');
                                                fecha = `${year}-${month}-${day}`;
                                            } else {
                                                fecha = '';
                                            }
                                        } catch (e) {
                                            fecha = '';
                                        }
                                    }
                                } else {
                                    fecha = '';
                                }

                                return {
                                    fecha: fecha,
                                    fuente: mappedRow.fuente || '',
                                    proyecto: mappedRow.proyecto || '',
                                    subproyecto: mappedRow.subproyecto || '',
                                    comentario: mappedRow.título || '',
                                    cita: mappedRow.cita || '',
                                    resumen: mappedRow.resumen || '',
                                    categoria: mappedRow.categoria || '',
                                    medio: mappedRow.medio || ''
                                };
                            });

                            if (processedData.length === 0) return showAlert("El archivo Excel está vacío o no es válido.", "warning");
                            
                            let replace = false;
                            if (historicalNews.length > 0) {
                                openModal(replaceHistoricalModal);
                                await new Promise(resolve => {
                                    confirmReplaceBtn.onclick = () => {
                                        replace = true;
                                        closeModal(replaceHistoricalModal);
                                        resolve();
                                    };
                                    cancelReplaceBtn.onclick = () => {
                                        replace = false;
                                        closeModal(replaceHistoricalModal);
                                        resolve();
                                    };
                                });
                                if (replace) {
                                    await deleteAllHistorical();
                                }
                            }
                            await importHistoricalData(processedData);
                            historicalFileInput.value = '';
                            importHistoricalBtn.disabled = true;
                            importHistoricalBtn.classList.add('hidden');
                        
                        } catch (error) {
                            console.error("Error al procesar el archivo:", error);
                            showAlert("Error al procesar el archivo. Asegúrese de que es un Excel válido.", "error");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            });




            downloadExcelBtn.addEventListener('click', () => {
                if (news.length === 0) return showAlert("No hay datos para descargar.", "warning");
                const data = prepareExportData(news);
                const ws = XLSX.utils.json_to_sheet(data, { header: exportHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Noticias");
                XLSX.writeFile(wb, "noticias_trenes.xlsx");
            });
            
            document.getElementById('download-historical-excel-btn').addEventListener('click', () => {
                // Obtener los datos actualmente filtrados en la tabla
                const filteredData = applyAllFilters(historicalNews, 'historical');

                if (filteredData.length === 0) return showAlert("No hay datos en la tabla para descargar.", "warning");
                const dataToExport = prepareExportData(filteredData);
                const ws = XLSX.utils.json_to_sheet(dataToExport, { header: exportHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Histórico Filtrado");
                XLSX.writeFile(wb, "noticias_historicas.xlsx");
            });
            
            closeWebviewBtn.addEventListener('click', () => {
                webviewFrame.src = 'about:blank';
                closeModal(webviewModal);
            });
            
            migrateNewsBtn.addEventListener('click', () => {
                requirePassword(() => openModal(migrateModal));
            });
            
            cancelMigrateBtn.addEventListener('click', () => closeModal(migrateModal));
            
            confirmMigrateBtn.addEventListener('click', async () => {
                try {
                    await migrateNewsToHistorical();
                    closeModal(migrateModal);
                } catch (error) {
                    console.error("Error en migración:", error);
                    showAlert("Error durante la migración: " + error.message, "error");
                }
            });

            closeDetailsModalBtn.addEventListener('click', () => closeModal(viewDetailsModal));
            
            // El evento 'shown' no es un evento estándar del DOM. 
            // La lógica para establecer la fecha ya está en el listener de 'addNewsBtn'.
            // newsModal.addEventListener('shown', () => {
            //     const today = new Date().toISOString().split('T')[0];
            //     document.getElementById('news-date').value = today;
            // });
        }

        // =============================================
        // MÓDULO: Inicialización
        // =============================================

        document.addEventListener('DOMContentLoaded', () => {
            // Asignar elementos del DOM una vez que la página esté cargada
            loader = document.getElementById('loader');
            appContainer = document.getElementById('app');
            userInfo = document.getElementById('user-info');
            tabsContainer = document.getElementById('tabs');
            tabContents = document.querySelectorAll('.tab-content');
            addNewsBtn = document.getElementById('add-news-btn');
            downloadExcelBtn = document.getElementById('download-excel-btn');
            migrateNewsBtn = document.getElementById('migrate-news-btn');
            newsTableBody = document.getElementById('news-table-body');
            noNewsMessage = document.getElementById('no-news-message');
            historicalTableBody = document.getElementById('historical-table-body');
            noHistoricalMessage = document.getElementById('no-historical-message');
            historicalFileInput = document.getElementById('historical-file-input');
            historicalFileName = document.getElementById('file-name');
            importHistoricalBtn = document.getElementById('import-historical-btn');
            reportesDataSource = document.getElementById('reportes-data-source');
            dynamicChartCanvas = document.getElementById('dynamicChart');
            dynamicChartVariable = document.getElementById('dynamic-chart-variable');
            toggleLabelsBtn = document.getElementById('toggle-labels-btn');
            dynamicTableBody = document.getElementById('dynamic-table-body');
            dynamicTableHeader = document.getElementById('dynamic-table-header');
            newsModal = document.getElementById('news-modal');
            newsForm = document.getElementById('news-form');
            closeModalBtn = document.getElementById('close-modal-btn');
            editModal = document.getElementById('edit-modal');
            editForm = document.getElementById('edit-form');
            closeEditModalBtn = document.getElementById('close-edit-modal-btn');
            confirmModal = document.getElementById('confirm-modal');
            cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            replaceHistoricalModal = document.getElementById('replace-historical-modal');
            cancelReplaceBtn = document.getElementById('cancel-replace-btn');
            confirmReplaceBtn = document.getElementById('confirm-replace-btn');
            editOptionModal = document.getElementById('edit-option-modal');
            editOptionInput = document.getElementById('edit-option-input');
            cancelEditOptionBtn = document.getElementById('cancel-edit-option-btn');
            confirmEditOptionBtn = document.getElementById('confirm-edit-option-btn');
            passwordModal = document.getElementById('password-modal');
            passwordInput = document.getElementById('password-input');
            cancelPasswordBtn = document.getElementById('cancel-password-btn');
            confirmPasswordBtn = document.getElementById('confirm-password-btn');
            webviewModal = document.getElementById('webview-modal');
            webviewFrame = document.getElementById('webview-frame');
            closeWebviewBtn = document.getElementById('close-webview-btn');
            migrateModal = document.getElementById('migrate-modal');
            cancelMigrateBtn = document.getElementById('cancel-migrate-btn'); // Esta línea está duplicada, pero la dejamos por seguridad
            confirmMigrateBtn = document.getElementById('confirm-migrate-btn'); // Esta línea está duplicada, pero la dejamos por seguridad
            uploadTemplateBtn = document.getElementById('upload-template-btn');
            viewDetailsModal = document.getElementById('view-details-modal');
            closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
            detailsModalContent = document.getElementById('details-modal-content');

            // Inicializar la autenticación y los listeners
            initializeAppWithAuth();
            setupEventListeners();

            // Configurar Select2 para los selects
            $('#news-project, #news-subproject, #news-category, #news-medio, #edit-news-project, #edit-news-subproject, #edit-news-category, #edit-news-medio').each(function() {
                 $(this).select2({
                     tags: true,
                     placeholder: "Seleccione o escriba una opción",
                     allowClear: true,
                     width: '100%'
                 });
             });

            // Mejora de UX: Auto-foco en el buscador de Select2 al abrirlo.
            $(document).on('select2:open', () => {
                // Usamos un pequeño timeout para asegurar que el campo de búsqueda ya es visible.
                setTimeout(() => document.querySelector('.select2-search__field').focus(), 50);
            });
            
             // Set current date as default
             const today = new Date().toISOString().split('T')[0];
             document.getElementById('news-date').value = today;
        });

        // Iniciar la aplicación
        // La inicialización ahora ocurre dentro del listener DOMContentLoaded

    </script>
</body> 
</html>
