<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario en Línea de Registro de Llamadas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- js-xlsx para leer archivos de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- PivotTable.js para tabla dinámica interactiva -->
    <link rel="stylesheet" type="text/css" href="https://pivottable.js.org/dist/pivot.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://pivottable.js.org/dist/pivot.min.js"></script>
    
    <!-- Select2 for searchable dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- html2pdf para generar reportes en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Hoja de estilos personalizada -->
    <style>
        html { font-size: 65%; } /* Simula zoom negativo al 50% */
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        
        /* Nueva paleta de colores */
        .bg-primary { background-color: #9C2348; }
        .text-primary { color: #9C2348; }
        .border-primary { border-color: #9C2348; }
        .focus\:ring-primary:focus { --tw-ring-color: #9C2348; }
        
        .bg-secondary { background-color: #A6802D; }
        .text-secondary { color: #A6802D; }
        .border-secondary { border-color: #A6802D; }
        
        .bg-accent { background-color: #1E5B4F; }
        .text-accent { color: #1E5B4F; }
        .border-accent { border-color: #1E5B4F; }
        
        .bg-success { background-color: #10B981; }
        .hover\:bg-success-dark:hover { background-color: #059669; }
        
        .bg-danger { background-color: #EF4444; }
        .hover\:bg-danger-dark:hover { background-color: #DC2626; }
        
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        .hidden { display: none; }
        .tab-btn.active { border-color: #9C2348; color: #9C2348; font-weight: bold; }
        
        .loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(255, 255, 255, 0.9); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .loader .spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; 
            border-left-color: #9C2348; animation: spin 1s ease infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .table-container { 
            overflow-x: auto; 
            max-height: 500px; /* Altura máxima para scroll vertical */
            overflow-y: auto;
        }
        
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .status-button {
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem;
            line-height: 1.25rem; font-weight: 500; text-align: center; user-select: none; border: 1px solid transparent;
        }
        .status-atendida { background-color: #10B981; color: #fff; border-color: #059669; }
        .status-pendiente { background-color: #EF4444; color: #fff; border-color: #DC2626; }
        
        .filterable-header { 
            cursor: pointer; 
            position: relative;
        }
        .filterable-header .filter-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .filterable-header:hover .filter-icon,
        .filterable-header.active .filter-icon {
            opacity: 1;
            color: #9C2348;
        }

        .filter-dropdown {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 6px;
            z-index: 20;
            max-height: 250px;
            overflow-y: auto;
            min-width: 200px;
        }
        
        input:invalid, select:invalid { border-color: #ef4444; }
        
        .section-title { font-weight: bold; color: #9C2348; margin-bottom: 1rem; }
        header + div { top: 56px !important; } /* Ajuste para eliminar hueco entre header y tabs */

        /* Aumentar el ancho máximo del contenedor principal */
        .max-w-7xl {
            max-width: 100% !important;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* Ajustar el ancho de las tablas */
        .table-container table {
            width: 100%;
            min-width: 1200px; /* Ancho mínimo aumentado */
        }

        /* Asegurar que el contenedor de la tabla ocupe todo el ancho */
        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        /* Ajustar el ancho de las columnas específicas si es necesario */
        .table-container th:nth-child(1), /* No. */
        .table-container td:nth-child(1),
        .table-container th:nth-child(15), /* Atendió */
        .table-container td:nth-child(15) {
            width: 30px;
        }

        .table-container th:nth-child(2), /* Fecha */
        .table-container td:nth-child(2){
            width: 60px;
        }
        
        .table-container th:nth-child(3), /* Inicio */
        .table-container td:nth-child(3),
        .table-container th:nth-child(4), /* Fin */
        .table-container td:nth-child(4),
        .table-container th:nth-child(5), /* Duración */
        .table-container td:nth-child(5),
        .table-container th:nth-child(6), /* Área */
        .table-container td:nth-child(6){
            width: 60px;
        }
        
        .table-container th:nth-child(16),
        .table-container td:nth-child(16) {
            max-width: 70px; /* Ancho máximo para la columna */
            white-space: normal; /* Permite que el texto se divida en líneas */
            word-wrap: break-word; /* Rompe palabras largas si es necesario */
        }

        .table-container th:nth-child(7), /* Institución */
        .table-container td:nth-child(7),
        .table-container th:nth-child(8), /* Asunto */
        .table-container td:nth-child(8),
        .table-container th:nth-child(9), /* Consulta */
        .table-container td:nth-child(9),
        .table-container th:nth-child(10), /* Nombre */
        .table-container td:nth-child(10),
        .table-container th:nth-child(11), /* Cargo */
        .table-container td:nth-child(11){
            width: 70px;
        }


        .flex-with-buttons {
        max-width: 340px; /* Ajusta este valor según necesites */
        min-width: 340px; /* Evita que se reduzca */
        max-width: 340px; /* Evita que se expanda */
        }

        .select2-selection__rendered {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        }

        .flex-with-buttons {
            display: flex;
            align-items: flex-end;
        }

        .flex-with-buttons .select2-container {
            flex-grow: 1;
            margin-bottom: 1px;
            min-width: 0;
        }

        .flex-with-buttons button {
            height: 38px;
            width: 38px;
            margin-bottom: 1px; /* Alineación vertical */
            flex-shrink: 0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        .flex-with-buttons button.edit-btn {
            background-color: #A6802D; /* Color secundario */
            color: white;
        }

        .flex-with-buttons button.edit-btn:hover {
            background-color: #8a6b22; /* Color secundario más oscuro */
        }

        .select2-container--default .select2-selection--single {
            height: 38px;
            padding: 5px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 26px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        /* Solución para truncar texto largo en los campos Select2 */
        .select2-container .select2-selection--single .select2-selection__rendered {
            display: block;
            padding-left: 8px;
            padding-right: 20px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .select2-container {
            width: 100% !important; /* Ocupa todo el ancho del contenedor */
        }

        .select2-selection__rendered {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-field {
            margin-bottom: 0.5rem;
        }

        .form-field label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        /* Mejoras para el formulario de llamada */
        .call-form-container {
            max-height: 75vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .call-form-container::-webkit-scrollbar {
            width: 6px;
        }

        .call-form-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .call-form-container::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .call-form-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Estilos para el reporte ejecutivo */
        .reporte-ejecutivo {
            padding: 20px;
            background: white;
            font-family: 'Inter', sans-serif;
        }
        
        .reporte-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #9C2348;
            padding-bottom: 20px;
        }
        
        .reporte-metricas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metrica {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #9C2348;
        }
        
        .graficas-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .grafica {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tabla-datos {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .tabla-datos th, .tabla-datos td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        
        .tabla-datos th {
            background-color: #f9fafb;
        }
        
        .reporte-footer {
            text-align: center;
            margin-top: 30px;
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
            color: #6b7280;
        }

        /* Nuevos estilos para la versión 1.1 */
        .config-report-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        @media (min-width: 640px) {
            .config-report-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .config-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .config-option input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .wide-modal .relative {
            max-width: 72rem !important; /* equivalente a max-w-6xl */
        }

        .bg-white.shadow-sm.sticky {
            margin-top: -1px !important;
        }
        
        #tabs {
            margin-top: 0 !important;
        }
        
        header + div {
            top: 56px !important;
        }
        
        .chart-size-control {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-size-control label {
            font-size: 14px;
            color: #374151;
        }
        
        .chart-size-control input {
            width: 150px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px; /* Altura por defecto, se ajustará con JS */
        }

        #reportes .grid {
            gap: 3rem 2rem; /* Aumenta el gap vertical y horizontal */
            margin-bottom: 2rem; /* Espacio extra al final */
        }

        /* Nuevos estilos para la versión 1.3 */
        .dynamic-chart-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dynamic-chart-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        
        .dynamic-chart-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .dynamic-table-container {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .dynamic-table th, .dynamic-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .dynamic-table th {
            background-color: #9C2348;
            color: white;
            font-weight: 600;
        }
        
        .dynamic-table tr:nth-child(even) {
            background-color: #f3f4f6;
        }
        
        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #1E5B4F;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .migrate-btn {
            background-color: #1E5B4F !important;
        }
        
        .migrate-btn:hover {
            background-color: #16463c !important;
        }


        /* Añadir al final de la sección de estilos */
        #toggle-labels-btn {
            transition: all 0.3s ease;
        }

        #toggle-labels-btn.bg-primary {
            background-color: #9C2348 !important;
        }

        /* Estilos para el pie de página */
        .footer-container {
            background-color: #ffffff;
            text-align: center;
            padding: 0.6rem;
            margin-top: 0.6rem;
            border-radius: 0.6rem;
            box-shadow: 0 -3px 5px rgba(0, 0, 0, 0.08);
        }
        .footer-container label {
            color: #4a5568;
            font-size: 0.65rem;
        }

    </style>
    
    <!-- Configuración de Tailwind con nueva paleta de colores -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#A6802D',
                            light: '#bf9a41',
                            dark: '#8a6b22'
                        },
                        secondary: {
                            DEFAULT: '#9C2348',
                            light: '#b52e5a',
                            dark: '#7d1c3a'
                        },
                        accent: {
                            DEFAULT: '#1E5B4F',
                            light: '#267c6c',
                            dark: '#16463c'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="antialiased text-slate-700">

    <!----------------- MENSAJE DE INICIO ---------------->
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-slate-600">Cargando datos, por favor espera...</p>
    </div>

    <!----------------- INICIO DE LA APP ---------------->
    <div id="app" class="min-h-screen hidden">

        <!----------------- LOGO Y TÍTULO DE LA APP ---------------->
        <header class="bg-primary shadow-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://github.com/SAGB-JCM/SICOINLlamadasFormulario/blob/main/SICOINLlamadasFormulario%20-%20LOGO.png?raw=true" alt="Logo Teléfono" class="h-14 w-auto">
                    <h1 class="text-xl sm:text-2xl font-bold text-white tracking-tight">Formulario en Línea de Registro de Llamadas</h1>
                </div>
                <div id="user-info" class="text-white text-sm font-mono"></div>
            </div>
        </header>

        <!----------------- BOTONES DE LAS PESTAÑAS ----------------> 
        <div class="bg-white shadow-sm sticky top-[56px] z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="tabs" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="registro" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Registro y Control</button>
                        <button data-tab="historico" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Reportes y Gráficos</button>
                    </nav>
                </div>
            </div>
        </div>

        <!----------------- CONTENIDO DE LAS PESTAÑAS ---------------->
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

            <!----------------- CONTENIDO DE LA TAB DE REGISTRO Y CONTROL (HISTORIAL DE LLAMADAS) ---------------->
            <main id="tab-content-registro" class="tab-content">
                <!----------------- SECCIÓN DE DASHBOARD PRINCIPAL ---------------->
                <section id="dashboard" class="mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-primary mb-2 sm:mb-0">Dashboard General</h2>
                        <div class="flex items-center space-x-4">
                            <button id="migrate-calls-btn" class="migrate-btn text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2">
                                <i class="fa-solid fa-database"></i>
                                <span>Migrar Llamadas</span>
                                <div class="info-tooltip">
                                    <i class="fa-solid fa-circle-info"></i>
                                    <span class="tooltip-text">Mover todas las llamadas de Registro y Control al Histórico</span>
                                </div>
                            </button>

                            <!-------- SELECTOR DE FUENTE DE DATOS EN DASHBOARD PRINCIPAL ---------------->
                            <label for="dashboard-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                            <select id="dashboard-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="registro">Registro y Control</option>
                                <option value="historico">Histórico</option>
                                <option value="combinado">Registro y Control + Histórico</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-primary/10 p-3 rounded-full"><i class="fa-solid fa-phone-volume text-primary text-2xl"></i></div><div><p class="text-slate-500">Total de Llamadas</p><p id="total-calls" class="text-3xl font-bold text-primary">0</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-primary/10 p-3 rounded-full"><i class="fa-solid fa-hourglass-half text-primary text-2xl"></i></div><div><p class="text-slate-500">Duración Promedio</p><p id="avg-duration" class="text-3xl font-bold text-primary">00:00</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-accent/10 p-3 rounded-full"><i class="fa-solid fa-circle-check text-accent text-2xl"></i></div><div><p class="text-slate-500">Llamadas Atendidas</p><p id="atendidas-count" class="text-3xl font-bold text-accent">0</p></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4"><div class="bg-danger/10 p-3 rounded-full"><i class="fa-solid fa-circle-xmark text-danger text-2xl"></i></div><div><p class="text-slate-500">Llamadas Pendientes</p><p id="pendientes-count" class="text-3xl font-bold text-danger">0</p></div></div>
                    </div>
                </section>

                <!----------------- CRONOMETRO ITEMS ---------------->
                <section class="bg-white p-6 rounded-xl shadow-md mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="text-center md:text-left"><h3 class="text-xl font-semibold text-slate-800">Control de Llamadas</h3><p class="text-slate-500">Inicia una nueva llamada para activar el cronómetro y el formulario.</p></div>
                    <div class="flex items-center gap-6"><div class="text-center"><p class="text-sm font-medium text-slate-500">TIEMPO DE LLAMADA ACTUAL</p><p id="timer" class="text-4xl font-bold text-primary tracking-wider">00:00:00</p></div><button id="start-call-btn" class="bg-success hover:bg-success-dark text-white font-bold py-4 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out flex items-center space-x-3"><i class="fa-solid fa-phone-alt h-6 w-6"></i><span>Iniciar Nueva Llamada</span></button></div>
                </section>
                
                <!----------------- HISTORIAL DE LLAMADAS - TABLA - LOG ---------------->
                <section id="call-log">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-primary">Historial de Llamadas</h2><div class="flex items-center space-x-2"><div class="relative w-full"><input type="text" id="filter-input-main" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"><i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i><button id="clear-filter-btn-main" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button></div><button id="download-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2"><i class="fa-solid fa-file-excel"></i><span>Descargar Excel</span></button></div></div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="main-table-header">
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fecha">Fecha <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="inicio">Inicio <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fin">Fin <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="duracion">Duración <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="area">Área <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="institucion">Institución <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="asunto">Asunto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="consulta">Consulta <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="nombre">Nombre <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="cargo">Cargo <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="correo">Correo <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="telefono">Teléfono <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="estatus">Estatus <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="atendio">Atendió <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="comentarios">Comentarios <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="calls-table-body"></tbody>
                        </table>
                        <div id="no-calls-message" class="p-6 text-center text-slate-500 hidden"><p>No hay llamadas registradas en la base de datos.</p></div>
                    </div>
                </section>
            </main>

            <!----------------- CONTENIDO DE LA TAB DE HISTÓRICO ---------------->
            <div id="tab-content-historico" class="tab-content hidden">
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-primary mb-4">Cargar Histórico desde Excel</h2>
                    <div class="flex flex-col md:flex-row items-center gap-4"><label for="historical-file-input" class="w-full md:w-auto cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 px-6 rounded-lg shadow-sm transition-all duration-200 ease-in-out text-center flex-grow"><i class="fa-solid fa-file-upload mr-2"></i><span id="file-name">Seleccionar archivo Excel (.xlsx)</span><input type="file" id="historical-file-input" class="hidden" accept=".xlsx, .xls"></label><button id="import-historical-btn" class="w-full md:w-auto bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fa-solid fa-database mr-2"></i>Importar a la Base de Datos</button></div>
                </section>

                <!----------------- HISTÓRICO DE LLAMADAS - TABLA - LOG ---------------->
                <section id="historical-log" class="mt-8">
                    <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-primary">Registro Histórico</h2><div class="flex items-center space-x-2"><div class="relative w-full"><input type="text" id="filter-input-historical" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"><i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i><button id="clear-filter-btn-historical" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button></div><button id="download-historical-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2"><i class="fa-solid fa-file-excel"></i><span>Descargar Histórico</span></button></div></div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="historical-table-header">
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fecha">Fecha <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="inicio">Inicio <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fin">Fin <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="duracion">Duración <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="area">Área <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="institucion">Institución <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="asunto">Asunto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="consulta">Consulta <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="nombre">Nombre <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="cargo">Cargo <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="correo">Correo <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="telefono">Teléfono <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="estatus">Estatus <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="atendio">Atendió <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="comentarios">Comentarios <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historical-table-body"></tbody>
                        </table>
                        <div id="no-historical-message" class="p-6 text-center text-slate-500 hidden"><p>No hay datos históricos cargados.</p></div>
                    </div>
                </section>
            </div>

            <!----------------- CONTENIDO DE LA TAB DE REPORTES ---------------->
            <div id="tab-content-reportes" class="tab-content hidden">
                <section id="reportes" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-primary">Reportes</h2>
                        <div class="flex items-center space-x-4">

                            <!----------------- GENERAR REPORTE BOTÓN ---------------->
                            <button id="generate-report-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2">
                                <i class="fa-solid fa-file-pdf"></i>
                                <span>Generar Reporte</span>
                            </button>

                            <!----------------- SELECCIÓN DE FUENTE DE DATOS ---------------->
                            <div class="flex items-center space-x-2">
                                <label for="reportes-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                                <select id="reportes-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                    <option value="registro">Registro y Control</option>
                                    <option value="historico">Histórico</option>
                                    <option value="combinado">Registro y Control + Histórico</option>
                                </select>
                                <button id="config-report-btn" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 ease-in-out ml-2">
                                    <i class="fa-solid fa-cog fa-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!----------------- GRÁFICOS PRINCIPALES ---------------->
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Estatus</h3>
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Asunto</h3>
                            <canvas id="asuntoChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Día de la Semana</h3>
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas atendidas por Servidor Público</h3>
                            <canvas id="atendioChart"></canvas>
                        </div>
                    </div>
                    
                    <!----------------- GRÁFICA DINÁMICA Y SUS VARIABLES ---------------->
                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Llamadas por</h3>
                            <select id="dynamic-chart-variable" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="area">Área</option>
                                <option value="institucion">Institución</option>
                                <option value="asunto">Asunto</option>
                                <option value="consulta">Consulta</option>
                                <option value="nombre">Nombre</option>
                                <option value="cargo">Cargo</option>
                                <option value="atendio">Atendió</option>
                            </select>
                        </div>
                        <div class="dynamic-chart-content">
                            <div class="chart-wrapper">
                                <canvas id="dynamicChart"></canvas>
                            </div>

                            <!----------------- TOTALES TABLA DE DISTRIBUCIÓN ---------------->
                            <div class="dynamic-table-container">
                                <h4 class="text-lg font-semibold text-slate-800 mb-2 text-center">Distribución por Estatus</h4>
                                <table class="dynamic-table">
                                    <thead>
                                        <tr>
                                            <th id="dynamic-table-header">Variable</th>
                                            <th>Atendida</th>
                                            <th>Pendiente</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dynamic-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!----------------- TABLA DINÁMICA INTERACTIVA---------------->
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-primary mb-4">Tabla Dinámica Interactiva</h2>
                    <p class="text-slate-500 mb-4">Selecciona variables para cruzar datos y genera gráficos dinámicos (tablas, barras, líneas, heatmaps, etc.).</p>
                    <div id="pivot-table"></div>
                </section>
            </div>
        </div>
    </div>
    
    <!----------------- MODAL NUEVA LLAMADA ---------------->
    <div id="call-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-primary">Detalles de la Llamada</h3><div class="text-right"><p class="text-sm font-medium text-slate-500">TIEMPO DE LLAMADA ACTUAL</p><p id="modal-timer" class="text-2xl font-bold text-primary tracking-wider">00:00:00</p></div></div>
            <div class="call-form-container">
                <form id="call-form" class="space-y-6" novalidate>
                    <div> 
                        <h4 class="section-title text-lg">Datos Institución</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="caller-institution">Institución</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-institution" name="institucion" required></select>
                                    <button type="button" id="edit-institution-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-area">Área o Departamento</label>
                                <div class="flex-with-buttons">
                                    <select id="call-area" name="area" required></select>
                                    <button type="button" id="edit-area-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-subject">Asunto</label>
                                <div class="flex-with-buttons">
                                    <select id="call-subject" name="asunto" required></select>
                                    <button type="button" id="edit-subject-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-query">Consulta</label>
                                <div class="flex-with-buttons">
                                    <select id="call-query" name="consulta" required></select>
                                    <button type="button" id="edit-query-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Datos Personales</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="caller-name">Nombre del Solicitante</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-name" name="nombre" required></select>
                                    <button type="button" id="edit-name-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-cargo">Cargo del Solicitante</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-cargo" name="cargo" required></select>
                                    <button type="button" id="edit-cargo-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-email">Correo Electrónico</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-email" name="correo" required></select>
                                    <button type="button" id="edit-email-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-phone">Teléfono (opcional)</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-phone" name="telefono"></select>
                                    <button type="button" id="edit-phone-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Atendió y Comentarios</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="call-atendio">Atendió</label>
                                <div class="flex-with-buttons">
                                    <select id="call-atendio" name="atendio" required></select>
                                    <button type="button" id="edit-atendio-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-comments">Comentarios</label>
                                <div class="flex-with-buttons">
                                     <select id="call-comments" name="comentarios"></select>
                                     <button type="button" id="edit-comments-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar y Finalizar Llamada</button></div>
                </form>
            </div>
        </div>
    </div>

    <!----------------- MODAL EDITAR LLAMADA ---------------->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <button id="close-edit-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <h3 class="text-2xl font-bold text-primary mb-6">Editar Llamada</h3>
            <div class="call-form-container">
                <form id="edit-form" class="space-y-6" novalidate>
                    <input type="hidden" id="edit-id">
                    <div>
                        <h4 class="section-title text-lg">Datos Institución</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-caller-institution" class="block text-sm font-medium text-gray-700">Institución</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-institution" name="institucion" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-institution-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-area" class="block text-sm font-medium text-gray-700">Área</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-area" name="area" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-area-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-subject" class="block text-sm font-medium text-gray-700">Asunto</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-subject" name="asunto" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-subject-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-query" class="block text-sm font-medium text-gray-700">Consulta</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-query" name="consulta" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-query-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Datos Personales</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-caller-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-name" name="nombre" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-name-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-cargo" name="cargo" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-cargo-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-email" class="block text-sm font-medium text-gray-700">Correo</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-email" name="correo" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-email-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-phone" class="block text-sm font-medium text-gray-700">Teléfono (opcional)</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-phone" name="telefono" class="mt-1 block w-full"></select>
                                    <button type="button" id="edit-phone-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Atendió y Comentarios</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-call-atendio" class="block text-sm font-medium text-gray-700">Atendió</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-atendio" name="atendio" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-atendio-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-comments" class="block text-sm font-medium text-gray-700">Comentarios</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-comments" name="comentarios" class="mt-1 block w-full"></select>
                                    <button type="button" id="edit-comments-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button></div>
                </form>
            </div>
        </div>
    </div>


    <!----------------- MODAL DE CONFIRMACIÓN DE ELIMINACIÓN DE LLAMADA ---------------->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center"><h3 class="text-xl font-bold text-slate-800 mb-4">Confirmar Eliminación</h3><p class="text-slate-600 mb-6">¿Estás seguro de que deseas eliminar este registro?</p><div class="flex justify-center space-x-4"><button id="cancel-delete-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-delete-btn" class="bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg">Eliminar</button></div></div>
    </div>
    
    <!----------------- MODAL DE CONFIRMACIÓN DE REEMPLAZAR HISTÓRICO ---------------->
    <div id="replace-historical-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center"><h3 class="text-xl font-bold text-primary mb-4">Reemplazar Histórico</h3><p class="text-slate-600 mb-6">¿Desea reemplazar el histórico actual?</p><div class="flex justify-center space-x-4"><button id="cancel-replace-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">No</button><button id="confirm-replace-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Sí</button></div></div>
    </div>
    
    <!----------------- MODAL DE CONFIRMACIÓN DE EDITAR OPCIÓN DE LISTA ---------------->
    <div id="edit-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Editar Opción</h3>
            <input type="text" id="edit-option-input" placeholder="Edite la opción" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-edit-option-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-edit-option-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <!----------------- MODAL DE CONFIRMACIÓN DE CONTRASEÑA  ---------------->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Verificación de Seguridad</h3>
            <p class="text-slate-600 mb-4">Esta acción requiere autenticación. Por favor, ingrese la contraseña.</p>
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-password-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-password-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Verificar</button>
            </div>
        </div>
    </div>

    <!----------------- MODAL DE GENERACIÓN DE REPORTE EJECUTIVO  ---------------->
    <div id="report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-report-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <h3 class="text-2xl font-bold text-primary mb-6">Generar Reporte Ejecutivo</h3>
            <form id="report-form" class="space-y-6">
                <div>
                    <!----------------- SELECCIÓN DE GRÁFICOS A INCLUIR ---------------->
                    <h4 class="section-title text-lg">Seleccionar gráficas a incluir</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="include-status" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-status" class="ml-2 block text-sm text-gray-700">Llamadas por Estatus</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-asunto" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-asunto" class="ml-2 block text-sm text-gray-700">Llamadas por Asunto</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-day" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-day" class="ml-2 block text-sm text-gray-700">Llamadas por Día de la Semana</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-atendio" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-atendio" class="ml-2 block text-sm text-gray-700">Llamadas por Servidor Público</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-dynamic-chart" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-dynamic-chart" class="ml-2 block text-sm text-gray-700">Llamadas por Variable Seleccionada (Gráfica)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-dynamic-table" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-dynamic-table" class="ml-2 block text-sm text-gray-700">Llamadas por Variable Seleccionada (Tabla de Datos)</label>
                        </div>
                    </div>
                </div>

                <!----------------- BOTÓN PARA GENERAR REPORTE EN PDF  ---------------->
                <div class="flex items-center justify-end pt-4">
                    <button type="button" id="generate-pdf-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Generar Reporte PDF</button>
                </div>
            </form>
        </div>
    </div>

    <!----------------- MODAL DE CONFIGURACIÓN DEL REPORTE EJECUTIVO  ---------------->
    <div id="config-report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-config-report-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-primary">Configuración de Reportes</h3>
                <div class="relative group">
                    <button type="button" class="text-primary hover:text-primary-dark focus:outline-none">
                        <i class="fa-solid fa-circle-info fa-lg"></i>
                    </button>
                    <div class="absolute hidden group-hover:block right-0 top-full mt-2 w-64 p-2 bg-white shadow-lg rounded-lg border border-gray-200 z-10 text-sm text-gray-600">
                        Seleccione un período para filtrar los reportes. Ejemplo: para ver datos del 15/04/2025, establezca la fecha de inicio 14/04/2025 y fecha de fin en 16/04/2025. 
                    </div>
                </div>
            </div>

            <!----------------- CONFIGURACIÓN DE PERIODO DE REPORTES ---------------->
            <form id="config-report-form" class="space-y-6">
                <div class="config-report-grid">
                    <div class="config-option">
                        <input type="radio" id="filter-all-data" name="data-filter" value="all" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="filter-all-data" class="block text-sm font-medium text-gray-700">Todos los datos</label>
                    </div>
                    
                    <div class="config-option">
                        <input type="radio" id="filter-by-period" name="data-filter" value="period" class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="filter-by-period" class="block text-sm font-medium text-gray-700">Seleccionar por periodo</label>
                    </div>
                    
                    <div class="form-field">
                        <label for="config-report-start-date">Fecha de inicio</label>
                        <input type="date" id="config-report-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" disabled>
                    </div>
                    
                    <div class="form-field">
                        <label for="config-report-end-date">Fecha de fin</label>
                        <input type="date" id="config-report-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" disabled>
                    </div>
                </div>

                <!----------------- CONFIGURACIÓN DE TAMAÑO DE GRÁFICAS Y SLIDER---------------->
                <div class="chart-size-control">
                    <label for="chart-size-slider" class="font-medium text-gray-700">Tamaño de gráficas:</label>
                    <input type="range" id="chart-size-slider" min="50" max="400" value="120" class="w-40">
                    <span id="chart-size-value" class="text-sm text-gray-600">120px</span>
                </div>
                <!----------------- GUARDAR CONFIGURACIÓN ---------------->
                <div class="flex items-center justify-end pt-4">
                    <button type="button" id="save-config-report-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Configuración</button>
                </div>
            </form>
        </div>
    </div>

    <!----------------- MODAL DE CONFIRMACIÓN DE MIGRACIÓN DE LLAMADAS (DE HISTORIAL A HISTÓRICO)  ---------------->
    <div id="migrate-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Migrar Llamadas</h3>
            <p class="text-slate-600 mb-6">¿Está seguro de que desea migrar todas las llamadas de Registro y Control al Histórico? Esta acción no se puede deshacer.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-migrate-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-migrate-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Migrar</button>
            </div>
        </div>
    </div>
    
    <!----------------- PIE DE PÁGINA ---------------->
    <footer class="footer-container">
        <label>Insurgentes Sur 1735, Col. Guadalupe Inn Ciudad de México., C.P 01020 - Tel. 2000 3000</label><br>
        <label>Secretaría Anticorrupción y Buen Gobierno, México - Algunos derechos reservados © 2025 </label>
    </footer>

    <div id="report-preview" class="hidden"></div>



    <script type="module">
        // =============================================
        // MÓDULO: Configuración de Firebase
        // =============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Datos del Proyecto
        const firebaseConfig = {
            apiKey: "AIzaSyBcuK6zAUnX09wEZ-hSfBP8A66kltUvBls",
            authDomain: "sicoinllamadasformulario.firebaseapp.com",
            projectId: "sicoinllamadasformulario",
            storageBucket: "sicoinllamadasformulario.firebasestorage.app",
            messagingSenderId: "831487187531",
            appId: "1:831487187531:web:3b9d4fc6e55ffb0bb38bce",
            measurementId: "G-F47JLWW4NY"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // =============================================
        // MÓDULO: Variables globales y estado de la aplicación
        // =============================================
        let timerInterval;
        let callStartTime;
        let calls = [];
        let historicalCalls = [];
        let userId;
        
        const callsCollectionRef = collection(db, "calls");
        const historicalCallsCollectionRef = collection(db, "historicalCalls");
        
        // Elementos del DOM
        const loader = document.getElementById('loader');
        const appContainer = document.getElementById('app');
        const userInfo = document.getElementById('user-info');
        const tabsContainer = document.getElementById('tabs');
        const tabContents = document.querySelectorAll('.tab-content');
        const dashboardDataSource = document.getElementById('dashboard-data-source');
        const totalCallsElem = document.getElementById('total-calls');
        const avgDurationElem = document.getElementById('avg-duration');
        const atendidasCountElem = document.getElementById('atendidas-count');
        const pendientesCountElem = document.getElementById('pendientes-count');
        const timerElem = document.getElementById('timer');
        const startCallBtn = document.getElementById('start-call-btn');
        const downloadExcelBtn = document.getElementById('download-excel-btn');
        const callLogTableBody = document.getElementById('calls-table-body');
        const noCallsMessage = document.getElementById('no-calls-message');
        const historicalTableBody = document.getElementById('historical-table-body');
        const noHistoricalMessage = document.getElementById('no-historical-message');
        const historicalFileInput = document.getElementById('historical-file-input');
        const historicalFileName = document.getElementById('file-name');
        const importHistoricalBtn = document.getElementById('import-historical-btn');
        const reportesDataSource = document.getElementById('reportes-data-source');
        const statusChartCanvas = document.getElementById('statusChart');
        const asuntoChartCanvas = document.getElementById('asuntoChart');
        const dayOfWeekChartCanvas = document.getElementById('dayOfWeekChart');
        const atendioChartCanvas = document.getElementById('atendioChart');
        const dynamicChartCanvas = document.getElementById('dynamicChart');
        const dynamicChartVariable = document.getElementById('dynamic-chart-variable');
        
        //Alternar visualización de etiquetas Reporte dinámico
        const toggleLabelsBtn = document.createElement('button');
        toggleLabelsBtn.id = 'toggle-labels-btn';
        toggleLabelsBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded ml-2';
        toggleLabelsBtn.innerHTML = '<i class="fa-solid fa-tag"></i>';
        toggleLabelsBtn.title = 'Alternar visualización de etiquetas';

        // Insertar el botón después del select
        dynamicChartVariable.parentNode.insertBefore(toggleLabelsBtn, dynamicChartVariable.nextSibling);

        // Variable para controlar el estado de las etiquetas
        let showChartLabels = true;

        // Event listener para el botón
        toggleLabelsBtn.addEventListener('click', () => {
            showChartLabels = !showChartLabels;
            toggleLabelsBtn.classList.toggle('bg-primary', showChartLabels);
            toggleLabelsBtn.classList.toggle('text-white', showChartLabels);
            updateDynamicChart();
        });


        const dynamicTableBody = document.getElementById('dynamic-table-body');
        const dynamicTableHeader = document.getElementById('dynamic-table-header');
        let statusChart, asuntoChart, dayOfWeekChart, atendioChart, dynamicChart;
        const callModal = document.getElementById('call-modal');
        const callForm = document.getElementById('call-form');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const modalTimerElem = document.getElementById('modal-timer');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const pivotTableContainer = document.getElementById('pivot-table');
        const replaceHistoricalModal = document.getElementById('replace-historical-modal');
        const cancelReplaceBtn = document.getElementById('cancel-replace-btn');
        const confirmReplaceBtn = document.getElementById('confirm-replace-btn');
        
        const editOptionModal = document.getElementById('edit-option-modal');
        const editOptionInput = document.getElementById('edit-option-input');
        const cancelEditOptionBtn = document.getElementById('cancel-edit-option-btn');
        const confirmEditOptionBtn = document.getElementById('confirm-edit-option-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const cancelPasswordBtn = document.getElementById('cancel-password-btn');
        const confirmPasswordBtn = document.getElementById('confirm-password-btn');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const configReportBtn = document.getElementById('config-report-btn');
        const reportModal = document.getElementById('report-modal');
        const closeReportModalBtn = document.getElementById('close-report-modal-btn');
        const reportForm = document.getElementById('report-form');
        const generatePdfBtn = document.getElementById('generate-pdf-btn');
        const configReportModal = document.getElementById('config-report-modal');
        const closeConfigReportModalBtn = document.getElementById('close-config-report-modal-btn');
        const configReportForm = document.getElementById('config-report-form');
        const saveConfigReportBtn = document.getElementById('save-config-report-btn');
        const filterAllDataRadio = document.getElementById('filter-all-data');
        const filterByPeriodRadio = document.getElementById('filter-by-period');
        const configReportStartDate = document.getElementById('config-report-start-date');
        const configReportEndDate = document.getElementById('config-report-end-date');
        const reportPreview = document.getElementById('report-preview');
        const chartSizeSlider = document.getElementById('chart-size-slider');
        const chartSizeValue = document.getElementById('chart-size-value');
        const migrateCallsBtn = document.getElementById('migrate-calls-btn');
        const migrateModal = document.getElementById('migrate-modal');
        const cancelMigrateBtn = document.getElementById('cancel-migrate-btn');
        const confirmMigrateBtn = document.getElementById('confirm-migrate-btn');
        const includeDynamicChartCheckbox = document.getElementById('include-dynamic-chart');
        const includeDynamicTableCheckbox = document.getElementById('include-dynamic-table');
        
        let currentEditIsHistorical = false;
        
        let fieldOptions = {
            areas: [],
            asuntos: [],
            consultas: [],
            nombres: [],
            cargos: [],
            correos: [],
            telefonos: [],
            comentarios: [],
            instituciones: [],
            atendioUsers: []
        };

        let currentEditingField = null;
        let currentEditingValue = null;
        let pendingAction = null;
        let reportFilter = {
            type: 'all', // 'all' o 'period'
            startDate: null,
            endDate: null
        };

        let activeFilters = {
            main: {},
            historical: {}
        };
        let currentFilterDropdown = null;

        // =============================================
        // MÓDULO: Utilidades
        // =============================================
        
        //Mostrar app
        function showApp() {
            loader.classList.add('hidden');
            appContainer.classList.remove('hidden');
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-gray-500' };
            alertContainer.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 z-[60] ${colors[type]}`;
            alertContainer.textContent = message;
            document.body.appendChild(alertContainer);
            setTimeout(() => { alertContainer.remove(); }, 3000);
        }

        //Dar formato a Duración
                function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        //Dar formato a.m. p.m. a las Horas de Inicio y Fin
        function formatTimeWithAmPm(timeString) {
            if (!timeString || typeof timeString !== 'string') return 'N/A';
            if (timeString.toLowerCase().includes('a. m.') || timeString.toLowerCase().includes('p. m.')) {
                return timeString;
            }
            try {
                // Asegurar que tenga formato HH:MM:SS
                const [hours, minutes, seconds = '00'] = timeString.split(':');
                let h = parseInt(hours, 10);
                const m = minutes.padStart(2, '0');
                const s = seconds.padStart(2, '0');
                
                const period = h >= 12 ? 'p. m.' : 'a. m.';
                h = h % 12 || 12; // Convertir a 12h
                
                return `${h.toString().padStart(2, '0')}:${m}:${s} ${period}`;
            } catch (e) {
                return timeString; // fallback si no parsea
            }
        }

        //Abrir modal
        function openModal(modal) {
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
        }

        //Cerrar modal
        function closeModal(modal) {
            modal.classList.remove('modal-enter');
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // Función auxiliar para esperar a que un gráfico se renderice completamente
        function waitForChartRender(canvasElement) {
            return new Promise(resolve => {
                if (!canvasElement) return resolve();
                
                const checkRender = () => {
                    if (canvasElement.width > 0 && canvasElement.height > 0) {
                        resolve();
                    } else {
                        setTimeout(checkRender, 100);
                    }
                };
                
                checkRender();
            });
        }

        // =============================================
        // MÓDULO: Interfaz de usuario
        // =============================================
        
        //Configuración de Pestañas
        function setupTabs() {
            tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
                    if (tabName === 'reportes') {
                        setTimeout(updateCharts, 50); // Delay to ensure container is visible
                    }
                }
            });
        }

        //Renderizar tablas
        function renderTable(tableBody, data, isHistorical = false) {
            const noDataMessage = isHistorical ? noHistoricalMessage : noCallsMessage;
            tableBody.innerHTML = '';
            noDataMessage.classList.toggle('hidden', data.length > 0);

            const headers = ['no', 'fecha', 'inicio', 'fin', 'duracion', 'area', 'institucion', 'asunto', 'consulta', 'nombre', 'cargo', 'correo', 'telefono', 'estatus', 'atendio', 'comentarios'];

            data.forEach((call, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                
                let cells = headers.map(header => {
                    let content = '';
                    if (header === 'no') content = index + 1;
                    else if (header === 'duracion') content = formatDuration(call.duracion);
                    else if (header === 'estatus') {
                        content = `<button data-id="${call.id}" data-is-historical="${isHistorical}" class="status-button status-${call.estatus === 'Atendida' ? 'atendida' : 'pendiente'} toggle-status-btn">${call.estatus || 'Pendiente'}</button>`;
                    } else if (header === 'inicio' || header === 'fin') {
                        content = formatTimeWithAmPm(call[header]);
                    } else {
                        content = call[header] || 'N/A';
                    }
                    return `<td class="py-4 px-6">${content}</td>`;
                }).join('');

                const actionsCell = `<td class="py-4 px-6 flex space-x-2">
                        <button data-id="${call.id}" data-is-historical="${isHistorical}" class="edit-btn text-blue-500 hover:text-blue-700"><i class="fa-solid fa-edit"></i></button>
                        <button data-id="${call.id}" data-is-historical="${isHistorical}" class="delete-btn text-red-500 hover:text-red-700"><i class="fa-solid fa-trash-alt"></i></button>
                    </td>`;
                
                row.innerHTML = cells + actionsCell;
                tableBody.appendChild(row);
            });
        }

        function applyAllFilters(data, filterKey) {
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = activeFilters[filterKey];

            return data.filter(item => {
                // 1. Check search box filter
                const matchesSearch = searchText === '' || Object.values(item).some(value => 
                    String(value).toLowerCase().includes(searchText)
                );
                if (!matchesSearch) return false;

                // 2. Check column filters
                for (const col in columnFilters) {
                    if (columnFilters[col].length > 0) {
                        let itemValue = item[col] || 'N/A';
                        if (col === 'duracion') itemValue = formatDuration(item[col]);
                        if (col === 'inicio' || col === 'fin') itemValue = formatTimeWithAmPm(item[col]);

                        if (!columnFilters[col].includes(itemValue)) {
                            return false;
                        }
                    }
                }
                return true;
            });
        }

        function setupColumnFilters(headerId, dataProvider, renderFunc, filterKey) {
            const headerRow = document.getElementById(headerId);
            headerRow.addEventListener('click', e => {
                const header = e.target.closest('.filterable-header');
                if (!header) return;

                if (currentFilterDropdown) {
                    currentFilterDropdown.remove();
                    currentFilterDropdown = null;
                }

                const filterBy = header.dataset.filterBy;
                const allData = dataProvider();
                const uniqueValues = [...new Set(allData.map(item => {
                    if (filterBy === 'duracion') return formatDuration(item[filterBy]);
                    if (filterBy === 'inicio' || filterBy === 'fin') return formatTimeWithAmPm(item[filterBy]);
                    return item[filterBy] || 'N/A';
                }))].sort((a, b) => a.localeCompare(b, 'es', { numeric: true }));

                const dropdown = document.createElement('div');
                dropdown.className = 'filter-dropdown p-2 space-y-1';
                
                const activeColumnFilters = activeFilters[filterKey][filterBy] || [];

                dropdown.innerHTML = `
                    <div class="p-1"><button class="clear-filter-btn text-blue-500 hover:underline text-xs" data-filter-by="${filterBy}">Limpiar filtro</button></div>
                    <div class="border-t my-1"></div>
                    ${uniqueValues.map(value => `
                        <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded cursor-pointer">
                            <input type="checkbox" class="filter-checkbox" value="${value}" ${activeColumnFilters.includes(value) ? 'checked' : ''}>
                            <span class="text-sm text-gray-700">${value}</span>
                        </label>
                    `).join('')}
                `;

                document.body.appendChild(dropdown);
                const rect = header.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom + window.scrollY}px`;
                dropdown.style.left = `${rect.left + window.scrollX}px`;
                currentFilterDropdown = dropdown;

                dropdown.addEventListener('change', e => {
                    if (e.target.classList.contains('filter-checkbox')) {
                        const checkedValues = Array.from(dropdown.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
                        activeFilters[filterKey][filterBy] = checkedValues;
                        header.classList.toggle('active', checkedValues.length > 0);
                        const filteredData = applyAllFilters(dataProvider(), filterKey);
                        renderFunc(document.getElementById(filterKey === 'main' ? 'calls-table-body' : 'historical-table-body'), filteredData, filterKey === 'historical');
                    }
                });

                dropdown.querySelector('.clear-filter-btn').addEventListener('click', () => {
                    activeFilters[filterKey][filterBy] = [];
                    header.classList.remove('active');
                    const filteredData = applyAllFilters(dataProvider(), filterKey);
                    renderFunc(document.getElementById(filterKey === 'main' ? 'calls-table-body' : 'historical-table-body'), filteredData, filterKey === 'historical');
                    if (currentFilterDropdown) currentFilterDropdown.remove();
                });
            });

            document.addEventListener('click', (e) => {
                if (currentFilterDropdown && !currentFilterDropdown.contains(e.target) && !e.target.closest('.filterable-header')) {
                    currentFilterDropdown.remove();
                    currentFilterDropdown = null;
                }
            }, true);
        }
        
        function setupFiltering(inputId, dataProvider, renderFunc, isHistorical = false) {
            const filterInput = document.getElementById(inputId);
            const filterKey = isHistorical ? 'historical' : 'main';
            const clearFilterBtn = document.getElementById(`clear-filter-btn-${filterKey}`);
            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                clearFilterBtn.classList.toggle('hidden', !filterText);
                const filteredData = applyAllFilters(dataProvider(), filterKey);
                renderFunc(document.getElementById(isHistorical ? 'historical-table-body' : 'calls-table-body'), filteredData, isHistorical);
            });
            clearFilterBtn.addEventListener('click', () => {
                filterInput.value = ''; filterInput.dispatchEvent(new Event('input'));
            });
        }


        //ordenar y renderizar tabla
        function sortAndRenderTable(tableBody, data, isHistorical) {
            const filterKey = isHistorical ? 'historical' : 'main';
            const filteredData = applyAllFilters(data, filterKey);
            renderTable(tableBody, filteredData, isHistorical);
        }


        //Actualizart el dashboard principal
        function updateDashboard() {
            const source = dashboardDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            const totalCalls = data.length;
            const atendidas = data.filter(c => c.estatus === 'Atendida').length;
            const pendientes = totalCalls - atendidas;

            // Convertir duraciones a número y sumarlas
            const totalDuration = data.reduce((sum, c) => sum + (Number(c.duracion) || 0), 0);
              
            // Promedio redondeado a segundos enteros
            const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;
            
            // Actualizar UI    
            totalCallsElem.textContent = totalCalls;
            avgDurationElem.textContent = formatDuration(avgDuration);
            atendidasCountElem.textContent = atendidas;
            pendientesCountElem.textContent = pendientes;
        }

        // =============================================
        // MÓDULO: Gestión de llamadas
        // =============================================
        
        //Empieza a contar tiempo de llamada
        function startTimer() {
            startCallBtn.dataset.state = 'active';
            startCallBtn.innerHTML = `<i class="fa-solid fa-stopwatch h-6 w-6"></i><span>Finalizar Llamada</span>`;
            startCallBtn.classList.replace('bg-success', 'bg-danger');
            startCallBtn.classList.replace('hover:bg-success-dark', 'hover:bg-danger-dark');
            
            callForm.reset();
            // Reset all select2 fields
            $('#call-form select').val(null).trigger('change');
            openModal(callModal);

            callStartTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const formattedTime = formatDuration(elapsed);
                timerElem.textContent = formattedTime;
                modalTimerElem.textContent = formattedTime;
            }, 1000);
        }
        
        //Detiene el contador de tiempo de llamada
        function stopTimer(shouldSave = true) {
            clearInterval(timerInterval);
            if (shouldSave) {
                const endTime = new Date();
                const duration = Math.floor((endTime - callStartTime) / 1000);
                const formData = new FormData(callForm);
                const callData = Object.fromEntries(formData.entries());
                
                callData.fecha = new Date(callStartTime).toLocaleDateString('es-ES');
                callData.inicio = new Date(callStartTime).toLocaleTimeString('es-ES', { hour12: false });
                callData.fin = endTime.toLocaleTimeString('es-ES', { hour12: false });
                callData.duracion = duration;
                callData.estatus = 'Atendida'; // Se asume atendida al guardar
                saveCall(callData);
            }
            
            //Inicio de llamada
            startCallBtn.dataset.state = 'inactive';
            startCallBtn.innerHTML = `<i class="fa-solid fa-phone-alt h-6 w-6"></i><span>Iniciar Nueva Llamada</span>`;
            startCallBtn.classList.replace('bg-danger', 'bg-success');
            startCallBtn.classList.replace('hover:bg-danger-dark', 'hover:bg-success-dark');
            resetTimer();
        }

        //Resetear contados
        function resetTimer() {
            timerElem.textContent = '00:00:00';
            modalTimerElem.textContent = '00:00:00';
        }
        
        //Guardar llamada
        async function saveCall(callData) {
            try {
                await addDoc(callsCollectionRef, { ...callData, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                showAlert("Llamada guardada con éxito!", "success");
            } catch (error) {
                console.error("Error al guardar la llamada:", error);
                showAlert(`Error al guardar: ${error.message}`, "error");
                
                // Intentar guardar en localStorage como respaldo
                try {
                    const backupCalls = JSON.parse(localStorage.getItem('backupCalls') || '[]');
                    backupCalls.push({ ...callData, id: Date.now().toString() });
                    localStorage.setItem('backupCalls', JSON.stringify(backupCalls));
                    showAlert("Datos guardados localmente como respaldo", "warning");
                } catch (backupError) {
                    console.error("Error al guardar respaldo:", backupError);
                }
            }
        }

        // Actualizar llamada - VERSIÓN CORREGIDA
        async function updateCall(id, updateData, isHistorical) {
            if (!id) {
                console.error("ID no válido para actualización");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalCallsCollectionRef : callsCollectionRef;
                const callDocRef = doc(db, collectionRef.path, id);
                
                // Verificar si el documento existe antes de intentar actualizarlo
                const docSnapshot = await getDoc(callDocRef);
                if (!docSnapshot.exists()) {
                    showAlert("El registro que intentas actualizar no existe", "error");
                    return;
                }
                
                await updateDoc(callDocRef, { ...updateData, updatedAt: serverTimestamp() });
                showAlert("Llamada actualizada con éxito!", "success");
            } catch (error) {
                console.error("Error al actualizar la llamada:", error);
                showAlert(`Error al actualizar: ${error.message}`, "error");
            }
        }


        // Eliminar llamadaa
        async function deleteCall(id, isHistorical) {
            if (!id) {
                console.error("ID no válido para eliminación");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalCallsCollectionRef : callsCollectionRef;
                const callDocRef = doc(db, collectionRef.path, id);
                
                // Verificar si el documento existe antes de intentar eliminarlo
                const docSnapshot = await getDoc(callDocRef);
                if (!docSnapshot.exists()) {
                    showAlert("El registro que intentas eliminar no existe", "error");
                    return;
                }
                
                await deleteDoc(callDocRef);
                showAlert("Llamada eliminada con éxito!", "success");
            } catch (error) {
                console.error("Error al eliminar la llamada:", error);
                showAlert(`Error al eliminar: ${error.message}`, "error");
            }
        }


        // Reemplazar la función handleEditClick con esta versión robusta
        function handleEditClick(button) {
            requirePassword(() => {
                const callId = button.getAttribute('data-id');
                const isHistorical = button.getAttribute('data-is-historical') === 'true';

                if (!callId) {
                    console.error("ID de llamada no encontrado para edición");
                    return;
                }

                currentEditIsHistorical = isHistorical;
                const allData = isHistorical ? (Array.isArray(historicalCalls) ? historicalCalls : []) : (Array.isArray(calls) ? calls : []);
                const callToEdit = allData.find(call => String(call.id) === String(callId));

                if (!callToEdit) {
                    showAlert("No se pudo encontrar la llamada para editar", "error");
                    return;
                }

                document.getElementById('edit-id').value = callId;

                // Helper local: asegurar y seleccionar opción en Select2
                function ensureSelectHasAndSelect($sel, value, text) {
                    if (!$sel || !$sel.length) return;
                    // Si las opciones usan id/text como objetos select2, permitir ambas formas:
                    const hasValue = $sel.find(`option[value="${value}"]`).length > 0;
                    if (!hasValue) {
                        // Crear opción nueva y marcarla seleccionada
                        const opt = new Option(text || value, value, true, true);
                        $sel.append(opt);
                        if ($sel.data('select2')) {
                            $sel.trigger('change.select2');
                        }
                    } else {
                        $sel.val(value).trigger('change.select2');
                    }
                }

                // Helper: normalizar y construir lista de nombres para la institución (sin depender de otros handlers)
                function buildNamesForInstitution(allData, institution) {
                    if (!Array.isArray(allData)) return [];
                    const names = [...new Set(
                        allData.filter(c => c && c.institucion === institution)
                            .map(c => c.nombre)
                            .filter(Boolean)
                    )].sort();
                    return names;
                }

                // 1) Setear institución, área, asunto, etc. (esto puede disparar handlers, pero no confiamos en ellos para poblar nombres)
                $('#edit-caller-institution').val(callToEdit.institucion || '').trigger('change.select2');
                $('#edit-call-area').val(callToEdit.area || '').trigger('change.select2');
                $('#edit-call-subject').val(callToEdit.asunto || '').trigger('change.select2');
                $('#edit-call-query').val(callToEdit.consulta || '').trigger('change.select2');

                // 2) Poblar directamente las opciones del select "nombre" basadas en la institución (no depender del handler global)
                const namesForInst = buildNamesForInstitution([... (Array.isArray(calls)?calls:[]), ...(Array.isArray(historicalCalls)?historicalCalls:[])], callToEdit.institucion || '');

                const $editName = $('#edit-caller-name');

                // Normalizar formato para select2: {id, text}
                const optionsData = namesForInst.map(n => ({ id: n, text: n }));

                // Re-inicializar / actualizar Select2 para el select de nombres con los datos correctos
                if ($editName.length) {
                    if ($editName.data('select2')) {
                        $editName.empty().select2({
                            data: optionsData,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });
                    } else {
                        $editName.select2({
                            data: optionsData,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });
                    }
                }

                // 3) Seleccionar el nombre correcto robustamente:
                //    Si las opciones usan id diferente al nombre (caso raro), buscar coincidencia por texto y usar su id.
                const desiredName = callToEdit.nombre || '';
                let selected = false;
                if ($editName.length && $editName.data('select2')) {
                    const sdata = $editName.select2('data') || [];
                    // buscar coincidencia por texto
                    const byText = sdata.find(d => (d.text || '') === desiredName);
                    if (byText) {
                        $editName.val(byText.id).trigger('change.select2');
                        selected = true;
                    }
                }

                // Si no se seleccionó arriba (o select2 no estaba en modo objeto), asegurar y seleccionar por valor=nombre
                if (!selected) {
                    ensureSelectHasAndSelect($editName, desiredName, desiredName);
                }

                // 4) Rellenar campos restantes
                $('#edit-caller-cargo').val(callToEdit.cargo || '').trigger('change.select2');
                $('#edit-caller-email').val(callToEdit.correo || '').trigger('change.select2');
                $('#edit-caller-phone').val(callToEdit.telefono || '').trigger('change.select2');
                $('#edit-call-comments').val(callToEdit.comentarios || '').trigger('change.select2');
                $('#edit-call-atendio').val(callToEdit.atendio || '').trigger('change.select2');

                // 5) Abrir modal después de todo (para evitar race conditions visuales)
                openModal(editModal);
            });
        }


        closeEditModalBtn.addEventListener('click', () => closeModal(editModal));

        // Manejar cambio de estado
        async function handleStatusToggle(button) {
            try {
                const callId = button.getAttribute('data-id');
                const isHistorical = button.getAttribute('data-is-historical') === 'true';
                
                if (!callId) {
                    console.error("ID de llamada no encontrado");
                    return;
                }
                
                const currentStatus = button.textContent.trim();
                const newStatus = currentStatus === 'Atendida' ? 'Pendiente' : 'Atendida';
                
                await updateCall(callId, { estatus: newStatus }, isHistorical);
            } catch (error) {
                console.error("Error en handleStatusToggle:", error);
            }
        }


        // Manejar clic en eliminar
        function handleDeleteClick(button) {
            requirePassword(() => {
                callToDeleteId = button.getAttribute('data-id');
                callToDeleteIsHistorical = button.getAttribute('data-is-historical') === 'true';
                
                if (!callToDeleteId) {
                    console.error("ID de llamada no encontrado para eliminación");
                    return;
                }
                
                openModal(confirmModal);
            });
        }


        // =============================================
        // MÓDULO: Gestión de datos históricos
        // =============================================
        
        //Eliminar toto el históroco
        async function deleteAllHistorical() {
            const batch = writeBatch(db);
            historicalCalls.forEach(call => {
                const ref = doc(historicalCallsCollectionRef, call.id);
                batch.delete(ref);
            });
            await batch.commit(); 
        }


        // Mejorar importación de histórico con manejo correcto de fechas y duraciones
        async function importHistoricalData(data) {
            try {
                const batch = writeBatch(db);
                data.forEach(item => {
                    const docRef = doc(historicalCallsCollectionRef);
                    batch.set(docRef, { ...item, importedAt: serverTimestamp() });
                });
                await batch.commit();
                showAlert(`Se han importado ${data.length} registros históricos.`, "success");
                
                // Forzar actualización de opciones y render
                updateDynamicSelectOptions();
                renderTable(historicalTableBody, historicalCalls, true);


            } catch (error) {
                console.error("Error al importar datos históricos:", error);
                showAlert(`Error al importar: ${error.message}`, "error");
            }
        }

        // =============================================
        // MÓDULO: Gestión de opciones dinámicas y autocompletado (Lista de Instituciones Homologada)
        // =============================================
   
        /**
         * @const {string[]} catalogoInstitucionesHomologado
         * Catálogo predefinido de instituciones que sirve como base para las opciones del selector.
         * Esta lista asegura que todas las instituciones oficiales estén siempre disponibles.
         * En futuras versiones, podría cargarse desde una colección de Firestore para gestión remota.
         */

        const catalogoInstitucionesHomologado = [
            "AGN - Archivo General de la Nación",
            "CEPROPIE - Centro de Producción de Programas Informativos y Especiales",
            "CONAVIM - Comisión Nacional para Prevenir y Erradicar la Violencia Contra las Mujeres",
            "CONAPRED - Consejo Nacional para Prevenir la Discriminación",
            "COMAR - Coordinación General de la Comisión Mexicana de Ayuda a Refugiados",
            "INM - Instituto Nacional de Migración",
            "INAFED - Instituto Nacional para el Federalismo y el Desarrollo Municipal",
            "SEGOB - Secretaría de Gobernación",
            "CONAPO - Secretaría General del Consejo Nacional de Población",
            "SIPINNA - Sistema Nacional de Protección Integral de Niñas, Niños y Adolescentes",
            "TGM - Talleres Gráficos de México",
            "AMEXCID - Agencia Mexicana de Cooperación Internacional para el Desarrollo",
            "IME - Instituto de Mexicanas y Mexicanos en el Exterior",
            "IMR - Instituto Matías Romero",
            "SRE  - Secretaría de Relaciones Exteriores",
            "AGROASEMEX - Agroasemex, S.A.",
            "BANBI - Banco del Bienestar, S.N.C., I.B.D.",
            "BANJERCITO - Banco Nacional del Ejército, Fuerza Aérea y Armada, S.N.C.",
            "CMM - Casa de Moneda de México",
            "CNBV - Comisión Nacional Bancaria y de Valores",
            "CNSF - Comisión Nacional de Seguros y Fianzas",
            "CONSAR - Comisión Nacional del Sistema de Ahorro para el Retiro",
            "CONDUSEF - Comisión Nacional para la Protección y Defensa de los Usuarios de Servicios Financieros",
            "FOCIR - Fondo de Capitalización e Inversión del Sector Rural",
            "INDAABIN - Instituto de Administración y Avalúos de Bienes Nacionales",
            "INDEP - Instituto para Devolver al Pueblo lo Robado",
            "IPAB - Instituto para la Protección al Ahorro Bancario",
            "LOTENAL - Lotería Nacional",
            "LOTENAL - Lotería Nacional Para la Asistencia Pública",
            "SHCP - Secretaría de Hacienda y Crédito Público",
            "SAT - Servicio de Administración Tributaria",
            "ISSFAM - Instituto de Seguridad Social para las Fuerzas Armadas Mexicanas",
            "DEFENSA - Secretaría de la Defensa Nacional",
            "COLPOS - Colegio de Postgraduados",
            "CSAEGRO - Colegio Superior Agropecuario del Estado de Guerrero",
            "CONAPESCA - Comisión Nacional de Acuacultura y Pesca",
            "CONAZA - Comisión Nacional de las Zonas Áridas",
            "CONADESUCA - Comité Nacional para el Desarrollo Sustentable de la Caña de Azúcar",
            "DICONSA - Diconsa, S.A de C.V.",
            "FIRCO - Fideicomiso de Riesgo Compartido",
            "INIFAP - Instituto Nacional de Investigaciones Forestales, Agrícolas y Pecuarias",
            "INCARURAL - Instituto Nacional para el Desarrollo de Capacidades del Sector Rural, A.C.",
            "LICONSA - Liconsa, S.A. de C.V.",
            "PRONABIVE - Productora Nacional de Biológicos Veterinarios",
            "AGRICULTURA - Secretaría de Agricultura y Desarrollo Rural",
            "SIAP - Servicio de Información Agroalimentaria y Pesquera",
            "SNICS - Servicio Nacional de Inspección y Certificación de Semillas",
            "SENASICA - Servicio Nacional de Sanidad, Inocuidad y Calidad Agroalimentaria",
            "ASA - Aeropuertos y Servicios Auxiliares",
            "AEM - Agencia Espacial Mexicana",
            "CAPUFE - Caminos y Puentes Federales de Ingresos y Servicios Conexos",
            "FINABIEN - Financiera para el Bienestar",
            "GACM - Grupo Aeroportuario de la Ciudad de México, S.A. de C.V.",
            "IMT - Instituto Mexicano del Transporte",
            "SICT - Secretaría de Infraestructura, Comunicaciones y Transportes",
            "SEPOMEX - Servicio Postal Mexicano",
            "SENEAM - Servicios a la Navegación en el Espacio Aéreo Mexicano",
            "CENAM - Centro Nacional de Metrología",
            "CONADIC - Comisión Nacional de Salud Mental y Adicciones",
            "CONAMER - Comisión Nacional de Mejora Regulatoria",
            "EXPOSAL - Exportadora de Sal, S.A. de C.V.",
            "FIFOMI - Fideicomiso de Fomento Minero",
            "IMPI - Instituto Mexicano de la Propiedad Industrial",
            "INDESOL - Instituto Nacional de Desarrollo Social",
            "INADEM - Instituto Nacional del Emprendedor",
            "PROFECO - Procuraduría Federal del Consumidor",
            "SE - Secretaría de Economía",
            "SCCPRI - Secretaría Técnica de la Comisión Calificadora de Publicaciones y Revistas Ilustradas",
            "SGM - Servicio Geológico Mexicano",
            "AEFCM - Autoridad Educativa Federal en la Ciudad de México",
            "CETI - Centro de Enseñanza Técnica Industrial",
            "CINVESTAV - Centro de Investigación y de Estudios Avanzados del Instituto Politécnico Nacional",
            "CRAE - Centro Regional de Alta Especialidad de Chiapas",
            "COLBACH - Colegio de Bachilleres",
            "CONALEP - Colegio Nacional de Educación Profesional Técnica",
            "CAAD - Comisión de Apelación y Arbitraje del Deporte",
            "COFAA - Comisión de Operación y Fomento de Actividades Académicas del Instituto Politécnico Nacional",
            "CONADE - Comisión Nacional de Cultura Física y Deporte",
            "CONALITEG - Comisión Nacional de Libros de Texto Gratuitos",
            "CONAFE - Consejo Nacional de Fomento Educativo",
            "PRENDE - Coordinación General @prende.mx",
            "CNBBBJ - Coordinación Nacional de Becas para el Bienestar Benito Juárez",
            "CONOCER - Fideicomiso de los Sistemas Normalizados de Competencia Laboral y de Certificación de Competencia Laboral",
            "FND - Financiera Nacional de Desarrollo Agropecuario, Rural, Forestal y Pesquero",
            "FCE - Fondo de Cultura Económica",
            "HRAEI - Hospital Regional de Alta Especialidad de Ixtapaluca",
            "HRAEPY - Hospital Regional de Alta Especialidad de la Península de Yucatán",
            "HRAEO - Hospital Regional de Alta Especialidad de Oaxaca",
            "HRAEB - Hospital Regional de Alta Especialidad del Bajío",
            "IEPSA - Impresora y Encuadernadora Progreso, S.A. de C.V.",
            "INSABI - Instituto de Salud para el Bienestar",
            "IMER - Instituto Mexicano de la Radio",
            "INIFED - Instituto Nacional de la Infraestructura Física Educativa",
            "INEA - Instituto Nacional para la Educación de los Adultos",
            "IPN - Instituto Politécnico Nacional",
            "NOTIMEX - Notimex, Agencia de Noticias del Estado Mexicano",
            "POI-IPN - Patronato de Obras e Instalaciones del Instituto Politécnico Nacional",
            "SEP - Secretaría de Educación Pública",
            "TecNM - Tecnológico Nacional de México",
            "USICAMM - Unidad del Sistema para la Carrera de las Maestras y los Maestros",
            "UNADM - Universidad Abierta y a Distancia de México",
            "UPN - Universidad Pedagógica Nacional",
            "APBP - Administración del Patrimonio de la Beneficencia Pública",
            "CNEGSR - Centro Nacional de Equidad de Género y Salud Reproductiva",
            "CENETEC - Centro Nacional de Excelencia Tecnológica en Salud",
            "CENAPRECE - Centro Nacional de Programas Preventivos y Control de Enfermedades",
            "CNTS - Centro Nacional de la Transfusión Sanguínea",
            "CENATRA - Centro Nacional de Trasplantes",
            "CENSIDA - Centro Nacional para la Prevención y el Control del VIH/SIDA",
            "CENSIA - Centro Nacional para la Salud de la Infancia y la Adolescencia",
            "CIJ - Centros de Integración Juvenil, A.C.",
            "COFEPRIS - Comisión Federal para la Protección contra Riesgos Sanitarios",
            "CONAMED - Comisión Nacional de Arbitraje Médico",
            "CNB - Comisión Nacional de Bioética",
            "COMESA - Compañía Mexicana de Exploraciones, S.A. de C.V",
            "CPTM - Consejo de Promoción Turística de México, S.A. de C.V.",
            "HGM - Hospital General de México \"Dr. Eduardo Liceaga\"",
            "GEA - Hospital General \"Dr. Manuel Gea González\"",
            "HIM - Hospital infantil de México Federico Gómez",
            "HJM - Hospital Juárez de México",
            "HRAEV - Hospital Regional de Alta Especialidad de Ciudad Victoria \"Bicentenario 2010\"",
            "INCAN - Instituto Nacional de Cancerología",
            "INCAR - Instituto Nacional de Cardiología Ignacio Chávez",
            "INCMNSZ - Instituto Nacional de Ciencias Médicas y Nutrición Salvador Zubirán",
            "INER - Instituto Nacional de Enfermedades Respiratorias Ismael Cosío Villegas",
            "GERIATRIA - Instituto Nacional de Geriatría",
            "INMEGEN - Instituto Nacional de Medicina Genómica",
            "INNN - Instituto Nacional de Neurología y Neurocirugía Manuel Velasco Suárez",
            "INP - Instituto Nacional de Pediatría",
            "INPER - Instituto Nacional de Perinatología Isidro Espinosa de los Reyes",
            "INPRFM - Instituto Nacional de Psiquiatría Ramón de la Fuente Muñiz",
            "INR - Instituto Nacional de Rehabilitación Luis Guillermo Ibarra Ibarra",
            "INSP - Instituto Nacional de Salud Pública",
            "BIRMEX - Laboratorios de Biológicos y Reactivos de México, S.A. de C.V.",
            "SALUD - Secretaría de Salud",
            "SAP - Servicios de Atención Psiquiátrica",
            "DIF - Sistema Nacional para el Desarrollo Integral de la Familia",
            "ASIPONA ALTAMIRA - Administración del Sistema Portuario Nacional Altamira, S.A. de C.V.",
            "ASIPONA COATZACOALCOS - Administración del Sistema Portuario Nacional Coatzacoalcos, S.A. de C.V.",
            "ASIPONA DOS BOCAS - Administración del Sistema Portuario Nacional Dos Bocas, S.A. de C.V.",
            "ASIPONA ENSENADA - Administración del Sistema Portuario Nacional Ensenada, S.A. de C.V.",
            "ASIPONA GUAYMAS - Administración del Sistema Portuario Nacional Guaymas, S.A. de C.V.",
            "ASIPONA LÁZARO CARDENAS - Administración del Sistema Portuario Nacional Lázaro Cárdenas, S.A. de C.V.",
            "ASIPONA MANZANILLO - Administración del Sistema Portuario Nacional Manzanillo, S.A. de C.V.",
            "ASIPONA MAZATLÁN - Administración del Sistema Portuario Nacional Mazatlán, S.A. de C.V.",
            "ASIPONA PROGRESO - Administración del Sistema Portuario Nacional Progreso, S.A. de C.V.",
            "ASIPONA CHIAPAS - Administración del Sistema Portuario Nacional Puerto Chiapas, S.A. de C.V.",
            "ASIPONA VALLARTA - Administración del Sistema Portuario Nacional Puerto Vallarta, S.A. de C.V.",
            "ASIPONA SALINA CRUZ - Administración del Sistema Portuario Nacional Salina Cruz, S.A. de C.V.",
            "ASIPONA TAMPICO - Administración del Sistema Portuario Nacional Tampico, S.A. de C.V.",
            "ASIPONA TOPOLOBAMPO - Administración del Sistema Portuario Nacional Topolobampo, S.A. de C.V.",
            "ASIPONA TUXPAN - Administración del Sistema Portuario Nacional Tuxpan, S.A. de C.V.",
            "ASIPONA VERACRUZ - Administración del Sistema Portuario Nacional Veracruz, S.A. de C.V.",
            "AICM - Aeropuerto Internacional de la Ciudad de México, S.A. de C.V.",
            "FUMPM - Fideicomiso Universidad Marítima y Portuaria de México",
            "MARINA - Secretaría de Marina",
            "CONASAMI - Comisión Nacional de los Salarios Mínimos",
            "CONAMPROS - Comité Nacional Mixto de Protección al Salario",
            "INFONACOT - Instituto del Fondo Nacional para el Consumo de los Trabajadores",
            "PROFEDET - Procuraduría Federal de la Defensa del Trabajo",
            "STyPS - Secretaría del Trabajo y Previsión Social",
            "CONAVI - Comisión Nacional de Vivienda",
            "FIFONAFE - Fideicomiso Fondo Nacional de Fomento Ejidal",
            "FONHAPO - Fidecomiso Fondo Nacional de Habitaciones Populares",
            "PROMEXICO - Fideicomiso ProMéxico",
            "INSUS - Instituto Nacional del Suelo Sustentable",
            "PA - Procuraduría Agraria",
            "RAN - Registro Agrario Nacional",
            "SEDATU - Secretaría de Desarrollo Agrario, Territorial y Urbano",
            "ASEA - Agencia Nacional de Seguridad Industrial y de Protección al Medio Ambiente del Sector Hidrocarburos",
            "CONANP - Comisión Nacional de Áreas Naturales Protegidas",
            "CONAGUA - Comisión Nacional del Agua",
            "CONAFOR - Comisión Nacional Forestal",
            "IMTA - Instituto Mexicano de Tecnología del Agua",
            "INECC - Instituto Nacional de Ecología y Cambio Climático",
            "PROFEPA - Procuraduría Federal de Protección al Ambiente",
            "SEMARNAT - Secretaría de Medio Ambiente y Recursos Naturales",
            "CENACE - Centro Nacional de Control de Energía",
            "CENAGAS - Centro Nacional de Control del Gas Natural",
            "CNH - Comisión Nacional de Hidrocarburos",
            "CNSNS - Comisión Nacional de Seguridad Nuclear y Salvaguardias",
            "CONUEE - Comisión Nacional para el Uso Eficiente de la Energía",
            "CNE - Comisión Nacional de Energía",
            "IMP - Instituto Mexicano del Petróleo",
            "INEEL - Instituto Nacional de Electricidad y Energías Limpias",
            "ININ - Instituto Nacional de Investigaciones Nucleares",
            "SENER - Secretaría de Energía",
            "CONADIS - Consejo Nacional para el Desarrollo y la Inclusión de las Personas con Discapacidad",
            "FONART - Fondo Nacional para el Fomento de las Artesanías",
            "IMJ - Instituto Mexicano de la Juventud",
            "INAES - Instituto Nacional de la Economía Social",
            "INAPAM - Instituto Nacional de las Personas Adultas Mayores",
            "BIENESTAR - Secretaría de Bienestar",
            "INFRAESTRUCTURA - FONATUR Infraestructura, S.A. de C.V.",
            "FTM - FONATUR Tren Maya, S.A. de C.V.",
            "FONATUR - Fondo Nacional de Fomento al Turismo",
            "SECTUR - Secretaría de Turismo",
            "CENAPRED - Centro Nacional de Prevención de Desastres",
            "CONASE - Coordinación Nacional Antisecuestro y Delitos de Alto Impacto",
            "PF - Policía Federal",
            "PRS - Prevención y Reinserción Social",
            "SESNSP - Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública",
            "SPF - Servicio de Protección Federal",
            "CJEF - Consejería Jurídica del Ejecutivo Federal",
            "CIDESI - Centro de Ingeniería y Desarrollo Industrial",
            "CICY - Centro de Investigación Científica de Yucatán, A.C.",
            "CICESE - Centro de investigación Científica y de Educación Superior de Ensenada, Baja California",
            "INFOTEC - INFOTEC Centro de Investigación e Innovación en Tecnologías de la Información y Comunicación",
            "CIAD - Centro de Investigación en Alimentación y Desarrollo, A.C.",
            "CENTROGEO - Centro de Investigación en Ciencias de Información Geoespacial, A.C.",
            "CIMAT - Centro de Investigación en Matemáticas, A.C.",
            "CIMAV - Centro de Investigación en Materiales Avanzados, S.C.",
            "CIQA - Centro de Investigación en Química Aplicada",
            "CIATEJ - Centro de Investigación y Asistencia en Tecnología y Diseño del Estado de Jalisco, A.C.",
            "CIDETEQ - Centro de Investigación y Desarrollo Tecnológico en Electroquímica, S.C.",
            "CIDE - Centro de Investigación y Docencia Económicas, A.C.",
            "CIESAS - Centro de Investigaciones y Estudios Superiores en Antropología Social",
            "CIBNOR - Centro de Investigaciones Biológicas del Noroeste, S.C.",
            "CIO - Centro de Investigaciones en Óptica, A.C.",
            "CIATEC - CIATEC, A.C. \"Centro de Innovación Aplicada en Tecnologías Competitivas\"",
            "CIATEQ - CIATEQ, A.C. Centro de Tecnología Avanzada",
            "COLEF - EI Colegio de la Frontera Norte, A.C.",
            "ECOSUR - EI Colegio de la Frontera Sur",
            "COLMICH - El Colegio de Michoacán, A.C.",
            "COLSAN - EI Colegio de San Luis, A.C.",
            "INECOL - Instituto de Ecología, A.C.",
            "MORA - Instituto de Investigaciones \"Dr. José María Luis Mora\"",
            "INAOE - Instituto Nacional de Astrofísica, Óptica y Electrónica",
            "IPICYT - Instituto Potosino de Investigación Científica y Tecnológica, A.C.",
            "SECIHTI - Secretaría de Ciencia, Humanidades, Tecnología e Innovación",
            "CCC - Centro de Capacitación Cinematográfica, A.C.",
            "CECUT - Compañía Operadora del Centro Cultural y Turístico de Tijuana, S.A. de C.V.",
            "EDUCAL - Educal, S.A. de C.V.",
            "ECHASA - Estudios Churubusco Azteca, S.A.",
            "FICINE - Fideicomiso para la Cineteca Nacional",
            "IMCINE - Instituto Mexicano de Cinematografía",
            "INAH - Instituto Nacional de Antropología e Historia",
            "INBAL - Instituto Nacional de Bellas Artes y Literatura",
            "INEHRM - Instituto Nacional de Estudios Históricos de las Revoluciones de México ",
            "INALI - Instituto Nacional de Lenguas Indígenas",
            "INDAUTOR - Instituto Nacional del Derecho de Autor ",
            "RE - Radio Educación",
            "CULTURA - Secretaría de Cultura",
            "CANAL 22 - Televisión Metropolitana, S.A. de C.V.",
            "ASERCA - Agencia de Servicios a la Comercialización y Desarrollo de Mercados Agropecuarios",
            "CEAV - Comisión Ejecutiva de Atención a Víctimas",
            "FIT - Ferrocarril del Istmo de Tehuantepec, S.A. de C.V.",
            "FCONST - FONATUR Constructora, S.A. de C.V.",
            "FOVISSSTE - Fondo de la Vivienda del Instituto de Seguridad y Servicios Sociales de los Trabajadores del Estado",
            "INNOVA BIENESTAR - InnovaBienestar de México, S.A.P.I. de C.V.",
            "ISSSTE - Instituto de Seguridad y Servicios Sociales de los Trabajadores del Estado",
            "IMSS - Instituto Mexicano del Seguro Social",
            "INACIPE - Instituto Nacional de Ciencias Penales",
            "INMUJERES - Instituto Nacional de las Mujeres",
            "INPI - Instituto Nacional de los Pueblos Indígenas",
            "INAPESCA - Instituto Mexicano de Investigación en Pesca y Acuacultura Sustentables",
            "PRODECON - Procuraduría de la Defensa del Contribuyente",
            "PGR - Fiscalía General de la República",
            "SABG - Secretaría Anticorrupción y Buen Gobierno",
            "SPR - Sistema Público de Radiodifusión del Estado Mexicano",
            "SUPERISSSTE - SUPERISSSTE",
            "PROMTEL - Organismo Promotor de Inversiones en Telecomunicaciones",
            "ZEE - Autoridad Federal para el Desarrollo de las Zonas Económicas Especiales",
            "CAIMFS - Coordinación para la Atención Integral de la Migración en la Frontera Sur",
            "SESNA - Secretaría Ejecutiva del Sistema Nacional Anticorrupción",
            "CIIT - Corredor Interoceánico del Istmo de Tehuantepec",
            "CONEVAL - Consejo Nacional de Evaluación de la Política de Desarrollo Social",
            "SSPC - Secretaría de Seguridad y Protección Ciudadana",
            "SEGALMEX - Seguridad Alimentaria Mexicana",
            "AFAC - Agencia Federal de Aviación Civil",
            "ARTF - Agencia Reguladora del Transporte Ferroviario",
            "CFCRL - Centro Federal de Conciliación y Registro Laboral",
            "ANAM - Agencia Nacional de Aduanas de México",
            "AIFA - Aeropuerto Internacional Felipe Ángeles, S.A. de C.V.",
            "GN - Guardia Nacional",
            "MEJOREDU - Comisión Nacional para la Mejora Continua de la Educación",
            "SHF - Sociedad Hipotecarla Federal, S.N.C.",
            "IMIPAS - Instituto Mexicano de Investigación en Pesca y Acuacultura Sustentables",
            "OCUBBJG - Organismo Coordinador de las Universidades para el Bienestar Benito Juárez García",
            "CONASAMA - Comisión Nacional de Salud Mental y Adicciones",
            "IMSS BIENESTAR - Servicios de Salud del Instituto Mexicano del Seguro Social para el Bienestar (IMSS-BIENESTAR)",
            "TREN MAYA - Tren Maya, S.A. de C.V.",
            "ATDT - Agencia de Transformación Digital y Telecomunicaciones",
            "GAFSACOMM - Grupo Aeroportuario, Ferroviario, de Servicios Auxiliares y Conexos Olmeca - Maya - Mexica, S.A. de C.V.",
            "No Capturado - No Capturado",
            "ASOCIACIÓN MEXICANA - Asociación Mexicana",
            "MUJERES - Secretaría de las Mujeres"
        ];


        /**
         * Actualiza las opciones de todos los selectores dinámicos de la aplicación.
         * Para el campo de 'institucion', fusiona el catálogo homologado con las instituciones
         * existentes en la base de datos para garantizar una lista completa y retrocompatible.
         */
        function updateDynamicSelectOptions() {
            const allData = [...calls, ...historicalCalls];
        
            // --- Lógica Específica para Instituciones ---
            // 1. Extraer todas las instituciones existentes en los registros.
            const historicalInstitutions = allData.map(c => c.institucion).filter(Boolean);
            
            // 2. Fusionar el catálogo oficial con las instituciones históricas.
            //    - Se utiliza `new Set()` para eliminar duplicados de forma automática y eficiente.
            //      (p. ej., si una institución del historial ya existe en el catálogo).
            //    - Se ordena alfabéticamente para una mejor experiencia de usuario.
            const combinedInstitutions = [...new Set([...catalogoInstitucionesHomologado, ...historicalInstitutions])].sort();
            
            // 3. Actualizar el estado global y el selector de UI.
            fieldOptions.instituciones = combinedInstitutions;
            updateSelectOptions('instituciones', fieldOptions.instituciones);
        
            // --- Lógica General para los demás campos (sin cambios) ---
            // Se extraen los valores únicos de los datos existentes y se ordenan.
            fieldOptions.areas = [...new Set(allData.map(c => c.area).filter(Boolean))].sort();
            fieldOptions.asuntos = [...new Set(allData.map(c => c.asunto).filter(Boolean))].sort();
            fieldOptions.consultas = [...new Set(allData.map(c => c.consulta).filter(Boolean))].sort();
            fieldOptions.nombres = [...new Set(allData.map(c => c.nombre).filter(Boolean))].sort();
            fieldOptions.cargos = [...new Set(allData.map(c => c.cargo).filter(Boolean))].sort();
            fieldOptions.correos = [...new Set(allData.map(c => c.correo).filter(Boolean))].sort();
            fieldOptions.telefonos = [...new Set(allData.map(c => c.telefono).filter(Boolean))].sort();
            fieldOptions.comentarios = [...new Set(allData.map(c => c.comentarios).filter(Boolean))].sort();
            fieldOptions.atendioUsers = [...new Set(allData.map(c => c.atendio).filter(Boolean))].sort();
            
            // Se actualizan los selectores correspondientes en la UI.
            updateSelectOptions('areas', fieldOptions.areas);
            updateSelectOptions('asuntos', fieldOptions.asuntos);
            updateSelectOptions('consultas', fieldOptions.consultas);
            updateSelectOptions('nombres', fieldOptions.nombres);
            updateSelectOptions('cargos', fieldOptions.cargos);
            updateSelectOptions('correos', fieldOptions.correos);
            updateSelectOptions('atendioUsers', fieldOptions.atendioUsers);
            updateSelectOptions('telefonos', fieldOptions.telefonos);
            updateSelectOptions('comentarios', fieldOptions.comentarios);
        }



        
        //Actualizar opciones despues de editar una lista desplegable
        function updateSelectOptions(field, options, selectedId = null) {
            const fieldToSelectMap = {
                'instituciones': ['caller-institution', 'edit-caller-institution'],
                'areas': ['call-area', 'edit-call-area'],
                'asuntos': ['call-subject', 'edit-call-subject'],
                'consultas': ['call-query', 'edit-call-query'],
                'nombres': ['caller-name', 'edit-caller-name'],
                'cargos': ['caller-cargo', 'edit-caller-cargo'],
                'correos': ['caller-email', 'edit-caller-email'],
                'telefonos': ['caller-phone', 'edit-caller-phone'],
                'comentarios': ['call-comments', 'edit-call-comments'],
                'atendioUsers': ['call-atendio', 'edit-call-atendio']
            };

            // Normalizar options: si son strings, convertir a {id, text}
            const normalizedOptions = options.map(opt =>
                typeof opt === "string" ? {id: opt, text: opt} : opt
            );

            if (fieldToSelectMap[field]) {
                fieldToSelectMap[field].forEach(selectId => {
                    const select = $(`#${selectId}`);
                    if (select.length) {
                        // Guardar el valor actual antes de actualizar
                        const currentValue = select.val();
                        
                        select.empty().select2({
                            data: normalizedOptions,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });

                        // Restaurar el valor seleccionado si todavía existe
                        if (currentValue && normalizedOptions.some(o => o.id === currentValue)) {
                            isProgrammaticChange = true;
                            select.val(currentValue).trigger('change.select2');
                            setTimeout(() => {
                                isProgrammaticChange = false;
                            }, 100);
                        }
                        // Seleccionar por id si se especifica
                        else if (selectedId && normalizedOptions.some(o => o.id === selectedId)) {
                            isProgrammaticChange = true;
                            select.val(selectedId).trigger('change.select2');
                            setTimeout(() => {
                                isProgrammaticChange = false;
                            }, 100);
                        }
                    }
                });
            }

        }


        // Función para el autocompletado inteligente
        function setupAutofill() {
            // Función para cargar los detalles del contacto
            function loadContactDetails(name, institution, isEditModal) {
                if (!name || !institution) return;

                const allData = [...calls, ...historicalCalls];
                const records = allData
                    .filter(c => c.nombre === name && c.institucion === institution)
                    .sort((a, b) => {
                        const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return dateB - dateA;
                    });

                if (records.length > 0) {
                    const latestRecord = records[0];
                    const cargo = latestRecord.cargo || '';
                    const email = latestRecord.correo || '';
                    const phone = latestRecord.telefono || '';
                    
                    if (isEditModal) {
                        $('#edit-caller-cargo').val(cargo).trigger('change');
                        $('#edit-caller-email').val(email).trigger('change');
                        $('#edit-caller-phone').val(phone).trigger('change');
                    } else {
                        $('#caller-cargo').val(cargo).trigger('change');
                        $('#caller-email').val(email).trigger('change');
                        $('#caller-phone').val(phone).trigger('change');
                    }
                }
            }

            // Evento para institución (formulario principal)
            $('#caller-institution').on('change', function() {

                if (isProgrammaticChange) return;

                const institution = $(this).val();
                const nameSelect = $('#caller-name');
                
                const allData = [...calls, ...historicalCalls];
                const namesForInstitution = [...new Set(allData
                    .filter(c => c.institucion === institution)
                    .map(c => c.nombre)
                    .filter(Boolean))].sort();
                
                // Actualizar opciones del select de nombres
                nameSelect.empty();
                namesForInstitution.forEach(name => {
                    nameSelect.append(new Option(name, name));
                });
                
                // Si hay un nombre seleccionado, cargar sus datos
                const currentName = nameSelect.val();
                if (currentName) {
                    loadContactDetails(currentName, institution, false);
                }
            });

            // Evento para institución (formulario de edición)
            $('#edit-caller-institution').on('change', function() {

                if (isProgrammaticChange) return;

                const institution = $(this).val();
                const nameSelect = $('#edit-caller-name');
                
                const allData = [...calls, ...historicalCalls];
                const namesForInstitution = [...new Set(allData
                    .filter(c => c.institucion === institution)
                    .map(c => c.nombre)
                    .filter(Boolean))].sort();
                
                // Actualizar opciones del select de nombres
                nameSelect.empty();
                namesForInstitution.forEach(name => {
                    nameSelect.append(new Option(name, name));
                });
                
                // Si hay un nombre seleccionado, cargar sus datos
                const currentName = nameSelect.val();
                if (currentName) {
                    loadContactDetails(currentName, institution, true);
                }
            });

            // Evento para nombre (formulario principal)
            $('#caller-name').on('change', function() {

                if (isProgrammaticChange) return;

                const name = $(this).val();
                const institution = $('#caller-institution').val();
                loadContactDetails(name, institution, false);
            });

            // Evento para nombre (formulario de edición)
            $('#edit-caller-name').on('change', function() {

                if (isProgrammaticChange) return;

                const name = $(this).val();
                const institution = $('#edit-caller-institution').val();
                loadContactDetails(name, institution, true);
            });
        }

        // =============================================
        // INICIO: Bloque de código para preservar estado del formulario
        // Colocar este bloque ANTES de la función findAndReplaceInDatabase
        // =============================================
        
        // Nuevo helper function: getFormState
        function getFormState(formId) {
            const form = document.getElementById(formId);
            if (!form) return null;
            const state = {};
            
            $(form).find('select').each(function() {
                const select = $(this);
                const selectName = select.attr('name');
                if (selectName) {
                    const select2Data = select.select2('data') || [];
                    state[selectName] = {
                        value: select.val(),
                        // Guardamos las etiquetas temporales que el usuario haya creado
                        tags: select2Data.filter(item => item.element === undefined || $(item.element).data('select2-tag') === true)
                    };
                }
            });
            
            return state;
        }

        // Nuevo helper function: restoreFormState
        function restoreFormState(formId, state) {
            const form = document.getElementById(formId);
            if (!form || !state) return;
            
            Object.entries(state).forEach(([fieldName, fieldState]) => {
                const select = $(form).find(`[name="${fieldName}"]`);
                if (select.length > 0) {
                    // Restaurar etiquetas temporales primero para que estén disponibles para la selección
                    if (fieldState.tags) {
                        fieldState.tags.forEach(tag => {
                            if (!select.find(`option[value="${tag.id}"]`).length) {
                                select.append(new Option(tag.text, tag.id));
                            }
                        });
                    }
                    // Restaurar valor seleccionado
                    select.val(fieldState.value).trigger('change.select2');
                }
            });
        }
        // =============================================
        // FIN: Bloque de código para preservar estado del formulario
        // =============================================




        async function findAndReplaceInDatabase(field, oldValue, newValue) {
            const fieldToDbFieldMap = {
                'instituciones': 'institucion', 
                'areas': 'area', 
                'asuntos': 'asunto',
                'consultas': 'consulta', 
                'nombres': 'nombre', 
                'cargos': 'cargo',
                'correos': 'correo', 
                'telefonos': 'telefono', 
                'comentarios': 'comentarios',
                'atendioUsers': 'atendio'
            };
            
            const dbField = fieldToDbFieldMap[field];
            if (!dbField) return;
            
            try {
                // Actualización de registros (existente)
                const callsQuery = query(callsCollectionRef, where(dbField, '==', oldValue));
                const callsSnapshot = await getDocs(callsQuery);
                
                const batch = writeBatch(db);
                callsSnapshot.forEach(doc => batch.update(doc.ref, { [dbField]: newValue }));
                const historicalQuery = query(historicalCallsCollectionRef, where(dbField, '==', oldValue));
                const historicalSnapshot = await getDocs(historicalQuery);
                historicalSnapshot.forEach(doc => batch.update(doc.ref, { [dbField]: newValue }));
                await batch.commit();
                
                // Actualizar las opciones globales en fieldOptions
                fieldOptions[field] = [...new Set([...fieldOptions[field].filter(opt => opt !== oldValue), newValue])].sort();
                // Redibujar los selects con la lista actualizada
                updateSelectOptions(field, fieldOptions[field]);
                
                showAlert(`Se actualizaron ${callsSnapshot.size + historicalSnapshot.size} registros.`, "success");
            } catch (error) {
                console.error("Error al actualizar registros:", error);
                showAlert("Error al actualizar registros existentes", "error");
            }
        }

        // Nuevo helper function: updateSelectOptionsPreservingState
        async function updateSelectOptionsPreservingState(field, newValue, activeModalStates) {
            // Actualizar opciones globales
            fieldOptions[field] = [...new Set([...fieldOptions[field], newValue])].sort();
            
            // Actualizar selects sin destruir estado
            $('select[name="' + field + '"]').each(function() {
                const select = $(this);
                const currentValue = select.val();
                
                // Agregar nueva opción si no existe
                if (!select.find('option[value="' + newValue + '"]').length) {
                    select.append(new Option(newValue, newValue));
                }
                
                // Mantener selección actual
                select.val(currentValue).trigger('change');
            });
            
            // Restaurar estado de modales
            if (activeModalStates.editModal) {
                restoreFormState('edit-form', activeModalStates.editModal);
            }
            if (activeModalStates.callModal) {
                restoreFormState('call-form', activeModalStates.callModal);
            }
        }

        
        //Añadir o Editar (Botones)

        // Variable global para mantener el contexto del <select> que está siendo modificado.
        // Se gestiona su ciclo de vida: se establece al iniciar y se limpia al finalizar o cancelar.
        let activeSelectElement = null;
        // Añadir al inicio de las variables globales
        let isProgrammaticChange = false;

        /**
         * Configura todos los manejadores de eventos para los botones de añadir (+) y editar (lápiz)
         * de los campos de formulario. Implementa la lógica para autoseleccionar la opción
         * recién creada o modificada.
         */


        function setupAddEditButtons() {
             const buttonToFieldMap = {
                 'edit-institution-btn': 'instituciones',
                 'edit-area-btn': 'areas',
                 'edit-subject-btn': 'asuntos',
                 'edit-query-btn': 'consultas',
                 'edit-name-btn': 'nombres',
                 'edit-cargo-btn': 'cargos',
                 'edit-email-btn': 'correos',
                 'edit-phone-btn': 'telefonos',
                 'edit-comments-btn': 'comentarios',
                 'edit-atendio-btn': 'atendioUsers',
                 'edit-institution-edit-btn': 'instituciones',
                 'edit-area-edit-btn': 'areas',
                 'edit-subject-edit-btn': 'asuntos',
                 'edit-query-edit-btn': 'consultas',
                 'edit-name-edit-btn': 'nombres',
                 'edit-cargo-edit-btn': 'cargos',
                 'edit-email-edit-btn': 'correos',
                 'edit-phone-edit-btn': 'telefonos',
                 'edit-comments-edit-btn': 'comentarios',
                 'edit-atendio-edit-btn': 'atendioUsers'
             };
            
             // 1. ASIGNACIÓN DE EVENTOS A LOS BOTONES (lápiz)
             Object.entries(buttonToFieldMap).forEach(([buttonId, field]) => {
                 const button = document.getElementById(buttonId);
                 if (!button) return;
 
                 button.addEventListener('click', (e) => {
                     activeSelectElement = e.currentTarget.parentElement.querySelector('select');
                     const currentValue = $(activeSelectElement).val();
                         
                     if (!currentValue) {
                         return showAlert("Por favor, seleccione una opción para editar.", "warning");
                     }
                        
                     currentEditingField = field;
                     currentEditingValue = currentValue;
                     editOptionInput.value = currentValue;
                     editOptionInput.placeholder = `Edite la opción para ${field}`;
                     openModal(editOptionModal);
                 });
             });
            
             // 2. LÓGICA DE CONFIRMACIÓN PARA EDITAR OPCIÓN EXISTENTE
             confirmEditOptionBtn.addEventListener('click', () => {
                 const newValue = editOptionInput.value.trim();
 
                 if (!newValue || !currentEditingField || !currentEditingValue) {
                     return;
                 }
 
                 closeModal(editOptionModal);
                 
                 const activeFormId = !callModal.classList.contains('hidden') ? 'call-form' : 
                                      !editModal.classList.contains('hidden') ? 'edit-form' : null;
                 
                 const formStateBeforeEdit = activeFormId ? getFormState(activeFormId) : null;
 
                 requirePassword(async () => {
                     try {
                         await findAndReplaceInDatabase(currentEditingField, currentEditingValue, newValue);
                         
                         if (formStateBeforeEdit) {
                             restoreFormState(activeFormId, formStateBeforeEdit);
                         }
 
                         if (activeSelectElement) {
                             $(activeSelectElement).val(newValue).trigger('change.select2');
                         }
                     } catch (dbErr) {
                         console.error('Error al actualizar la base de datos:', dbErr);
                         showAlert("Error al actualizar la opción en la base de datos", "error");
                     } finally {
                         activeSelectElement = null;
                     }
                 });
             });
             
             // 3. LIMPIEZA DE ESTADO EN CASO DE CANCELACIÓN
             cancelEditOptionBtn.addEventListener('click', () => {
                 closeModal(editOptionModal);
                 activeSelectElement = null;
             });
        }


        // =============================================
        // MÓDULO: Autenticación y seguridad
        // =============================================

        //Verificar contraseña
        function verifyPassword() {
            const password = passwordInput.value;
            
            if (password === 'admin') {
                closeModal(passwordModal);
                passwordInput.value = '';
                if (pendingAction) {
                    pendingAction();
                    pendingAction = null;
                }
            } else {
                showAlert("Contraseña incorrecta", "error");
                passwordInput.value = '';
            }
        }



        function setupPasswordVerification() {
            confirmPasswordBtn.addEventListener('click', verifyPassword);
            cancelPasswordBtn.addEventListener('click', () => {
                closeModal(passwordModal);
                pendingAction = null;
            });
            
            // Usar el elemento correcto del DOM para el evento keypress
            const passwordInputElement = document.getElementById('password-input');
            if (passwordInputElement) {
                passwordInputElement.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        verifyPassword();
                    }
                });
            }
        }


        function requirePassword(action) {
            pendingAction = action;
            openModal(passwordModal);
        }


        //Authenticación de firestore
        async function initializeAppWithAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userInfo.textContent = `Usuario Anónimo: ${userId.substring(0, 8)}...`;
                    setupRealtimeListeners();
                    showApp();
                } else {
                    await signInAnonymously(auth);
                }
            });
        }
        
        //Realtime Listas de llamadas e histórico
        function setupRealtimeListeners() {
            onSnapshot(query(callsCollectionRef), (snapshot) => {
                calls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(callLogTableBody, calls, false);
                updateDashboard();
                updateCharts();
                updateDynamicSelectOptions();
            }, (error) => console.error("Error en listener de llamadas:", error));
            
            onSnapshot(query(historicalCallsCollectionRef), (snapshot) => {
                historicalCalls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(historicalTableBody, historicalCalls, true);
                updateDashboard();
                updateCharts();
                updateDynamicSelectOptions();
            }, (error) => console.error("Error en listener de histórico:", error));
        }

        // =============================================
        // MÓDULO: Gráficos y reportes
        // =============================================
        
        //Actualizar 
        function updateCharts() {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            if (reportFilter.type === 'period' && reportFilter.startDate && reportFilter.endDate) {
                const startDate = new Date(reportFilter.startDate);
                let endDate = new Date(reportFilter.endDate);
                endDate.setHours(23, 59, 59, 999);
                data = data.filter(call => {
                    if (!call.fecha) return false;
                    try {
                        const callDate = new Date(call.fecha.split('/').reverse().join('-'));
                        return callDate >= startDate && callDate <= endDate;
                    } catch (e) { return false; }
                });
            }
            
            const chartWrappers = document.querySelectorAll('.chart-wrapper');
            const chartSize = chartSizeSlider.value;
            chartWrappers.forEach(wrapper => {
                wrapper.style.height = `${chartSize}px`;
            });

            const statusCounts = {}, asuntoCounts = {}, dayOfWeekCounts = {}, atendioCounts = {};
            data.forEach(call => {
                statusCounts[call.estatus || 'N/A'] = (statusCounts[call.estatus || 'N/A'] || 0) + 1;
                asuntoCounts[call.asunto || 'N/A'] = (asuntoCounts[call.asunto || 'N/A'] || 0) + 1;
                atendioCounts[call.atendio || 'N/A'] = (atendioCounts[call.atendio || 'N/A'] || 0) + 1;
                if (call.fecha && typeof call.fecha === 'string') {
                    try {
                        const date = new Date(call.fecha.split('/').reverse().join('-'));
                        const day = date.toLocaleDateString('es-ES', { weekday: 'long' });
                        dayOfWeekCounts[day] = (dayOfWeekCounts[day] || 0) + 1;
                    } catch (e) { /* Ignorar */ }
                }
            });


            const createOrUpdateChart = (canvas, chartInstance, type, data, labelsOrder, datasetLabel = 'Cantidad') => {
                // Destruye la instancia del gráfico si existe para evitar duplicaciones
                if (chartInstance) chartInstance.destroy();

                // Obtiene las etiquetas de los datos
                let labels = Object.keys(data);
                
                // Ordena las etiquetas si se proporciona un orden
                if (labelsOrder) {
                    labels.sort((a, b) => labelsOrder.indexOf(a) - labelsOrder.indexOf(b));
                }

                // Mapea los datos a un array de valores
                const chartData = labels.map(label => data[label]);

                // Define un array de colores para las barras/sectores del pastel
                const backgroundColors = ['#9C2348', '#1E5B4F', '#A6802D', '#EF4444', '#3B82F6'];

                // Define el conjunto de datos para el gráfico
                const dataset = {
                    label: datasetLabel,
                    data: chartData,
                    backgroundColor: backgroundColors,
                    // El borde es blanco para todos los tipos de gráfico, excepto para las líneas donde es del color del primer fondo
                    borderColor: type === 'line' ? backgroundColors[0] : '#FFFFFF', 
                    borderWidth: 1.5, 
                    tension: 0.1 
                };
                
                // Crea y devuelve la nueva instancia de Chart
                return new Chart(canvas, { 
                    type, 
                    data: { labels, datasets: [dataset] }, 
                    options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    // El color del borde de la etiqueta es el mismo que el color de fondo para ocultarlo
                                    boxWidth: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    } 
                });
            };



            
            if (statusChart) statusChart.destroy();
            if (asuntoChart) asuntoChart.destroy();
            if (dayOfWeekChart) dayOfWeekChart.destroy();
            if (atendioChart) atendioChart.destroy();
            if (dynamicChart) dynamicChart.destroy();

            statusChart = createOrUpdateChart(statusChartCanvas, statusChart, 'pie', statusCounts);
            asuntoChart = createOrUpdateChart(asuntoChartCanvas, asuntoChart, 'bar', asuntoCounts, null, 'Llamadas por Asunto');
            atendioChart = createOrUpdateChart(atendioChartCanvas, atendioChart, 'bar', atendioCounts, null, 'Llamadas Atendidas');
            dayOfWeekChart = createOrUpdateChart(dayOfWeekChartCanvas, dayOfWeekChart, 'line', dayOfWeekCounts, ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo'], 'Llamadas por Día');
                 
            // Actualizar gráfica dinámica
            updateDynamicChart();

            $.pivotUtilities.locales.es = {
                localeStrings: { renderError: "Error al renderizar.", computeError: "Error al calcular.", uiRenderError: "Error de UI.", selectAll: "Seleccionar Todo", selectNone: "Seleccionar Ninguno", tooMany: "(demasiados)", filterResults: "Filtrar", apply: "Aplicar", cancel: "Cancelar", totals: "Totales", vs: "vs", by: "por" },
                aggregators: { "Conteo": "Conteo", "Suma": "Suma", "Promedio": "Promedio", "Mínimo": "Mínimo", "Máximo": "Máximo" },
                renderers: { "Tabla": "Tabla", "Gráfico de Barras": "Gráfico de Barras", "Gráfico de Líneas": "Gráfico de Líneas", "Mapa de Calor": "Mapa de Calor" }
            };

            $(pivotTableContainer).pivotUI(data, {
                rows: ["area"], cols: ["estatus"], vals: ["duracion"],
                aggregatorName: "Conteo", rendererName: "Tabla", locale: "es"
            });
        }

        //Update Chart

        function updateDynamicChart() {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            if (reportFilter.type === 'period' && reportFilter.startDate && reportFilter.endDate) {
                const startDate = new Date(reportFilter.startDate);
                let endDate = new Date(reportFilter.endDate);
                endDate.setHours(23, 59, 59, 999);
                data = data.filter(call => {
                    if (!call.fecha) return false;
                    try {
                        const callDate = new Date(call.fecha.split('/').reverse().join('-'));
                        return callDate >= startDate && callDate <= endDate;
                    } catch (e) { return false; }
                });
            }
            
            const selectedVariable = dynamicChartVariable.value;
            const variableCounts = {};
            const variableStatusCounts = {};
            
            data.forEach(call => {
                const value = call[selectedVariable] || 'N/A';
                variableCounts[value] = (variableCounts[value] || 0) + 1;
                
                if (!variableStatusCounts[value]) {
                    variableStatusCounts[value] = { 'Atendida': 0, 'Pendiente': 0 };
                }
                
                if (call.estatus === 'Atendida') {
                    variableStatusCounts[value].Atendida += 1;
                } else {
                    variableStatusCounts[value].Pendiente += 1;
                }
            });
            
            // Actualizar tabla dinámica
            const table = dynamicTableBody.closest('table');
            let tfoot = table.querySelector('tfoot');
            if (!tfoot) {
                tfoot = document.createElement('tfoot');
                table.appendChild(tfoot);
            }
            
            dynamicTableBody.innerHTML = '';
            dynamicTableHeader.textContent = selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1);
            
            let totalAtendida = 0;
            let totalPendiente = 0;
            let granTotal = 0;

            Object.entries(variableStatusCounts).forEach(([value, counts]) => {
                const total = counts.Atendida + counts.Pendiente;
                totalAtendida += counts.Atendida;
                totalPendiente += counts.Pendiente;
                granTotal += total;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value}</td>
                    <td>${counts.Atendida}</td>
                    <td>${counts.Pendiente}</td>
                    <td>${total}</td>
                `;
                dynamicTableBody.appendChild(row);
            });

            // Añadir fila de totales al tfoot
            tfoot.innerHTML = `
                <tr class="bg-slate-200 font-bold">
                    <td>Total</td>
                    <td>${totalAtendida}</td>
                    <td>${totalPendiente}</td>
                    <td>${granTotal}</td>
                </tr>
            `;
            
            // Actualizar gráfico
            if (dynamicChart) dynamicChart.destroy();
            
            const labels = Object.keys(variableCounts);
            const chartData = Object.values(variableCounts);
            
            dynamicChart = new Chart(dynamicChartCanvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: chartData,
                        backgroundColor: '#9C2348'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                display: showChartLabels,
                                maxRotation: showChartLabels ? 90 : 0,
                                minRotation: showChartLabels ? 45 : 0
                            }
                        }
                    }
                }
            });
        }

        
        
        //Botón de Configuración
        function setupReportConfig() {
            configReportBtn.addEventListener('click', () => openModal(configReportModal));
            closeConfigReportModalBtn.addEventListener('click', () => closeModal(configReportModal));
            
            filterAllDataRadio.addEventListener('change', () => {
                configReportStartDate.disabled = true;
                configReportEndDate.disabled = true;
            });
            
            filterByPeriodRadio.addEventListener('change', () => {
                configReportStartDate.disabled = false;
                configReportEndDate.disabled = false;
            });
            
            saveConfigReportBtn.addEventListener('click', () => {
                if (filterByPeriodRadio.checked && (!configReportStartDate.value || !configReportEndDate.value)) {
                    return showAlert("Por favor, seleccione un rango de fechas válido.", "warning");
                }
                reportFilter.type = filterAllDataRadio.checked ? 'all' : 'period';
                reportFilter.startDate = configReportStartDate.value;
                reportFilter.endDate = configReportEndDate.value;
                
                showAlert("Configuración de reportes guardada.", "success");
                closeModal(configReportModal);
                updateCharts();
            });
        }


        // =============================================
        // FUNCIÓN MEJORADA: Generación de Reporte Ejecutivo PDF 
        // =============================================

        // Paleta global para sincronización (colócala fuera de funciones, e.g., al inicio del script)
        const globalColorPalette = {
            primary: ['#9C2348', '#7c1d3a', '#d946ef', '#8b5cf6'],
            secondary: ['#1E5B4F', '#059669', '#0d9488', '#14b8a6'],
            accent: ['#A6802D', '#d97706', '#f59e0b', '#fbbf24'],
            status: ['#EF4444', '#dc2626', '#f87171', '#fca5a5'],
            neutral: ['#6366f1', '#8b5cf6', '#a855f7', '#c084fc']
        };

        function generateExecutiveReport(includeStatus, includeAsunto, includeDay, includeAtendio, includeDynamicChart, includeDynamicTable) {
            const source = reportesDataSource.value;
            let data = [];
            if (source === 'registro') data = calls;
            else if (source === 'historico') data = historicalCalls;
            else data = [...calls, ...historicalCalls];
            
            // Aplicar filtros de fecha si están configurados
            if (reportFilter.type === 'period' && reportFilter.startDate && reportFilter.endDate) {
                const startDate = new Date(reportFilter.startDate);
                let endDate = new Date(reportFilter.endDate);
                endDate.setHours(23, 59, 59, 999);
                data = data.filter(call => {
                    if (!call.fecha) return false;
                    try {
                        const callDate = new Date(call.fecha.split('/').reverse().join('-'));
                        return callDate >= startDate && callDate <= endDate;
                    } catch (e) { return false; }
                });
            }
            
            // Calcular métricas y conteos
            const statusCounts = {}, asuntoCounts = {}, dayOfWeekCounts = {}, atendioCounts = {};
            data.forEach(call => {
                statusCounts[call.estatus || 'N/A'] = (statusCounts[call.estatus || 'N/A'] || 0) + 1;
                asuntoCounts[call.asunto || 'N/A'] = (asuntoCounts[call.asunto || 'N/A'] || 0) + 1;
                atendioCounts[call.atendio || 'N/A'] = (atendioCounts[call.atendio || 'N/A'] || 0) + 1;
                if (call.fecha && typeof call.fecha === 'string') {
                    try {
                        const date = new Date(call.fecha.split('/').reverse().join('-'));
                        const day = date.toLocaleDateString('es-ES', { weekday: 'long' });
                        dayOfWeekCounts[day] = (dayOfWeekCounts[day] || 0) + 1;
                    } catch (e) { /* Ignorar */ }
                }
            });
            
            const totalCalls = data.length;
            const atendidas = data.filter(c => c.estatus === 'Atendida').length;
            const pendientes = totalCalls - atendidas;
            const totalDuration = data.reduce((sum, c) => sum + (Number(c.duracion) || 0), 0);
            const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;
            
            const currentDate = new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Obtener el tamaño configurado de los gráficos
            const chartSize = 400;
            const fontBase = Math.min(24, Math.max(18, Math.round(chartSize / 15))); // Agresivo, labels ~título
            
            // Generar HTML con estilos CSS integrados y dimensiones respetadas
            let reportHTML = `
                <style>
                    .reporte-ejecutivo {
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        background: white;
                        color: #1f2937;
                        padding: 20px 30px 20px 30px; /* Simétrico */
                        max-width: 800px; /* Ajustado para centering */
                        margin: 0 auto;
                        line-height: 1.6;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    }
                    
                    .reporte-header {
                        text-align: center;
                        margin-bottom: 40px;
                        padding: 25px;
                        background: linear-gradient(135deg, #9C2348 0%, #7c1d3a 100%);
                        color: white;
                        border-radius: 12px;
                        box-shadow: 0 8px 25px rgba(156, 35, 72, 0.3);
                    }
                    
                    .reporte-header h1 {
                        font-size: 32px;
                        font-weight: bold;
                        margin: 0 0 15px 0;
                        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    }
                    
                    .reporte-header p {
                        font-size: 16px;
                        margin: 8px 0;
                        opacity: 0.95;
                    }
                    
                    .reporte-metricas {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 20px;
                        margin: 40px 0;
                    }
                    
                    .metrica {
                        background: #f8fafc;
                        border: 2px solid #e2e8f0;
                        border-radius: 12px;
                        padding: 25px;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                        transition: all 0.3s ease;
                    }
                    
                    .metrica h3 {
                        color: #475569;
                        font-size: 14px;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        margin: 0 0 12px 0;
                    }
                    
                    .metrica p {
                        color: #9C2348;
                        font-size: 28px;
                        font-weight: bold;
                        margin: 0;
                    }
                    
                    .grafica {
                        margin: 20px 0; /* Reducido para menos espacios y evitar cortes */
                        page-break-inside: avoid;
                        page-break-before: auto;
                        break-after: avoid;
                        background: white;
                        border: 1px solid #e2e8f0;
                        border-radius: 12px;
                        padding: 15px; /* Reducido */
                        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                    }
                    
                    .grafica h3 {
                        color: #1e293b;
                        font-size: 24px; /* Aumentado para match con labels */
                        font-weight: 600;
                        margin: 0 0 15px 0;
                        text-align: center;
                        border-bottom: 3px solid #9C2348;
                        padding-bottom: 10px;
                    }
                    
                    .grafica canvas {
                        display: block !important;
                        margin: 0 auto !important;
                        max-width: 100% !important;
                        border-radius: 8px;
                    }
                    
                    .tabla-datos {
                        margin: 30px 0;
                        page-break-inside: avoid !important;
                        page-break-before: auto !important;
                        break-inside: avoid !important;
                        break-before: auto !important;
                        background: white;
                        border: 1px solid #e2e8f0;
                        border-radius: 12px;
                        padding: 25px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                        /* SOLUCIÓN DEFINITIVA: Ancho fijo para evitar dependencia del tamaño de ventana */
                        width: 800px !important;
                        min-width: 800px !important;
                        max-width: 800px !important;
                        box-sizing: border-box;
                    }
                    .tabla-datos h3 {
                        color: #1e293b;
                        font-size: 24px;
                        font-weight: 600;
                        margin: 0 0 25px 0;
                        text-align: center;
                        border-bottom: 3px solid #9C2348;
                        padding-bottom: 15px;
                    }
                    
                    .tabla-datos table {
                        width: 100%;
                        border-collapse: collapse;
                        margin: 20px 0;
                        background: white;
                        border-radius: 8px;
                        overflow: hidden;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }
                    
                    .tabla-datos th {
                        background: linear-gradient(135deg, #9C2348 0%, #7c1d3a 100%);
                        color: white;
                        font-weight: 600;
                        padding: 18px 15px;
                        text-align: center;
                        font-size: 16px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    
                    .tabla-datos td {
                        padding: 15px;
                        text-align: center;
                        border-bottom: 1px solid #e2e8f0;
                        font-size: 16px;
                    }
                    
                    .tabla-datos tr:nth-child(even) {
                        background-color: #f8fafc;
                    }
                    
                    .tabla-datos tr:hover {
                        background-color: #f1f5f9;
                    }
                    
                    .tabla-datos .atendida { color: #059669; font-weight: 600; }
                    .tabla-datos .pendiente { color: #dc2626; font-weight: 600; }
                    .tabla-datos .effectiveness-high { color: #059669; font-weight: 600; }
                    .tabla-datos .effectiveness-medium { color: #d97706; font-weight: 600; }
                    .tabla-datos .effectiveness-low { color: #dc2626; font-weight: 600; }
                    
                    .reporte-footer {
                        text-align: center;
                        margin-top: 50px;
                        padding: 30px;
                        background: #f8fafc;
                        border-radius: 12px;
                        border: 1px solid #e2e8f0;
                    }
                    .reporte-footer p {
                        color: #64748b;
                        font-size: 16px;
                        margin: 0;
                        font-weight: 500;
                    }


                    @media print {
                        /* SOLUCIÓN DEFINITIVA: Reglas de impresión para evitar problemas de renderizado */
                        body {
                            width: 800px !important;
                            min-width: 800px !important;
                            max-width: 800px !important;
                            margin: 0 auto !important;
                        }
                        
                        .reporte-ejecutivo {
                            width: 800px !important;
                            min-width: 800px !important;
                            max-width: 800px !important;
                            margin: 0 auto !important;
                            padding: 20px 30px !important;
                        }
                        
                        .grafica, .tabla-datos {
                            width: 800px !important;
                            min-width: 800px !important;
                            max-width: 800px !important;
                            page-break-inside: avoid !important;
                            break-inside: avoid !important;
                        }
                        
                        .grafica canvas, .tabla-datos table {
                            width: 100% !important;
                            max-width: 100% !important;
                        }
                    }
                </style>
                
                <div class="reporte-ejecutivo">
                    <div class="reporte-header">
                        <h1>Reporte Ejecutivo de Llamadas</h1>
                        <p>Generado el: ${currentDate}</p>
                        <p>Total de registros: ${totalCalls}</p>
                        ${reportFilter.type === 'period' ? 
                            `<p>Período: ${reportFilter.startDate} - ${reportFilter.endDate}</p>` : 
                            '<p>Período: Todos los registros</p>'
                        }
                    </div>
                    
                    <div class="reporte-metricas">
                        <div class="metrica">
                            <h3>Llamadas Atendidas</h3>
                            <p>${atendidas}</p>
                        </div>
                        <div class="metrica">
                            <h3>Llamadas Pendientes</h3>
                            <p>${pendientes}</p>
                        </div>
                        <div class="metrica">
                            <h3>Duración Promedio</h3>
                            <p>${formatDuration(avgDuration)}</p>
                        </div>
                        <div class="metrica">
                            <h3>Total de Llamadas</h3>
                            <p>${totalCalls}</p>
                        </div>
                    </div>
            `;
            
            // Agregar secciones de gráficos con dimensiones respetadas
            if (includeStatus) {
                reportHTML += `
                    <div class="grafica">
                        <h3>Distribución de Llamadas por Estatus</h3>
                        <canvas id="report-status-chart" width="${chartSize}" height="${chartSize}" style="width: ${chartSize}px !important; height: ${chartSize}px !important;"></canvas>
                    </div>
                `;
            }
            
            if (includeAsunto) {
                reportHTML += `
                    <div class="grafica">
                        <h3>Análisis de Llamadas por Asunto</h3>
                        <canvas id="report-asunto-chart" width="${chartSize}" height="${chartSize}" style="width: ${chartSize}px !important; height: ${chartSize}px !important;"></canvas>
                    </div>
                `;
            }
            
            if (includeDay) {
                reportHTML += `
                    <div class="grafica">
                        <h3>Tendencia Semanal de Llamadas</h3>
                        <canvas id="report-day-chart" width="${chartSize}" height="${chartSize}" style="width: ${chartSize}px !important; height: ${chartSize}px !important;"></canvas>
                    </div>
                `;
            }
            
            if (includeAtendio) {
                reportHTML += `
                    <div class="grafica">
                        <h3>Distribución por Servidor Público</h3>
                        <canvas id="report-atendio-chart" width="${chartSize}" height="${chartSize}" style="width: ${chartSize}px !important; height: ${chartSize}px !important;"></canvas>
                    </div>
                `;
            }
            
            if (includeDynamicChart || includeDynamicTable) {
                const selectedVariable = dynamicChartVariable.value;
                const variableCounts = {};
                const variableStatusCounts = {};
                
                data.forEach(call => {
                    const value = call[selectedVariable] || 'N/A';
                    variableCounts[value] = (variableCounts[value] || 0) + 1;
                    
                    if (!variableStatusCounts[value]) {
                        variableStatusCounts[value] = { 'Atendida': 0, 'Pendiente': 0 };
                    }
                    
                    if (call.estatus === 'Atendida') {
                        variableStatusCounts[value].Atendida += 1;
                    } else {
                        variableStatusCounts[value].Pendiente += 1;
                    }
                });
                
                if (includeDynamicChart) {
                    reportHTML += `
                        <div class="grafica">
                            <h3>Análisis Dinámico - ${selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1)}</h3>
                            <canvas id="report-dynamic-chart" width="${chartSize}" height="${chartSize}" style="width: ${chartSize}px !important; height: ${chartSize}px !important;"></canvas>
                        </div>
                    `;
                }
                
                if (includeDynamicTable) {
                    let totalAtendida = 0;
                    let totalPendiente = 0;
                    let granTotal = 0;
                    
                    reportHTML += `
                        <div class="tabla-datos">
                            <h3>Distribución Detallada por Estatus - ${selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1)}</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>${selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1)}</th>
                                        <th>Atendidas</th>
                                        <th>Pendientes</th>
                                        <th>Total</th>
                                        <th>% Efectividad</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    Object.entries(variableStatusCounts).forEach(([value, counts]) => {
                        const total = counts.Atendida + counts.Pendiente;
                        const effectiveness = total > 0 ? ((counts.Atendida / total) * 100).toFixed(1) : '0.0';
                        const effClass = effectiveness >= 75 ? 'effectiveness-high' : effectiveness >= 50 ? 'effectiveness-medium' : 'effectiveness-low';
                        totalAtendida += counts.Atendida;
                        totalPendiente += counts.Pendiente;
                        granTotal += total;
                        
                        reportHTML += `

                            <tr>
                                <td style="font-weight: 500; font-size: 16px;">${value}</td>
                                <td class="atendida" style="font-size: 16px;">${counts.Atendida}</td>
                                <td class="pendiente" style="font-size: 16px;">${counts.Pendiente}</td>
                                <td style="font-weight: 600; font-size: 16px;">${total}</td>
                                <td class="${effClass}" style="font-size: 16px;">${effectiveness}%</td>
                            </tr>


                        `;
                    });
                    
                    const overallEffectiveness = granTotal > 0 ? ((totalAtendida / granTotal) * 100).toFixed(1) : '0.0';
                    
                    reportHTML += `
                                </tbody>
                                <tfoot>
                                    <tr style="background: linear-gradient(135deg, #9C2348 0%, #7c1d3a 100%); color: white; font-weight: bold;">
                                        <td>TOTAL GENERAL</td>
                                        <td>${totalAtendida}</td>
                                        <td>${totalPendiente}</td>
                                        <td>${granTotal}</td>
                                        <td>${overallEffectiveness}%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    `;
                }
            }
            
            reportHTML += `
                    <div class="reporte-footer">
                        <p>Registro de LLamadas - SIOCIN</p>
                        <p>Gobierno de México - Generado el ${new Date().toLocaleString('es-ES')}</p>
                    </div>
                </div>
            `;
            
            // Renderizar el preview con los estilos aplicados
            reportPreview.innerHTML = reportHTML;
            reportPreview.classList.remove('hidden');
            
            // Función mejorada para renderizar gráficos con configuraciones optimizadas
            const renderOptimizedChart = (canvasId, chartConfig) => {
                return new Promise((resolve) => {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return resolve();
                    
                    // Configurar dimensiones exactas del canvas para alta resolución
                    const ctx = canvas.getContext('2d');
                    canvas.width = chartSize * 3;
                    canvas.height = chartSize * 3;
                    canvas.style.width = `${chartSize}px`;
                    canvas.style.height = `${chartSize}px`;
                    
                    // Configuración optimizada para PDF, con fonts mayores
                    const optimizedConfig = {
                        ...chartConfig,
                        options: {
                            ...chartConfig.options,
                            responsive: false,
                            maintainAspectRatio: false,
                            devicePixelRatio: 3,
                            animation: {
                                duration: 0
                            },
                            plugins: {
                                ...chartConfig.options.plugins,
                                legend: {
                                    ...chartConfig.options.plugins?.legend,
                                    labels: {
                                        boxWidth: 15,
                                        padding: 15,
                                        font: {
                                            size: fontBase, // Labels casi como título
                                            weight: 'bold'
                                        },
                                        usePointStyle: true
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    ...chartConfig.options.scales?.y,
                                    ticks: {
                                        ...chartConfig.options.scales?.y?.ticks,
                                        font: { size: fontBase - 2 }
                                    }
                                },
                                x: {
                                    ...chartConfig.options.scales?.x,
                                    ticks: {
                                        ...chartConfig.options.scales?.x?.ticks,
                                        font: { size: fontBase - 2 },
                                        maxRotation: 45
                                    }
                                }
                            }
                        }
                    };
                    
                    // Crear el gráfico y esperar a que se renderice
                    const chart = new Chart(ctx, optimizedConfig);
                    
                    // Esperar múltiples ciclos de renderizado para asegurar completitud
                    setTimeout(() => {
                        chart.update('none');
                        setTimeout(resolve, 300);
                    }, 300);
                });
            };
            
            // Renderizar todos los gráficos de forma secuencial y optimizada
            const renderAllChartsOptimized = async () => {
                const chartsToRender = [];
                
                if (includeStatus) {
                    chartsToRender.push({
                        canvasId: 'report-status-chart',
                        config: {
                            type: 'pie',
                            data: {
                                labels: Object.keys(statusCounts),
                                datasets: [{
                                    data: Object.values(statusCounts),
                                    backgroundColor: globalColorPalette.primary,
                                    borderColor: '#ffffff',
                                    borderWidth: 3
                                }]
                            },
                            options: {
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        }
                    });
                }
                
                if (includeAsunto) {
                    chartsToRender.push({
                        canvasId: 'report-asunto-chart',
                        config: {
                            type: 'bar',
                            data: {
                                labels: Object.keys(asuntoCounts),
                                datasets: [{
                                    label: 'Llamadas por Asunto',
                                    data: Object.values(asuntoCounts),
                                    backgroundColor: globalColorPalette.secondary[0],
                                    borderColor: globalColorPalette.secondary[1],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: '#e2e8f0'
                                        },
                                        ticks: {
                                            font: { size: 11 }
                                        }
                                    },
                                    x: {
                                        grid: {
                                            display: false
                                        },
                                        ticks: {
                                            font: { size: 11 },
                                            maxRotation: 45
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                if (includeDay) {
                    const daysOrder = ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo'];
                    const orderedData = daysOrder.map(day => dayOfWeekCounts[day] || 0);
                    
                    chartsToRender.push({
                        canvasId: 'report-day-chart',
                        config: {
                            type: 'line',
                            data: {
                                labels: daysOrder.map(day => day.charAt(0).toUpperCase() + day.slice(1)),
                                datasets: [{
                                    label: 'Llamadas por Día',
                                    data: orderedData,
                                    borderColor: globalColorPalette.accent[0],
                                    backgroundColor: globalColorPalette.accent[0] + '20',
                                    borderWidth: 4,
                                    tension: 0.5,
                                    fill: true,
                                    pointRadius: 7,
                                    pointHoverRadius: 9,
                                    pointBackgroundColor: globalColorPalette.accent[0],
                                    pointBorderColor: '#ffffff',
                                    pointBorderWidth: 3
                                }]
                            },
                            options: {
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: '#e2e8f0'
                                        }
                                    },
                                    x: {
                                        grid: {
                                            display: false
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                if (includeAtendio) {
                    chartsToRender.push({
                        canvasId: 'report-atendio-chart',
                        config: {
                            type: 'bar',
                            data: {
                                labels: Object.keys(atendioCounts),
                                datasets: [{
                                    data: Object.values(atendioCounts),
                                    backgroundColor: globalColorPalette.neutral,
                                    borderColor: '#ffffff',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            }
                        }
                    });
                }
                
                if (includeDynamicChart) {
                    const selectedVariable = dynamicChartVariable.value;
                    const variableCounts = {};
                    
                    data.forEach(call => {
                        const value = call[selectedVariable] || 'N/A';
                        variableCounts[value] = (variableCounts[value] || 0) + 1;
                    });
                    
                    chartsToRender.push({
                        canvasId: 'report-dynamic-chart',
                        config: {
                            type: 'bar',
                            data: {
                                labels: Object.keys(variableCounts),
                                datasets: [{
                                    label: 'Cantidad',
                                    data: Object.values(variableCounts),
                                    backgroundColor: globalColorPalette.primary[0],
                                    borderColor: globalColorPalette.primary[1],
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                indexAxis: Object.keys(variableCounts).length > 10 ? 'y' : 'x',
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: '#e2e8f0'
                                        }
                                    },
                                    x: {
                                        grid: {
                                            display: false
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                        
                // Renderizar todos los gráficos secuencialmente
                for (const chartData of chartsToRender) {
                    await renderOptimizedChart(chartData.canvasId, chartData.config);
                }
            };
            
            // Proceso de generación PDF mejorado con múltiples validaciones
            const generateOptimizedPDF = async () => {
                try {
                    // Esperar a que todos los gráficos se rendericen completamente
                    await renderAllChartsOptimized();
                    
                    // Espera adicional para asegurar renderizado completo
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Configuración optimizada de html2pdf
                    const pdfOptions = {
                        margin: [10, 10, 10, 10], // Reset para simetría, manejar con CSS
                        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }, // Fix cortes
                        filename: `reporte_ejecutivo_llamadas_${new Date().toISOString().slice(0, 10)}.pdf`,
                        image: { 
                            type: 'jpeg', 
                            quality: 1.0
                        },
                        html2canvas: { 
                            scale: 3,
                            useCORS: true,
                            allowTaint: true,
                            logging: false,
                            letterRendering: true,
                            height: reportPreview.scrollHeight,
                            width: 800, // Forzar width para centering
                            windowWidth: 800,
                            scrollX: 0,
                            scrollY: 0,
                            backgroundColor: '#ffffff'
                        },
                        jsPDF: { 
                            unit: 'mm', 
                            format: 'a4', 
                            orientation: 'portrait',
                            compress: true
                        }
                    };
                    
                    // Generar y descargar el PDF
                    await html2pdf().set(pdfOptions).from(reportPreview).save();
                    
                    showAlert("✅ Reporte ejecutivo generado y descargado exitosamente", "success");
                    
                } catch (error) {
                    console.error("Error detallado al generar PDF:", error);
                    showAlert(`❌ Error al generar el PDF: ${error.message}`, "error");
                } finally {
                    // Ocultar preview después de la generación
                    setTimeout(() => {
                        reportPreview.classList.add('hidden');
                    }, 1000);
                }
            };
            
            // Iniciar el proceso de generación
            generateOptimizedPDF();
        }








        // =============================================
        // MÓDULO: Exportación/Importación
        // =============================================

        // Encabezados de exportación (orden correcto)
        const exportHeaders = [
        "No.", "Fecha", "Inicio", "Fin", "Duración", "Área", "Institución",
        "Asunto", "Consulta", "Nombre", "Cargo", "Correo", "Teléfono",
        "Estatus", "Atendió", "Comentarios"
        ];

        function secondsToExcelDate(seconds) {
        // Convertir segundos a objeto Date (para que Excel lo interprete como tiempo)
        return new Date(0, 0, 0, 0, 0, seconds || 0);
        }
 
        function prepareExportData(data) {
            return data.map((call, index) => ({
                "No.": index + 1, 
                "Fecha": call.fecha || "", 
                "Inicio": formatTimeWithAmPm(call.inicio),
                "Fin": formatTimeWithAmPm(call.fin), 
                "Duración": formatDuration(
                    call.duracion instanceof Date 
                        ? (call.duracion.getHours() * 3600 + call.duracion.getMinutes() * 60 + call.duracion.getSeconds()) 
                        : (Number(call.duracion) || 0)
                ),
                "Área": call.area || "", 
                "Institución": call.institucion || "", 
                "Asunto": call.asunto || "",
                "Consulta": call.consulta || "", 
                "Nombre": call.nombre || "", 
                "Cargo": call.cargo || "",
                "Correo": call.correo || "", 
                "Teléfono": String(call.telefono || ""), 
                "Estatus": call.estatus || "",
                "Atendió": call.atendio || "", 
                "Comentarios": call.comentarios || ""
            }));
        }

        // =============================================
        // MÓDULO: Migración de datos
        // =============================================
        

        async function migrateCallsToHistorical() {
            try {
                if (calls.length === 0) {
                    showAlert("No hay llamadas para migrar.", "warning");
                    return;
                }
                
                // Mostrar loader para bloquear interacciones durante migración
                showLoader(true);
                
                const batch = writeBatch(db);
                const callsCount = calls.length; // Guardar el count antes de limpiar
                
                calls.forEach(call => {
                    const historicalDocRef = doc(historicalCallsCollectionRef);
                    const { id, ...callData } = call; // Omitir el id antiguo
                    batch.set(historicalDocRef, { 
                        ...callData,  // Usar solo los datos sin el id
                        migratedAt: serverTimestamp(),
                        originalId: id  // Guardar el id original en un campo separate
                    });
                });
                
                calls.forEach(call => {
                    const callDocRef = doc(callsCollectionRef, call.id);
                    batch.delete(callDocRef);
                });
                
                await batch.commit();
                
                // Sincronización manual: Limpiar calls local y re-render inmediatamente
                calls = [];
                sortAndRenderTable(callLogTableBody, calls, false);
                
                // Actualizar dashboard y charts
                updateDashboard();
                updateCharts();
                
                showAlert(`Se migraron ${callsCount} llamadas al histórico.`, "success");
            } catch (error) {
                console.error("Error al migrar llamadas:", error);
                showAlert(`Error al migrar: ${error.message}`, "error");
            } finally {
                showLoader(false);
            }
        }

        // Añadir función showLoader si no existe
        function showLoader(show) {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }


        // =============================================
        // MÓDULO: Configuración de eventos 
        // =============================================
        
        function setupEventListeners() {
            setupTabs();
            setupColumnFilters('main-table-header', () => calls, renderTable, 'main');
            setupColumnFilters('historical-table-header', () => historicalCalls, renderTable, 'historical');
            setupFiltering('filter-input-main', () => calls, renderTable, false);
            setupFiltering('filter-input-historical', () => historicalCalls, renderTable, true);
            setupAutofill();
            
            // Dashboard ya jala Registro y Control como predeterminado en fuente de datos
            dashboardDataSource.addEventListener('change', updateDashboard);
            
            // Establecer "Histórico" como valor predeterminado en fuente de datos
            reportesDataSource.addEventListener('change', updateCharts);
            reportesDataSource.value = 'historico'; 


            dynamicChartVariable.addEventListener('change', updateDynamicChart);
            
            startCallBtn.addEventListener('click', () => {
                startCallBtn.dataset.state === 'active' ? (stopTimer(false), closeModal(callModal)) : startTimer();
            });
            
            closeModalBtn.addEventListener('click', () => {
                closeModal(callModal);
                if (startCallBtn.dataset.state === 'active') stopTimer(false);
            });
            
            callForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!callForm.checkValidity()) return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                stopTimer();
                closeModal(callModal);
            });
            
            closeEditModalBtn.addEventListener('click', () => closeModal(editModal));
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!editForm.checkValidity()) return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                
                const formData = new FormData(editForm);
                const updateData = Object.fromEntries(formData.entries());
                const id = document.getElementById('edit-id').value;
                
                await updateCall(id, updateData, currentEditIsHistorical);
                closeModal(editModal);
            });

            let callToDeleteId = null;
            let callToDeleteIsHistorical = false;

            function handleDeleteClick(e) {
                requirePassword(() => {
                    callToDeleteId = e.currentTarget.dataset.id;
                    callToDeleteIsHistorical = e.currentTarget.dataset.isHistorical === 'true';
                    openModal(confirmModal);
                });
            }


            let isProgrammaticChange = false;

            // Reemplazar la función handleEditClick con esta versión corregida
            function handleEditClick(event) {
                requirePassword(() => {
                    const button = event.currentTarget;
                    const callId = button.getAttribute('data-id');
                    const isHistorical = button.getAttribute('data-is-historical') === 'true';

                    if (!callId) {
                        console.error("ID de llamada no encontrado para edición");
                        return;
                    }

                    currentEditIsHistorical = isHistorical;
                    const allData = isHistorical ? historicalCalls : calls;
                    const callToEdit = allData.find(call => call.id === callId);

                    if (!callToEdit) {
                        showAlert("No se pudo encontrar la llamada para editar", "error");
                        return;
                    }

                    document.getElementById('edit-id').value = callId;

                    // Desactivar autofill durante la carga inicial
                    isProgrammaticChange = true;
                    
                    $('#edit-caller-institution').val(callToEdit.institucion || '').trigger('change.select2');
                    $('#edit-call-area').val(callToEdit.area || '').trigger('change.select2');
                    $('#edit-call-subject').val(callToEdit.asunto || '').trigger('change.select2');
                    $('#edit-call-query').val(callToEdit.consulta || '').trigger('change.select2');
                    $('#edit-caller-name').val(callToEdit.nombre || '').trigger('change.select2');
                    $('#edit-caller-cargo').val(callToEdit.cargo || '').trigger('change.select2');
                    $('#edit-caller-email').val(callToEdit.correo || '').trigger('change.select2');
                    $('#edit-caller-phone').val(callToEdit.telefono || '').trigger('change.select2');
                    $('#edit-call-comments').val(callToEdit.comentarios || '').trigger('change.select2');
                    $('#edit-call-atendio').val(callToEdit.atendio || '').trigger('change.select2');

                    // Reactivar autofill después de la carga
                    setTimeout(() => {
                        isProgrammaticChange = false;
                    }, 100);

                    openModal(editModal);
                });
            }




            // Funcion para actualizar estatus
            async function handleStatusToggle(e) {
                const button = e.currentTarget;
                const callId = button.dataset.id;
                const isHistorical = button.dataset.isHistorical === 'true';
                const currentStatus = button.textContent.trim();
                const newStatus = currentStatus === 'Atendida' ? 'Pendiente' : 'Atendida';
                await updateCall(callId, { estatus: newStatus }, isHistorical);
            }

            callLogTableBody.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('edit-btn')) handleEditClick({ currentTarget: target });
                if (target.classList.contains('delete-btn')) handleDeleteClick({ currentTarget: target });
                if (target.classList.contains('toggle-status-btn')) handleStatusToggle({ currentTarget: target });
            });

            // Estatus tabla de histórico
            historicalTableBody.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                if (target.classList.contains('edit-btn')) handleEditClick({ currentTarget: target });
                if (target.classList.contains('delete-btn')) handleDeleteClick({ currentTarget: target });
                if (target.classList.contains('toggle-status-btn')) handleStatusToggle({ currentTarget: target });
            });


            // Cancelar Eliminar llamada de historico
            cancelDeleteBtn.addEventListener('click', () => {
                closeModal(confirmModal);
                callToDeleteId = null;
            });
            
            // Eliminar llamada de historico
            confirmDeleteBtn.addEventListener('click', async () => {
                if (callToDeleteId) {
                    await deleteCall(callToDeleteId, callToDeleteIsHistorical);
                    closeModal(confirmModal);
                }
            });


            // Importar histórico
            historicalFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    historicalFileName.textContent = file.name;
                    importHistoricalBtn.disabled = false;
                } else {
                    historicalFileName.textContent = 'Seleccionar archivo Excel (.xlsx)';
                    importHistoricalBtn.disabled = true;
                }
            });

            // Importar histórico
            importHistoricalBtn.addEventListener('click', () => {
                requirePassword(async () => {
                    const file = historicalFileInput.files[0];
                    if (!file) {
                        showAlert("Por favor, selecciona un archivo Excel primero.", "warning");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = async (e) => {  // Hacer onload async para permitir await dentro
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            if (jsonData.length === 0) return showAlert("El archivo no contiene datos válidos.", "warning");

                            const processedData = jsonData.map(row => {  // Corregir json a jsonData
                                const mapKeys = (obj, keyMap) => Object.keys(obj).reduce((acc, key) => {
                                    const newKey = keyMap[key.toLowerCase().trim()] || key.toLowerCase().trim();
                                    acc[newKey] = obj[key];
                                    return acc;
                                }, {});

                                const keyMapping = { 'no.': 'no', 'duración': 'duracion', 'área': 'area', 'institución': 'institucion', 'teléfono': 'telefono', 'atendió': 'atendio' };
                                const mappedRow = mapKeys(row, keyMapping);

                                // No asignar fechas/horas actuales si vienen vacías
                                let fecha = mappedRow.fecha;
                                let inicio = mappedRow.inicio;
                                let fin = mappedRow.fin;
                                let duracion = mappedRow.duracion;
                                
                                if (fecha instanceof Date) {
                                    fecha = fecha.toLocaleDateString('es-ES');
                                } else if (!fecha) {
                                    fecha = ''; // Dejar vacío en lugar de asignar fecha actual
                                }
                                
                                if (inicio instanceof Date) {
                                    inicio = inicio.toLocaleTimeString('es-ES', { hour12: false });
                                } else if (!inicio) {
                                    inicio = ''; // Dejar vacío
                                }
                                
                                if (fin instanceof Date) {
                                    fin = fin.toLocaleTimeString('es-ES', { hour12: false });
                                } else if (!fin) {
                                    fin = ''; // Dejar vacío
                                }

                                if (typeof duracion === 'number') {
                                    if (duracion < 1) {
                                        duracion = Math.round(duracion * 86400); // Decimal a segundos
                                    }
                                } else if (typeof duracion === 'string') {
                                    const timeParts = duracion.split(':');
                                    if (timeParts.length === 3) {
                                        duracion = (parseInt(timeParts[0]) * 3600) +
                                                (parseInt(timeParts[1]) * 60) +
                                                parseInt(timeParts[2]);
                                    } else {
                                        duracion = parseInt(duracion) || 0;
                                    }
                                } else if (duracion instanceof Date) {
                                    duracion = (duracion.getHours() * 3600) +
                                            (duracion.getMinutes() * 60) +
                                            duracion.getSeconds();
                                } else {
                                    duracion = 0;
                                }

                                return {
                                    fecha: fecha,
                                    inicio: inicio,
                                    fin: fin,
                                    duracion: duracion,
                                    area: mappedRow.area || '',
                                    institucion: mappedRow.institucion || '',
                                    asunto: mappedRow.asunto || '',
                                    consulta: mappedRow.consulta || '',
                                    nombre: mappedRow.nombre || '',
                                    cargo: mappedRow.cargo || '',
                                    correo: mappedRow.correo || '',
                                    telefono: String(mappedRow.telefono || ''),
                                    estatus: mappedRow.estatus || 'Pendiente',
                                    atendio: mappedRow.atendio || '',
                                    comentarios: mappedRow.comentarios || ''
                                };
                            });

                            if (processedData.length === 0) return showAlert("El archivo Excel está vacío o no es válido.", "warning");
                            
                            let replace = false;
                            if (historicalCalls.length > 0) {
                                openModal(replaceHistoricalModal);
                                await new Promise(resolve => {
                                    confirmReplaceBtn.onclick = () => {
                                        replace = true;
                                        closeModal(replaceHistoricalModal);
                                        resolve();
                                    };
                                    cancelReplaceBtn.onclick = () => {
                                        replace = false;
                                        closeModal(replaceHistoricalModal);
                                        resolve();
                                    };
                                });
                                if (replace) {
                                    await deleteAllHistorical();
                                }
                            }
                            await importHistoricalData(processedData);
                            historicalFileInput.value = '';
                            historicalFileName.textContent = 'Seleccionar archivo Excel (.xlsx)';
                            importHistoricalBtn.disabled = true;                        
                        
                        } catch (error) {
                            console.error("Error al procesar el archivo:", error);
                            showAlert("Error al procesar el archivo. Asegúrese de que es un Excel válido.", "error");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            });

            // Registro de llamadas descargar
            downloadExcelBtn.addEventListener('click', () => {
                if (calls.length === 0) return showAlert("No hay datos para descargar.", "warning");
                const data = prepareExportData(calls);
                const ws = XLSX.utils.json_to_sheet(data, { header: exportHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Llamadas");
                XLSX.writeFile(wb, "registro_llamadas.xlsx");
            });
            
            // Registro histórico descargar
            document.getElementById('download-historical-excel-btn').addEventListener('click', () => {
                if (historicalCalls.length === 0) return showAlert("No hay datos históricos para descargar.", "warning");
                const data = prepareExportData(historicalCalls);
                const ws = XLSX.utils.json_to_sheet(data, { header: exportHeaders });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Llamadas Históricas");
                XLSX.writeFile(wb, "Registro_historico.xlsx");
            });
            
            // Generar Reporte Boton
            generateReportBtn.addEventListener('click', () => openModal(reportModal));
            closeReportModalBtn.addEventListener('click', () => closeModal(reportModal));
            

            // Generar PDF
            generatePdfBtn.addEventListener('click', () => {
                const includeStatus = document.getElementById('include-status').checked;
                const includeAsunto = document.getElementById('include-asunto').checked;
                const includeDay = document.getElementById('include-day').checked;
                const includeAtendio = document.getElementById('include-atendio').checked;
                const includeDynamicChart = document.getElementById('include-dynamic-chart').checked;
                const includeDynamicTable = document.getElementById('include-dynamic-table').checked;
                
                closeModal(reportModal);
                generateExecutiveReport(includeStatus, includeAsunto, includeDay, includeAtendio, includeDynamicChart, includeDynamicTable);
            });
            
            // slider pixeles
            chartSizeSlider.addEventListener('input', () => {
                const size = chartSizeSlider.value;
                chartSizeValue.textContent = `${size}px`;
                updateCharts();
            });

            // Migración de historial
            migrateCallsBtn.addEventListener('click', () => {
                requirePassword(() => openModal(migrateModal));
            });
            
            // Cancelar migración de historial
            cancelMigrateBtn.addEventListener('click', () => closeModal(migrateModal));
            

            // Confirmar migración de historial corregida Versión 2
            confirmMigrateBtn.addEventListener('click', async () => {
                try {
                    await migrateCallsToHistorical();
                    closeModal(migrateModal);
                } catch (error) {
                    console.error("Error en migración:", error);
                    showAlert("Error durante la migración: " + error.message, "error");
                }
            });

        }

        // Forzar actualización de opciones y render

        // =============================================
        // MÓDULO: Inicialización
        // =============================================

        function initialize() {
            initializeAppWithAuth();
            setupEventListeners();
            setupAddEditButtons();
            setupPasswordVerification();
            setupReportConfig();
            
            // Configurar Select2 para todos los selects
            $('#call-form select, #edit-form select').each(function() {
                $(this).select2({
                    tags: true,
                    placeholder: "Seleccione o escriba una opción",
                    allowClear: true,
                    width: '100%' 
                }); 
            });
        }

        // Iniciar la aplicación
        initialize();



    </script>
</body> 
</html> 
