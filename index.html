<!DOCTYPE html> 
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario en Línea de Registro de Llamadas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Plugin de Chart.js para etiquetas de datos (necesario para el PDF) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- xlsx-js-style para leer/escribir archivos de Excel con estilos -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style/dist/xlsx.bundle.js"></script>
    
    <!-- PivotTable.js para tabla dinámica interactiva -->
    <link rel="stylesheet" type="text/css" href="https://pivottable.js.org/dist/pivot.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://pivottable.js.org/dist/pivot.min.js"></script>
    
    <!-- Select2 for searchable dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- html2pdf para generar reportes en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Hoja de estilos personalizada -->
    <style>
        /* ============================================= */
        /* === ESTILOS GLOBALES Y PALETA DE COLORES === */
        /* ============================================= */

        html { font-size: 60%; } /* Ajusta la escala base de la página para simular un zoom del 90% */
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        
        /* Paleta de colores principal (usada en header, botones primarios) */
        .bg-primary { background-color: #9C2348; }
        .text-primary { color: #9C2348; }
        .border-primary { border-color: #9C2348; }
        .focus\:ring-primary:focus { --tw-ring-color: #9C2348; }
        
        /* Colores de estado: Éxito */
        .bg-success { background-color: #10B981; }
        .hover\:bg-success-dark:hover { background-color: #059669; }
        
        /* Colores de estado: Peligro/Error */
        .bg-danger { background-color: #EF4444; }
        .hover\:bg-danger-dark:hover { background-color: #DC2626; }
        
        /* Variable CSS para colores dinámicos (usada en highlights) */
        :root {
            --primary-color: #A6802D; /* Color primario por defecto */
        }

        /* ============================================= */
        /* === LAYOUT Y ESTRUCTURA PRINCIPAL === */
        /* ============================================= */

        /* Aumenta el ancho máximo del contenedor principal para ocupar más pantalla */
        .max-w-7xl {
            max-width: 100% !important;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* Ajustes para la barra de pestañas y el header pegajoso */
        .bg-white.shadow-sm.sticky { margin-top: -1px !important; }
        #tabs { margin-top: 0 !important; }
        header + div { top: 56px !important; } /* Elimina hueco entre header y tabs */

        /* Estilos para los títulos de sección en los formularios */
        .section-title { font-weight: bold; color: #9C2348; margin-bottom: 1rem; }

        /* ============================================= */
        /* === COMPONENTES DE UI GENERALES === */
        /* ============================================= */

        /* Loader/Spinner de carga inicial */
        .loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: rgba(255, 255, 255, 0.9); z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
        }
        .loader .spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; 
            border-left-color: #9C2348; animation: spin 1s ease infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Pestañas de navegación (Registro, Histórico, Reportes) */
        .tab-btn.active { border-color: #9C2348; color: #9C2348; font-weight: bold; }

        /* Botones de estado (Saliente/Entrante) en las tablas */
        .status-button {
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem;
            line-height: 1.25rem; font-weight: 500; text-align: center; user-select: none; border: 1px solid transparent;
        }
        .status-saliente { background-color: #10B981; color: #fff; border-color: #059669; } /* Verde */
        .status-entrante { background-color: #3B82F6; color: #fff; border-color: #2563EB; } /* Azul */

        /* Botón de migración */
        .migrate-btn { background-color: #1E5B4F !important; }
        .migrate-btn:hover { background-color: #16463c !important; }

        /* ============================================= */
        /* === DASHBOARD Y TARJETAS INDICADORAS === */
        /* ============================================= */

        /* Estilo para la tarjeta de día cuando está seleccionada como filtro */
        .indicator-card.active-filter {
            box-shadow: 0 0 0 2px var(--primary-color), 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-2px);
        }
        /* Estilo para resaltar la tarjeta del día actual */
        .indicator-card.current-day-highlight {
            border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            background-color: #fcfdff;
        }

        /* ============================================= */
        /* === MODALES === */
        /* ============================================= */

        /* Animaciones de entrada y salida para modales */
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        /* Clase para bloquear el scroll del body cuando un modal está abierto */
        body.modal-open { overflow: hidden; }

        /* Ancho para modales grandes (Nueva/Editar llamada, Ver Detalles) */
        .wide-modal .relative { max-width: 76rem !important; }

        /* Contenedor con scroll para formularios largos dentro de modales */
        .call-form-container {
            max-height: 75vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .call-form-container::-webkit-scrollbar { width: 6px; }
        .call-form-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .call-form-container::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 10px; }
        .call-form-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Estilos para el modal de detalles de la llamada */
        .details-modal-content {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 2rem;
            background-color: #f9fafb;
        }
        .details-header {
            border-bottom: 2px solid #9C2348;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        .details-header .date { font-size: 1rem; color: #6b7280; font-weight: 500; }
        .details-section { margin-bottom: 1.5rem; }
        .details-section h4 { font-size: 1.125rem; font-weight: 600; color: #9C2348; margin-bottom: 0.75rem; }
        .editable-header { cursor: pointer; transition: color 0.2s ease-in-out; }
        .editable-header:hover { color: #A6802D; } /* Color primario al pasar el ratón */

        /* ============================================= */
        /* === COMPONENTES DE TABLA === */
        /* ============================================= */

        /* Contenedor principal de las tablas con scroll */
        .table-container { 
            overflow-x: auto; 
            max-height: 430px; 
            overflow-y: auto;
            width: 100%;
        }
        #historical-table-container { max-height: 425px; } /* Altura específica para tabla de histórico */

        /* Ancho de la tabla interna para evitar compresión de columnas */
        .table-container table {
            width: 100%;
            min-width: 1300px; 
        }

        /* Encabezados de tabla fijos (sticky) */
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f1f5f9; /* Evita transparencia al hacer scroll */
        }

        /* Estilos para la barra de scroll de las tablas */
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #c5c5c5; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* ============================================= */
        /* === FILTROS DE TABLA === */
        /* ============================================= */

        /* Encabezados de columna con capacidad de filtro */
        .filterable-header { 
            cursor: pointer; 
            position: relative;
        }
        .filterable-header .filter-icon { opacity: 0.5; transition: opacity 0.2s; }
        .filterable-header:hover .filter-icon,
        .filterable-header.active .filter-icon { opacity: 1; color: #9C2348; }

        /* Menú desplegable para filtros de columna */
        .filter-dropdown {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 6px;
            z-index: 20;
            max-height: 250px;
            overflow-y: auto;
            min-width: 200px;
        }

        /* Resaltado para el texto de búsqueda en las tablas */
        .highlight {
            background-color: #ffd966;
            border-radius: 2px;
        }

        /* ============================================= */
        /* === FORMULARIOS Y CAMPOS (Select2) === */
        /* ============================================= */

        /* Estilo para campos de formulario inválidos */
        input:invalid, select:invalid { border-color: #ef4444; }

        /* Grid para la disposición de campos en formularios */
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 640px) { .form-grid { grid-template-columns: repeat(2, 1fr); } }

        .form-field { margin-bottom: 0.5rem; }
        .form-field label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #374151; }

        /* Contenedor para un campo Select2 y sus botones de acción (editar) */
        .flex-with-buttons {
            display: flex;
            align-items: flex-end;
            max-width: 340px;
            min-width: 340px;
        }
        .flex-with-buttons .select2-container { flex-grow: 1; margin-bottom: 1px; min-width: 0; }
        .flex-with-buttons button {
            height: 38px; width: 38px;
            margin-bottom: 1px; /* Alineación vertical */
            flex-shrink: 0;
            border-radius: 0.25rem;
            padding: 0.5rem;
            display: flex; align-items: center; justify-content: center;
            border: none;
            cursor: pointer;
        }
        .flex-with-buttons button.edit-btn { background-color: #A6802D; color: white; }
        .flex-with-buttons button.edit-btn:hover { background-color: #8a6b22; }

        /* Estilos para normalizar la apariencia de Select2 con Tailwind */
        .select2-container--default .select2-selection--single {
            height: 38px; padding: 5px; border: 1px solid #d1d5db; border-radius: 0.375rem;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered { line-height: 26px; }
        .select2-container--default .select2-selection--single .select2-selection__arrow { height: 36px; }
        .select2-container { width: 100% !important; }

        /* Truncar texto largo en los campos Select2 para evitar desbordamiento */
        .select2-container .select2-selection--single .select2-selection__rendered {
            display: block;
            padding-left: 8px;
            padding-right: 20px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* ============================================= */
        /* === REPORTES Y GRÁFICOS === */
        /* ============================================= */

        /* Configuración del grid para el modal de configuración de reportes */
        .config-report-grid {
            display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1.5rem;
        }
        @media (min-width: 640px) {
            .config-report-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        .config-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .config-option input[type="checkbox"] { margin-right: 0.5rem; }

        /* Controles de tamaño para los gráficos en la pestaña de reportes */
        .chart-size-control {
            margin: 15px 0; display: flex; align-items: center; gap: 10px;
        }
        .chart-size-control label { font-size: 14px; color: #374151; }
        .chart-size-control input { width: 150px; }

        /* Contenedor de cada gráfico */
        .chart-wrapper { position: relative; height: 300px; /* Altura por defecto, se ajustará con JS */ }
        #reportes .grid {
            gap: 3rem 2rem; 
            margin-bottom: 2rem; 
        }

        /* Nuevos estilos para la versión 1.3 */
        .dynamic-chart-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Encabezado del contenedor del gráfico dinámico (con selector de variable) */
        .dynamic-chart-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }
        
        /* Contenido del gráfico dinámico (gráfico a la izquierda, tabla a la derecha) */
        .dynamic-chart-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .dynamic-table-container {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Tabla de datos que acompaña al gráfico dinámico */
        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .dynamic-table th, .dynamic-table td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }
        
        .dynamic-table th {
            background-color: #9C2348;
            color: white;
            font-weight: 600;
        }
        
        .dynamic-table tr:nth-child(even) {
            background-color: #f3f4f6;
        }

        /* Botón para alternar etiquetas en el gráfico dinámico */
        #toggle-labels-btn { transition: all 0.3s ease; }
        #toggle-labels-btn.bg-primary { background-color: #9C2348 !important; }

        /* Estilos para el reporte ejecutivo en PDF */
        .reporte-ejecutivo { padding: 20px; background: white; font-family: 'Inter', sans-serif; }
        .reporte-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #9C2348; padding-bottom: 20px; }
        .reporte-metricas { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .metrica { background: #f9fafb; padding: 15px; border-radius: 8px; border-left: 4px solid #9C2348; }
        .graficas-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .grafica { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tabla-datos { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .tabla-datos th, .tabla-datos td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        .tabla-datos th { background-color: #f9fafb; }

        /* ============================================= */
        /* === TOOLTIPS Y VISTAS RÁPIDAS === */
        /* ============================================= */

        /* Estilos para el tooltip de vista rápida (replicado de la app de licitaciones) */
        #quick-view-tooltip {
            position: fixed; /* Flota sobre toda la página */
            display: none;   /* Oculto por defecto */
            background-color: #ffffff; /* Fondo blanco */
            color: #374151; /* Texto oscuro (gray-700) */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb; /* Borde sutil (gray-200) */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* Sombra más pronunciada */
            z-index: 100;
            pointer-events: none; /* Para que no interfiera con el cursor */
            font-size: 0.9rem; /* Tamaño de fuente mejorado */
            line-height: 1.5;
            max-width: 350px;
            transition: opacity 0.2s ease-in-out;
            opacity: 0;
        }
        #quick-view-tooltip .duration-highlight { 
            font-size: 1.1rem; font-weight: 700; color: var(--secondary-color); 
            text-align: right; border-top: 1px solid #e5e7eb; padding-top: 0.5rem; margin-top: 0.5rem;
        }
        #quick-view-tooltip .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        #quick-view-tooltip .status-dot.saliente { background-color: #10B981; } /* success-color */
        #quick-view-tooltip .status-dot.entrante { background-color: #3B82F6; } /* blue-500 */
        #quick-view-tooltip.visible {
            display: block;
            opacity: 1;
        }
        #quick-view-tooltip strong { color: var(--secondary-color); } /* Títulos en color secundario para mejor estética */
        #quick-view-tooltip p { margin-bottom: 0.25rem; }
        
        /* ============================================= */
        /* === VENTANAS MINIMIZABLES Y DRAGGABLES === */
        /* ============================================= */

        /* Controles en la cabecera de los modales (minimizar, cerrar) */
        .modal-header-controls button { width: 32px; height: 32px; border: none; cursor: pointer; }

        /* Estilo para una ventana minimizada en la barra inferior */
        .minimized-window {
            width: 280px;
            height: 40px;
            background-color: #fff;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px 0 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            pointer-events: all;
        }
        .minimized-window:hover {
            background-color: #f9fafb;
        }
        .minimized-window-title {
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .minimized-window-controls button {
            color: #6b7280;
            background: none;
            border: none;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .minimized-window-controls button:hover {
            background-color: #e5e7eb;
        }
        .minimized-window-controls button.close-btn:hover {
            background-color: #fee2e2;
            color: #ef4444;
        }
        #minimized-timer { margin-right: auto; margin-left: 12px; }

        /* ============================================= */
        /* === PANELES FLOTANTES (Quick History) === */
        /* ============================================= */

        #quick-history-panel {
            position: fixed;
            top: 120px;
            right: 20px;
            width: 400px;
            max-height: calc(100vh - 140px);
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            z-index: 55; /* Por encima del overlay del modal, pero debajo de otros modales */
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        #quick-history-panel.hidden { opacity: 0; transform: translateX(100%); pointer-events: none; }
        .quick-history-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1rem; border-bottom: 1px solid #e5e7eb;
            cursor: move; background-color: #f9fafb;
            border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem;
        }
        .quick-history-header .flex.items-center.space-x-2 button {
            width: 32px; height: 32px; border-radius: 0.25rem;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .quick-history-content { overflow-y: auto; padding: 1rem; flex-grow: 1; }
        .quick-history-item { padding: 0.75rem; border-bottom: 1px solid #f3f4f6; }

        /* ============================================= */
        /* === ALERTAS Y NOTIFICACIONES === */
        /* ============================================= */

        #summary-alert-container.alert-enter { animation: slideInUp 0.5s ease-out forwards; }
        #summary-alert-container.alert-leave { animation: slideOutDown 0.5s ease-in forwards; }

        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(20px); } }

    </style>

    <!-- Utilidad para ocultar elementos -->
    <style> .hidden { display: none; } </style>

    <!-- Configuración de Tailwind con nueva paleta de colores -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#A6802D',
                            light: '#bf9a41',
                            dark: '#8a6b22'
                        },
                        secondary: {
                            DEFAULT: '#9C2348',
                            light: '#b52e5a',
                            dark: '#7d1c3a'
                        },
                        accent: {
                            DEFAULT: '#1E5B4F',
                            light: '#267c6c',
                            dark: '#16463c'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Estilos para la pantalla de inicio de sesión -->
    <style>
        #login-screen {
            background: linear-gradient(135deg, #f0f2f5 0%, #e6e9ed 100%);
        }
        .login-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            overflow: hidden;
            display: flex;
            max-width: 900px;
            width: 100%;
        }
        .login-art {
            background-color: #A6802D;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 255, 255, 0.1) 0%, transparent 40%);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            width: 45%;
        }
        .login-form-container {
            padding: 3rem;
            width: 55%;
        }
        @media (max-width: 768px) {
            .login-card { flex-direction: column; }
            .login-art, .login-form-container { width: 100%; }
            .login-art { padding: 2rem 1rem; }
            .login-form-container { padding: 2rem 1.5rem; }
        }
    </style>
</head>
<body class="antialiased text-slate-700">

    <!----------------- MENSAJE DE INICIO ---------------->
    <div id="loader" class="loader">
        <div class="spinner"></div>
        <p class="mt-4 text-sm text-slate-600">Cargando datos, por favor espera...</p>
    </div>

    <!----------------- PANTALLA DE INICIO DE SESIÓN ---------------->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="login-card">
            <!-- Columna de Arte y Logo -->
            <div class="login-art">
                <img src="https://github.com/SAGB-JCM/SICOINLlamadasFormulario/blob/main/SICOINLlamadasFormulario%20-%20LOGO.png?raw=true" alt="Logo SICOIN" class="h-40 w-auto">
                <h2 class="text-2xl font-bold text-center mb-2">Sistema de Registro de Llamadas</h2>
                <p class="text-center text-sm opacity-80">Bienvenido. Por favor, inicie sesión para continuar.</p>
            </div>
            <!-- Columna del Formulario -->
            <div class="login-form-container">
                <h3 class="text-2xl font-bold text-primary mb-2">Iniciar Sesión</h3>
                <p class="text-slate-500 mb-6">Ingrese sus credenciales de acceso.</p>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-slate-600 mb-1">Correo Electrónico</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="usuario@dominio.com">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-slate-600 mb-1">Contraseña</label>
                        <div class="relative">
                            <input type="password" id="login-password" required class="w-full px-4 py-2 pr-10 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" placeholder="••••••••">
                            <button type="button" id="toggle-password-visibility" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-400 hover:text-slate-600">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                    <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all duration-300">
                        Acceder
                    </button>
                    <button type="button" id="back-to-app-btn" class="hidden w-full text-center text-sm text-slate-500 hover:text-primary mt-4">
                        Volver a la aplicación
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!----------------- INICIO DE LA APP ---------------->
    <div id="app" class="min-h-screen hidden">

        <!----------------- LOGO Y TÍTULO DE LA APP ---------------->
        <header class="bg-primary shadow-lg sticky top-0 z-30">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://github.com/SAGB-JCM/SICOINLlamadasFormulario/blob/main/SICOINLlamadasFormulario%20-%20LOGO.png?raw=true" alt="Logo Teléfono" class="h-16 w-auto">
                    <h1 class="text-xl sm:text-2xl font-bold text-white tracking-tight">Formulario en Línea de Registro de Llamadas</h1>
                </div>
                <div id="user-info-container" class="flex items-center space-x-4 hidden">
                    <span id="user-email" class="text-white text-sm font-medium"></span>
                    <button id="logout-btn" class="bg-white/20 hover:bg-white/30 text-white text-xs font-bold py-2 px-3 rounded-lg transition-colors">
                        <i class="fa-solid fa-right-from-bracket mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </header>

        <!----------------- BOTONES DE LAS PESTAÑAS ----------------> 
        <div class="bg-white shadow-sm sticky top-[96px] z-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div id="tabs" class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                        <button data-tab="registro" class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Registro y Control</button>
                        <button data-tab="historico" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Histórico</button>
                        <button data-tab="reportes" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Reportes y Gráficos</button>
                    </nav>
                </div>
            </div>
        </div>

        <!----------------- CONTENIDO DE LAS PESTAÑAS ---------------->
        <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">

            <!----------------- CONTENIDO DE LA TAB DE REGISTRO Y CONTROL (HISTORIAL DE LLAMADAS) ---------------->
            <main id="tab-content-registro" class="tab-content">
                <!----------------- SECCIÓN DE DASHBOARD PRINCIPAL ---------------->
                <section id="dashboard" class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Resumen Operativo</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <!-- Lunes -->
                        <div data-day="1" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar por Lunes">
                            <div class="bg-blue-100 p-2 rounded-full"><i data-default-icon="fa-headset" class="fa-solid fa-headset text-blue-500 text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Lunes</p><p id="calls-lunes-count" class="text-2xl font-bold text-blue-600">0</p></div>
                        </div>
                        <!-- Martes -->
                        <div data-day="2" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar por Martes">
                            <div class="bg-indigo-100 p-2 rounded-full"><i data-default-icon="fa-users-gear" class="fa-solid fa-users-gear text-indigo-500 text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Martes</p><p id="calls-martes-count" class="text-2xl font-bold text-indigo-600">0</p></div>
                        </div>
                        <!-- Miércoles -->
                        <div data-day="3" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar por Miércoles">
                            <div class="bg-purple-100 p-2 rounded-full"><i data-default-icon="fa-comments" class="fa-solid fa-comments text-purple-500 text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Miércoles</p><p id="calls-miercoles-count" class="text-2xl font-bold text-purple-600">0</p></div>
                        </div>
                        <!-- Jueves -->
                        <div data-day="4" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar por Jueves">
                            <div class="bg-pink-100 p-2 rounded-full"><i data-default-icon="fa-chart-line" class="fa-solid fa-chart-line text-pink-500 text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Jueves</p><p id="calls-jueves-count" class="text-2xl font-bold text-pink-600">0</p></div>
                        </div>
                        <!-- Viernes -->
                        <div data-day="5" class="indicator-card bg-white p-4 rounded-xl shadow-md flex items-center space-x-3 cursor-pointer transition-all duration-200" title="Hacer clic para filtrar por Viernes">
                            <div class="bg-green-100 p-2 rounded-full"><i data-default-icon="fa-phone-volume" class="fa-solid fa-phone-volume text-green-500 text-xl"></i></div>
                            <div><p class="text-sm text-slate-500">Viernes</p><p id="calls-viernes-count" class="text-2xl font-bold text-green-600">0</p></div>
                        </div>
                    </div>
                </section>

                <!----------------- HISTORIAL DE LLAMADAS - TABLA - LOG ---------------->
                <section id="call-log">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Historial de Llamadas</h2>
                        <div class="flex items-center space-x-2">
                            <button id="clear-all-filters-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap" title="Limpiar todos los filtros">
                                <i class="fa-solid fa-broom"></i>
                            </button>
                            <div class="relative w-full"><input type="text" id="filter-input-main" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"><i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i><button id="clear-filter-btn-main" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button></div>
                            <button id="start-call-btn" class="bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-phone-alt"></i><span>Iniciar Nueva Llamada</span>
                            </button>
                            <button id="download-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap"><i class="fa-solid fa-file-excel"></i><span>Descargar Excel</span></button>
                            <button id="start-migration-btn" class="migrate-btn text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-database"></i>
                                <span>Migrar Llamadas</span>
                            </button>
                            <button id="confirm-migration-btn" class="hidden bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap" disabled>
                                <i class="fa-solid fa-check"></i>
                                <span>Confirmar</span>
                            </button>
                            <button id="cancel-migration-btn" class="hidden bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-times"></i>
                                <span>Cancelar</span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="main-table-header">
                                    <th scope="col" class="py-3 px-6 migration-select-col hidden">
                                        <input type="checkbox" id="select-all-calls-checkbox" class="rounded border-gray-300 text-primary focus:ring-primary">
                                    </th>
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fecha">Fecha <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="inicio">Inicio <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fin">Fin <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="duracion">Duración <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="area">Área <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="institucion">Institución <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="asunto">Asunto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="consulta">Consulta <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="nombre">Nombre <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="cargo">Cargo <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="correo">Correo <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="telefono">Teléfono <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="estatus">Estatus <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="atendio">Atendió <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="comentarios">Comentarios <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="calls-table-body"></tbody>
                        </table>
                        <div id="no-calls-message" class="p-6 text-center text-slate-500 hidden"><p>No hay llamadas registradas en la base de datos.</p></div>
                    </div>
                </section>
            </main>

            <!----------------- CONTENIDO DE LA TAB DE HISTÓRICO ---------------->
            <div id="tab-content-historico" class="tab-content hidden">
                <section id="dashboard-historico" class="mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary mb-2 sm:mb-0">Resumen Operativo</h2>
                        <div class="flex items-center space-x-4">
                            <label for="dashboard-data-source-historico" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                            <select id="dashboard-data-source-historico" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="combinado">Registro y Control + Histórico</option>
                                <option value="registro">Registro y Control</option>
                                <option value="historico">Histórico</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl shadow-md flex items-center space-x-3"><div class="bg-primary/10 p-2 rounded-full"><i class="fa-solid fa-phone-volume text-primary text-xl"></i></div><div><p class="text-sm text-slate-500">Total de Llamadas</p><p id="total-calls-historico" class="text-2xl font-bold text-primary">0</p></div></div>
                        <div class="bg-white p-4 rounded-xl shadow-md flex items-center space-x-3"><div class="bg-primary/10 p-2 rounded-full"><i class="fa-solid fa-hourglass-half text-primary text-xl"></i></div><div><p class="text-sm text-slate-500">Duración Promedio</p><p id="avg-duration-historico" class="text-2xl font-bold text-primary">00:00</p></div></div>
                        <div class="bg-white p-4 rounded-xl shadow-md flex items-center space-x-3"><div class="bg-green-500/10 p-2 rounded-full"><i class="fa-solid fa-arrow-up-from-bracket text-green-500 text-xl"></i></div><div><p class="text-sm text-slate-500">Llamadas Salientes</p><p id="salientes-count-historico" class="text-2xl font-bold text-green-600">0</p></div></div>
                        <div class="bg-white p-4 rounded-xl shadow-md flex items-center space-x-3"><div class="bg-blue-500/10 p-2 rounded-full"><i class="fa-solid fa-inbox text-blue-500 text-xl"></i></div><div><p class="text-sm text-slate-500">Llamadas Entrantes</p><p id="entrantes-count-historico" class="text-2xl font-bold text-blue-600">0</p></div></div>
                    </div>
                </section>

                <!----------------- HISTÓRICO DE LLAMADAS - TABLA - LOG ---------------->
                <section id="historical-log" class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Registro Histórico</h2>
                        <div class="flex items-center space-x-2">
                            <button id="clear-all-filters-historical-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap" title="Limpiar todos los filtros">
                                <i class="fa-solid fa-broom"></i>
                            </button>
                            <div class="relative w-full"><input type="text" id="filter-input-historical" placeholder="Buscar..." class="w-full pl-10 pr-10 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"><i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i><button id="clear-filter-btn-historical" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400 hover:text-slate-600 hidden"><i class="fa-solid fa-times-circle"></i></button></div>
                            <button id="download-historical-excel-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap"><i class="fa-solid fa-file-excel"></i><span>Descargar</span></button>
                            <label for="historical-file-input" class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg shadow-sm transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap"><i class="fa-solid fa-file-upload"></i><span>Subir Excel</span><input type="file" id="historical-file-input" class="hidden" accept=".xlsx, .xls"></label>
                            
                            <button id="confirm-import-historical-btn" class="hidden bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap" disabled>
                               <i class="fa-solid fa-check"></i>
                               <span>Confirmar</span>
                           </button>
    
                            <button id="cancel-import-historical-btn" class="hidden bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-times"></i>
                                <span>Cancelar</span>
                            </button> 
                            
                            <button id="start-reverse-migration-btn" class="migrate-btn text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-arrow-left"></i>
                                <span>Migrar a Registro</span>
                            </button>
                            <button id="confirm-reverse-migration-btn" class="hidden bg-success hover:bg-success-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap" disabled>
                                <i class="fa-solid fa-check"></i>
                                <span>Confirmar</span>
                            </button>
                            <button id="cancel-reverse-migration-btn" class="hidden bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2 whitespace-nowrap">
                                <i class="fa-solid fa-times"></i>
                                <span>Cancelar</span>
                            </button>
                        </div>
                    </div>
                    <div id="historical-table-container" class="bg-white rounded-xl shadow-md table-container">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                <tr id="historical-table-header">
                                    <th scope="col" class="py-3 px-6 reverse-migration-select-col hidden">
                                        <input type="checkbox" id="select-all-historical-calls-checkbox" class="rounded border-gray-300 text-primary focus:ring-primary">
                                    </th>
                                    <th scope="col" class="py-3 px-6">No.</th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fecha">Fecha <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="inicio">Inicio <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="fin">Fin <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="duracion">Duración <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="area">Área <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="institucion">Institución <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="asunto">Asunto <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="consulta">Consulta <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="nombre">Nombre <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="cargo">Cargo <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="correo">Correo <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="telefono">Teléfono <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="estatus">Estatus <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="atendio">Atendió <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6 filterable-header" data-filter-by="comentarios">Comentarios <span class="filter-icon"><i class="fa-solid fa-filter ml-1"></i></span></th>
                                    <th scope="col" class="py-3 px-6">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historical-table-body"></tbody>
                        </table>
                        <div id="no-historical-message" class="p-6 text-center text-slate-500 hidden"><p>No hay datos históricos cargados.</p></div>
                    </div>
                </section>
            </div>

            <!----------------- CONTENIDO DE LA TAB DE REPORTES ---------------->
            <div id="tab-content-reportes" class="tab-content hidden">
                <section id="reportes" class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-primary">Reportes</h2>
                        <div class="flex items-center space-x-4">

                            <!----------------- GENERAR REPORTE BOTÓN ---------------->
                            <button id="generate-report-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg shadow transition-all duration-200 ease-in-out flex items-center space-x-2">
                                <i class="fa-solid fa-file-pdf"></i>
                                <span>Generar Reporte</span>
                            </button>

                            <!----------------- SELECCIÓN DE FUENTE DE DATOS ---------------->
                            <div class="flex items-center space-x-2">
                                <label for="reportes-data-source" class="block text-sm font-medium text-gray-700">Fuente de datos:</label>
                                <select id="reportes-data-source" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                    <option value="registro">Registro y Control</option>
                                    <option value="historico">Histórico</option>
                                    <option value="combinado">Registro y Control + Histórico</option>
                                </select>
                                <button id="config-report-btn" class="text-gray-500 hover:text-gray-700 transition-colors duration-200 ease-in-out ml-2">
                                    <i class="fa-solid fa-cog fa-lg"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!----------------- GRÁFICOS PRINCIPALES ---------------->
                    <div class="grid grid-cols-1 md:grid-cols-2">
                        <div class="chart-wrapper"> 
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Estatus</h3>
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Asunto</h3>
                            <canvas id="asuntoChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <h3 class="text-xl font-semibold text-slate-800 mb-2">Llamadas por Día de la Semana</h3>
                            <canvas id="dayOfWeekChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                            <div class="flex items-center justify-start gap-4 mb-2 px-4">
                                <h3 id="consulta-chart-title" class="text-xl font-semibold text-slate-800">Llamadas por Consulta</h3>
                                <select id="consulta-asunto-filter" class="block w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-1"></select>
                            </div>
                            <canvas id="consultaChart" class="mt-2"></canvas>
                        </div>
                    </div>
                    
                    <!----------------- GRÁFICA DINÁMICA Y SUS VARIABLES ---------------->
                    <div class="dynamic-chart-container">
                        <div class="dynamic-chart-header">
                            <h3 class="text-xl font-semibold text-slate-800">Llamadas por</h3>
                            <select id="dynamic-chart-variable" class="mt-1 block w-full md:w-auto rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2">
                                <option value="area">Área</option>
                                <option value="institucion">Institución</option>
                                <option value="nombre">Nombre</option>
                                <option value="cargo">Cargo</option>
                                <option value="atendio">Atendió</option>
                            </select>
                        </div>
                        <div class="dynamic-chart-content">
                            <div class="chart-wrapper">
                                <canvas id="dynamicChart"></canvas>
                            </div>

                            <!----------------- TOTALES TABLA DE DISTRIBUCIÓN ---------------->
                            <div class="dynamic-table-container">
                                <h4 class="text-lg font-semibold text-slate-800 mb-2 text-center">Distribución por Estatus</h4>
                                <table class="dynamic-table">
                                    <thead>
                                        <tr>
                                            <th id="dynamic-table-header">Variable</th>
                                            <th>Salientes</th>
                                            <th>Entrantes</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dynamic-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!----------------- TABLA DINÁMICA INTERACTIVA---------------->
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-primary mb-4">Tabla Dinámica Interactiva</h2>
                    <p class="text-sm text-slate-500 mb-4">Por defecto se muestran llamadas por Institución y asunto, para cambiar la configuración, arrastre las variable deseada al encabezado o renglon para ajustar los datos. </p>
                    <div id="pivot-table"></div>
                </section>
            </div>
        </div>
    </div>

        <!----------------- MODAL NUEVA LLAMADA ---------------->
    <div id="call-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <!-- Encabezado del Modal Mejorado -->
            <div id="call-modal-header" class="flex justify-between items-center pb-4 mb-4 border-b cursor-move">
                <h3 class="text-2xl font-bold text-primary">Detalles de la Llamada</h3>
                <div class="modal-header-controls flex items-center space-x-2">
                    <button id="minimize-call-modal-btn" class="text-gray-500 hover:bg-gray-200 rounded transition-colors" title="Minimizar"><i class="fa-solid fa-window-minimize"></i></button>
                    <button id="close-modal-btn" class="text-gray-500 hover:bg-red-500 hover:text-white rounded transition-colors" title="Cerrar"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>

            <!-- Temporizador -->
            <div class="text-right mb-6">
                <p class="text-sm font-medium text-slate-500">TIEMPO DE LLAMADA ACTUAL</p>
                <p id="modal-timer" class="text-2xl font-bold text-primary tracking-wider">00:00:00</p>
            </div>

            <!-- Contenido del Formulario -->
            <div class="call-form-container">
                <form id="call-form" class="space-y-6" novalidate>
                    <div> 
                        <h4 class="section-title text-lg">Datos Institución</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="caller-institution">Institución</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-institution" name="institucion" required></select>
                                    <button type="button" id="edit-institution-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-area">Área o Departamento</label>
                                <div class="flex-with-buttons">
                                    <select id="call-area" name="area" required></select>
                                    <button type="button" id="edit-area-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-subject">Asunto</label>
                                <div class="flex-with-buttons">
                                    <select id="call-subject" name="asunto" required></select>
                                    <button type="button" id="edit-subject-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-query">Consulta</label>
                                <div class="flex-with-buttons">
                                    <select id="call-query" name="consulta" required></select>
                                    <button type="button" id="edit-query-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Datos Personales</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="caller-name">Nombre del Solicitante</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-name" name="nombre" required></select>
                                    <button type="button" id="edit-name-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-cargo">Cargo del Solicitante</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-cargo" name="cargo"></select>
                                    <button type="button" id="edit-cargo-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-email">Correo Electrónico</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-email" name="correo"></select>
                                    <button type="button" id="edit-email-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="caller-phone">Teléfono (opcional)</label>
                                <div class="flex-with-buttons">
                                    <select id="caller-phone" name="telefono"></select>
                                    <button type="button" id="edit-phone-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Atendió y Comentarios</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="call-atendio">Atendió</label>
                                <div class="flex-with-buttons">
                                    <select id="call-atendio" name="atendio" required></select>
                                    <button type="button" id="edit-atendio-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="call-comments">Comentarios</label>
                                <div class="flex-with-buttons">
                                     <select id="call-comments" name="comentarios"></select>
                                     <button type="button" id="edit-comments-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar y Finalizar Llamada</button></div>
                </form>
            </div>
        </div>
    </div>

    <!----------------- MODAL EDITAR LLAMADA ---------------->
    <div id="edit-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-6xl mx-4">
            <!-- Encabezado del Modal Mejorado -->
            <div id="edit-modal-header" class="flex justify-between items-center pb-4 mb-6 border-b cursor-move">
                <h3 class="text-2xl font-bold text-primary">Editar Llamada</h3>
                <div class="modal-header-controls flex items-center space-x-2">
                    <button id="minimize-edit-modal-btn" class="text-gray-500 hover:bg-gray-200 rounded transition-colors" title="Minimizar"><i class="fa-solid fa-window-minimize"></i></button>
                    <button id="close-edit-modal-btn" class="text-gray-500 hover:bg-red-500 hover:text-white rounded transition-colors" title="Cerrar"><i class="fa-solid fa-times"></i></button>
                </div>
            </div>
            <div class="call-form-container">
                <form id="edit-form" class="space-y-6" novalidate>
                    <input type="hidden" id="edit-id">
                    <div>
                        <h4 class="section-title text-lg">Datos Institución</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-caller-institution" class="block text-sm font-medium text-gray-700">Institución</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-institution" name="institucion" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-institution-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-area" class="block text-sm font-medium text-gray-700">Área</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-area" name="area" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-area-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-subject" class="block text-sm font-medium text-gray-700">Asunto</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-subject" name="asunto" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-subject-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-query" class="block text-sm font-medium text-gray-700">Consulta</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-query" name="consulta" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-query-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Datos Personales</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-caller-name" class="block text-sm font-medium text-gray-700">Nombre</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-name" name="nombre" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-name-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-cargo" class="block text-sm font-medium text-gray-700">Cargo</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-cargo" name="cargo" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-cargo-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-email" class="block text-sm font-medium text-gray-700">Correo</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-email" name="correo" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-email-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-caller-phone" class="block text-sm font-medium text-gray-700">Teléfono (opcional)</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-caller-phone" name="telefono" class="mt-1 block w-full"></select>
                                    <button type="button" id="edit-phone-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="section-title text-lg">Atendió y Comentarios</h4>
                        <div class="form-grid">
                            <div class="form-field">
                                <label for="edit-call-atendio" class="block text-sm font-medium text-gray-700">Atendió</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-atendio" name="atendio" class="mt-1 block w-full" required></select>
                                    <button type="button" id="edit-atendio-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                            <div class="form-field">
                                <label for="edit-call-comments" class="block text-sm font-medium text-gray-700">Comentarios</label>
                                <div class="flex-with-buttons">
                                    <select id="edit-call-comments" name="comentarios" class="mt-1 block w-full"></select>
                                    <button type="button" id="edit-comments-edit-btn" class="edit-btn"><i class="fa-solid fa-pen"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end pt-4"><button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Cambios</button></div>
                </form>
            </div>
        </div>
    </div>


    <!----------------- MODAL DE CONFIRMACIÓN DE ELIMINACIÓN DE LLAMADA ---------------->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center"><h3 class="text-xl font-bold text-slate-800 mb-4">Confirmar Eliminación</h3><p class="text-slate-600 mb-6">¿Estás seguro de que deseas eliminar este registro?</p><div class="flex justify-center space-x-4"><button id="cancel-delete-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button><button id="confirm-delete-btn" class="bg-danger hover:bg-danger-dark text-white font-bold py-2 px-4 rounded-lg">Eliminar</button></div></div>
    </div>
    
    <!----------------- MODAL DE CONFIRMACIÓN DE EDITAR OPCIÓN DE LISTA ---------------->
    <div id="edit-option-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Editar Opción</h3>
            <input type="text" id="edit-option-input" placeholder="Edite la opción" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-edit-option-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-edit-option-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <!----------------- MODAL DE CONFIRMACIÓN DE CONTRASEÑA  ---------------->
    <div id="password-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 text-center">
            <h3 class="text-xl font-bold text-primary mb-4">Verificación de Seguridad</h3>
            <p class="text-slate-600 mb-4">Esta acción requiere autenticación. Por favor, ingrese la contraseña.</p>
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full p-2 border border-gray-300 rounded-md mb-4">
            <div class="flex justify-center space-x-4">
                <button id="cancel-password-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-password-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Verificar</button>
            </div>
        </div>
    </div>

    <!----------------- MODAL DE GENERACIÓN DE REPORTE EJECUTIVO  ---------------->
    <div id="report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-report-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <h3 class="text-2xl font-bold text-primary mb-6">Generar Reporte Ejecutivo</h3>
            <form id="report-form" class="space-y-6">
                <div>
                    <!----------------- SELECCIÓN DE GRÁFICOS A INCLUIR ---------------->
                    <h4 class="section-title text-lg">Seleccionar gráficas a incluir</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="include-asunto" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-asunto" class="ml-2 block text-sm text-gray-700">Llamadas por Asunto</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-dynamic-chart" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-dynamic-chart" class="ml-2 block text-sm text-gray-700">Llamadas por Variable Seleccionada (Gráfica)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-dynamic-table" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-dynamic-table" class="ml-2 block text-sm text-gray-700">Llamadas por Variable Seleccionada (Tabla de Datos)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-day" class="rounded border-gray-300 text-primary focus:ring-primary" checked>
                            <label for="include-day" class="ml-2 block text-sm text-gray-700">Llamadas por Día de la Semana</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-atendio" class="rounded border-gray-300 text-primary focus:ring-primary">
                            <label for="include-atendio" class="ml-2 block text-sm text-gray-700">Llamadas por Consulta</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="include-status" class="rounded border-gray-300 text-primary focus:ring-primary">
                            <label for="include-status" class="ml-2 block text-sm text-gray-700">Llamadas por Estatus</label>
                        </div>

                    </div>
                </div>

                <!----------------- BOTÓN PARA GENERAR REPORTE EN PDF  ---------------->
                <div class="flex items-center justify-end pt-4">
                    <button type="button" id="generate-pdf-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Generar Reporte PDF</button>
                </div>
            </form>
        </div>
    </div>

    <!----------------- MODAL DE CONFIGURACIÓN DEL REPORTE EJECUTIVO  ---------------->
    <div id="config-report-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-config-report-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-primary">Configuración de Reportes</h3>
                <div class="relative group">
                    <button type="button" class="text-primary hover:text-primary-dark focus:outline-none">
                        <i class="fa-solid fa-circle-info fa-lg"></i>
                    </button>
                    <div class="absolute hidden group-hover:block right-0 top-full mt-2 w-64 p-2 bg-white shadow-lg rounded-lg border border-gray-200 z-10 text-sm text-gray-600">
                        Seleccione un período para filtrar los reportes. Ejemplo: para ver datos del 15/04/2025, establezca la fecha de inicio 14/04/2025 y fecha de fin en 16/04/2025. 
                    </div>
                </div>
            </div>

            <!----------------- CONFIGURACIÓN DE PERIODO DE REPORTES ---------------->
            <form id="config-report-form" class="space-y-6">
                <div class="config-report-grid">
                    <div class="config-option">
                        <input type="radio" id="filter-all-data" name="data-filter" value="all" checked class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="filter-all-data" class="block text-sm font-medium text-gray-700">Todos los datos</label>
                    </div>
                    
                    <div class="config-option">
                        <input type="radio" id="filter-by-period" name="data-filter" value="period" class="rounded border-gray-300 text-primary focus:ring-primary">
                        <label for="filter-by-period" class="block text-sm font-medium text-gray-700">Seleccionar por periodo</label>
                    </div>
                    
                    <div class="form-field">
                        <label for="config-report-start-date">Fecha de inicio</label>
                        <input type="date" id="config-report-start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" disabled>
                    </div>
                    
                    <div class="form-field">
                        <label for="config-report-end-date">Fecha de fin</label>
                        <input type="date" id="config-report-end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" disabled>
                    </div>
                </div>

                <!----------------- CONFIGURACIÓN DE TAMAÑO DE GRÁFICAS Y SLIDER---------------->
                <div class="chart-size-control">
                    <label for="chart-size-slider" class="font-medium text-gray-700">Tamaño de gráficas:</label>
                    <input type="range" id="chart-size-slider" min="120" max="400" value="220" class="w-40">
                    <span id="chart-size-value" class="text-sm text-gray-600">220px</span>
                </div>
                <!----------------- GUARDAR CONFIGURACIÓN ---------------->
                <div class="flex items-center justify-end pt-4">
                    <button type="button" id="save-config-report-btn" class="bg-primary hover:bg-primary-dark text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 ease-in-out">Guardar Configuración</button>
                </div>
            </form>
        </div>
    </div>

    <!----------------- MODAL VER DETALLES DE LLAMADA ---------------->
    <div id="view-details-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center wide-modal">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
            <button id="close-details-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-times-circle fa-lg"></i>
            </button>
            <div class="flex items-center space-x-4 mb-6">
                <img src="https://github.com/SAGB-JCM/SICOINLlamadasFormulario/blob/main/SICOINLlamadasFormulario%20-%20LOGO.png?raw=true" alt="Logo Teléfono" class="h-16 w-auto">
                <h3 class="text-2xl font-bold text-primary">Detalle de la Llamada</h3>
            </div>
            <div class="call-form-container">
                <div id="details-modal-content" class="details-modal-content">
                    <!-- El contenido se generará dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!----------------- MODAL EDITAR HORARIOS ---------------->
    <div id="edit-timestamps-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4">
            <button id="close-timestamps-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors"><i class="fa-solid fa-times-circle fa-lg"></i></button>
            <h3 class="text-2xl font-bold text-primary mb-6">Editar Horarios de la Llamada</h3>
            <form id="edit-timestamps-form" class="space-y-4">
                <input type="hidden" id="timestamps-call-id">
                <input type="hidden" id="timestamps-is-historical">
                <div><label for="timestamps-date" class="block text-sm font-medium text-gray-700">Fecha</label><input type="date" id="timestamps-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" required></div>
                <div><label for="timestamps-start-time" class="block text-sm font-medium text-gray-700">Hora de Inicio</label><input type="time" id="timestamps-start-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" step="1" required></div>
                <div><label for="timestamps-end-time" class="block text-sm font-medium text-gray-700">Hora de Fin</label><input type="time" id="timestamps-end-time" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary sm:text-sm p-2" step="1" required></div>
                <div><label class="block text-sm font-medium text-gray-700">Duración Calculada</label><p id="timestamps-duration" class="mt-1 text-lg font-mono p-2 bg-gray-100 rounded-md">00:00:00</p></div>
                <div class="flex items-center justify-end pt-4 space-x-4">
                    <button type="button" id="cancel-timestamps-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-primary hover:bg-primary-dark text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!----------------- PANEL DE HISTORIAL RÁPIDO ---------------->
    <div id="quick-history-panel" class="hidden">
        <div class="quick-history-header">
            <h4 class="text-md font-bold text-primary flex items-center">
                <i class="fa-solid fa-history mr-2"></i>
                Historial Rápido
            </h4>
            <div class="flex items-center space-x-2">
                <button id="minimize-quick-history-btn" class="text-gray-500 hover:bg-gray-200 rounded transition-colors" title="Minimizar">
                    <i class="fa-solid fa-window-minimize"></i>
                </button>
                <button id="close-quick-history-btn" class="close-btn text-gray-500 hover:bg-red-500 hover:text-white rounded transition-colors" title="Cerrar"><i class="fa-solid fa-times"></i></button>
            </div>
        </div>
        <div id="quick-history-content" class="quick-history-content">
            <!-- El contenido se generará dinámicamente -->
        </div>
    </div>
    <!-- Tooltip para vista rápida en tablas -->
    <div id="quick-view-tooltip"></div>

    <!----------------- CONTENEDOR DE VENTANAS MINIMIZADAS ---------------->
    <div id="minimized-windows-container" class="fixed bottom-0 left-0 w-full h-12 bg-transparent z-[90] pointer-events-none flex items-center px-4 gap-3">
        <!-- Las ventanas minimizadas se añadirán aquí dinámicamente -->
    </div>

    <!-- Contenedor para la Alerta de Resumen Semanal (adaptado de Licitaciones) -->
    <div id="summary-alert-container" class="hidden fixed bottom-4 right-4 w-full max-w-sm z-40">
        <div class="bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden">
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-chart-pie text-primary text-xl"></i>
                    </div>
                    <div class="ml-3 w-0 flex-1 pt-0.5">
                        <p class="text-sm font-bold text-slate-800">Resumen operativo de la semana</p>
                        <div id="summary-alert-content" class="mt-2 space-y-2 text-sm text-slate-600">
                            <!-- El contenido se generará dinámicamente -->
                        </div>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button id="close-summary-alert-btn" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                            <span class="sr-only">Cerrar</span>
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="report-preview" class="hidden"></div>

    <script type="module">
        // =============================================
        // MÓDULO: Configuración de Firebase
        // =============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Autenticación
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, writeBatch, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        /**
         * Configuración de Firebase para la conexión con la base de datos y autenticación.
         * Contiene las claves y endpoints del proyecto en Firebase.
         */
        const firebaseConfig = {
            // NOTA DE SEGURIDAD: En un entorno de producción real, estas claves deberían gestionarse
            // a través de variables de entorno o un servicio de configuración seguro para evitar
            // exponerlas directamente en el código del cliente.
            apiKey: "AIzaSyBcuK6zAUnX09wEZ-hSfBP8A66kltUvBls",
            authDomain: "sicoinllamadasformulario.firebaseapp.com",
            projectId: "sicoinllamadasformulario",
            storageBucket: "sicoinllamadasformulario.firebasestorage.app",
            messagingSenderId: "831487187531",
            appId: "1:831487187531:web:3b9d4fc6e55ffb0bb38bce",
            measurementId: "G-F47JLWW4NY"
        };

        // Inicialización de la aplicación Firebase y servicios.
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // =============================================
        // MÓDULO: Variables globales y estado de la aplicación
        // Descripción: Centraliza las referencias al DOM, el estado de la aplicación y las
        // referencias a las colecciones de Firestore para un acceso y manejo consistentes.
        // =============================================

        // Referencias a las colecciones de Firestore.
        const callsCollectionRef = collection(db, "calls");
        const historicalCallsCollectionRef = collection(db, "historicalCalls");

        // UID especial para el modo de solo lectura.
        const READ_ONLY_UID = 'UCmz5As1BMXeq6dIIsKjG2L25Xw2';
        
        /**
         * Objeto `DOM` que centraliza todas las referencias a elementos del DOM.
         * Facilita el acceso y la modificación de la interfaz de usuario.
         */
        const DOM = {
            loader: document.getElementById('loader'),
            appContainer: document.getElementById('app'),
            // Elementos de Login/Logout
            loginScreen: document.getElementById('login-screen'),
            loginForm: document.getElementById('login-form'),
            loginError: document.getElementById('login-error'),
            userInfoContainer: document.getElementById('user-info-container'),
            userEmail: document.getElementById('user-email'),
            logoutBtn: document.getElementById('logout-btn'),
            tabsContainer: document.getElementById('tabs'),
            tabContents: document.querySelectorAll('.tab-content'),
            dashboardDataSourceHistorico: document.getElementById('dashboard-data-source-historico'),
            totalCallsElemHistorico: document.getElementById('total-calls-historico'),
            avgDurationElemHistorico: document.getElementById('avg-duration-historico'),
            salientesCountElemHistorico: document.getElementById('salientes-count-historico'),
            entrantesCountElemHistorico: document.getElementById('entrantes-count-historico'),
            startCallBtn: document.getElementById('start-call-btn'),
            downloadExcelBtn: document.getElementById('download-excel-btn'),
            callLogTableBody: document.getElementById('calls-table-body'),
            noCallsMessage: document.getElementById('no-calls-message'),
            historicalTableBody: document.getElementById('historical-table-body'),
            noHistoricalMessage: document.getElementById('no-historical-message'),
            historicalFileInput: document.getElementById('historical-file-input'),
            confirmImportHistoricalBtn: document.getElementById('confirm-import-historical-btn'),
            cancelImportHistoricalBtn: document.getElementById('cancel-import-historical-btn'),
            reportesDataSource: document.getElementById('reportes-data-source'),
            statusChartCanvas: document.getElementById('statusChart'),
            asuntoChartCanvas: document.getElementById('asuntoChart'),
            dayOfWeekChartCanvas: document.getElementById('dayOfWeekChart'),
            consultaChartCanvas: document.getElementById('consultaChart'),
            dynamicChartCanvas: document.getElementById('dynamicChart'),
            consultaAsuntoFilter: document.getElementById('consulta-asunto-filter'),
            dynamicChartVariable: document.getElementById('dynamic-chart-variable'),
            dynamicTableBody: document.getElementById('dynamic-table-body'),
            dynamicTableHeader: document.getElementById('dynamic-table-header'),
            callModal: document.getElementById('call-modal'),
            callForm: document.getElementById('call-form'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            editModal: document.getElementById('edit-modal'),
            editForm: document.getElementById('edit-form'),
            modalTimerElem: document.getElementById('modal-timer'),
            minimizeEditModalBtn: document.getElementById('minimize-edit-modal-btn'),
            closeEditModalBtn: document.getElementById('close-edit-modal-btn'),
            confirmModal: document.getElementById('confirm-modal'),
            cancelDeleteBtn: document.getElementById('cancel-delete-btn'),
            confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            pivotTableContainer: document.getElementById('pivot-table'),
            editOptionModal: document.getElementById('edit-option-modal'),
            editOptionInput: document.getElementById('edit-option-input'),
            cancelEditOptionBtn: document.getElementById('cancel-edit-option-btn'),
            confirmEditOptionBtn: document.getElementById('confirm-edit-option-btn'),
            passwordModal: document.getElementById('password-modal'),
            passwordInput: document.getElementById('password-input'),
            cancelPasswordBtn: document.getElementById('cancel-password-btn'),
            confirmPasswordBtn: document.getElementById('confirm-password-btn'),
            generateReportBtn: document.getElementById('generate-report-btn'),
            configReportBtn: document.getElementById('config-report-btn'),
            reportModal: document.getElementById('report-modal'),
            closeReportModalBtn: document.getElementById('close-report-modal-btn'),
            reportForm: document.getElementById('report-form'),
            generatePdfBtn: document.getElementById('generate-pdf-btn'),
            configReportModal: document.getElementById('config-report-modal'),
            closeConfigReportModalBtn: document.getElementById('close-config-report-modal-btn'),
            configReportForm: document.getElementById('config-report-form'),
            saveConfigReportBtn: document.getElementById('save-config-report-btn'),
            filterAllDataRadio: document.getElementById('filter-all-data'),
            filterByPeriodRadio: document.getElementById('filter-by-period'),
            configReportStartDate: document.getElementById('config-report-start-date'),
            configReportEndDate: document.getElementById('config-report-end-date'),
            reportPreview: document.getElementById('report-preview'),
            chartSizeSlider: document.getElementById('chart-size-slider'),
            chartSizeValue: document.getElementById('chart-size-value'),
            startMigrationBtn: document.getElementById('start-migration-btn'),
            confirmMigrationBtn: document.getElementById('confirm-migration-btn'),
            cancelMigrationBtn: document.getElementById('cancel-migration-btn'),
            selectAllCallsCheckbox: document.getElementById('select-all-calls-checkbox'),
            startReverseMigrationBtn: document.getElementById('start-reverse-migration-btn'),
            confirmReverseMigrationBtn: document.getElementById('confirm-reverse-migration-btn'),
            cancelReverseMigrationBtn: document.getElementById('cancel-reverse-migration-btn'),
            selectAllHistoricalCallsCheckbox: document.getElementById('select-all-historical-calls-checkbox'),
            viewDetailsModal: document.getElementById('view-details-modal'),
            closeDetailsModalBtn: document.getElementById('close-details-modal-btn'),
            includeDynamicChartCheckbox: document.getElementById('include-dynamic-chart'),
            includeDynamicTableCheckbox: document.getElementById('include-dynamic-table'),
            editTimestampsModal: document.getElementById('edit-timestamps-modal'),
            editTimestampsForm: document.getElementById('edit-timestamps-form'),
            closeTimestampsModalBtn: document.getElementById('close-timestamps-modal-btn'),
            cancelTimestampsBtn: document.getElementById('cancel-timestamps-btn'),
            timestampsDateInput: document.getElementById('timestamps-date'),
            timestampsStartTimeInput: document.getElementById('timestamps-start-time'),
            timestampsEndTimeInput: document.getElementById('timestamps-end-time'),
            timestampsDurationElem: document.getElementById('timestamps-duration'),
            consultaChartHeader: document.querySelector('#consultaChart').previousElementSibling,
            consultaChartTitle: document.getElementById('consulta-chart-title'),
            quickViewTooltip: document.getElementById('quick-view-tooltip'),
            quickHistoryPanel: document.getElementById('quick-history-panel'),
            quickHistoryContent: document.getElementById('quick-history-content'),
            minimizeQuickHistoryBtn: document.getElementById('minimize-quick-history-btn'),
            closeQuickHistoryBtn: document.getElementById('close-quick-history-btn'),
            // Nuevos elementos para la alerta de resumen
        };
        
        //Alternar visualización de etiquetas Reporte dinámico
        const toggleLabelsBtn = document.createElement('button');
        toggleLabelsBtn.id = 'toggle-labels-btn';
        toggleLabelsBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded ml-2';
        toggleLabelsBtn.innerHTML = '<i class="fa-solid fa-tag"></i>';
        toggleLabelsBtn.title = 'Alternar visualización de etiquetas';

        // Insertar el botón después del select
        DOM.dynamicChartVariable.parentNode.insertBefore(toggleLabelsBtn, DOM.dynamicChartVariable.nextSibling);

        // Event listener para el botón
        toggleLabelsBtn.addEventListener('click', () => {
            state.ui.showChartLabels = !state.ui.showChartLabels;
            toggleLabelsBtn.classList.toggle('bg-primary', state.ui.showChartLabels);
            toggleLabelsBtn.classList.toggle('text-white', state.ui.showChartLabels);
            updateDynamicChart();
        });
        
        /**
         * Objeto `state` que centraliza el estado de la aplicación.
         * Mantiene los datos de llamadas, opciones de campos, estado de la UI y filtros.
         */
        const state = {
            isReadOnly: false, // Nuevo estado para el modo de solo lectura
            user: null,
            listeners: { calls: null, historical: null }, // Para manejar las suscripciones de Firestore
            userId: null,
            calls: [],
            historicalCalls: [],
            fieldOptions: {
                areas: [], asuntos: [], consultas: [], nombres: [], cargos: [],
                correos: [], telefonos: [], comentarios: [], instituciones: [], atendioUsers: []
            },
            ui: {
                timerInterval: null,
                callStartTime: null,
                openModalCount: 0, // Contador de modales abiertos para gestionar el scroll del body.
                currentFilterDropdown: null, // Referencia al menú desplegable de filtro activo.
                isCallModalActive: false, // Indica si el modal de "Nueva Llamada" está activo para deshabilitar otras acciones.
                isMigrationModeActive: false, // Indica si el modo de migración de 'Registro' a 'Histórico' está activo.
                selectedCallIdsToMigrate: new Set(), // IDs de llamadas seleccionadas para migrar.
                isReverseMigrationModeActive: false, // Indica si el modo de migración inversa está activo.
                selectedHistoricalCallIdsToMigrate: new Set(), // IDs de llamadas históricas seleccionadas para migrar.
                currentEditIsHistorical: false, // Contexto para saber si la llamada que se edita es del histórico.
                currentEditingField: null,
                currentEditingValue: null,
                pendingAction: null,
                activeDayFilter: null, // null o un número de 1 a 5 para el día
                isProgrammaticChange: false,
                isDragging: false,
                showChartLabels: true,
            }, 
            consultaChartState: { showLabels: false }, // Estado específico para el gráfico de consultas.
            reportFilter: {
                type: 'all', // 'all' o 'period'
                startDate: null,
                endDate: null,
            },
            activeFilters: {
                main: {},
                historical: {}
            },
            charts: {
                status: null, asunto: null, dayOfWeek: null, consulta: null, dynamic: null
            }
        };

        // =============================================
        // MÓDULO: Gestión de Modales (con contador para anidamiento)
        // Descripción: Funciones para controlar la visibilidad y el comportamiento de los modales.
        // =============================================
        let openModalCount = 0;
        const z_INDEX_BASE = 50; // Base para el z-index de los modales
        
        /**
         * Oculta el loader inicial y muestra el contenido principal de la aplicación.
         */
        function showApp() {
            DOM.loader.classList.add('hidden'); // Oculta el loader
            DOM.loginScreen.classList.add('hidden'); // Oculta la pantalla de login
            DOM.appContainer.classList.remove('hidden');
            DOM.userInfoContainer.classList.remove('hidden');
        }

        /**
         * Muestra la pantalla de inicio de sesión y oculta el resto de la aplicación.
         */
        function showLoginScreen() {
            DOM.loader.classList.add('hidden'); // Oculta el loader
            DOM.appContainer.classList.add('hidden'); // Oculta la app principal
            DOM.userInfoContainer.classList.add('hidden');
            DOM.loginScreen.classList.remove('hidden'); // Muestra la pantalla de login
        }
        /**
         * Muestra una notificación flotante (toast) en la esquina inferior derecha.
         * @param {string} message - El mensaje a mostrar.
         * @param {'info'|'success'|'warning'|'error'} [type='info'] - El tipo de alerta, que determina su color.
         */
        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500', info: 'bg-gray-500' };
            alertContainer.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white transform transition-all duration-300 z-[100] ${colors[type]}`;
            alertContainer.textContent = message;
            document.body.appendChild(alertContainer);
            // La alerta se elimina automáticamente después de 3 segundos.
            setTimeout(() => { alertContainer.remove(); }, 6000);
        }

        /**
         * Genera una marca de tiempo formateada para usar en nombres de archivo.
         * @returns {string} Una cadena con el formato `DD-MM-YYYY_HHhMMmSSs`.
         */
        function getFormattedTimestamp() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0'); // Los meses son base 0
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${day}-${month}-${year}_${hours}h${minutes}m${seconds}s`;
        }

        /**
         * Función de utilidad (debounce) que retrasa la ejecución de una función.
         * Es útil para eventos que se disparan con frecuencia, como `resize` o `scroll`.
         * @param {Function} func - La función a ejecutar.
         * @param {number} delay - El tiempo de espera en milisegundos.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Formatea una cantidad de segundos en un formato de tiempo HH:MM:SS.
         * @param {number} seconds - La duración en segundos.
         * @returns {string} La duración formateada como "HH:MM:SS".
         */
                function formatDuration(seconds) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        
        /**
         * Convierte una cadena de tiempo en formato 24h (HH:MM:SS) a formato 12h con a.m./p.m.
         * @param {string} timeString - La cadena de tiempo en formato 24h.
         * @returns {string} El tiempo formateado como "HH:MM:SS a. m." o "HH:MM:SS p. m.".
         */
        function formatTimeWithAmPm(timeString) {
            if (!timeString || typeof timeString !== 'string') return 'N/A';
            if (timeString.toLowerCase().includes('a. m.') || timeString.toLowerCase().includes('p. m.')) {
                return timeString;
            }
            try {
                // Asegurar que tenga formato HH:MM:SS
                const [hours, minutes, seconds = '00'] = timeString.split(':');
                let h = parseInt(hours, 10);
                const m = minutes.padStart(2, '0');
                const s = seconds.padStart(2, '0');
                
                const period = h >= 12 ? 'p. m.' : 'a. m.';
                h = h % 12 || 12; // Convertir a 12h
                
                return `${h.toString().padStart(2, '0')}:${m}:${s} ${period}`;
            } catch (e) {
                return timeString; // fallback si no parsea
            }
        }

        /**
         * Convierte una cadena de tiempo en formato 12h (con a.m./p.m.) a formato 24h (HH:mm:ss).
         * @param {string} timeStr - La cadena de tiempo en formato 12h.
         * @returns {string} El tiempo convertido a formato "HH:mm:ss".
         */
        function convertTo24HourFormat(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return '00:00:00';
            const lcTime = timeStr.toLowerCase();

            // Case 1: Already in 24h format (e.g., "14:30:00")
            if (!lcTime.includes('a. m.') && !lcTime.includes('p. m.')) {
                // Basic validation and normalization for 24h format
                if (/^\d{1,2}:\d{1,2}(:\d{1,2})?$/.test(lcTime)) {
                    const parts = lcTime.split(':');
                    const h = String(parts[0] || '00').padStart(2, '0');
                    const m = String(parts[1] || '00').padStart(2, '0');
                    const s = String(parts[2] || '00').padStart(2, '0');
                    return `${h}:${m}:${s}`;
                }
                return '00:00:00'; // Invalid format
            }

            // Case 2: In 12h format (e.g., "2:30 p. m.")
            const isPm = lcTime.includes('p. m.');
            const timePart = lcTime.split(' ')[0];
            const [hours, minutes = '00', seconds = '00'] = timePart.split(':');

            let h = parseInt(hours, 10);
            if (isNaN(h)) return '00:00:00';

            // Convert to 24h logic
            if (isPm && h < 12) h += 12;
            else if (!isPm && h === 12) h = 0; // Handle 12 a.m. (midnight)

            return `${String(h).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /**
         * Abre un modal, gestionando el z-index y bloqueando el scroll del body.
         * @param {HTMLElement} modal - El elemento del modal a abrir.
         */
        function openModal(modal) {
            state.ui.openModalCount++;
            modal.style.zIndex = z_INDEX_BASE + state.ui.openModalCount;
            modal.classList.remove('hidden', 'modal-leave');
            modal.classList.add('modal-enter');
            // Bloquear el scroll del body siempre que haya al menos un modal abierto.
            document.body.classList.add('modal-open');

            // --- INICIO: Lógica de Autofoco ---
            // Se añade un pequeño retardo para asegurar que el modal sea visible antes de intentar enfocar el campo.
            setTimeout(() => {
                if (modal === DOM.passwordModal) {
                    DOM.passwordInput.focus();
                } else if (modal === DOM.editOptionModal) {
                    DOM.editOptionInput.focus();
                } else if (modal === DOM.callModal) {
                    $('#caller-institution').select2('open');
                }
                // Al abrir el modal de nueva llamada, revisamos si hay que mostrar el historial
                if (modal === DOM.callModal) {
                    updateQuickHistoryPanel();
                }
            }, 400); // 400ms es suficiente para que la animación de entrada comience.
            // --- FIN: Lógica de Autofoco ---
        } 

        /**
         * Cierra un modal, gestionando el z-index y restaurando el scroll del body si es necesario.
         * @param {HTMLElement} modal - El elemento del modal a cerrar.
         */
        function closeModal(modal) {
            modal.classList.remove('modal-enter');
            modal.classList.add('modal-leave');
            setTimeout(() => {
                modal.classList.add('hidden');
                state.ui.openModalCount--;
                if (state.ui.openModalCount === 0) {
                    document.body.classList.remove('modal-open'); // Restaurar scroll solo si no quedan modales abiertos
                }
                modal.style.zIndex = ''; // Limpiar el z-index DESPUÉS de que el modal se oculte
            }, 300);

            // Si se cierra el modal de nueva llamada, ocultamos el panel de historial
            if (modal === DOM.callModal || modal === DOM.editModal) {
                DOM.quickHistoryPanel.classList.add('hidden');
                // También nos aseguramos de que la ventana minimizada se elimine si existe
                const minimizedCallWindow = document.getElementById('minimized-call-window');
                if (minimizedCallWindow) {
                    minimizedCallWindow.remove();
                }
                toggleCallActiveState(false);
            }
        }

        /**
         * Activa o desactiva el modo de solo lectura, ocultando elementos sensibles.
         * @param {boolean} isReadOnly - True para activar el modo, false para desactivar.
         */
        function toggleReadOnlyMode(isReadOnly) {
            state.isReadOnly = isReadOnly;

            // Ocultar botones en la pestaña de Registro
            DOM.startCallBtn.classList.toggle('hidden', isReadOnly);
            DOM.startMigrationBtn.classList.toggle('hidden', isReadOnly);

            // Ocultar botones en la pestaña de Histórico
            document.querySelector('label[for="historical-file-input"]').classList.toggle('hidden', isReadOnly);
            DOM.startReverseMigrationBtn.classList.toggle('hidden', isReadOnly);
        }

        // =============================================
        // MÓDULO: Interfaz de usuario
        // Descripción: Funciones relacionadas con la manipulación y actualización de la interfaz,
        // como pestañas, tablas, filtros y dashboards.
        // =============================================
        
        /**
         * Configura la navegación por pestañas (Registro, Histórico, Reportes).
         */
        function setupTabs() {
            DOM.tabsContainer.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const tabName = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    DOM.tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
                    if (tabName === 'reportes') {
                        setTimeout(updateCharts, 50); // Delay to ensure container is visible
                    }
                }
            });
        }

        /**
         * Resalta las coincidencias de un término de búsqueda dentro de un texto.
         * @param {string} text - El texto original.
         * @param {string} searchTerm - El término a buscar y resaltar.
         * @returns {string} El texto con las coincidencias envueltas en un span con la clase 'highlight'.
         */
        function highlightText(text, searchTerm) {
            if (!searchTerm || searchTerm.trim() === '' || typeof text !== 'string') {
                return text;
            }
            // Escapar caracteres especiales en el término de búsqueda para la expresión regular
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
            return text.replace(regex, `<span class="highlight">$1</span>`);
        }

        /**
         * Renderiza las filas de una tabla (principal o histórica) con los datos proporcionados.
         * @param {HTMLTableSectionElement} tableBody - El `<tbody>` de la tabla a poblar.
         * @param {Array<Object>} data - El array de objetos de llamada.
         * @param {boolean} [isHistorical=false] - Indica si la tabla es la del histórico.
         */
        function renderTable(tableBody, data, isHistorical = false) {
            const noDataMessage = isHistorical ? DOM.noHistoricalMessage : DOM.noCallsMessage;
            tableBody.innerHTML = '';
            noDataMessage.classList.toggle('hidden', data.length > 0);

            const headers = ['no', 'fecha', 'inicio', 'fin', 'duracion', 'area', 'institucion', 'asunto', 'consulta', 'nombre', 'cargo', 'correo', 'telefono', 'estatus', 'atendio', 'comentarios'];

            const filterKey = isHistorical ? 'historical' : 'main';
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.trim() : '';

            // Función para truncar texto, inspirada en la app de trenes
            function truncateText(text, maxLength = 30) {
                if (!text) return 'N/A';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            data.forEach((call, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';

                // Añadimos los atributos data-* para el tooltip de vista rápida. (CORREGIDO)
                row.dataset.quickview = 'true';
                row.dataset.institucion = call.institucion || 'N/A';
                row.dataset.consulta = call.consulta || 'N/A';
                row.dataset.asunto = call.asunto || 'N/A';
                row.dataset.nombre = call.nombre || 'N/A';
                row.dataset.fecha = call.fecha || 'N/A';
                row.dataset.inicio = formatTimeWithAmPm(call.inicio);
                row.dataset.duracion = formatDuration(call.duracion);
                row.dataset.estatus = call.estatus || 'Entrante';

                let cells = headers.map(header => {
                    let content = '';
                    if (header === 'no') content = index + 1;
                    else if (header === 'duracion') content = formatDuration(call.duracion);
                    else if (header === 'estatus') {
                        content = `<button data-id="${call.id}" data-is-historical="${isHistorical}" class="status-button status-${call.estatus === 'Saliente' ? 'saliente' : 'entrante'} toggle-status-btn">${call.estatus || 'Entrante'}</button>`;
                    } else if (header === 'inicio' || header === 'fin') {
                        content = formatTimeWithAmPm(call[header]);
                    } else {
                        // Aplicar truncamiento a columnas con texto potencialmente largo
                        const longTextFields = ['institucion', 'asunto', 'consulta', 'nombre', 'cargo', 'correo', 'comentarios'];
                        if (longTextFields.includes(header)) {
                            content = truncateText(call[header] || 'N/A', 30);
                        } else {
                            content = call[header] || 'N/A';
                        }
                    }

                    const finalContent = (header !== 'estatus' && searchText) ? highlightText(String(content), searchText) : content;
                    // Añadir 'whitespace-nowrap' para evitar que el texto se divida en varias líneas
                    // y mantener la altura de la fila consistente.
                    return `<td class="py-4 px-6 whitespace-nowrap">${finalContent}</td>`;

                }).join('');

                // --- INICIO: Lógica para añadir el checkbox de migración inversa ---
                let reverseMigrationCell = '';
                if (isHistorical && state.ui.isReverseMigrationModeActive) {
                    const isSelected = state.ui.selectedHistoricalCallIdsToMigrate.has(call.id);
                    reverseMigrationCell = `<td class="py-4 px-6 whitespace-nowrap"><input type="checkbox" class="historical-call-migration-checkbox rounded border-gray-300 text-primary focus:ring-primary" data-id="${call.id}" ${isSelected ? 'checked' : ''}></td>`;
                }
                // --- FIN: Lógica para añadir el checkbox de migración inversa ---

                // --- INICIO: Lógica para añadir el checkbox de migración al principio de la fila ---
                let migrationCell = '';
                // Solo se añade el checkbox a la tabla principal y si el modo migración está activo.
                if (!isHistorical && state.ui.isMigrationModeActive) {
                    const isSelected = state.ui.selectedCallIdsToMigrate.has(call.id);
                    migrationCell = `<td class="py-4 px-6 whitespace-nowrap"><input type="checkbox" class="call-migration-checkbox rounded border-gray-300 text-primary focus:ring-primary" data-id="${call.id}" ${isSelected ? 'checked' : ''}></td>`;
                }
                // --- FIN: Lógica para añadir el checkbox de migración ---

                const actionsCell = state.isReadOnly ? '' : `<td class="py-4 px-6 flex space-x-2">
                        <button data-id="${call.id}" data-is-historical="${isHistorical}" class="edit-btn text-blue-500 hover:text-blue-700"><i class="fa-solid fa-edit"></i></button>
                        <button data-id="${call.id}" data-is-historical="${isHistorical}" class="delete-btn text-red-500 hover:text-red-700"><i class="fa-solid fa-trash-alt"></i></button>
                    </td>`;

                // Ocultar el encabezado de la columna de acciones si estamos en modo solo lectura
                document.querySelectorAll('.table-container th:last-child').forEach(th => th.classList.toggle('hidden', state.isReadOnly));

                row.innerHTML = migrationCell + reverseMigrationCell + cells + actionsCell;
                tableBody.appendChild(row);
            });
        }

        /**
         * Obtiene el día de la semana (1=Lunes, ..., 7=Domingo, 0=Domingo en getDay()) a partir de una fecha en formato DD/MM/YYYY.
         * @param {string} dateString - La fecha en formato "DD/MM/YYYY".
         * @returns {number} El número del día de la semana (1-7) o -1 si hay un error.
         */
        function getDayOfWeek(dateString) {
            if (!dateString || typeof dateString !== 'string') return -1;
            try {
                // Formato esperado: DD/MM/YYYY
                const [day, month, year] = dateString.split('/');
                // Ojo: los meses en JS son 0-indexados (Enero=0)
                const date = new Date(year, month - 1, day);
                // getDay() devuelve 0 para Domingo, 1 para Lunes, etc.
                return date.getDay();
            } catch (e) {
                return -1; // Retorna un valor inválido si la fecha no se puede parsear
            }
        }

        /**
         * Aplica todos los filtros activos (búsqueda general, filtros de columna, filtro de día) a un conjunto de datos.
         * @param {Array<Object>} data - El conjunto de datos a filtrar.
         * @param {'main'|'historical'} filterKey - La clave que identifica el conjunto de filtros a usar ('main' o 'historical').
         * @returns {Array<Object>} Los datos filtrados.
         */
        function applyAllFilters(data, filterKey) {
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = state.activeFilters[filterKey];

            return data.filter(item => {
                // Filtro del dashboard de días de la semana (solo para la tabla principal)
                if (filterKey === 'main' && state.ui.activeDayFilter !== null) {
                    const callDay = getDayOfWeek(item.fecha);
                    if (callDay !== state.ui.activeDayFilter) return false;
                }

                // 1. Check search box filter
                const matchesSearch = searchText === '' || Object.values(item).some(value => 
                    String(value).toLowerCase().includes(searchText)
                );
                if (!matchesSearch) return false;

                // 2. Check column filters
                for (const col in columnFilters) {
                    if (columnFilters[col].length > 0) {
                        let itemValue = item[col] || 'N/A';
                        if (col === 'duracion') itemValue = formatDuration(item[col]);
                        if (col === 'inicio' || col === 'fin') itemValue = formatTimeWithAmPm(item[col]);

                        if (!columnFilters[col].includes(itemValue)) {
                            return false;
                        }
                    }
                }
                return true;
            });
        }

        /**
         * Obtiene los datos pre-filtrados por todas las columnas excepto la especificada.
         * Esto es crucial para que los menús desplegables de filtro muestren solo opciones relevantes.
         * @param {function} dataProvider - Función que devuelve el conjunto de datos completo.
         * @param {'main'|'historical'} filterKey - 'main' o 'historical'.
         * @param {string} excludeColumn - La clave de la columna a excluir del filtrado.
         * @returns {Array} - Los datos filtrados.
         */
        function getPreFilteredData(dataProvider, filterKey, excludeColumn) {
            const allData = dataProvider();
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const columnFilters = state.activeFilters[filterKey];

            return allData.filter(item => {
                const matchesSearch = searchText === '' || Object.values(item).some(value => String(value).toLowerCase().includes(searchText));
                if (!matchesSearch) return false;

                return Object.entries(columnFilters).every(([col, values]) => {
                    if (col === excludeColumn || values.length === 0) return true;
                    const itemValue = col === 'duracion' ? formatDuration(item[col]) : (col === 'inicio' || col === 'fin' ? formatTimeWithAmPm(item[col]) : (item[col] || 'N/A'));
                    return values.includes(itemValue);
                });
            });
        }

        /**
         * Configura los manejadores de eventos para los encabezados de columna filtrables.
         * Crea y gestiona los menús desplegables de filtro.
         * @param {string} headerId - El ID del `<tr>` que contiene los encabezados.
         * @param {Function} dataProvider - Una función que devuelve los datos a filtrar.
         * @param {Function} renderFunc - La función que renderiza la tabla.
         * @param {'main'|'historical'} filterKey - La clave del conjunto de filtros.
         * @param {Function} [dayFilterProvider] - Proveedor opcional para datos pre-filtrados por día.
         */
        function setupColumnFilters(headerId, dataProvider, renderFunc, filterKey, dayFilterProvider) {
            const headerRow = document.getElementById(headerId);
            headerRow.addEventListener('click', e => {
                const header = e.target.closest('.filterable-header');
                
                // Nueva lógica: si el filtro de día está activo, el dataProvider debe ser el conjunto filtrado.
                let currentDataProvider = dataProvider;
                if (dayFilterProvider) {
                    const dayFilteredData = dayFilterProvider();
                    // Si hay datos filtrados por día, los usamos como base.
                    if (dayFilteredData) currentDataProvider = () => dayFilteredData;
                }

                if (!header) return;

                if (state.ui.currentFilterDropdown) {
                    state.ui.currentFilterDropdown.remove();
                    state.ui.currentFilterDropdown = null;
                }

                const filterBy = header.dataset.filterBy;
                
                // Usar los datos pre-filtrados para generar las opciones del dropdown.
                const preFilteredData = getPreFilteredData(currentDataProvider, filterKey, filterBy);

                const uniqueValues = [...new Set(preFilteredData.map(item => {
                    if (filterBy === 'duracion') return formatDuration(item.duracion);
                    if (filterBy === 'inicio' || filterBy === 'fin') return formatTimeWithAmPm(item[filterBy]);
                    return item[filterBy] || 'N/A';
                }))].sort((a, b) => {
                    // Lógica de ordenamiento personalizada para fechas
                    if (filterBy === 'fecha') {
                        try {
                            const [dayA, monthA, yearA] = a.split('/');
                            const [dayB, monthB, yearB] = b.split('/');
                            const dateA = new Date(`${yearA}-${monthA}-${dayA}`);
                            const dateB = new Date(`${yearB}-${monthB}-${dayB}`);
                            return dateA - dateB; // Orden ascendente
                        } catch (e) { return a.localeCompare(b); }
                    }
                    return a.localeCompare(b, 'es', { numeric: true });
                });

                const dropdown = document.createElement('div');
                dropdown.className = 'filter-dropdown p-2 space-y-1';
                
                const activeColumnFilters = state.activeFilters[filterKey][filterBy] || [];

                dropdown.innerHTML = `
                    <div class="p-1 border-b border-gray-200">
                        <input type="text" placeholder="Buscar opciones..." class="filter-search-input w-full text-xs p-1 border rounded-md focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div class="filter-options-container max-h-48 overflow-y-auto">
                        ${uniqueValues.map(value => `
                            <label class="flex items-center space-x-2 p-1 hover:bg-gray-100 rounded cursor-pointer filter-option-label">
                                <input type="checkbox" class="filter-checkbox" value="${value}" ${activeColumnFilters.includes(value) ? 'checked' : ''}>
                                <span class="text-sm text-gray-700">${value}</span>
                            </label>
                        `).join('')}
                    </div>
                    <div class="border-t my-1"></div>
                    <div class="p-1"><button class="clear-filter-btn text-blue-500 hover:underline text-xs" data-filter-by="${filterBy}">Limpiar filtro</button></div>
                `;

                document.body.appendChild(dropdown);
                const rect = header.getBoundingClientRect();
                dropdown.style.top = `${rect.bottom + window.scrollY}px`;
                dropdown.style.left = `${rect.left + window.scrollX}px`;
                state.ui.currentFilterDropdown = dropdown;

                // Lógica para el buscador dentro del filtro
                const searchInput = dropdown.querySelector('.filter-search-input');
                const labels = dropdown.querySelectorAll('.filter-option-label');
                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    labels.forEach(label => {
                        const text = label.textContent.toLowerCase();
                        const isVisible = text.includes(searchTerm);
                        label.style.display = isVisible ? 'flex' : 'none';
                    });
                });

                dropdown.addEventListener('change', e => {
                    if (e.target.classList.contains('filter-checkbox')) {
                        const checkedValues = Array.from(dropdown.querySelectorAll('.filter-checkbox:checked')).map(cb => cb.value);
                        state.activeFilters[filterKey][filterBy] = checkedValues;
                        header.classList.toggle('active', checkedValues.length > 0);
                        const filteredData = applyAllFilters(currentDataProvider(), filterKey);
                        renderFunc(filterKey === 'main' ? DOM.callLogTableBody : DOM.historicalTableBody, filteredData, filterKey === 'historical');
                    }
                });

                dropdown.querySelector('.clear-filter-btn').addEventListener('click', () => {
                    state.activeFilters[filterKey][filterBy] = [];
                    header.classList.remove('active');
                    const filteredData = applyAllFilters(currentDataProvider(), filterKey);
                    renderFunc(filterKey === 'main' ? DOM.callLogTableBody : DOM.historicalTableBody, filteredData, filterKey === 'historical');
                    if (state.ui.currentFilterDropdown) state.ui.currentFilterDropdown.remove();
                });
            });

            document.addEventListener('click', (e) => {
                if (state.ui.currentFilterDropdown && !state.ui.currentFilterDropdown.contains(e.target) && !e.target.closest('.filterable-header')) {
                    state.ui.currentFilterDropdown.remove();
                    state.ui.currentFilterDropdown = null;
                }
            }, true);
        }
        
        /**
         * Configura el campo de búsqueda general para una tabla.
         * @param {string} inputId - El ID del campo de input para la búsqueda.
         * @param {Function} dataProvider - Función que devuelve los datos a filtrar.
         * @param {Function} renderFunc - La función que renderiza la tabla.
         * @param {boolean} [isHistorical=false] - Indica si es la tabla histórica.
         */
        function setupFiltering(inputId, dataProvider, renderFunc, isHistorical = false) {
            const filterInput = document.getElementById(inputId);
            const filterKey = isHistorical ? 'historical' : 'main';
            const clearFilterBtn = document.getElementById(`clear-filter-btn-${filterKey}`);
            filterInput.addEventListener('input', () => {
                const filterText = filterInput.value.toLowerCase();
                clearFilterBtn.classList.toggle('hidden', !filterText);
                const filteredData = applyAllFilters(dataProvider(), filterKey);
                renderFunc(isHistorical ? DOM.historicalTableBody : DOM.callLogTableBody, filteredData, isHistorical);
            });
            clearFilterBtn.addEventListener('click', () => {
                filterInput.value = ''; filterInput.dispatchEvent(new Event('input'));
            });
        }

        /**
         * Limpia todos los filtros aplicados a una tabla (búsqueda, columnas, día) y la vuelve a renderizar.
         * @param {'main'|'historical'} filterKey - La clave de la tabla cuyos filtros se limpiarán.
         */
        function clearAllFilters(filterKey) {
            // 1. Limpiar el estado de los filtros de columna
            state.activeFilters[filterKey] = {};

            // 2. Limpiar el campo de búsqueda
            const searchInput = document.getElementById(`filter-input-${filterKey}`);
            if (searchInput) searchInput.value = '';

            // 3. Limpiar visualmente los encabezados de columna activos
            const tableId = filterKey === 'main' ? 'main-table-header' : 'historical-table-header';
            document.querySelectorAll(`#${tableId} .filterable-header.active`).forEach(h => h.classList.remove('active'));

            // 4. Si es la tabla principal, limpiar también el filtro de día
            if (filterKey === 'main') {
                state.ui.activeDayFilter = null;
                document.querySelectorAll('#dashboard .indicator-card.active-filter').forEach(card => card.classList.remove('active-filter'));
            }

            // 5. Re-renderizar la tabla correspondiente con los datos completos
            const data = filterKey === 'main' ? state.calls : state.historicalCalls;
            sortAndRenderTable(filterKey === 'main' ? DOM.callLogTableBody : DOM.historicalTableBody, data, filterKey === 'historical');
        }

        /**
         * Ordena los datos por fecha y hora de inicio (más recientes primero) y luego los renderiza en la tabla.
         * @param {HTMLTableSectionElement} tableBody - El `<tbody>` de la tabla.
         * @param {Array<Object>} data - El array de datos de llamadas.
         * @param {boolean} isHistorical - Indica si son datos históricos.
         */
        function sortAndRenderTable(tableBody, data, isHistorical) {
            // Ordenar los datos por fecha y luego por hora de inicio (más recientes primero)
            data.sort((a, b) => {
                try {
                    // Construir objetos Date completos para una comparación precisa
                    const [dayA, monthA, yearA] = a.fecha.split('/').map(part => part.padStart(2, '0'));
                    const timeA24 = convertTo24HourFormat(a.inicio);
                    const dateTimeA = new Date(`${yearA}-${monthA}-${dayA}T${timeA24}`);

                    const [dayB, monthB, yearB] = b.fecha.split('/').map(part => part.padStart(2, '0'));
                    const timeB24 = convertTo24HourFormat(b.inicio);
                    const dateTimeB = new Date(`${yearB}-${monthB}-${dayB}T${timeB24}`);

                    // Validar que las fechas sean válidas antes de comparar
                    if (isNaN(dateTimeA.getTime()) || isNaN(dateTimeB.getTime())) {
                        return 0; // No ordenar si hay datos inválidos
                    }

                    // Para orden descendente (más reciente primero), restar A de B
                    return dateTimeB - dateTimeA;
                } catch (e) {
                    // Fallback por si algún dato está malformado y causa un error
                    console.warn("No se pudo ordenar un elemento por datos malformados:", { itemA: a, itemB: b, error: e });
                    return 0;
                }
            });

            const filterKey = isHistorical ? 'historical' : 'main';
            const filteredData = applyAllFilters(data, filterKey);
            renderTable(tableBody, filteredData, isHistorical);
        }

        /**
         * Formatea una fecha en formato "DD/MM/YYYY" a un formato largo (ej. "lunes, 1 de enero de 2024").
         * @param {string} dateString - La fecha en formato "DD/MM/YYYY".
         * @returns {string} La fecha en formato largo.
         */
        function formatLongDate(dateString) {
            if (!dateString || typeof dateString !== 'string' || !dateString.includes('/')) return 'Fecha no disponible';
            try {
                const [day, month, year] = dateString.split('/').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    timeZone: 'UTC'
                };
                return new Intl.DateTimeFormat('es-ES', options).format(date);
            } catch (e) { return dateString; }
        }

        /**
         * Actualiza todos los dashboards de la aplicación (resumen por día y resumen general).
         */
        function updateAllDashboards() {            
            updateWeekdayDashboard();
            // Dashboard de Histórico (fuente variable)
            const sourceHistorico = DOM.dashboardDataSourceHistorico.value;
            let dataHistorico = [];
            if (sourceHistorico === 'historico') {
                dataHistorico = state.historicalCalls;
            } else if (sourceHistorico === 'registro') {
                dataHistorico = state.calls;
            } else if (sourceHistorico === 'combinado') {
                dataHistorico = [...state.calls, ...state.historicalCalls];
            }
            updateSingleDashboard(dataHistorico, DOM.totalCallsElemHistorico, DOM.avgDurationElemHistorico, DOM.salientesCountElemHistorico, DOM.entrantesCountElemHistorico);
        }

        /**
         * Actualiza el dashboard de resumen operativo que muestra el total de llamadas por día de la semana.
         */
        function updateWeekdayDashboard() {
            const dayCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 }; // Lunes a Viernes
            const dayIds = { 1: 'lunes', 2: 'martes', 3: 'miercoles', 4: 'jueves', 5: 'viernes' };

            state.calls.forEach(call => {
                const day = getDayOfWeek(call.fecha);
                if (day >= 1 && day <= 5) { // Solo contar de Lunes a Viernes
                    dayCounts[day]++;
                }
            });

            for (const dayNum in dayCounts) {
                const countElement = document.getElementById(`calls-${dayIds[dayNum]}-count`);
                if (countElement) {
                    countElement.textContent = dayCounts[dayNum];
                }
            }

            // Resaltar el día actual
            const today = new Date().getDay(); // 0=Dom, 1=Lun, ...
            const iconColors = { 1: 'text-blue-500', 2: 'text-indigo-500', 3: 'text-purple-500', 4: 'text-pink-500', 5: 'text-green-500' };

            document.querySelectorAll('#dashboard .indicator-card').forEach(card => {
                const day = parseInt(card.dataset.day);
                const iconElement = card.querySelector('i');
                const defaultIcon = iconElement.dataset.defaultIcon;

                // 1. Restablecer el estilo y el icono por defecto
                card.classList.remove('current-day-highlight');
                iconElement.className = `fa-solid ${defaultIcon} ${iconColors[day]} text-xl`;

                // 2. Aplicar el estilo especial para el día actual
                if (day === today) {
                    card.classList.add('current-day-highlight');
                    // Cambiar el icono y el color para el día actual
                    iconElement.classList.remove(iconColors[day]);
                    iconElement.classList.add('fa-calendar-star', 'text-primary');
                }
            });
        }
        
        /**
         * Actualiza los elementos de un dashboard específico (tarjetas de métricas) con los datos proporcionados.
         * @param {Array<Object>} data - Los datos de llamadas a analizar.
         * @param {HTMLElement} totalElem - Elemento para el total de llamadas.
         * @param {HTMLElement} avgElem - Elemento para la duración promedio.
         * @param {HTMLElement} salientesElem - Elemento para el total de llamadas salientes.
         * @param {HTMLElement} entrantesElem - Elemento para el total de llamadas entrantes.
         */
        function updateSingleDashboard(data, totalElem, avgElem, salientesElem, entrantesElem) {
            const totalCalls = data.length;
            const salientes = data.filter(c => c.estatus === 'Saliente').length;
            const entrantes = totalCalls - salientes;
            const totalDuration = data.reduce((sum, c) => sum + (Number(c.duracion) || 0), 0);
            const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;

            if (totalElem) totalElem.textContent = totalCalls;
            if (avgElem) avgElem.textContent = formatDuration(avgDuration);
            if (salientesElem) salientesElem.textContent = salientes;
            if (entrantesElem) entrantesElem.textContent = entrantes;
        }

        // =============================================
        // MÓDULO: Gestión de llamadas
        // Descripción: Funciones para el ciclo de vida de una llamada: iniciar, detener, guardar,
        // actualizar, eliminar y editar.
        // =============================================

        /**
         * Inicia una nueva llamada: abre el modal, resetea el formulario y comienza el temporizador.
         */
        function startTimer() {
            DOM.callForm.reset();
            toggleCallActiveState(true); // Activar el estado de llamada activa
            // Reset all select2 fields
            $('#call-form select').val(null).trigger('change');
            openModal(DOM.callModal);

            const atendioSelect = $('#call-atendio');
            if (atendioSelect.find("option[value='AGMO']").length) {
                atendioSelect.val('AGMO').trigger('change');
            }

            // Seleccionar "INSTITUCIÓN" en "Área" si existe la opción.
            const areaSelect = $('#call-area');
            if (areaSelect.find("option[value='INSTITUCIÓN']").length) {
                areaSelect.val('INSTITUCIÓN').trigger('change');
            }

            state.ui.callStartTime = Date.now();
            state.ui.timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - state.ui.callStartTime) / 1000);
                DOM.modalTimerElem.textContent = formatDuration(elapsed);
            }, 1000);
        }

        /**
         * Activa o desactiva el estado de "llamada activa", deshabilitando botones de acción en toda la app.
         * @param {boolean} isActive - `true` para activar el estado, `false` para desactivar.
         */
        function toggleCallActiveState(isActive) {
            state.ui.isCallModalActive = isActive;
        
            const buttonsToDisable = [
                // Botones de la tabla principal
                DOM.startCallBtn,
                ...document.querySelectorAll('#call-log .edit-btn'),
                ...document.querySelectorAll('#call-log .delete-btn'),
                DOM.downloadExcelBtn,
                DOM.startMigrationBtn,
                // Botones de la tabla histórica
                ...document.querySelectorAll('#historical-log .edit-btn'),
                ...document.querySelectorAll('#historical-log .delete-btn'),
                document.getElementById('download-historical-excel-btn'),
                document.getElementById('historical-file-input').parentElement, // El label
                DOM.confirmImportHistoricalBtn,
                DOM.startReverseMigrationBtn,
            ];
        
            buttonsToDisable.forEach(btn => {
                if (btn) btn.disabled = isActive;
            });
        }
        
        /**
         * Detiene el temporizador de la llamada y, si se indica, guarda los datos.
         * @param {boolean} [shouldSave=true] - Si es `true`, los datos del formulario se guardan.
         */
        function stopTimer(shouldSave = true) {
            clearInterval(state.ui.timerInterval);
            if (shouldSave) {
                const endTime = new Date();
                const duration = Math.floor((endTime - state.ui.callStartTime) / 1000);
                const formData = new FormData(DOM.callForm);
                const callData = Object.fromEntries(formData.entries());
                
                callData.fecha = new Date(state.ui.callStartTime).toLocaleDateString('es-ES');
                callData.inicio = new Date(state.ui.callStartTime).toLocaleTimeString('es-ES', { hour12: false });
                callData.fin = endTime.toLocaleTimeString('es-ES', { hour12: false });
                callData.duracion = duration;
                callData.estatus = 'Entrante'; // Por defecto, las llamadas nuevas son 'Entrante'
                saveCall(callData);
            }
            resetTimer();
        }

        /**
         * Resetea el temporizador del modal a "00:00:00".
         */
        function resetTimer() {
            DOM.modalTimerElem.textContent = '00:00:00';
        }
        
        /**
         * Guarda un nuevo registro de llamada en la colección 'calls' de Firestore.
         * Incluye un mecanismo de respaldo en localStorage si falla la conexión.
         * @param {Object} callData - El objeto con los datos de la llamada a guardar.
         * @returns {Promise<void>}
         */
        async function saveCall(callData) {
            try {
                await addDoc(callsCollectionRef, { ...callData, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                showAlert("Llamada guardada con éxito!", "success");
            } catch (error) {
                console.error("Error al guardar la llamada:", error);
                showAlert(`Error al guardar: ${error.message}`, "error");
                
                // Intentar guardar en localStorage como respaldo
                try {
                    const backupCalls = JSON.parse(localStorage.getItem('backupCalls') || '[]');
                    backupCalls.push({ ...callData, id: Date.now().toString() });
                    localStorage.setItem('backupCalls', JSON.stringify(backupCalls));
                    showAlert("Datos guardados localmente como respaldo", "warning");
                } catch (backupError) {
                    console.error("Error al guardar respaldo:", backupError);
                }
            }
        }

        /**
         * Actualiza un registro de llamada existente en Firestore.
         * @param {string} id - El ID del documento a actualizar.
         * @param {Object} updateData - El objeto con los campos a actualizar.
         * @param {boolean} isHistorical - `true` si la llamada está en la colección histórica.
         * @returns {Promise<void>}
         */
        async function updateCall(id, updateData, isHistorical) {
            if (!id) {
                console.error("ID no válido para actualización");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalCallsCollectionRef : callsCollectionRef;
                const callDocRef = doc(db, collectionRef.path, id);
                
                // Verificar si el documento existe antes de intentar actualizarlo
                const docSnapshot = await getDoc(callDocRef);
                if (!docSnapshot.exists()) {
                    showAlert("El registro que intentas actualizar no existe", "error");
                    return;
                }
                
                await updateDoc(callDocRef, { ...updateData, updatedAt: serverTimestamp() });
                showAlert("Llamada actualizada con éxito!", "success");
            } catch (error) {
                console.error("Error al actualizar la llamada:", error);
                showAlert(`Error al actualizar: ${error.message}`, "error");
            }
        }

        /**
         * Elimina un registro de llamada de Firestore.
         * @param {string} id - El ID del documento a eliminar.
         * @param {boolean} isHistorical - `true` si la llamada está en la colección histórica.
         * @returns {Promise<void>}
         */
        async function deleteCall(id, isHistorical) {
            if (!id) {
                console.error("ID no válido para eliminación");
                showAlert("Error interno: ID no válido", "error");
                return;
            }
            
            try {
                const collectionRef = isHistorical ? historicalCallsCollectionRef : callsCollectionRef;
                const callDocRef = doc(db, collectionRef.path, id);
                
                // Verificar si el documento existe antes de intentar eliminarlo
                const docSnapshot = await getDoc(callDocRef);
                if (!docSnapshot.exists()) {
                    showAlert("El registro que intentas eliminar no existe", "error");
                    return;
                }
                
                await deleteDoc(callDocRef);
                showAlert("Llamada eliminada con éxito!", "success");
            } catch (error) {
                console.error("Error al eliminar la llamada:", error);
                showAlert(`Error al eliminar: ${error.message}`, "error");
            }
        }

        /**
         * Maneja el evento de clic en el botón de editar de una fila de la tabla.
         * @param {HTMLElement} button - El botón que fue presionado.
         */
        function handleEditClick(button) {
            if (state.isReadOnly) return; // No permitir edición en modo solo lectura
            requirePassword(() => {
                const callId = button.getAttribute('data-id');
                const isHistorical = button.getAttribute('data-is-historical') === 'true';

                if (!callId) {
                    console.error("ID de llamada no encontrado para edición");
                    return;
                }

                state.ui.currentEditIsHistorical = isHistorical;
                const allData = isHistorical ? (Array.isArray(state.historicalCalls) ? state.historicalCalls : []) : (Array.isArray(state.calls) ? state.calls : []);
                const callToEdit = allData.find(call => String(call.id) === String(callId));

                if (!callToEdit) {
                    showAlert("No se pudo encontrar la llamada para editar", "error");
                    return;
                }

                DOM.editForm.querySelector('#edit-id').value = callId;

                // Helper local: asegurar y seleccionar opción en Select2
                function ensureSelectHasAndSelect($sel, value, text) {
                    if (!$sel || !$sel.length) return;
                    // Si las opciones usan id/text como objetos select2, permitir ambas formas:
                    const hasValue = $sel.find(`option[value="${value}"]`).length > 0;
                    if (!hasValue) {
                        // Crear opción nueva y marcarla seleccionada
                        const opt = new Option(text || value, value, true, true);
                        $sel.append(opt);
                        if ($sel.data('select2')) {
                            $sel.trigger('change.select2');
                        }
                    } else {
                        $sel.val(value).trigger('change.select2');
                    }
                }

                // Helper: normalizar y construir lista de nombres para la institución (sin depender de otros handlers)
                function buildNamesForInstitution(allData, institution) {
                    if (!Array.isArray(allData)) return [];
                    const names = [...new Set(
                        allData.filter(c => c && c.institucion === institution)
                            .map(c => c.nombre)
                            .filter(Boolean)
                    )].sort();
                    return names;
                }

                // 1) Setear institución, área, asunto, etc. (esto puede disparar handlers, pero no confiamos en ellos para poblar nombres)
                $('#edit-caller-institution').val(callToEdit.institucion || '').trigger('change.select2');
                $('#edit-call-area').val(callToEdit.area || '').trigger('change.select2');
                $('#edit-call-subject').val(callToEdit.asunto || '').trigger('change.select2');
                $('#edit-call-query').val(callToEdit.consulta || '').trigger('change.select2');

                // 2) Poblar directamente las opciones del select "nombre" basadas en la institución (no depender del handler global)
                const namesForInst = buildNamesForInstitution([... (Array.isArray(state.calls)?state.calls:[]), ...(Array.isArray(state.historicalCalls)?state.historicalCalls:[])], callToEdit.institucion || '');

                const $editName = $('#edit-caller-name');

                // Normalizar formato para select2: {id, text}
                const optionsData = namesForInst.map(n => ({ id: n, text: n }));

                // Re-inicializar / actualizar Select2 para el select de nombres con los datos correctos
                if ($editName.length) {
                    if ($editName.data('select2')) {
                        $editName.empty().select2({
                            data: optionsData,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });
                    } else {
                        $editName.select2({
                            data: optionsData,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });
                    }
                }

                // 3) Seleccionar el nombre correcto robustamente:
                //    Si las opciones usan id diferente al nombre (caso raro), buscar coincidencia por texto y usar su id.
                const desiredName = callToEdit.nombre || '';
                let selected = false;
                if ($editName.length && $editName.data('select2')) {
                    const sdata = $editName.select2('data') || [];
                    // buscar coincidencia por texto
                    const byText = sdata.find(d => (d.text || '') === desiredName);
                    if (byText) {
                        $editName.val(byText.id).trigger('change.select2');
                        selected = true;
                    }
                }

                // Si no se seleccionó arriba (o select2 no estaba en modo objeto), asegurar y seleccionar por valor=nombre
                if (!selected) {
                    ensureSelectHasAndSelect($editName, desiredName, desiredName);
                }

                // 4) Rellenar campos restantes
                $('#edit-caller-cargo').val(callToEdit.cargo || '').trigger('change.select2');
                $('#edit-caller-email').val(callToEdit.correo || '').trigger('change.select2');
                $('#edit-caller-phone').val(callToEdit.telefono || '').trigger('change.select2');
                $('#edit-call-comments').val(callToEdit.comentarios || '').trigger('change.select2');
                $('#edit-call-atendio').val(callToEdit.atendio || '').trigger('change.select2');

                // 5) Abrir modal después de todo (para evitar race conditions visuales)
                openModal(DOM.editModal);
            });
        }

        //Evento para cerrar el boton de editar registro
        DOM.closeEditModalBtn.addEventListener('click', () => closeModal(DOM.editModal));

        /**
         * Maneja el cambio de estatus (Saliente/Entrante) de una llamada.
         * @param {HTMLElement} button - El botón de estatus que fue presionado.
         */
        async function handleStatusToggle(button) {
            if (state.isReadOnly) return; // No permitir cambio de estatus en modo solo lectura
            try {
                const callId = button.getAttribute('data-id');
                const isHistorical = button.getAttribute('data-is-historical') === 'true';
                
                if (!callId) {
                    console.error("ID de llamada no encontrado");
                    return;
                }
                
                const currentStatus = button.textContent.trim();
                const newStatus = currentStatus === 'Saliente' ? 'Entrante' : 'Saliente';
                
                await updateCall(callId, { estatus: newStatus }, isHistorical);
            } catch (error) {
                console.error("Error en handleStatusToggle:", error);
            }
        }

        /**
         * Maneja el evento de clic en el botón de eliminar de una fila de la tabla.
         * @param {HTMLElement} button - El botón que fue presionado.
         */
        function handleDeleteClick(button) {
            if (state.isReadOnly) return; // No permitir eliminación en modo solo lectura
            requirePassword(() => {
                callToDeleteId = button.getAttribute('data-id');
                state.ui.callToDeleteIsHistorical = button.getAttribute('data-is-historical') === 'true';
                
                if (!callToDeleteId) {
                    console.error("ID de llamada no encontrado para eliminación");
                    return;
                }
                
                openModal(DOM.confirmModal);
            });
        }


        // =============================================
        // MÓDULO: Gestión de datos históricos
        // Descripción: Funciones para importar y gestionar la colección de datos históricos.
        // =============================================
        
        /**
         * Elimina todos los documentos de la colección 'historicalCalls'.
         * @returns {Promise<void>}
         */
        async function deleteAllHistorical() {
            const batch = writeBatch(db);
            state.historicalCalls.forEach(call => {
                const ref = doc(historicalCallsCollectionRef, call.id);
                batch.delete(ref);
            });
            await batch.commit(); 
        }

        /**
         * Importa un lote de registros de llamadas a la colección 'historicalCalls'.
         * @param {Array<Object>} data - Un array de objetos de llamada para importar.
         */
        async function importHistoricalData(data) {
            try {
                const batch = writeBatch(db);
                data.forEach(item => {
                    const docRef = doc(historicalCallsCollectionRef);
                    batch.set(docRef, { ...item, importedAt: serverTimestamp() });
                });
                await batch.commit();
                showAlert(`Se han importado ${data.length} registros históricos.`, "success");
                
                // Forzar actualización de opciones y render
                updateDynamicSelectOptions();
                renderTable(DOM.historicalTableBody, state.historicalCalls, true);

            } catch (error) {
                console.error("Error al importar datos históricos:", error);
                showAlert(`Error al importar: ${error.message}`, "error");
            }
        }

        // =============================================
        // MÓDULO: Gestión de opciones dinámicas y autocompletado (Lista de Instituciones Homologada)
        // Descripción: Funciones para poblar, actualizar y gestionar las opciones de los
        // selectores dinámicos (Select2), incluyendo el autocompletado inteligente.
        // =============================================

        /**
         * Catálogo base de instituciones. Se combina con las instituciones existentes en la base de datos.
         */
        const catalogoInstitucionesHomologado = [
            "AGN - Archivo General de la Nación",
            "CEPROPIE - Centro de Producción de Programas Informativos y Especiales",
            "CONAVIM - Comisión Nacional para Prevenir y Erradicar la Violencia Contra las Mujeres",
            "CONAPRED - Consejo Nacional para Prevenir la Discriminación",
            "COMAR - Coordinación General de la Comisión Mexicana de Ayuda a Refugiados",
            "INM - Instituto Nacional de Migración",
            "INAFED - Instituto Nacional para el Federalismo y el Desarrollo Municipal",
            "SEGOB - Secretaría de Gobernación",
            "CONAPO - Secretaría General del Consejo Nacional de Población",
            "SIPINNA - Sistema Nacional de Protección Integral de Niñas, Niños y Adolescentes",
            "TGM - Talleres Gráficos de México",
            "AMEXCID - Agencia Mexicana de Cooperación Internacional para el Desarrollo",
            "IME - Instituto de Mexicanas y Mexicanos en el Exterior",
            "IMR - Instituto Matías Romero",
            "SRE  - Secretaría de Relaciones Exteriores",
            "AGROASEMEX - Agroasemex, S.A.",
            "BANBI - Banco del Bienestar, S.N.C., I.B.D.",
            "BANJERCITO - Banco Nacional del Ejército, Fuerza Aérea y Armada, S.N.C.",
            "CMM - Casa de Moneda de México",
            "CNBV - Comisión Nacional Bancaria y de Valores",
            "CNSF - Comisión Nacional de Seguros y Fianzas",
            "CONSAR - Comisión Nacional del Sistema de Ahorro para el Retiro",
            "CONDUSEF - Comisión Nacional para la Protección y Defensa de los Usuarios de Servicios Financieros",
            "FOCIR - Fondo de Capitalización e Inversión del Sector Rural",
            "INDAABIN - Instituto de Administración y Avalúos de Bienes Nacionales",
            "INDEP - Instituto para Devolver al Pueblo lo Robado",
            "IPAB - Instituto para la Protección al Ahorro Bancario",
            "LOTENAL - Lotería Nacional",
            "LOTENAL - Lotería Nacional Para la Asistencia Pública",
            "SHCP - Secretaría de Hacienda y Crédito Público",
            "SAT - Servicio de Administración Tributaria",
            "ISSFAM - Instituto de Seguridad Social para las Fuerzas Armadas Mexicanas",
            "DEFENSA - Secretaría de la Defensa Nacional",
            "COLPOS - Colegio de Postgraduados",
            "CSAEGRO - Colegio Superior Agropecuario del Estado de Guerrero",
            "CONAPESCA - Comisión Nacional de Acuacultura y Pesca",
            "CONAZA - Comisión Nacional de las Zonas Áridas",
            "CONADESUCA - Comité Nacional para el Desarrollo Sustentable de la Caña de Azúcar",
            "DICONSA - Diconsa, S.A de C.V.",
            "FIRCO - Fideicomiso de Riesgo Compartido",
            "INIFAP - Instituto Nacional de Investigaciones Forestales, Agrícolas y Pecuarias",
            "INCARURAL - Instituto Nacional para el Desarrollo de Capacidades del Sector Rural, A.C.",
            "LICONSA - Liconsa, S.A. de C.V.",
            "PRONABIVE - Productora Nacional de Biológicos Veterinarios",
            "AGRICULTURA - Secretaría de Agricultura y Desarrollo Rural",
            "SIAP - Servicio de Información Agroalimentaria y Pesquera",
            "SNICS - Servicio Nacional de Inspección y Certificación de Semillas",
            "SENASICA - Servicio Nacional de Sanidad, Inocuidad y Calidad Agroalimentaria",
            "ASA - Aeropuertos y Servicios Auxiliares",
            "AEM - Agencia Espacial Mexicana",
            "CAPUFE - Caminos y Puentes Federales de Ingresos y Servicios Conexos",
            "FINABIEN - Financiera para el Bienestar",
            "GACM - Grupo Aeroportuario de la Ciudad de México, S.A. de C.V.",
            "IMT - Instituto Mexicano del Transporte",
            "SICT - Secretaría de Infraestructura, Comunicaciones y Transportes",
            "SEPOMEX - Servicio Postal Mexicano",
            "SENEAM - Servicios a la Navegación en el Espacio Aéreo Mexicano",
            "CENAM - Centro Nacional de Metrología",
            "CONADIC - Comisión Nacional de Salud Mental y Adicciones",
            "CONAMER - Comisión Nacional de Mejora Regulatoria",
            "EXPOSAL - Exportadora de Sal, S.A. de C.V.",
            "FIFOMI - Fideicomiso de Fomento Minero",
            "IMPI - Instituto Mexicano de la Propiedad Industrial",
            "INDESOL - Instituto Nacional de Desarrollo Social",
            "INADEM - Instituto Nacional del Emprendedor",
            "PROFECO - Procuraduría Federal del Consumidor",
            "SE - Secretaría de Economía",
            "SCCPRI - Secretaría Técnica de la Comisión Calificadora de Publicaciones y Revistas Ilustradas",
            "SGM - Servicio Geológico Mexicano",
            "AEFCM - Autoridad Educativa Federal en la Ciudad de México",
            "CETI - Centro de Enseñanza Técnica Industrial",
            "CINVESTAV - Centro de Investigación y de Estudios Avanzados del Instituto Politécnico Nacional",
            "CRAE - Centro Regional de Alta Especialidad de Chiapas",
            "COLBACH - Colegio de Bachilleres",
            "CONALEP - Colegio Nacional de Educación Profesional Técnica",
            "CAAD - Comisión de Apelación y Arbitraje del Deporte",
            "COFAA - Comisión de Operación y Fomento de Actividades Académicas del Instituto Politécnico Nacional",
            "CONADE - Comisión Nacional de Cultura Física y Deporte",
            "CONALITEG - Comisión Nacional de Libros de Texto Gratuitos",
            "CONAFE - Consejo Nacional de Fomento Educativo",
            "PRENDE - Coordinación General @prende.mx",
            "CNBBBJ - Coordinación Nacional de Becas para el Bienestar Benito Juárez",
            "CONOCER - Fideicomiso de los Sistemas Normalizados de Competencia Laboral y de Certificación de Competencia Laboral",
            "FND - Financiera Nacional de Desarrollo Agropecuario, Rural, Forestal y Pesquero",
            "FCE - Fondo de Cultura Económica",
            "HRAEI - Hospital Regional de Alta Especialidad de Ixtapaluca",
            "HRAEPY - Hospital Regional de Alta Especialidad de la Península de Yucatán",
            "HRAEO - Hospital Regional de Alta Especialidad de Oaxaca",
            "HRAEB - Hospital Regional de Alta Especialidad del Bajío",
            "IEPSA - Impresora y Encuadernadora Progreso, S.A. de C.V.",
            "INSABI - Instituto de Salud para el Bienestar",
            "IMER - Instituto Mexicano de la Radio",
            "INIFED - Instituto Nacional de la Infraestructura Física Educativa",
            "INEA - Instituto Nacional para la Educación de los Adultos",
            "IPN - Instituto Politécnico Nacional",
            "NOTIMEX - Notimex, Agencia de Noticias del Estado Mexicano",
            "POI-IPN - Patronato de Obras e Instalaciones del Instituto Politécnico Nacional",
            "SEP - Secretaría de Educación Pública",
            "TecNM - Tecnológico Nacional de México",
            "USICAMM - Unidad del Sistema para la Carrera de las Maestras y los Maestros",
            "UNADM - Universidad Abierta y a Distancia de México",
            "UPN - Universidad Pedagógica Nacional",
            "APBP - Administración del Patrimonio de la Beneficencia Pública",
            "CNEGSR - Centro Nacional de Equidad de Género y Salud Reproductiva",
            "CENETEC - Centro Nacional de Excelencia Tecnológica en Salud",
            "CENAPRECE - Centro Nacional de Programas Preventivos y Control de Enfermedades",
            "CNTS - Centro Nacional de la Transfusión Sanguínea",
            "CENATRA - Centro Nacional de Trasplantes",
            "CENSIDA - Centro Nacional para la Prevención y el Control del VIH/SIDA",
            "CENSIA - Centro Nacional para la Salud de la Infancia y la Adolescencia",
            "CIJ - Centros de Integración Juvenil, A.C.",
            "COFEPRIS - Comisión Federal para la Protección contra Riesgos Sanitarios",
            "CONAMED - Comisión Nacional de Arbitraje Médico",
            "CONBIOETICA - Comisión Nacional de Bioética",
            "CNB - Comisión Nacional de Búsqueda",
            "COMESA - Compañía Mexicana de Exploraciones, S.A. de C.V",
            "CPTM - Consejo de Promoción Turística de México, S.A. de C.V.",
            "HGM - Hospital General de México \"Dr. Eduardo Liceaga\"",
            "GEA - Hospital General \"Dr. Manuel Gea González\"",
            "HIM - Hospital infantil de México Federico Gómez",
            "HJM - Hospital Juárez de México",
            "HRAEV - Hospital Regional de Alta Especialidad de Ciudad Victoria \"Bicentenario 2010\"",
            "INCAN - Instituto Nacional de Cancerología",
            "INCAR - Instituto Nacional de Cardiología Ignacio Chávez",
            "INCMNSZ - Instituto Nacional de Ciencias Médicas y Nutrición Salvador Zubirán",
            "INER - Instituto Nacional de Enfermedades Respiratorias Ismael Cosío Villegas",
            "GERIATRIA - Instituto Nacional de Geriatría",
            "INMEGEN - Instituto Nacional de Medicina Genómica",
            "INNN - Instituto Nacional de Neurología y Neurocirugía Manuel Velasco Suárez",
            "INP - Instituto Nacional de Pediatría",
            "INPER - Instituto Nacional de Perinatología Isidro Espinosa de los Reyes",
            "INPRFM - Instituto Nacional de Psiquiatría Ramón de la Fuente Muñiz",
            "INR - Instituto Nacional de Rehabilitación Luis Guillermo Ibarra Ibarra",
            "INSP - Instituto Nacional de Salud Pública",
            "BIRMEX - Laboratorios de Biológicos y Reactivos de México, S.A. de C.V.",
            "SALUD - Secretaría de Salud",
            "SAP - Servicios de Atención Psiquiátrica",
            "DIF - Sistema Nacional para el Desarrollo Integral de la Familia",
            "ASIPONA ALTAMIRA - Administración del Sistema Portuario Nacional Altamira, S.A. de C.V.",
            "ASIPONA COATZACOALCOS - Administración del Sistema Portuario Nacional Coatzacoalcos, S.A. de C.V.",
            "ASIPONA DOS BOCAS - Administración del Sistema Portuario Nacional Dos Bocas, S.A. de C.V.",
            "ASIPONA ENSENADA - Administración del Sistema Portuario Nacional Ensenada, S.A. de C.V.",
            "ASIPONA GUAYMAS - Administración del Sistema Portuario Nacional Guaymas, S.A. de C.V.",
            "ASIPONA LÁZARO CARDENAS - Administración del Sistema Portuario Nacional Lázaro Cárdenas, S.A. de C.V.",
            "ASIPONA MANZANILLO - Administración del Sistema Portuario Nacional Manzanillo, S.A. de C.V.",
            "ASIPONA MAZATLÁN - Administración del Sistema Portuario Nacional Mazatlán, S.A. de C.V.",
            "ASIPONA PROGRESO - Administración del Sistema Portuario Nacional Progreso, S.A. de C.V.",
            "ASIPONA CHIAPAS - Administración del Sistema Portuario Nacional Puerto Chiapas, S.A. de C.V.",
            "ASIPONA VALLARTA - Administración del Sistema Portuario Nacional Puerto Vallarta, S.A. de C.V.",
            "ASIPONA SALINA CRUZ - Administración del Sistema Portuario Nacional Salina Cruz, S.A. de C.V.",
            "ASIPONA TAMPICO - Administración del Sistema Portuario Nacional Tampico, S.A. de C.V.",
            "ASIPONA TOPOLOBAMPO - Administración del Sistema Portuario Nacional Topolobampo, S.A. de C.V.",
            "ASIPONA TUXPAN - Administración del Sistema Portuario Nacional Tuxpan, S.A. de C.V.",
            "ASIPONA VERACRUZ - Administración del Sistema Portuario Nacional Veracruz, S.A. de C.V.",
            "AICM - Aeropuerto Internacional de la Ciudad de México, S.A. de C.V.",
            "FUMPM - Fideicomiso Universidad Marítima y Portuaria de México",
            "MARINA - Secretaría de Marina",
            "CONASAMI - Comisión Nacional de los Salarios Mínimos",
            "CONAMPROS - Comité Nacional Mixto de Protección al Salario",
            "INFONACOT - Instituto del Fondo Nacional para el Consumo de los Trabajadores",
            "PROFEDET - Procuraduría Federal de la Defensa del Trabajo",
            "STyPS - Secretaría del Trabajo y Previsión Social",
            "CONAVI - Comisión Nacional de Vivienda",
            "FIFONAFE - Fideicomiso Fondo Nacional de Fomento Ejidal",
            "FONHAPO - Fidecomiso Fondo Nacional de Habitaciones Populares",
            "PROMEXICO - Fideicomiso ProMéxico",
            "INSUS - Instituto Nacional del Suelo Sustentable",
            "PA - Procuraduría Agraria",
            "RAN - Registro Agrario Nacional",
            "SEDATU - Secretaría de Desarrollo Agrario, Territorial y Urbano",
            "ASEA - Agencia Nacional de Seguridad Industrial y de Protección al Medio Ambiente del Sector Hidrocarburos",
            "CONANP - Comisión Nacional de Áreas Naturales Protegidas",
            "CONAGUA - Comisión Nacional del Agua",
            "CONAFOR - Comisión Nacional Forestal",
            "IMTA - Instituto Mexicano de Tecnología del Agua",
            "INECC - Instituto Nacional de Ecología y Cambio Climático",
            "PROFEPA - Procuraduría Federal de Protección al Ambiente",
            "SEMARNAT - Secretaría de Medio Ambiente y Recursos Naturales",
            "CENACE - Centro Nacional de Control de Energía",
            "CENAGAS - Centro Nacional de Control del Gas Natural",
            "CNH - Comisión Nacional de Hidrocarburos",
            "CNSNS - Comisión Nacional de Seguridad Nuclear y Salvaguardias",
            "CONUEE - Comisión Nacional para el Uso Eficiente de la Energía",
            "CNE - Comisión Nacional de Energía",
            "IMP - Instituto Mexicano del Petróleo",
            "INEEL - Instituto Nacional de Electricidad y Energías Limpias",
            "ININ - Instituto Nacional de Investigaciones Nucleares",
            "SENER - Secretaría de Energía",
            "CONADIS - Consejo Nacional para el Desarrollo y la Inclusión de las Personas con Discapacidad",
            "FONART - Fondo Nacional para el Fomento de las Artesanías",
            "IMJ - Instituto Mexicano de la Juventud",
            "INAES - Instituto Nacional de la Economía Social",
            "INAPAM - Instituto Nacional de las Personas Adultas Mayores",
            "BIENESTAR - Secretaría de Bienestar",
            "INFRAESTRUCTURA - FONATUR Infraestructura, S.A. de C.V.",
            "FTM - FONATUR Tren Maya, S.A. de C.V.",
            "FONATUR - Fondo Nacional de Fomento al Turismo",
            "SECTUR - Secretaría de Turismo",
            "CENAPRED - Centro Nacional de Prevención de Desastres",
            "CONASE - Coordinación Nacional Antisecuestro y Delitos de Alto Impacto",
            "PF - Policía Federal",
            "PRS - Prevención y Reinserción Social",
            "SESNSP - Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública",
            "SPF - Servicio de Protección Federal",
            "CJEF - Consejería Jurídica del Ejecutivo Federal",
            "CIDESI - Centro de Ingeniería y Desarrollo Industrial",
            "CICY - Centro de Investigación Científica de Yucatán, A.C.",
            "CICESE - Centro de investigación Científica y de Educación Superior de Ensenada, Baja California",
            "INFOTEC - INFOTEC Centro de Investigación e Innovación en Tecnologías de la Información y Comunicación",
            "CIAD - Centro de Investigación en Alimentación y Desarrollo, A.C.",
            "CENTROGEO - Centro de Investigación en Ciencias de Información Geoespacial, A.C.",
            "CIMAT - Centro de Investigación en Matemáticas, A.C.",
            "CIMAV - Centro de Investigación en Materiales Avanzados, S.C.",
            "CIQA - Centro de Investigación en Química Aplicada",
            "CIATEJ - Centro de Investigación y Asistencia en Tecnología y Diseño del Estado de Jalisco, A.C.",
            "CIDETEQ - Centro de Investigación y Desarrollo Tecnológico en Electroquímica, S.C.",
            "CIDE - Centro de Investigación y Docencia Económicas, A.C.",
            "CIESAS - Centro de Investigaciones y Estudios Superiores en Antropología Social",
            "CIBNOR - Centro de Investigaciones Biológicas del Noroeste, S.C.",
            "CIO - Centro de Investigaciones en Óptica, A.C.",
            "CIATEC - CIATEC, A.C. \"Centro de Innovación Aplicada en Tecnologías Competitivas\"",
            "CIATEQ - CIATEQ, A.C. Centro de Tecnología Avanzada",
            "COLEF - EI Colegio de la Frontera Norte, A.C.",
            "ECOSUR - EI Colegio de la Frontera Sur",
            "COLMICH - El Colegio de Michoacán, A.C.",
            "COLSAN - EI Colegio de San Luis, A.C.",
            "INECOL - Instituto de Ecología, A.C.",
            "MORA - Instituto de Investigaciones \"Dr. José María Luis Mora\"",
            "INAOE - Instituto Nacional de Astrofísica, Óptica y Electrónica",
            "IPICYT - Instituto Potosino de Investigación Científica y Tecnológica, A.C.",
            "SECIHTI - Secretaría de Ciencia, Humanidades, Tecnología e Innovación",
            "CCC - Centro de Capacitación Cinematográfica, A.C.",
            "CECUT - Compañía Operadora del Centro Cultural y Turístico de Tijuana, S.A. de C.V.",
            "EDUCAL - Educal, S.A. de C.V.",
            "ECHASA - Estudios Churubusco Azteca, S.A.",
            "FICINE - Fideicomiso para la Cineteca Nacional",
            "IMCINE - Instituto Mexicano de Cinematografía",
            "INAH - Instituto Nacional de Antropología e Historia",
            "INBAL - Instituto Nacional de Bellas Artes y Literatura",
            "INEHRM - Instituto Nacional de Estudios Históricos de las Revoluciones de México ",
            "INALI - Instituto Nacional de Lenguas Indígenas",
            "INDAUTOR - Instituto Nacional del Derecho de Autor ",
            "RE - Radio Educación",
            "CULTURA - Secretaría de Cultura",
            "CANAL 22 - Televisión Metropolitana, S.A. de C.V.",
            "ASERCA - Agencia de Servicios a la Comercialización y Desarrollo de Mercados Agropecuarios",
            "CEAV - Comisión Ejecutiva de Atención a Víctimas",
            "FIT - Ferrocarril del Istmo de Tehuantepec, S.A. de C.V.",
            "FCONST - FONATUR Constructora, S.A. de C.V.",
            "FOVISSSTE - Fondo de la Vivienda del Instituto de Seguridad y Servicios Sociales de los Trabajadores del Estado",
            "INNOVA BIENESTAR - InnovaBienestar de México, S.A.P.I. de C.V.",
            "ISSSTE - Instituto de Seguridad y Servicios Sociales de los Trabajadores del Estado",
            "IMSS - Instituto Mexicano del Seguro Social",
            "INACIPE - Instituto Nacional de Ciencias Penales",
            "INMUJERES - Instituto Nacional de las Mujeres",
            "INPI - Instituto Nacional de los Pueblos Indígenas",
            "INAPESCA - Instituto Mexicano de Investigación en Pesca y Acuacultura Sustentables",
            "PRODECON - Procuraduría de la Defensa del Contribuyente",
            "PGR - Fiscalía General de la República",
            "SABG - Secretaría Anticorrupción y Buen Gobierno",
            "SPR - Sistema Público de Radiodifusión del Estado Mexicano",
            "SUPERISSSTE - SUPERISSSTE",
            "PROMTEL - Organismo Promotor de Inversiones en Telecomunicaciones",
            "ZEE - Autoridad Federal para el Desarrollo de las Zonas Económicas Especiales",
            "CAIMFS - Coordinación para la Atención Integral de la Migración en la Frontera Sur",
            "SESNA - Secretaría Ejecutiva del Sistema Nacional Anticorrupción",
            "CIIT - Corredor Interoceánico del Istmo de Tehuantepec",
            "CONEVAL - Consejo Nacional de Evaluación de la Política de Desarrollo Social",
            "SSPC - Secretaría de Seguridad y Protección Ciudadana",
            "SEGALMEX - Seguridad Alimentaria Mexicana",
            "AFAC - Agencia Federal de Aviación Civil",
            "ARTF - Agencia Reguladora del Transporte Ferroviario",
            "CFCRL - Centro Federal de Conciliación y Registro Laboral",
            "ANAM - Agencia Nacional de Aduanas de México",
            "AIFA - Aeropuerto Internacional Felipe Ángeles, S.A. de C.V.",
            "GN - Guardia Nacional",
            "MEJOREDU - Comisión Nacional para la Mejora Continua de la Educación",
            "SHF - Sociedad Hipotecarla Federal, S.N.C.",
            "IMIPAS - Instituto Mexicano de Investigación en Pesca y Acuacultura Sustentables",
            "OCUBBJG - Organismo Coordinador de las Universidades para el Bienestar Benito Juárez García",
            "CONASAMA - Comisión Nacional de Salud Mental y Adicciones",
            "IMSS BIENESTAR - Servicios de Salud del Instituto Mexicano del Seguro Social para el Bienestar (IMSS-BIENESTAR)",
            "TREN MAYA - Tren Maya, S.A. de C.V.",
            "ATDT - Agencia de Transformación Digital y Telecomunicaciones",
            "GAFSACOMM - Grupo Aeroportuario, Ferroviario, de Servicios Auxiliares y Conexos Olmeca - Maya - Mexica, S.A. de C.V.",
            "No Capturado - No Capturado",
            "ASOCIACIÓN MEXICANA - Asociación Mexicana",
            "MUJERES - Secretaría de las Mujeres"
        ];
        
        /**
         * Actualiza las opciones de todos los selectores dinámicos de la aplicación.
         * Extrae valores únicos de los datos existentes y los fusiona con catálogos base.
         */
        function updateDynamicSelectOptions() {
            const allData = [...state.calls, ...state.historicalCalls];
            // 1. Extraer todas las instituciones existentes en los registros.
            const historicalInstitutions = allData.map(c => c.institucion).filter(Boolean).map(i => i.trim());
            
            // 2. Fusionar el catálogo oficial con las instituciones históricas.
            const combinedInstitutions = [...new Set([...catalogoInstitucionesHomologado, ...historicalInstitutions])].sort();
            
            // 3. Actualizar el estado global y el selector de UI.
            state.fieldOptions.instituciones = combinedInstitutions;
            updateSelectOptions('instituciones', state.fieldOptions.instituciones);
        
            // Se extraen los valores únicos de los datos existentes, se normalizan y se ordenan.
            state.fieldOptions.areas = [...new Set(allData.map(c => c.area).filter(Boolean).map(v => v.trim()))].sort();
            state.fieldOptions.asuntos = [...new Set(allData.map(c => c.asunto).filter(Boolean).map(v => v.trim()))].sort();
            state.fieldOptions.consultas = [...new Set(allData.map(c => c.consulta).filter(Boolean).map(v => v.trim()))].sort();
            state.fieldOptions.nombres = [...new Set(allData.map(c => c.nombre).filter(Boolean).map(v => v.trim()))].sort();
            state.fieldOptions.cargos = [...new Set(allData.map(c => c.cargo).filter(Boolean).map(v => v.trim()))].sort();
            state.fieldOptions.correos = [...new Set(allData.map(c => c.correo).filter(Boolean).map(v => v.trim()))].sort();
            state.fieldOptions.telefonos = [...new Set(allData.map(c => c.telefono).filter(Boolean).map(v => String(v).trim()))].sort();
            state.fieldOptions.comentarios = [...new Set(allData.map(c => c.comentarios).filter(Boolean).map(v => v.trim()))].sort();
            state.fieldOptions.atendioUsers = [...new Set(allData.map(c => c.atendio).filter(Boolean).map(v => v.trim()))].sort();
            
            // Se actualizan los selectores correspondientes en la UI.
            updateSelectOptions('areas', state.fieldOptions.areas);
            updateSelectOptions('asuntos', state.fieldOptions.asuntos);
            updateSelectOptions('consultas', state.fieldOptions.consultas);
            updateSelectOptions('nombres', state.fieldOptions.nombres);
            updateSelectOptions('cargos', state.fieldOptions.cargos);
            updateSelectOptions('correos', state.fieldOptions.correos);
            updateSelectOptions('atendioUsers', state.fieldOptions.atendioUsers);
            updateSelectOptions('telefonos', state.fieldOptions.telefonos);
            updateSelectOptions('comentarios', state.fieldOptions.comentarios);
        }
        
        /**
         * Actualiza las opciones de un conjunto de selectores Select2.
         * @param {string} field - La clave del campo (ej. 'instituciones', 'areas').
         * @param {Array<string|Object>} options - El array de nuevas opciones.
         * @param {string|null} [selectedId=null] - El ID de la opción que debe quedar seleccionada.
         */
        function updateSelectOptions(field, options, selectedId = null) {
            const fieldToSelectMap = {
                'instituciones': ['caller-institution', 'edit-caller-institution'],
                'areas': ['call-area', 'edit-call-area'],
                'asuntos': ['call-subject', 'edit-call-subject'],
                'consultas': ['call-query', 'edit-call-query'],
                'nombres': ['caller-name', 'edit-caller-name'],
                'cargos': ['caller-cargo', 'edit-caller-cargo'],
                'correos': ['caller-email', 'edit-caller-email'],
                'telefonos': ['caller-phone', 'edit-caller-phone'],
                'comentarios': ['call-comments', 'edit-call-comments'],
                'atendioUsers': ['call-atendio', 'edit-call-atendio']
            };

            // Normalizar options: si son strings, convertir a {id, text}
            const normalizedOptions = options.map(opt =>
                typeof opt === "string" ? {id: opt, text: opt} : opt
            );

            if (fieldToSelectMap[field]) {
                fieldToSelectMap[field].forEach(selectId => {
                    const select = $(`#${selectId}`);
                    if (select.length) {
                        // Guardar el valor actual antes de actualizar
                        const currentValue = select.val();
                        
                        select.empty().select2({
                            data: normalizedOptions,
                            tags: true,
                            placeholder: "Seleccione o escriba una opción",
                            allowClear: true,
                            width: '100%'
                        });

                        // Restaurar el valor seleccionado si todavía existe
                        if (currentValue && normalizedOptions.some(o => o.id === currentValue)) {
                            state.ui.isProgrammaticChange = true;
                            select.val(currentValue).trigger('change.select2');
                            setTimeout(() => {
                                state.ui.isProgrammaticChange = false;
                            }, 100);
                        }
                        // Seleccionar por id si se especifica
                        else if (selectedId && normalizedOptions.some(o => o.id === selectedId)) {
                            state.ui.isProgrammaticChange = true;
                            select.val(selectedId).trigger('change.select2');
                            setTimeout(() => {
                                state.ui.isProgrammaticChange = false;
                            }, 100);
                        }
                    }
                });
            }
        }

        /**
         * Configura la lógica de autocompletado inteligente para los formularios.
         * Por ejemplo, al seleccionar una institución, filtra los nombres de contacto asociados.
         */
        function setupAutofill() {
            // Función para cargar los detalles del contacto
            function loadContactDetails(name, institution, isEditModal) {
                if (!name || !institution) return;

                const allData = [...state.calls, ...state.historicalCalls];
                const records = allData
                    .filter(c => c.nombre === name && c.institucion === institution)
                    .sort((a, b) => {
                        const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                        const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                        return dateB - dateA;
                    });

                if (records.length > 0) {
                    const latestRecord = records[0];
                    const cargo = latestRecord.cargo || '';
                    const email = latestRecord.correo || '';
                    const phone = latestRecord.telefono || '';
                    
                    if (isEditModal) {
                        $('#edit-caller-cargo').val(cargo).trigger('change');
                        $('#edit-caller-email').val(email).trigger('change');
                        $('#edit-caller-phone').val(phone).trigger('change');
                    } else {
                        $('#caller-cargo').val(cargo).trigger('change');
                        $('#caller-email').val(email).trigger('change');
                        $('#caller-phone').val(phone).trigger('change');
                    }
                }
            }

            // Evento para institución (formulario principal)
            $('#caller-institution').on('change', function() {

                if (state.ui.isProgrammaticChange) return;

                const institution = $(this).val();
                const nameSelect = $('#caller-name');
                
                const allData = [...state.calls, ...state.historicalCalls];
                const namesForInstitution = [...new Set(allData
                    .filter(c => c.institucion === institution)
                    .map(c => c.nombre)
                    .filter(Boolean))].sort();
                
                // Actualizar opciones del select de nombres
                nameSelect.empty();
                namesForInstitution.forEach(name => {
                    nameSelect.append(new Option(name, name));
                });
                
                // Si hay un nombre seleccionado, cargar sus datos
                const currentName = nameSelect.val();
                if (currentName) {
                    loadContactDetails(currentName, institution, false);
                }

                // --- INICIO: Lógica para filtrar comentarios por institución ---
                const commentsSelect = $('#call-comments');
                const commentsForInstitution = [...new Set(allData
                    .filter(c => c.institucion === institution)
                    .map(c => c.comentarios)
                    .filter(Boolean))].sort();

                commentsSelect.empty(); // Limpiar opciones
                commentsForInstitution.forEach(comment => {
                    commentsSelect.append(new Option(comment, comment));
                });
                commentsSelect.val(null).trigger('change.select2'); // Resetear selección y actualizar

                updateQuickHistoryPanel();
            });

            // Evento para institución (formulario de edición)
            $('#edit-caller-institution').on('change', function() {

                if (state.ui.isProgrammaticChange) return;

                const institution = $(this).val();
                const nameSelect = $('#edit-caller-name');
                
                const allData = [...state.calls, ...state.historicalCalls];
                const namesForInstitution = [...new Set(allData
                    .filter(c => c.institucion === institution)
                    .map(c => c.nombre)
                    .filter(Boolean))].sort();
                
                // Actualizar opciones del select de nombres
                nameSelect.empty();
                namesForInstitution.forEach(name => {
                    nameSelect.append(new Option(name, name));
                });
                
                // Si hay un nombre seleccionado, cargar sus datos
                const currentName = nameSelect.val();
                if (currentName) {
                    loadContactDetails(currentName, institution, true);
                }

                // --- INICIO: Lógica para filtrar comentarios por institución (modal de edición) ---
                const editCommentsSelect = $('#edit-call-comments');
                const commentsForInstitutionEdit = [...new Set(allData
                    .filter(c => c.institucion === institution)
                    .map(c => c.comentarios)
                    .filter(Boolean))].sort();

                editCommentsSelect.empty(); // Limpiar opciones
                commentsForInstitutionEdit.forEach(comment => {
                    editCommentsSelect.append(new Option(comment, comment));
                });
                editCommentsSelect.val(null).trigger('change.select2'); // Resetear selección y actualizar
            });

            // Evento para nombre (formulario principal)
            $('#caller-name').on('change', function() {

                if (state.ui.isProgrammaticChange) return;

                const name = $(this).val();
                const institution = $('#caller-institution').val();
                loadContactDetails(name, institution, false);
            });

            // Evento para nombre (formulario de edición)
            $('#edit-caller-name').on('change', function() {

                if (state.ui.isProgrammaticChange) return;

                const name = $(this).val();
                const institution = $('#edit-caller-institution').val();
                loadContactDetails(name, institution, true);
            });


            //Filtra las opciones del select de 'Consulta' basándose en el 'Asunto' seleccionado.
            function filterQueriesBySubject(subjectSelect, querySelect) {
                if (state.ui.isProgrammaticChange) return;

                const subject = subjectSelect.val();
                const allData = [...state.calls, ...state.historicalCalls];

                // Si no hay un asunto seleccionado, no hacemos nada (o podríamos mostrar todas las consultas)
                if (!subject) {
                    // Opcional: resetear el select de consulta para mostrar todas las opciones de nuevo.
                    // Por ahora, lo dejamos como está para no perder la selección si el usuario se equivoca.
                    return;
                }

                // Obtenemos el valor actual de la consulta para intentar preservarlo si sigue siendo válido.
                const currentQuery = querySelect.val();

                // Filtramos las consultas únicas asociadas al asunto seleccionado.
                const queriesForSubject = [...new Set(allData
                    .filter(c => c.asunto === subject)
                    .map(c => c.consulta)
                    .filter(Boolean) // Elimina valores nulos o vacíos
                )].sort();

                // Actualizamos las opciones del select de consulta.
                querySelect.empty(); // Limpiamos las opciones existentes.
                queriesForSubject.forEach(query => {
                    querySelect.append(new Option(query, query));
                });

                // Si el valor previo de consulta existe en la nueva lista, lo restauramos.
                if (queriesForSubject.includes(currentQuery)) {
                    querySelect.val(currentQuery);
                }

                // Disparamos el evento 'change' para que Select2 actualice su visualización.
                querySelect.trigger('change.select2');
            }

            // Evento para asunto (formulario principal)
            $('#call-subject').on('change', function() {
                filterQueriesBySubject($(this), $('#call-query'));
            });

            // Evento para asunto (formulario de edición)
            $('#edit-call-subject').on('change', function() {
                filterQueriesBySubject($(this), $('#edit-call-query'));
            });
        }

        // =============================================
        // INICIO: Bloque de código para preservar estado del formulario
        // Descripción: Funciones para capturar y restaurar el estado de un formulario,
        // útil cuando se realizan operaciones en segundo plano (como editar una opción)
        // y se quiere mantener lo que el usuario ya había llenado.
        // =============================================
        
        /**
         * Captura el estado actual de un formulario (valores y etiquetas de Select2).
         * @param {string} formId - El ID del formulario.
         * @returns {Object|null} Un objeto que representa el estado del formulario.
         */
        function getFormState(formId) {
            const form = document.getElementById(formId);
            if (!form) return null;
            const state = {};
            
            $(form).find('select').each(function() {
                const select = $(this);
                const selectName = select.attr('name');
                if (selectName) {
                    const select2Data = select.select2('data') || [];
                    state[selectName] = {
                        value: select.val(),
                        // Guardamos las etiquetas temporales que el usuario haya creado
                        tags: select2Data.filter(item => item.element === undefined || $(item.element).data('select2-tag') === true)
                    };
                }
            });
            
            return state;
        }

        /**
         * Restaura el estado de un formulario a partir de un objeto de estado guardado.
         * @param {string} formId - El ID del formulario a restaurar.
         * @param {Object} state - El objeto de estado previamente guardado con `getFormState`.
         */
        function restoreFormState(formId, state) {
            const form = document.getElementById(formId);
            if (!form || !state) return;
            
            Object.entries(state).forEach(([fieldName, fieldState]) => {
                const select = $(form).find(`[name="${fieldName}"]`);
                if (select.length > 0) {
                    // Restaurar etiquetas temporales primero para que estén disponibles para la selección
                    if (fieldState.tags) {
                        fieldState.tags.forEach(tag => {
                            if (!select.find(`option[value="${tag.id}"]`).length) {
                                const newOption = new Option(tag.text, tag.id);
                                $(newOption).attr('data-select2-tag', 'true'); // Marcar como etiqueta para la siguiente captura de estado.
                                select.append(newOption);
                            }
                        });
                    }
                    // Restaurar valor seleccionado
                    select.val(fieldState.value).trigger('change.select2');
                }
            });
        }

        /**
         * Busca y reemplaza un valor en un campo específico en todos los registros de la base de datos.
         * Se utiliza para actualizar en masa cuando se edita una opción de un selector.
         * @param {string} field - La clave del campo (ej. 'instituciones').
         * @param {string} oldValue - El valor antiguo a reemplazar.
         * @param {string} newValue - El nuevo valor.
         * @param {string} activeFormId - El ID del formulario activo para restaurar su estado.
         * @param {Object} formStateBeforeEdit - El estado del formulario antes de la edición.
         */

        async function findAndReplaceInDatabase(field, oldValue, newValue, activeFormId, formStateBeforeEdit) {
            const fieldToDbFieldMap = {
                'instituciones': 'institucion', 
                'areas': 'area', 
                'asuntos': 'asunto',
                'consultas': 'consulta', 
                'nombres': 'nombre', 
                'cargos': 'cargo',
                'correos': 'correo', 
                'telefonos': 'telefono', 
                'comentarios': 'comentarios',
                'atendioUsers': 'atendio'
            };
            
            const dbField = fieldToDbFieldMap[field];
            if (!dbField) return;
            
            try {
                // Actualización de registros (existente)
                const callsQuery = query(callsCollectionRef, where(dbField, '==', oldValue));
                const callsSnapshot = await getDocs(callsQuery);
                
                const batch = writeBatch(db);
                callsSnapshot.forEach(doc => batch.update(doc.ref, { [dbField]: newValue }));
                const historicalQuery = query(historicalCallsCollectionRef, where(dbField, '==', oldValue));
                const historicalSnapshot = await getDocs(historicalQuery);
                historicalSnapshot.forEach(doc => batch.update(doc.ref, { [dbField]: newValue }));
                await batch.commit();
                
                // Actualizar las opciones globales en fieldOptions
                state.fieldOptions[field] = [...new Set([...state.fieldOptions[field].filter(opt => opt !== oldValue), newValue])].sort();
                // Redibujar los selects con la lista actualizada, preservando el estado del formulario
                updateSelectOptions(field, state.fieldOptions[field]);

                // Restaurar el estado del formulario para mantener los valores no guardados
                if (formStateBeforeEdit) {
                    restoreFormState(activeFormId, formStateBeforeEdit);
                }
                
                showAlert(`Se actualizaron ${callsSnapshot.size + historicalSnapshot.size} registros.`, "success");
            } catch (error) {
                console.error("Error al actualizar registros:", error);
                showAlert("Error al actualizar registros existentes", "error");
            }
        }

        // Variable global para mantener el contexto del <select> que está siendo modificado.
        // Se gestiona su ciclo de vida: se establece al iniciar y se limpia al finalizar o cancelar.
        let activeSelectElement = null;

        /**
         * Configura los manejadores de eventos para los botones de edición (lápiz)
         * asociados a cada campo de tipo Select2 en los formularios.
         */
        function setupAddEditButtons() {
             const buttonToFieldMap = {
                 'edit-institution-btn': 'instituciones',
                 'edit-area-btn': 'areas',
                 'edit-subject-btn': 'asuntos',
                 'edit-query-btn': 'consultas',
                 'edit-name-btn': 'nombres',
                 'edit-cargo-btn': 'cargos',
                 'edit-email-btn': 'correos',
                 'edit-phone-btn': 'telefonos',
                 'edit-comments-btn': 'comentarios',
                 'edit-atendio-btn': 'atendioUsers',
                 'edit-institution-edit-btn': 'instituciones',
                 'edit-area-edit-btn': 'areas',
                 'edit-subject-edit-btn': 'asuntos',
                 'edit-query-edit-btn': 'consultas',
                 'edit-name-edit-btn': 'nombres',
                 'edit-cargo-edit-btn': 'cargos',
                 'edit-email-edit-btn': 'correos',
                 'edit-phone-edit-btn': 'telefonos',
                 'edit-comments-edit-btn': 'comentarios',
                 'edit-atendio-edit-btn': 'atendioUsers'
             };
            
             // 1. ASIGNACIÓN DE EVENTOS A LOS BOTONES (lápiz)
             Object.entries(buttonToFieldMap).forEach(([buttonId, field]) => {
                 const button = document.getElementById(buttonId);
                 if (!button) return;
 
                 // Ocultar los botones de lápiz en modo solo lectura
                 button.classList.toggle('hidden', state.isReadOnly);
                 button.addEventListener('click', (e) => {
                     activeSelectElement = e.currentTarget.parentElement.querySelector('select');
                     const currentValue = $(activeSelectElement).val();
                         
                     if (!currentValue) {
                         return showAlert("Por favor, seleccione una opción para editar.", "warning");
                     }
                        
                     state.ui.currentEditingField = field;
                     state.ui.currentEditingValue = currentValue;
                     DOM.editOptionInput.value = currentValue;
                     DOM.editOptionInput.placeholder = `Edite la opción para ${field}`;
                     openModal(DOM.editOptionModal);
                 });
             });
            
             // 2. LÓGICA DE CONFIRMACIÓN PARA EDITAR OPCIÓN EXISTENTE
             DOM.confirmEditOptionBtn.addEventListener('click', () => {
                 const newValue = DOM.editOptionInput.value.trim();
 
                 if (!newValue || !state.ui.currentEditingField || !state.ui.currentEditingValue) {
                     return;
                 }
 
                 closeModal(DOM.editOptionModal);
                 
                 const activeFormId = !DOM.callModal.classList.contains('hidden') ? DOM.callForm.id : 
                                      !DOM.editModal.classList.contains('hidden') ? DOM.editForm.id : null;
                 
                 const formStateBeforeEdit = activeFormId ? getFormState(activeFormId) : null;
 
                 requirePassword(async () => {
                     try {
                         await findAndReplaceInDatabase(state.ui.currentEditingField, state.ui.currentEditingValue, newValue, activeFormId, formStateBeforeEdit);
                         
                         if (formStateBeforeEdit) {
                             restoreFormState(activeFormId, formStateBeforeEdit);
                         }
 
                         if (activeSelectElement) {
                             $(activeSelectElement).val(newValue).trigger('change.select2');
                         }
                     } catch (dbErr) {
                         console.error('Error al actualizar la base de datos:', dbErr);
                         showAlert("Error al actualizar la opción en la base de datos", "error");
                     } finally {
                         activeSelectElement = null;
                     }
                 });
             });
             
             // 3. LIMPIEZA DE ESTADO EN CASO DE CANCELACIÓN
             DOM.cancelEditOptionBtn.addEventListener('click', () => {
                 closeModal(DOM.editOptionModal);
                 activeSelectElement = null;
             });
        }

        // =============================================
        // MÓDULO PRINCIPAL: Autenticación y listeners
        // Descripción: Lógica de autenticación, verificación de contraseña y configuración
        // de los listeners de datos en tiempo real de Firestore.
        // =============================================

        /**
         * Verifica la contraseña introducida en el modal de seguridad.
         */
        function verifyPassword() {
            const password = DOM.passwordInput.value;

            if (password === 'admin') {
                // Usar la función closeModal mejorada que maneja el contador
                closeModal(DOM.passwordModal);
                DOM.passwordInput.value = '';
                
                if (state.ui.pendingAction) {
                    state.ui.pendingAction();
                    state.ui.pendingAction = null;
                }
            } else {
                showAlert("Contraseña incorrecta", "error");
                DOM.passwordInput.value = '';
            }
        }

        /**
         * Configura los manejadores de eventos para el modal de verificación de contraseña.
         */
        function setupPasswordVerification() {
            DOM.confirmPasswordBtn.addEventListener('click', verifyPassword);
            DOM.cancelPasswordBtn.addEventListener('click', () => {
                closeModal(DOM.passwordModal);
                state.ui.pendingAction = null;
            });
            
            // Usar el elemento correcto del DOM para el evento keypress
            const passwordInputElement = DOM.passwordInput;
            if (passwordInputElement) {
                passwordInputElement.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        verifyPassword();
                    }
                });
            }
        }

        /**
         * Muestra el modal de contraseña y guarda la acción a ejecutar tras una verificación exitosa.
         * @param {Function} action - La función a ejecutar si la contraseña es correcta.
         */
        function requirePassword(action) {
            state.ui.pendingAction = action;
            openModal(DOM.passwordModal);
        }

        /**
         * Inicializa la autenticación de Firebase.
         * Una vez autenticado, configura los listeners en tiempo real.
         */
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Si el usuario tiene una sesión anónima (del sistema antiguo),
                    // se cierra su sesión para forzar el nuevo login.
                    if (user.isAnonymous) {
                        signOut(auth);
                        toggleReadOnlyMode(false); // Asegurarse de que el modo lectura esté desactivado
                        // onAuthStateChanged se volverá a ejecutar con user=null,
                        // mostrando la pantalla de login.
                    } else {
                        // Si es un usuario normal (con email/contraseña), se le da acceso.
                        state.user = user;
                        DOM.userEmail.textContent = user.email;

                        // Comprobar si el usuario es de solo lectura
                        const isReadOnly = user.uid === READ_ONLY_UID;
                        toggleReadOnlyMode(isReadOnly);
                        showAlert(isReadOnly ? "Modo de solo lectura activado." : "Sesión iniciada con éxito.", "info");

                        showApp(); // Muestra la aplicación principal
                        setupRealtimeListeners();
                    }
                } else {
                    // Usuario no ha iniciado sesión o ha cerrado sesión
                    state.user = null;
                    detachRealtimeListeners(); // Detiene los listeners para no consumir recursos
                    toggleReadOnlyMode(false); // Desactivar el modo lectura al cerrar sesión
                    showLoginScreen(); // Muestra la pantalla de inicio de sesión
                }
            });
        }
        
        /**
         * Desconecta los listeners de Firestore para evitar fugas de memoria y consumo innecesario
         * cuando el usuario no ha iniciado sesión.
         */
        function detachRealtimeListeners() {
            if (state.listeners.calls) {
                state.listeners.calls(); // Llama a la función de desuscripción
                state.listeners.calls = null;
            }
            if (state.listeners.historical) {
                state.listeners.historical();
                state.listeners.historical = null;
            }
            // Limpiar los datos locales al cerrar sesión
            state.calls = [];
            state.historicalCalls = [];
            sortAndRenderTable(DOM.callLogTableBody, [], false);
            document.querySelectorAll('.table-container th:last-child').forEach(th => th.classList.remove('hidden'));
            sortAndRenderTable(DOM.historicalTableBody, [], true);
            updateAllDashboards();
            updateCharts();
        }

        /**
         * Configura los listeners de Firestore (`onSnapshot`) para recibir actualizaciones
         * en tiempo real de las colecciones 'calls' y 'historicalCalls'.
         */
        function setupRealtimeListeners() {
            // Si ya hay un listener, no crear otro
            if (state.listeners.calls) return;

            showLoader(true); // Mostrar loader mientras se cargan los datos iniciales

            state.listeners.calls = onSnapshot(query(callsCollectionRef), (snapshot) => {
                state.calls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(DOM.callLogTableBody, state.calls, false);
                updateAllDashboards();
                updateCharts();
                updateDynamicSelectOptions();
                showLoader(false); // Ocultar loader después de la primera carga

                // Llamar a la función de la alerta después de que los datos se carguen
                setTimeout(checkAndShowSummaryAlert, 1000);
            }, (error) => console.error("Error en listener de llamadas:", error));
            
            state.listeners.historical = onSnapshot(query(historicalCallsCollectionRef), (snapshot) => {
                state.historicalCalls = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                sortAndRenderTable(DOM.historicalTableBody, state.historicalCalls, true);
                updateAllDashboards();
                updateCharts();
                updateDynamicSelectOptions();
            }, (error) => console.error("Error en listener de histórico:", error));
        }



        // =============================================
        // MÓDULO: Gráficos y reportes
        // Descripción: Funciones para generar, actualizar y configurar los gráficos y reportes
        // de la aplicación.
        // =============================================
        
        /**
         * Obtiene los datos para los reportes según la fuente seleccionada y el filtro de fecha configurado.
         * @returns {Array<Object>} Un array con los datos de llamadas filtrados.
         */
        function getReportData() {
            const source = DOM.reportesDataSource.value;
            let data = [];
            if (source === 'registro') data = state.calls;
            else if (source === 'historico') data = state.historicalCalls;
            else data = [...state.calls, ...state.historicalCalls];

            if (state.reportFilter.type === 'period' && state.reportFilter.startDate && state.reportFilter.endDate) {
                const startDate = new Date(state.reportFilter.startDate);
                let endDate = new Date(state.reportFilter.endDate);
                endDate.setHours(23, 59, 59, 999); // Incluir todo el día de fin
                return data.filter(call => {
                    if (!call.fecha) return false;
                    try {
                        // Formato esperado: DD/MM/YYYY
                        const [day, month, year] = call.fecha.split('/');
                        const callDate = new Date(`${year}-${month}-${day}`);
                        return callDate >= startDate && callDate <= endDate;
                    } catch (e) { return false; }
                });
            }
            return data;
        }
        
        /**
         * Actualiza todos los gráficos y la tabla dinámica en la pestaña de "Reportes".
         */
        function updateCharts() {
            const data = getReportData();

            // --- INICIO: Poblar el nuevo selector de Asunto para el gráfico de Consulta ---
            const asuntosUnicos = [...new Set(data.map(call => call.asunto).filter(Boolean))].sort();
            const asuntoFilterSelect = DOM.consultaAsuntoFilter;
            const currentAsuntoFilterValue = asuntoFilterSelect.value; // Guardar valor actual
            asuntoFilterSelect.innerHTML = '<option value="Todos">Todos los Asuntos</option>'; // Opción por defecto

            // Actualizar el título del gráfico de consulta
            DOM.consultaChartTitle.textContent = currentAsuntoFilterValue === 'Todos' ? 'Llamadas por Consulta' : `Consultas para: ${currentAsuntoFilterValue}`;

            asuntosUnicos.forEach(asunto => {
                const option = document.createElement('option');
                option.value = asunto;
                option.textContent = asunto;
                if (asunto === currentAsuntoFilterValue) {
                    option.selected = true;
                }
                asuntoFilterSelect.appendChild(option);
            });
            // --- FIN: Poblar el nuevo selector ---

            const chartSize = DOM.chartSizeSlider.value; // Se define chartSize
            document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
                wrapper.style.height = `${chartSize}px`; // Se usa la variable correcta: chartSize
            });

            const statusCounts = {}, asuntoCounts = {}, dayOfWeekCounts = {}, consultaCounts = {};
            const selectedAsunto = asuntoFilterSelect.value;

            // Filtrar los datos para el gráfico de consulta ANTES del bucle principal
            const consultaData = (selectedAsunto === 'Todos') 
                ? data 
                : data.filter(call => call.asunto === selectedAsunto);

            consultaData.forEach(call => {
                consultaCounts[call.consulta || 'N/A'] = (consultaCounts[call.consulta || 'N/A'] || 0) + 1;
            });

            data.forEach(call => {
                // Lógica existente para los otros gráficos (sin cambios)
                statusCounts[call.estatus || 'N/A'] = (statusCounts[call.estatus || 'N/A'] || 0) + 1;
                asuntoCounts[call.asunto || 'N/A'] = (asuntoCounts[call.asunto || 'N/A'] || 0) + 1;
                
                // --- CORRECCIÓN: Usar la función getDayOfWeek para consistencia ---
                const dayOfWeekIndex = getDayOfWeek(call.fecha); // Devuelve 1 para Lunes, 2 para Martes, etc.
                if (dayOfWeekIndex !== -1) {
                    // Mapear el índice a un nombre de día para el gráfico
                    const days = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'];
                    const day = days[dayOfWeekIndex];
                    if (day) {
                        dayOfWeekCounts[day] = (dayOfWeekCounts[day] || 0) + 1;
                    }
                }
            });

            const createOrUpdateChart = (canvas, chartInstance, type, data, labelsOrder, datasetLabel = 'Cantidad', sort = false, showXLabels = true) => {
                // Destruye la instancia del gráfico si existe para evitar duplicaciones
                if (chartInstance) chartInstance.destroy();

                // Obtiene las etiquetas de los datos
                let labels = Object.keys(data);
                let sortedData = { ...data };
                
                if (sort) {
                    labels = Object.keys(data).sort((a, b) => data[b] - data[a]);
                    sortedData = {};
                    labels.forEach(label => sortedData[label] = data[label]);
                } else if (labelsOrder) {
                    // Ordena las etiquetas si se proporciona un orden
                    labels.sort((a, b) => labelsOrder.indexOf(a) - labelsOrder.indexOf(b));
                }

                // Mapea los datos a un array de valores
                const chartData = labels.map(label => data[label]);

                // Define un array de colores para las barras/sectores del pastel
                const backgroundColors = ['#9C2348', '#1E5B4F', '#A6802D', '#EF4444', '#3B82F6'];

                // Define el conjunto de datos para el gráfico
                const dataset = {
                    label: datasetLabel,
                    data: chartData,
                    backgroundColor: backgroundColors,
                    // El borde es blanco para todos los tipos de gráfico, excepto para las líneas donde es del color del primer fondo
                    borderColor: type === 'line' ? backgroundColors[0] : '#FFFFFF', 
                    borderWidth: 1.5, 
                    tension: 0.1 
                };
                
                // Crea y devuelve la nueva instancia de Chart
                return new Chart(canvas, { 
                    type, 
                    data: { labels, datasets: [dataset] }, 
                    options: { 
                    scales: {
                        x: {
                            ticks: {
                                display: showXLabels // Controla la visibilidad de las etiquetas del eje X
                            }
                        }
                    },
                    responsive: true, 
                    maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    // El color del borde de la etiqueta es el mismo que el color de fondo para ocultarlo
                                    boxWidth: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    } 
                });
            };
            
            if (state.charts.status) state.charts.status.destroy();
            if (state.charts.asunto) state.charts.asunto.destroy();
            if (state.charts.dayOfWeek) state.charts.dayOfWeek.destroy();
            if (state.charts.consulta) state.charts.consulta.destroy();
            if (state.charts.dynamic) state.charts.dynamic.destroy();

            state.charts.status = createOrUpdateChart(DOM.statusChartCanvas, state.charts.status, 'pie', statusCounts);
            state.charts.asunto = createOrUpdateChart(DOM.asuntoChartCanvas, state.charts.asunto, 'bar', asuntoCounts, null, 'Llamadas por Asunto', true);
            state.charts.consulta = createOrUpdateChart(DOM.consultaChartCanvas, state.charts.consulta, 'bar', consultaCounts, null, 'Llamadas por Consulta', true, state.consultaChartState.showLabels); // Se pasa el estado para mostrar/ocultar etiquetas
            state.charts.dayOfWeek = createOrUpdateChart(DOM.dayOfWeekChartCanvas, state.charts.dayOfWeek, 'line', dayOfWeekCounts, ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo'], 'Llamadas por Día', false);
                 
            // Actualizar gráfica dinámica
            updateDynamicChart();

            // 1. Simplificar los datos eliminando atributos no deseados para la tabla dinámica.
            const pivotData = data.map(call => {
                const { id, fin, telefono, importedAt, correo, inicio, comentarios, fecha, createdAt, updatedAt, migratedAt, originalId, ...rest } = call;
                return rest;
            });

            $(DOM.pivotTableContainer).pivotUI(data, {
                // 2. Establecer la configuración por defecto.
                cols: ["asunto"],
                rows: ["institucion"], 
                aggregatorName: "Count", 
                rendererName: "Table", // Por defecto se mostrará la tabla.
                locale: "es",
                // 3. Ocultar atributos para simplificar la interfaz de la tabla dinámica.
                hiddenAttributes: ["id", "fin", "telefono", "importedAt", "correo", "inicio", "comentarios", "fecha", "createdAt", "updatedAt", "migratedAt", "originalId"]
            });
        }

        
        /**
         * Actualiza el gráfico dinámico y su tabla de distribución de datos asociada.
         */
        function updateDynamicChart() {
            const data = getReportData();
            
            const selectedVariable = DOM.dynamicChartVariable.value;
            const variableCounts = {};
            const variableStatusCounts = {};
            
            data.forEach(call => {
                const value = call[selectedVariable] || 'N/A';
                variableCounts[value] = (variableCounts[value] || 0) + 1;
                
                if (!variableStatusCounts[value]) {
                    variableStatusCounts[value] = { 'Saliente': 0, 'Entrante': 0 };
                }
                
                if (call.estatus === 'Saliente') {
                    variableStatusCounts[value].Saliente = (variableStatusCounts[value].Saliente || 0) + 1;
                } else {
                    variableStatusCounts[value].Entrante = (variableStatusCounts[value].Entrante || 0) + 1;
                }
            });
            
            // Actualizar tabla dinámica
            const table = DOM.dynamicTableBody.closest('table');
            let tfoot = table.querySelector('tfoot');
            if (!tfoot) {
                tfoot = document.createElement('tfoot');
                table.appendChild(tfoot);
            }
            
            DOM.dynamicTableBody.innerHTML = '';
            DOM.dynamicTableHeader.textContent = selectedVariable.charAt(0).toUpperCase() + selectedVariable.slice(1);
            
            let totalSaliente = 0;
            let totalEntrante = 0;
            let granTotal = 0;

            // Ordenar los datos de la tabla de mayor a menor por el total de llamadas
            const sortedVariableStatusCounts = Object.entries(variableStatusCounts).sort(([, a], [, b]) => {
                const totalA = (a.Saliente || 0) + (a.Entrante || 0);
                const totalB = (b.Saliente || 0) + (b.Entrante || 0);
                return totalB - totalA;
            });

            sortedVariableStatusCounts.forEach(([value, counts]) => {
                const total = (counts.Saliente || 0) + (counts.Entrante || 0);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${value}</td>
                    <td>${counts.Saliente || 0}</td>
                    <td>${counts.Entrante || 0}</td>
                    <td>${total}</td>
                `;
                DOM.dynamicTableBody.appendChild(row);

                totalSaliente += (counts.Saliente || 0);
                totalEntrante += (counts.Entrante || 0);
                granTotal += total;
            });

            // Añadir fila de totales al tfoot
            tfoot.innerHTML = `
                <tr class="bg-slate-200 font-bold">
                    <td>Total</td>
                    <td>${totalSaliente}</td>
                    <td>${totalEntrante}</td>
                    <td>${granTotal}</td>
                </tr>
            `;
            
            // Actualizar gráfico
            if (state.charts.dynamic) state.charts.dynamic.destroy();
            
            // Ordenar los datos del gráfico de mayor a menor
            const sortedChartData = Object.entries(variableCounts).sort(([, a], [, b]) => b - a);

            const labels = sortedChartData.map(([label]) => label);
            const chartData = sortedChartData.map(([, count]) => count);
            
            state.charts.dynamic = new Chart(DOM.dynamicChartCanvas, {
                type: 'bar',
                data: {

                    labels: labels,
                    datasets: [{
                        label: 'Cantidad',
                        data: chartData,
                        backgroundColor: '#9C2348'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            ticks: {
                                display: state.ui.showChartLabels,
                                maxRotation: state.ui.showChartLabels ? 90 : 0,
                                minRotation: state.ui.showChartLabels ? 45 : 0
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Configura los manejadores de eventos para el modal de configuración de reportes.
         */
        function setupReportConfig() {
            DOM.configReportBtn.addEventListener('click', () => openModal(DOM.configReportModal));
            DOM.closeConfigReportModalBtn.addEventListener('click', () => closeModal(DOM.configReportModal));
            
            DOM.filterAllDataRadio.addEventListener('change', () => {
                DOM.configReportStartDate.disabled = true;
                DOM.configReportEndDate.disabled = true;
            });
            
            DOM.filterByPeriodRadio.addEventListener('change', () => {
                DOM.configReportStartDate.disabled = false;
                DOM.configReportEndDate.disabled = false;
            });
            
            DOM.saveConfigReportBtn.addEventListener('click', () => {
                if (DOM.filterByPeriodRadio.checked && (!DOM.configReportStartDate.value || !DOM.configReportEndDate.value)) {
                    return showAlert("Por favor, seleccione un rango de fechas válido.", "warning");
                }
                state.reportFilter.type = DOM.filterAllDataRadio.checked ? 'all' : 'period';
                state.reportFilter.startDate = DOM.configReportStartDate.value;
                state.reportFilter.endDate = DOM.configReportEndDate.value;
                
                showAlert("Configuración de reportes guardada.", "success");
                closeModal(DOM.configReportModal);
                updateCharts();
            });
        }

        // =============================================
        // MÓDULO: Genera un reporte ejecutivo en formato PDF.
        // Descripción: Funciones para la generación de reportes en PDF utilizando `html2pdf.js`.
        // =============================================

        /**
         * Genera un reporte ejecutivo en formato PDF a partir de los datos y gráficos actuales.
         * @param {Object} options - Opciones que indican qué elementos incluir en el reporte.
         */
        async function generateExecutiveReport(options) {
            const { includeStatus, includeAsunto, includeDay, includeAtendio, includeDynamicChart, includeDynamicTable } = options;
            const data = getReportData();

            // --- Preparación de Datos y Métricas ---
            const totalCalls = data.length;
            const salientes = data.filter(c => c.estatus === 'Saliente').length;
            const entrantes = totalCalls - salientes;
            const totalDuration = data.reduce((sum, c) => sum + (Number(c.duracion) || 0), 0);
            const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;
            const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });

            // --- Construcción del HTML para el PDF ---
            const reportContainer = document.createElement('div');
            reportContainer.innerHTML = `
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #1f2937; }
                    .reporte-ejecutivo { width: 190mm; margin: 0 auto; padding: 10mm; box-sizing: border-box; }
                    .reporte-header { text-align: center; margin-bottom: 10mm; padding: 5mm; background: #9C2348; color: white; border-radius: 3mm; }
                    .reporte-header h1 { font-size: 18pt; margin: 0 0 2mm 0; } .reporte-header p { font-size: 10pt; margin: 0; opacity: 0.9; }
                    .reporte-metricas { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5mm; margin: 10mm 0; }
                    .metrica { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 3mm; padding: 4mm; text-align: center; }
                    .metrica h3 { font-size: 9pt; font-weight: 600; text-transform: uppercase; margin: 0 0 2mm 0; color: #475569; }
                    .metrica p { font-size: 16pt; font-weight: bold; margin: 0; color: #9C2348; }
                    .grafica, .tabla-datos { page-break-inside: avoid; margin-top: 8mm; border: 1px solid #e2e8f0; border-radius: 3mm; padding: 4mm; }
                    .grafica h3, .tabla-datos h3 { font-size: 14pt; text-align: center; margin: 0 0 4mm 0; padding-bottom: 2mm; border-bottom: 1px solid #9C2348; }
                    .grafica canvas { max-width: 100%; }
                    .tabla-datos table { width: 100%; border-collapse: collapse; font-size: 9pt; }
                    .tabla-datos th { background: #f1f5f9; padding: 2.5mm; text-align: center; }
                    .tabla-datos td { padding: 2.5mm; text-align: center; border-top: 1px solid #e2e8f0; }
                    .tabla-datos .saliente-pdf { color: #10B981; font-weight: 600; } .tabla-datos .entrante-pdf { color: #3B82F6; font-weight: 600; }
                    .tabla-datos tfoot tr { background-color: #e2e8f0; font-weight: bold; }
                    .reporte-footer { text-align: center; margin-top: 10mm; padding-top: 5mm; border-top: 1px solid #e2e8f0; font-size: 8pt; color: #64748b; }
                </style>
                <div class="reporte-ejecutivo">
                    <div class="reporte-header">
                        <h1>Reporte de Llamadas</h1>
                        <p>Generado el: ${currentDate}</p>
                        <p>${state.reportFilter.type === 'period' ? `Período: ${state.reportFilter.startDate} al ${state.reportFilter.endDate}` : 'Todos los registros'}</p>
                    </div>
                    <div class="reporte-metricas">
                        <div class="metrica"><h3>Salientes</h3><p>${salientes}</p></div>
                        <div class="metrica"><h3>Entrantes</h3><p>${entrantes}</p></div>
                        <div class="metrica"><h3>Duración Prom.</h3><p>${formatDuration(avgDuration)}</p></div>
                        <div class="metrica"><h3>Total Llamadas</h3><p>${totalCalls}</p></div>
                    </div>
                </div>`;

            const reportBody = reportContainer.querySelector('.reporte-ejecutivo');

            // --- Generación y Adjunto de Gráficos ---
            const chartConfigs = [
                { condition: includeStatus, title: "Distribución por Estatus", data: getReportData(), key: 'estatus', type: 'pie' },
                { condition: includeAsunto, title: "Llamadas por Asunto", data: getReportData(), key: 'asunto', type: 'bar' },
                { condition: includeDay, title: "Tendencia Semanal", data: getReportData(), key: 'fecha', type: 'line' },
                { condition: includeAtendio, title: "Llamadas por Consulta", data: getReportData(), key: 'consulta', type: 'bar' },
                { condition: includeDynamicChart, title: `Análisis por ${DOM.dynamicChartVariable.value}`, data: getReportData(), key: DOM.dynamicChartVariable.value, type: 'bar' }
            ];

            for (const config of chartConfigs) {
                if (config.condition) {
                    const chartImage = await generateChartImage(config);
                    const section = document.createElement('div');
                    section.className = 'grafica';
                    section.innerHTML = `<h3>${config.title}</h3><img src="${chartImage}" style="width:100%; height:auto;">`;
                    reportBody.appendChild(section);
                }
            }

            // --- Generación y Adjunto de Tabla Dinámica ---
            if (includeDynamicTable) {
                const selectedVariable = DOM.dynamicChartVariable.value;
                const variableStatusCounts = {};
                data.forEach(call => {
                    const value = call[selectedVariable] || 'N/A';
                    if (!variableStatusCounts[value]) variableStatusCounts[value] = { 'Saliente': 0, 'Entrante': 0 };
                    variableStatusCounts[value][call.estatus === 'Saliente' ? 'Saliente' : 'Entrante']++;
                });

                let totalSalientes = 0;
                let totalEntrantes = 0;
                let granTotal = 0;

                let tableHTML = `<div class="tabla-datos"><h3>Distribución Detallada - ${selectedVariable}</h3><table><thead><tr><th>${selectedVariable}</th><th>Salientes</th><th>Entrantes</th><th>Total</th></tr></thead><tbody>`;
                Object.entries(variableStatusCounts).forEach(([value, counts]) => {
                    const totalRow = (counts.Saliente || 0) + (counts.Entrante || 0);
                    totalSalientes += (counts.Saliente || 0);
                    totalEntrantes += (counts.Entrante || 0);
                    granTotal += totalRow;
                    tableHTML += `<tr><td>${value}</td><td class="saliente-pdf">${counts.Saliente || 0}</td><td class="entrante-pdf">${counts.Entrante || 0}</td><td>${totalRow}</td></tr>`;
                });
                tableHTML += `</tbody><tfoot><tr><td>Totales</td><td>${totalSalientes}</td><td>${totalEntrantes}</td><td>${granTotal}</td></tr></tfoot></table></div>`;
                reportBody.innerHTML += tableHTML;
            }

            reportBody.innerHTML += `<div class="reporte-footer"><p>Registro de Llamadas - SICOIN © ${new Date().getFullYear()}</p></div>`;

            // --- Generación del PDF ---
            try {
                showLoader(true);
                const pdfOptions = {
                    margin: 0,
                    filename: `reporte_ejecutivo_llamadas_${new Date().toISOString().slice(0, 10)}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, logging: false },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                await html2pdf().set(pdfOptions).from(reportContainer).save();
                showAlert("Reporte generado y descargado exitosamente.", "success");
            } catch (error) {
                console.error("Error al generar PDF:", error);
                showAlert(`Error al generar el PDF: ${error.message}`, "error");
            } finally {
                showLoader(false);
            }
        }

        
        /**
         * Genera una imagen de un gráfico de forma aislada y la devuelve como un Data URL (Base64).
         * @param {Object} config - Configuración del gráfico a generar.
         * @returns {Promise<string>} Una promesa que se resuelve con la imagen en formato Data URL.
         */
        async function generateChartImage({ data, key, type, title }) {
            const canvas = document.createElement('canvas');
            canvas.width = 1400; // Resolución aumentada
            canvas.height = 550; // Resolución aumentada (proporción 16:9)

            const counts = {};
            const daysOrder = ['lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado', 'domingo'];

            data.forEach(item => {
                let value = item[key] || 'N/A';
                if (key === 'fecha') {
                    try {
                        const [d, m, y] = value.split('/');
                        value = new Date(`${y}-${m}-${d}`).toLocaleDateString('es-ES', { weekday: 'long' });
                    } catch { value = 'N/A'; }
                }
                counts[value] = (counts[value] || 0) + 1;
            });

            let labels = Object.keys(counts);
            let chartData = Object.values(counts);

            if (key === 'fecha') {
                labels = daysOrder.map(d => d.charAt(0).toUpperCase() + d.slice(1));
                chartData = daysOrder.map(day => counts[day] || 0);
            }

            const chart = new Chart(canvas, {
                type,
                data: {
                    labels,
                    datasets: [{
                        label: title,
                        data: chartData,
                        backgroundColor: ['#9C2348', '#1E5B4F', '#A6802D', '#64748B', '#3B82F6', '#F59E0B', '#10B981'],
                        borderColor: type === 'line' ? '#9C2348' : '#fff',
                        tension: 0.1
                    }]
                },
                plugins: [ChartDataLabels],
                options: {
                    responsive: false,
                    animation: { duration: 0 },
                    layout: {
                        padding: { top: 40, bottom: 10, left: 10, right: 10 } // Más espacio para etiquetas
                    },
                    scales: {
                        x: { ticks: { font: { size: 25 } } }, // Tamaño de fuente en eje X aumentado
                        y: { ticks: { font: { size: 25 } } }  // Tamaño de fuente en eje Y aumentado
                    },
                    plugins: {
                        legend: { 
                            display: type === 'pie',
                            labels: {
                                font: {
                                    size: 25 // Tamaño de fuente en la leyenda aumentado
                                }
                            }
                        },
                        datalabels: {
                            // Configuración general de etiquetas
                            color: (context) => {
                                // Para gráficas de pastel, el color del texto es blanco si el fondo es oscuro
                                if (context.chart.config.type === 'pie') {
                                    return '#fff';
                                }
                                // Para otras gráficas, un color oscuro es más legible
                                return '#333';
                            },
                            font: {
                                weight: 'bold',
                                size: 30, // Tamaño de fuente de etiquetas aumentado
                            },
                            // Posición de la etiqueta según el tipo de gráfica
                            anchor: (context) => (context.chart.config.type === 'bar' || context.chart.config.type === 'line') ? 'end' : 'center',
                            align: (context) => (context.chart.config.type === 'bar' || context.chart.config.type === 'line') ? 'end' : 'center',
                            // Formato del valor mostrado
                            formatter: (value, context) => {
                                if (context.chart.config.type === 'pie') {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                    return `${value}\n(${percentage})`; // Muestra cantidad y porcentaje
                                }
                                return value; // Muestra solo la cantidad para otras gráficas
                            },
                        }
                    }
                }
            });

            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(chart.toBase64Image());
                    chart.destroy();
                }, 500); // Espera para asegurar el renderizado completo
            });
        }

        // =============================================
        // MÓDULO: Exportación/Importación
        // Descripción: Funciones para exportar datos a Excel con formato y para importar
        // datos desde archivos Excel.
        // =============================================

        /**
         * Define el orden y los nombres de las columnas para la exportación a Excel.
         */
        const exportHeaders = [
        "No.", "Fecha", "Inicio", "Fin", "Duración", "Área", "Institución",
        "Asunto", "Consulta", "Nombre", "Cargo", "Correo", "Teléfono",
        "Estatus", "Atendió", "Comentarios"
        ];

        /**
         * Exporta un conjunto de datos a un archivo Excel con formato personalizado.
         * @param {Array<Object>} data - Los datos de llamadas a exportar.
         * @param {string} sheetName - El nombre de la hoja en el archivo Excel.
         * @param {string} fileName - El nombre del archivo a descargar.
         */
        function exportToExcelWithFormatting(data, sheetName, fileName) {
            // 1. Preparar los datos y el título
            const dataToExport = prepareExportData(data);
            const longDate = formatLongDate(new Date().toLocaleDateString('es-ES'));
            const title = `Llamadas Registradas al ${longDate}`;

            // 2. Definir estilos
            const titleStyle = { 
                font: { name: "Noto Sans", sz: 12, bold: true },
                alignment: { horizontal: "left", vertical: "center" },
            };
            const headerStyle = {
                font: { name: "Noto Sans", sz: 11, bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "A6802D" } }, // Color primario
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    // Borde para todas las celdas del encabezado
                    top: { style: "thin", color: { auto: 1 } },
                    bottom: { style: "thin", color: { auto: 1 } },
                    left: { style: "thin", color: { auto: 1 } },
                    right: { style: "thin", color: { auto: 1 } },
                }
            };
            const cellStyle = {
                font: { name: "Noto Sans", sz: 10 },
                alignment: { horizontal: "center", vertical: "center" },
                border: {
                    // Borde para todas las celdas de datos
                    top: { style: "thin", color: { auto: 1 } },
                    bottom: { style: "thin", color: { auto: 1 } },
                    left: { style: "thin", color: { auto: 1 } },
                    right: { style: "thin", color: { auto: 1 } },
                }
            };

            // 3. Crear la hoja de cálculo
            // Se crea un array de arrays para tener control total sobre las celdas
            const ws_data = [
                [title], // Fila 1: Título
                exportHeaders // Fila 2: Encabezados
            ];

            dataToExport.forEach(row => {
                const rowData = exportHeaders.map(header => row[header]);
                ws_data.push(rowData);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            // 4. Aplicar estilos
            // Estilo del título en A1
            if (ws['A1']) {
                ws['A1'].s = titleStyle;
            }

            // Estilos de encabezados (fila 2) y celdas de datos (desde fila 3)
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = { c: C, r: R };
                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                    if (!ws[cell_ref]) continue;

                    if (R === 1) { // Fila de encabezados (índice 1 en ws_data)
                        ws[cell_ref].s = headerStyle;
                    } else if (R > 1) { // Filas de datos
                        ws[cell_ref].s = cellStyle;
                    }
                }
            }

            // 5. Ajustar anchos de columna
            const colWidths = [
                { wch: 5 }, // No.
            ];
            // Auto-ajuste para las demás columnas (opcional, pero mejora la apariencia)
            for (let i = 1; i < exportHeaders.length; i++) { // Inicia en 1 para omitir la columna "No."
                colWidths.push({ wch: 20 }); // Ancho estándar de 20
            }
            ws['!cols'] = colWidths;

            // 6. Generar y descargar el archivo
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, fileName);
        }

        /**
         * Convierte segundos a un objeto Date que Excel puede interpretar como formato de tiempo.
         * @param {number} seconds - La duración en segundos.
         * @returns {Date}
         */
        function secondsToExcelDate(seconds) {
        // Convertir segundos a objeto Date (para que Excel lo interprete como tiempo)
        return new Date(0, 0, 0, 0, 0, seconds || 0);
        }

        /**
         * Prepara los datos para la exportación, asegurando el formato y el orden correctos.
         */
        function prepareExportData(data) {
            // Helper para asegurar que los campos vacíos se exporten como "N/A"
            const na = (value) => value || "N/A";

            return data.map((call, index) => ({
                "No.": index + 1, 
                "Fecha": na(call.fecha), 
                "Inicio": na(formatTimeWithAmPm(call.inicio)),
                "Fin": na(formatTimeWithAmPm(call.fin)), 
                "Duración": formatDuration(
                    call.duracion instanceof Date 
                        ? (call.duracion.getHours() * 3600 + call.duracion.getMinutes() * 60 + call.duracion.getSeconds()) 
                        : (Number(call.duracion) || 0)
                ),
                "Área": na(call.area), 
                "Institución": na(call.institucion), 
                "Asunto": na(call.asunto),
                "Consulta": na(call.consulta), 
                "Nombre": na(call.nombre), 
                "Cargo": na(call.cargo),
                "Correo": na(call.correo), 
                "Teléfono": na(String(call.telefono || "")), 
                "Estatus": na(call.estatus),
                "Atendió": na(call.atendio), 
                "Comentarios": na(call.comentarios)
            }));
        }

        // =============================================
        // MÓDULO: Edición de Horarios
        // Descripción: Funciones para el modal de edición de fecha y horas de una llamada.
        // =============================================
        /**
         * Abre el modal para editar los timestamps (fecha, inicio, fin) de una llamada.
         * @param {Object} callItem - El objeto de la llamada a editar.
         * @param {boolean} isHistorical - `true` si la llamada es del histórico.
         */
        function openEditTimestampsModal(callItem, isHistorical) {
            // Poblar el formulario
            DOM.editTimestampsForm.querySelector('#timestamps-call-id').value = callItem.id;
            DOM.editTimestampsForm.querySelector('#timestamps-is-historical').value = isHistorical;

            // Convertir fecha DD/MM/YYYY a YYYY-MM-DD para el input
            try {
                const [day, month, year] = callItem.fecha.split('/');
                DOM.timestampsDateInput.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            } catch (e) {
                console.error("Error al parsear la fecha para el modal de edición:", callItem.fecha, e);
                DOM.timestampsDateInput.value = ''; // Dejar vacío si hay error
            }
            
            DOM.timestampsStartTimeInput.value = convertTo24HourFormat(callItem.inicio);
            DOM.timestampsEndTimeInput.value = convertTo24HourFormat(callItem.fin);

            calculateAndDisplayDuration();
            openModal(DOM.editTimestampsModal);
        }

        /**
         * Calcula y muestra la duración en el modal de edición de horarios.
         */
        function calculateAndDisplayDuration() {
            const start = DOM.timestampsStartTimeInput.value;
            const end = DOM.timestampsEndTimeInput.value;

            if (start && end) {
                const startDate = new Date(`1970-01-01T${start}Z`);
                const endDate = new Date(`1970-01-01T${end}Z`);
                let diff = (endDate.getTime() - startDate.getTime()) / 1000;
                if (diff < 0) diff = 0; // No permitir duraciones negativas
                DOM.timestampsDurationElem.textContent = formatDuration(diff);
            }
        }

        /**
         * Guarda los cambios de fecha y hora de una llamada.
         * @param {Event} e - El evento de submit del formulario.
         */
        async function saveTimestamps(e) {
            e.preventDefault();
            requirePassword(async () => {
                const callId = DOM.editTimestampsForm.querySelector('#timestamps-call-id').value;
                const isHistorical = DOM.editTimestampsForm.querySelector('#timestamps-is-historical').value === 'true';
                
                // Formatear la fecha correctamente desde el input YYYY-MM-DD a DD/MM/YYYY
                const dateParts = DOM.timestampsDateInput.value.split('-');
                const newDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;

                const newStart24h = DOM.timestampsStartTimeInput.value;
                const newEnd24h = DOM.timestampsEndTimeInput.value;
                const newDuration = (new Date(`1970-01-01T${newEnd24h}Z`) - new Date(`1970-01-01T${newStart24h}Z`)) / 1000;

                try {
                    await updateCall(callId, { fecha: newDate, inicio: formatTimeWithAmPm(newStart24h), fin: formatTimeWithAmPm(newEnd24h), duracion: newDuration }, isHistorical);
                    // Forzar el reordenamiento de la tabla correcta después de la actualización exitosa.
                    const data = isHistorical ? state.historicalCalls : state.calls;
                    const tableBody = isHistorical ? DOM.historicalTableBody : DOM.callLogTableBody;
                    sortAndRenderTable(tableBody, data, isHistorical);
                } finally {
                    closeModal(DOM.editTimestampsModal);
                    closeModal(DOM.viewDetailsModal); // Cerrar también el modal de detalles para forzar la reapertura con datos frescos
                }
            });
        }

        /**
         * Configura los filtros del dashboard de días de la semana.
         */
        function setupWeekdayDashboardFilter() {
            const indicators = document.querySelectorAll('#dashboard .indicator-card');

            indicators.forEach(card => {
                card.addEventListener('click', (e) => {
                    // Evitar que el evento se propague si se hace clic en un ícono dentro de la tarjeta
                    if (e.target.closest('i')) return;

                    const dayFilter = parseInt(card.dataset.day, 10);
                    const isDeactivating = state.ui.activeDayFilter === dayFilter;

                    if (isDeactivating) {
                        state.ui.activeDayFilter = null;
                        card.classList.remove('active-filter');
                        // Opcional: Limpiar todos los otros filtros al desactivar el filtro de día
                        state.activeFilters.main = {};
                        document.querySelectorAll('#main-table-header .filterable-header.active').forEach(h => h.classList.remove('active'));
                        const searchInput = document.getElementById('filter-input-main');
                        if (searchInput) {
                            searchInput.value = '';
                        }
                    } else {
                        // Limpiar visualmente el filtro activo anterior antes de establecer uno nuevo
                        indicators.forEach(c => c.classList.remove('active-filter'));
                        state.ui.activeDayFilter = dayFilter;
                        card.classList.add('active-filter');
                    }

                    // Re-renderizar la tabla principal con el filtro (o sin él)
                    // Y forzar la actualización de los filtros de columna
                    const dayFilteredData = state.ui.activeDayFilter !== null ? state.calls.filter(c => getDayOfWeek(c.fecha) === state.ui.activeDayFilter) : state.calls;
                    setupColumnFilters('main-table-header', () => dayFilteredData, renderTable, 'main');

                    // Re-renderizar la tabla principal con el filtro (o sin él)
                    sortAndRenderTable(DOM.callLogTableBody, state.calls, false);
                });
            });
        }

        // =============================================
        // MÓDULO: Notificación de Resumen Semanal
        // Descripción: Funcionalidad para mostrar una alerta con el resumen de actividad de la semana actual.
        // =============================================
        let summaryAlertShown = false;
        let summaryAlertTimeout;

        /**
         * Obtiene el rango de fechas para la semana actual (de Lunes a Domingo).
         * @returns {{start: Date, end: Date}}
         */
        function getWeekRange() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 (Dom) - 6 (Sáb)
            const diffToMonday = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajuste para que la semana empiece en Lunes
            
            const startOfWeek = new Date(now.setDate(diffToMonday));
            startOfWeek.setHours(0, 0, 0, 0);

            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            endOfWeek.setHours(23, 59, 59, 999);

            return { start: startOfWeek, end: endOfWeek };
        }

        /**
         * Comprueba si hay llamadas en la semana actual y muestra la alerta de resumen si corresponde.
         */
        function checkAndShowSummaryAlert() {
            if (summaryAlertShown) return;

            const { start, end } = getWeekRange();
            
            const weeklyCalls = state.calls.filter(call => {
                try {
                    const [day, month, year] = call.fecha.split('/');
                    const callDate = new Date(`${year}-${month}-${day}`);
                    return callDate >= start && callDate <= end;
                } catch (e) { return false; }
            });

            if (weeklyCalls.length > 0) {
                const totalCalls = weeklyCalls.length;
                const salientes = weeklyCalls.filter(c => c.estatus === 'Saliente').length;
                const entrantes = totalCalls - salientes;
                const totalDuration = weeklyCalls.reduce((sum, c) => sum + (Number(c.duracion) || 0), 0);
                const avgDuration = totalCalls > 0 ? Math.round(totalDuration / totalCalls) : 0;

                const alertContainer = document.getElementById('summary-alert-container');
                const alertContent = document.getElementById('summary-alert-content');

                alertContent.innerHTML = `
                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-phone-volume w-4 text-center mr-1"></i> Total:</span> <strong>${totalCalls}</strong></div>
                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-arrow-up-from-bracket w-4 text-center mr-1 text-green-500"></i> Salientes:</span> <strong>${salientes}</strong></div>
                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-inbox w-4 text-center mr-1 text-blue-500"></i> Entrantes:</span> <strong>${entrantes}</strong></div>
                    <div class="flex justify-between items-center"><span><i class="fa-solid fa-hourglass-half w-4 text-center mr-1"></i> Duración Prom:</span> <strong>${formatDuration(avgDuration)}</strong></div>
                    <div class="mt-3 text-right">
                        <button id="view-summary-btn" class="text-xs font-bold text-primary hover:underline">Ver Detalle</button>
                    </div>
                `;

                alertContainer.classList.remove('hidden', 'alert-leave');
                alertContainer.classList.add('alert-enter');
                summaryAlertShown = true;

                startSummaryAlertTimeout();
            }
        }

        /**
         * Inicia un temporizador para cerrar automáticamente la alerta de resumen.
         */
        function startSummaryAlertTimeout() {
            clearTimeout(summaryAlertTimeout);
            summaryAlertTimeout = setTimeout(() => {
                const closeBtn = document.getElementById('close-summary-alert-btn');
                if (closeBtn) closeBtn.click();
            }, 15000); // 15 segundos
        }

        /**
         * Configura los listeners para la alerta de resumen (cerrar, ver detalle, pausar al pasar el ratón).
         */
        function setupSummaryAlertListeners() {
            document.body.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'view-summary-btn') {
                    document.querySelector('button[data-tab="historico"]').click();
                    DOM.dashboardDataSourceHistorico.value = 'registro';
                    DOM.dashboardDataSourceHistorico.dispatchEvent(new Event('change'));
                    document.getElementById('close-summary-alert-btn').click();
                } else if (e.target && e.target.closest('#close-summary-alert-btn')) {
                    const container = document.getElementById('summary-alert-container');
                    container.classList.remove('alert-enter');
                    container.classList.add('alert-leave');
                    clearTimeout(summaryAlertTimeout);
                }
            });

            const alertContainer = document.getElementById('summary-alert-container');
            alertContainer.addEventListener('mouseenter', () => clearTimeout(summaryAlertTimeout));
            alertContainer.addEventListener('mouseleave', startSummaryAlertTimeout);
        }

        // =============================================
        // MÓDULO: Migración de datos
        // Descripción: Funciones para migrar datos entre la colección de 'Registro' y la de 'Histórico'.
        // =============================================

        /**
         * Migra las llamadas seleccionadas desde 'Registro y Control' hacia 'Histórico'.
         * @returns {Promise<void>}
         */
        async function migrateSelectedCallsToHistorical() {
            try {
                if (state.ui.selectedCallIdsToMigrate.size === 0) {
                    showAlert("No hay llamadas seleccionadas para migrar.", "warning");
                    return;
                }
                
                showLoader(true);
                
                const batch = writeBatch(db);
                const callsToMigrate = state.calls.filter(call => state.ui.selectedCallIdsToMigrate.has(call.id));
                if (callsToMigrate.length === 0) return; // Doble verificación

                callsToMigrate.forEach(call => {
                    const historicalDocRef = doc(historicalCallsCollectionRef);
                    const { id, ...callData } = call;
                    batch.set(historicalDocRef, { 
                        ...callData,
                        migratedAt: serverTimestamp(),
                        originalId: id
                    });

                    const callDocRef = doc(callsCollectionRef, call.id);
                    batch.delete(callDocRef);
                });
                
                await batch.commit();
                
                showAlert(`Se migraron ${callsToMigrate.length} llamadas al histórico.`, "success");
            } catch (error) {
                console.error("Error al migrar llamadas:", error);
                showAlert(`Error al migrar: ${error.message}`, "error");
            } finally {
                showLoader(false);
                // Salir del modo migración después de completar
                toggleMigrationMode(false);
            }
        }

        /**
         * Muestra u oculta el spinner de carga global.
         * @param {boolean} show - `true` para mostrar, `false` para ocultar.
         */
        function showLoader(show) {
            const loader = DOM.loader;
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        /**
         * Activa o desactiva el modo de migración de 'Registro' a 'Histórico'.
         * @param {boolean} activate - `true` para activar, `false` para desactivar.
         */
        function toggleMigrationMode(activate) {
            state.ui.isMigrationModeActive = activate;
            state.ui.selectedCallIdsToMigrate.clear();

            // Alternar visibilidad de botones
            DOM.startMigrationBtn.classList.toggle('hidden', activate);
            DOM.confirmMigrationBtn.classList.toggle('hidden', !activate);
            DOM.cancelMigrationBtn.classList.toggle('hidden', !activate);
            DOM.confirmMigrationBtn.disabled = true; // Siempre deshabilitar al entrar/salir del modo

            // Alternar visibilidad de la columna de checkboxes
            document.querySelectorAll('.migration-select-col').forEach(col => {
                col.classList.toggle('hidden', !activate);
            });

            // Limpiar estado
            DOM.selectAllCallsCheckbox.checked = false;

            // Re-renderizar la tabla principal para mostrar/ocultar los checkboxes en las filas
            sortAndRenderTable(DOM.callLogTableBody, state.calls, false);
        }

        // =============================================
        // MÓDULO: Migración Inversa (Histórico -> Registro)
        // Descripción: Funciones para la migración de datos desde 'Histórico' de vuelta a 'Registro'.
        // =============================================

        /**
         * Activa o desactiva el modo de migración inversa (de 'Histórico' a 'Registro').
         * @param {boolean} activate - `true` para activar, `false` para desactivar.
         */
        function toggleReverseMigrationMode(activate) {
            state.ui.isReverseMigrationModeActive = activate;
            state.ui.selectedHistoricalCallIdsToMigrate.clear();

            // Alternar visibilidad de botones
            DOM.startReverseMigrationBtn.classList.toggle('hidden', activate);
            DOM.confirmReverseMigrationBtn.classList.toggle('hidden', !activate);
            DOM.cancelReverseMigrationBtn.classList.toggle('hidden', !activate);
            DOM.confirmReverseMigrationBtn.disabled = true;

            // Alternar visibilidad de la columna de checkboxes en el histórico
            document.querySelectorAll('.reverse-migration-select-col').forEach(col => {
                col.classList.toggle('hidden', !activate);
            });

            // Limpiar estado del checkbox "seleccionar todo"
            DOM.selectAllHistoricalCallsCheckbox.checked = false;

            // Re-renderizar la tabla del histórico para mostrar/ocultar los checkboxes
            sortAndRenderTable(DOM.historicalTableBody, state.historicalCalls, true);
        }

        /**
         * Migra las llamadas seleccionadas desde 'Histórico' hacia 'Registro y Control'.
         * @returns {Promise<void>}
         */
        async function migrateSelectedCallsToRegistry() {
            try {
                if (state.ui.selectedHistoricalCallIdsToMigrate.size === 0) {
                    showAlert("No hay llamadas seleccionadas para migrar.", "warning");
                    return;
                }

                showLoader(true);

                const batch = writeBatch(db);
                const callsToMigrate = state.historicalCalls.filter(call => state.ui.selectedHistoricalCallIdsToMigrate.has(call.id));

                callsToMigrate.forEach(call => {
                    const newCallDocRef = doc(callsCollectionRef); // Nuevo documento en 'calls'
                    const { id, migratedAt, originalId, ...callData } = call; // Excluir campos de migración
                    
                    batch.set(newCallDocRef, {
                        ...callData,
                        createdAt: serverTimestamp(), // Nueva fecha de creación en el registro
                        updatedAt: serverTimestamp()
                    });

                    const historicalDocRef = doc(historicalCallsCollectionRef, call.id);
                    batch.delete(historicalDocRef); // Eliminar del histórico
                });

                await batch.commit();

                showAlert(`Se migraron ${callsToMigrate.length} llamadas al registro principal.`, "success");
            } catch (error) {
                console.error("Error al migrar llamadas al registro:", error);
                showAlert(`Error en la migración inversa: ${error.message}`, "error");
            } finally {
                showLoader(false);
                toggleReverseMigrationMode(false); // Salir del modo migración
            }
        }

        // =============================================
        // MÓDULO: Panel de Historial Rápido
        // Descripción: Funcionalidad para el panel flotante que muestra el historial de llamadas
        // de una institución seleccionada. Incluye la lógica para arrastrar y minimizar ventanas.
        // =============================================

        /**
         * Configura la funcionalidad del panel de historial rápido (cerrar, minimizar, arrastrar).
         */
        function setupQuickHistoryPanel() {
            const panel = DOM.quickHistoryPanel;
            const header = panel.querySelector('.quick-history-header');

            // Lógica para cerrar el panel
            DOM.closeQuickHistoryBtn.addEventListener('click', () => {
                panel.classList.add('hidden');
                // Asegurarse de que la ventana minimizada también se elimine
                const minimizedHistoryWindow = document.getElementById('minimized-history-window');
                if (minimizedHistoryWindow) {
                    minimizedHistoryWindow.remove();
                }
            });

            // Lógica para hacerlo arrastrable (draggable)
            let offsetX, offsetY;

            const move = (e) => {
                if (!state.ui.isDragging) return;
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                panel.style.left = `${clientX - offsetX}px`;
                panel.style.top = `${clientY - offsetY}px`;
            };

            const stopDrag = () => {
                state.ui.isDragging = false;
                document.removeEventListener('mousemove', move);
                document.removeEventListener('touchmove', move);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchend', stopDrag);
            };

            header.addEventListener('mousedown', (e) => {
                state.ui.isDragging = true;
                offsetX = e.clientX - panel.offsetLeft;
                offsetY = e.clientY - panel.offsetTop;
                document.addEventListener('mousemove', move);
                document.addEventListener('mouseup', stopDrag);
            });
            
            header.addEventListener('touchstart', (e) => {
                state.ui.isDragging = true;
                offsetX = e.touches[0].clientX - panel.offsetLeft;
                offsetY = e.touches[0].clientY - panel.offsetTop;
                document.addEventListener('touchmove', move);
                document.addEventListener('touchend', stopDrag);
            });

            // Lógica de Minimizar/Restaurar para el modal de llamada
            const minimizeCallBtn = document.getElementById('minimize-call-modal-btn');
            minimizeCallBtn.addEventListener('click', () => {
                minimizeWindow('call-modal', 'Llamada en curso...', 'minimized-call-window');
            });

            // Lógica de Minimizar/Restaurar para el modal de edición
            DOM.minimizeEditModalBtn.addEventListener('click', () => {
                minimizeWindow('edit-modal', 'Editando Llamada', 'minimized-edit-window');
            });

            // Lógica de Minimizar/Restaurar para el panel de historial
            DOM.minimizeQuickHistoryBtn.addEventListener('click', () => {
                minimizeWindow('quick-history-panel', 'Historial Rápido', 'minimized-history-window');
            });

            // Hacer el modal de llamada arrastrable
            const callModalHeader = document.getElementById('call-modal-header');
            const callModal = DOM.callModal.querySelector('.relative'); 

            callModalHeader.addEventListener('mousedown', (e) => {
                // Evitar iniciar el arrastre si se hace clic en un botón
                if (e.target.closest('button')) return;

                state.ui.isDragging = true;
                // La posición del modal es 'relative', pero su contenedor flex lo centra.
                // Para moverlo, necesitamos cambiarlo a 'absolute' y calcular su posición inicial.
                const rect = callModal.getBoundingClientRect();
                callModal.style.position = 'absolute';
                callModal.style.left = `${rect.left}px`;
                callModal.style.top = `${rect.top}px`;

                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;

                document.addEventListener('mousemove', moveCallModal);
                document.addEventListener('mouseup', stopDragCallModal);
            });

            const moveCallModal = (e) => {
                if (!state.ui.isDragging) return;
                e.preventDefault();
                callModal.style.left = `${e.clientX - offsetX}px`;
                callModal.style.top = `${e.clientY - offsetY}px`;
            };

            const stopDragCallModal = () => {
                state.ui.isDragging = false;
                document.removeEventListener('mousemove', moveCallModal);
                document.removeEventListener('mouseup', stopDragCallModal);
            };

            // Hacer el modal de edición arrastrable
            const editModalHeader = document.getElementById('edit-modal-header');
            const editModal = DOM.editModal.querySelector('.relative');

            editModalHeader.addEventListener('mousedown', (e) => {
                // Evitar iniciar el arrastre si se hace clic en un botón
                if (e.target.closest('button')) return;

                state.ui.isDragging = true;
                const rect = editModal.getBoundingClientRect();
                editModal.style.position = 'absolute';
                editModal.style.left = `${rect.left}px`;
                editModal.style.top = `${rect.top}px`;

                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;

                document.addEventListener('mousemove', moveEditModal);
                document.addEventListener('mouseup', stopDragEditModal);
            });

            const moveEditModal = (e) => {
                if (!state.ui.isDragging) return;
                e.preventDefault();
                editModal.style.left = `${e.clientX - offsetX}px`;
                editModal.style.top = `${e.clientY - offsetY}px`;
            };

            const stopDragEditModal = () => {
                state.ui.isDragging = false;
                document.removeEventListener('mousemove', moveEditModal);
                document.removeEventListener('mouseup', stopDragEditModal);
            };
        }

        /**
         * Minimiza un modal o panel a una barra en la parte inferior de la pantalla.
         * @param {string} elementId - El ID del elemento a minimizar.
         * @param {string} title - El título a mostrar en la ventana minimizada.
         * @param {string} minimizedId - El ID para la nueva ventana minimizada.
         */
        function minimizeWindow(elementId, title, minimizedId) {
            const element = document.getElementById(elementId);
            if (!element || element.classList.contains('hidden')) return;

            // Ocultar el modal/panel principal
            element.classList.add('hidden');

            // Crear la ventana minimizada si no existe
            if (!document.getElementById(minimizedId)) {
                const container = document.getElementById('minimized-windows-container');
                const minimizedWindow = document.createElement('div');
                minimizedWindow.id = minimizedId;
                minimizedWindow.className = 'minimized-window';
                minimizedWindow.dataset.target = elementId;

                let timerHTML = '';
                if (elementId === 'call-modal') {
                    timerHTML = `<span id="minimized-timer" class="text-sm font-mono text-primary">${DOM.modalTimerElem.textContent}</span>`;
                }

                minimizedWindow.innerHTML = `
                    <span class="minimized-window-title">${title}</span>
                    ${timerHTML}
                    <div class="minimized-window-controls">
                        <button class="restore-btn" title="Restaurar"><i class="fa-solid fa-window-restore"></i></button>
                        <button class="close-btn" title="Cerrar"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                `;
                container.appendChild(minimizedWindow);

                // Evento para restaurar (haciendo clic en cualquier parte excepto los botones)
                minimizedWindow.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        restoreWindow(minimizedId);
                    }
                });

                // Eventos para los botones
                minimizedWindow.querySelector('.restore-btn').addEventListener('click', () => restoreWindow(minimizedId));
                minimizedWindow.querySelector('.close-btn').addEventListener('click', () => {
                    const targetId = minimizedWindow.dataset.target;
                    const targetElement = document.getElementById(targetId);
                    if (targetId === 'call-modal') {
                        closeModal(targetElement);
                        stopTimer(false);
                    } else if (targetId === 'edit-modal') {
                        closeModal(targetElement);
                    } else {
                        targetElement.classList.add('hidden');
                    }
                    minimizedWindow.remove();
                });
            }
        }

        /**
         * Restaura una ventana que fue minimizada.
         * @param {string} minimizedId - El ID de la ventana minimizada.
         */
        function restoreWindow(minimizedId) {
            const minimizedWindow = document.getElementById(minimizedId);
            if (!minimizedWindow) return;

            const targetId = minimizedWindow.dataset.target;
            const targetElement = document.getElementById(targetId);

            targetElement.classList.remove('hidden');
            minimizedWindow.remove();
        }

        // Sincronizar el temporizador en la ventana minimizada
        setInterval(() => {
            const minimizedTimer = document.getElementById('minimized-timer');
            if (minimizedTimer) {
                minimizedTimer.textContent = DOM.modalTimerElem.textContent;
            }
        }, 1000);

        /**
         * Actualiza el contenido del panel de historial rápido basándose en la institución seleccionada en el formulario.
         */
        function updateQuickHistoryPanel() {
            const selectedInstitution = $('#caller-institution').val();
            const panel = DOM.quickHistoryPanel;
            const contentDiv = DOM.quickHistoryContent;

            if (!selectedInstitution || DOM.callModal.classList.contains('hidden')) {
                panel.classList.add('hidden');
                return;
            }

            const allCalls = [...state.calls, ...state.historicalCalls];
            const institutionCalls = allCalls
                .filter(call => call.institucion === selectedInstitution)
                .sort((a, b) => {
                    // Ordenar por fecha y hora descendente (más reciente primero)
                    const dateA = new Date(a.fecha.split('/').reverse().join('-') + 'T' + convertTo24HourFormat(a.inicio));
                    const dateB = new Date(b.fecha.split('/').reverse().join('-') + 'T' + convertTo24HourFormat(b.inicio));
                    return dateB - dateA;
                })
                .slice(0, 10); // Tomar las últimas 10

            if (institutionCalls.length === 0) {
                contentDiv.innerHTML = `<p class="text-center text-sm text-slate-500 p-4">No hay llamadas anteriores para esta institución.</p>`;
            } else {
                contentDiv.innerHTML = institutionCalls.map(call => {
                    const statusClass = call.estatus === 'Saliente' ? 'text-green-500' : 'text-blue-500';
                    const statusIcon = call.estatus === 'Saliente' ? 'fa-arrow-up-from-bracket' : 'fa-inbox';
                    return `
                        <div class="quick-history-item">
                            <div class="flex justify-between items-center mb-1">
                                <p class="text-xs text-slate-500">${formatLongDate(call.fecha)} - ${formatTimeWithAmPm(call.inicio)}</p>
                                <span class="text-xs font-semibold ${statusClass}"><i class="fa-solid ${statusIcon} mr-1"></i>${call.estatus}</span>
                            </div>
                            <p class="font-semibold text-slate-800">${call.nombre || 'N/A'}</p>
                            <p class="text-sm text-slate-600"><strong>Asunto:</strong> ${call.asunto || 'N/A'}</p>
                            <p class="text-sm text-slate-600"><strong>Consulta:</strong> ${call.consulta || 'N/A'}</p>
                            ${call.comentarios ? `
                                <details class="mt-2 text-xs">
                                    <summary class="cursor-pointer text-primary hover:underline">Ver comentarios</summary>
                                    <p class="italic text-slate-500 bg-slate-50 p-2 rounded mt-1 border">${call.comentarios}</p>
                                </details>
                            ` : ''}
                        </div>`;
                }).join('');
            }
            panel.classList.remove('hidden');
        }

        // =============================================
        // MÓDULO: Configuración de eventos 
        // Descripción: Punto central donde se asignan todos los manejadores de eventos
        // principales de la aplicación.
        // =============================================
        
        /**
         * Configura todos los `event listeners` principales de la aplicación.
         */
        function setupEventListeners() {
            // --- Evento para el ojo de la contraseña (mejorado a press-and-hold) ---
            const togglePasswordBtn = document.getElementById('toggle-password-visibility');
            if (togglePasswordBtn) {
                const passwordInput = document.getElementById('login-password');
                const icon = togglePasswordBtn.querySelector('i');

                const showPassword = () => {
                    passwordInput.type = 'text';
                    icon.classList.replace('fa-eye', 'fa-eye-slash');
                };

                const hidePassword = () => {
                    passwordInput.type = 'password';
                    icon.classList.replace('fa-eye-slash', 'fa-eye');
                };

                togglePasswordBtn.addEventListener('mousedown', showPassword);
                togglePasswordBtn.addEventListener('mouseup', hidePassword);
                togglePasswordBtn.addEventListener('mouseleave', hidePassword); // Si el mouse se sale del botón
                togglePasswordBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault(); showPassword();
                });
                togglePasswordBtn.addEventListener('touchend', hidePassword);
            }


            // --- Eventos de Login/Logout ---
            DOM.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                DOM.loginError.classList.add('hidden');
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;

                try {
                    showLoader(true); // Mostrar loader durante el intento de login
                    await signInWithEmailAndPassword(auth, email, password);
                    // onAuthStateChanged se encargará de mostrar la app
                } catch (error) {
                    showLoader(false); // Ocultar loader si hay error
                    let message = "Error al iniciar sesión. Inténtalo de nuevo.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                        message = "Credenciales incorrectas. Verifica tu correo y contraseña.";
                    }
                    DOM.loginError.textContent = message;
                    DOM.loginError.classList.remove('hidden');
                    console.error("Error de inicio de sesión:", error.code, error.message);
                }
            });

            // Botón para volver a la app desde la pantalla de login
            document.getElementById('back-to-app-btn').addEventListener('click', () => {
                DOM.loginScreen.classList.add('hidden');
                showApp();
            });

            DOM.logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged se encargará de mostrar la pantalla de login
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                    showAlert("Error al cerrar sesión.", "error");
                }
            });

            setupTabs();
            // Modificación: El dataProvider para los filtros de columna ahora puede ser dinámico.
            setupColumnFilters('main-table-header', () => {
                // Si hay un filtro de día activo, devuelve los datos ya filtrados. Si no, todos los datos.
                return state.ui.activeDayFilter !== null ? state.calls.filter(c => getDayOfWeek(c.fecha) === state.ui.activeDayFilter) : state.calls;
            }, renderTable, 'main');
            setupColumnFilters('historical-table-header', () => state.historicalCalls, renderTable, 'historical');

            setupFiltering('filter-input-main', () => state.calls, renderTable, false);
            setupFiltering('filter-input-historical', () => state.historicalCalls, renderTable, true);
            setupAutofill();

            // Listeners para los nuevos botones de limpiar filtros
            document.getElementById('clear-all-filters-btn').addEventListener('click', () => clearAllFilters('main'));
            document.getElementById('clear-all-filters-historical-btn').addEventListener('click', () => clearAllFilters('historical'));


            setupWeekdayDashboardFilter();
            
            // Listener para el dashboard de la pestaña de histórico
            DOM.dashboardDataSourceHistorico.addEventListener('change', updateAllDashboards);
            
            // Establecer "Histórico" como valor predeterminado en fuente de datos
            DOM.reportesDataSource.value = 'historico'; 
            DOM.reportesDataSource.addEventListener('change', updateCharts);

            // Listener para el nuevo selector de asunto en el gráfico de consultas
            DOM.consultaAsuntoFilter.addEventListener('change', updateCharts);

            DOM.dynamicChartVariable.addEventListener('change', updateDynamicChart);

            DOM.startCallBtn.addEventListener('click', () => {
                startTimer();
            });

            DOM.closeModalBtn.addEventListener('click', () => {
                closeModal(DOM.callModal);
                stopTimer(false); // Detener el cronómetro sin guardar si se cierra con la 'X'
            });
            
            DOM.callForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!DOM.callForm.checkValidity()) return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                stopTimer();
                closeModal(DOM.callModal);
            });
            
            DOM.closeEditModalBtn.addEventListener('click', () => closeModal(DOM.editModal));
            DOM.editForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!DOM.editForm.checkValidity()) return showAlert("Por favor, complete todos los campos obligatorios.", "warning");
                
                const formData = new FormData(DOM.editForm);
                const updateData = Object.fromEntries(formData.entries());
                const id = DOM.editForm.querySelector('#edit-id').value;
                
                await updateCall(id, updateData, state.ui.currentEditIsHistorical);
                closeModal(DOM.editModal);
            });

            let callToDeleteId = null;
            let callToDeleteIsHistorical = false;

            function handleDeleteClick(e) {
                if (state.isReadOnly) return;
                const button = e.currentTarget;
                if (button.disabled) return; // Evitar acción si el botón está deshabilitado
                requirePassword(() => {
                    callToDeleteId = button.dataset.id;
                    state.ui.callToDeleteIsHistorical = button.dataset.isHistorical === 'true';
                    openModal(DOM.confirmModal);
                });
            }

            // Reemplazar la función handleEditClick con esta versión corregida
            function handleEditClick(event) {
                if (state.isReadOnly) return;
                const button = event.currentTarget;
                if (button.disabled) return; // Evitar acción si el botón está deshabilitado
                requirePassword(() => {
                    const callId = button.getAttribute('data-id');
                    const isHistorical = button.getAttribute('data-is-historical') === 'true';

                    if (!callId) {
                        console.error("ID de llamada no encontrado para edición");
                        return;
                    }

                    state.ui.currentEditIsHistorical = isHistorical;
                    const allData = isHistorical ? state.historicalCalls : state.calls;
                    const callToEdit = allData.find(call => call.id === callId);

                    if (!callToEdit) {
                        showAlert("No se pudo encontrar la llamada para editar", "error");
                        return;
                    }

                    DOM.editForm.querySelector('#edit-id').value = callId;

                    // Desactivar autofill durante la carga inicial
                    state.ui.isProgrammaticChange = true;
                    
                    $('#edit-caller-institution').val(callToEdit.institucion || '').trigger('change.select2');
                    $('#edit-call-area').val(callToEdit.area || '').trigger('change.select2');
                    $('#edit-call-subject').val(callToEdit.asunto || '').trigger('change.select2');
                    $('#edit-call-query').val(callToEdit.consulta || '').trigger('change.select2');
                    $('#edit-caller-name').val(callToEdit.nombre || '').trigger('change.select2');
                    $('#edit-caller-cargo').val(callToEdit.cargo || '').trigger('change.select2');
                    $('#edit-caller-email').val(callToEdit.correo || '').trigger('change.select2');
                    $('#edit-caller-phone').val(callToEdit.telefono || '').trigger('change.select2');
                    $('#edit-call-comments').val(callToEdit.comentarios || '').trigger('change.select2');
                    $('#edit-call-atendio').val(callToEdit.atendio || '').trigger('change.select2');

                    // Reactivar autofill después de la carga
                    setTimeout(() => {
                        state.ui.isProgrammaticChange = false;
                    }, 100);

                    openModal(DOM.editModal);
                    // Bloquear acciones de fondo al abrir el modal de edición
                    toggleCallActiveState(true);

                });
            }

            // Funcion para actualizar estatus
            async function handleStatusToggle(e) {
                if (state.isReadOnly) return;
                if (e.currentTarget.disabled) return; // Evitar acción si el botón está deshabilitado
                const button = e.currentTarget;
                const callId = button.dataset.id;
                const isHistorical = button.dataset.isHistorical === 'true';
                const currentStatus = button.textContent.trim();
                const newStatus = currentStatus === 'Saliente' ? 'Entrante' : 'Saliente';
                await updateCall(callId, { estatus: newStatus }, isHistorical);
            }

            DOM.callLogTableBody.addEventListener('click', e => {
                // Si se hizo clic en un botón, manejar la acción del botón y detener.
                const buttonTarget = e.target.closest('button');
                if (buttonTarget) {
                    if (buttonTarget.classList.contains('edit-btn')) handleEditClick({ currentTarget: buttonTarget });
                    if (buttonTarget.classList.contains('delete-btn')) handleDeleteClick({ currentTarget: buttonTarget });
                    if (buttonTarget.classList.contains('toggle-status-btn')) handleStatusToggle({ currentTarget: buttonTarget }); 
                    return;
                }

                // Si el modo de migración está activo y no se hizo clic en un botón, manejar la selección de la fila.
                if (state.ui.isMigrationModeActive) {
                    const row = e.target.closest('tr');
                    if (!row) return;

                    const checkbox = row.querySelector('.call-migration-checkbox');
                    if (checkbox) {
                        // No procesar si el clic fue directamente en el checkbox para evitar doble evento.
                        if (e.target === checkbox) return;

                        // Invertir el estado del checkbox y disparar el evento 'change'
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });

            // Estatus tabla de histórico
            DOM.historicalTableBody.addEventListener('click', (e) => {
                const buttonTarget = e.target.closest('button');
                if (buttonTarget) {
                    if (buttonTarget.classList.contains('edit-btn')) handleEditClick({ currentTarget: buttonTarget });
                    if (buttonTarget.classList.contains('delete-btn')) handleDeleteClick({ currentTarget: buttonTarget });
                    if (buttonTarget.classList.contains('toggle-status-btn')) handleStatusToggle({ currentTarget: buttonTarget }); 
                    return;
                }

                // Lógica para seleccionar fila en modo de migración inversa
                if (state.ui.isReverseMigrationModeActive) {
                    const row = e.target.closest('tr');
                    if (!row) return;

                    const checkbox = row.querySelector('.historical-call-migration-checkbox');
                    if (checkbox) {
                        if (e.target === checkbox) return;

                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                }
            });

            // Cancelar Eliminar llamada de historico
            DOM.cancelDeleteBtn.addEventListener('click', () => {
                closeModal(DOM.confirmModal);
                callToDeleteId = null;
            });
            
            // Eliminar llamada de historico
            DOM.confirmDeleteBtn.addEventListener('click', async () => {
                if (callToDeleteId) {
                    await deleteCall(callToDeleteId, state.ui.callToDeleteIsHistorical);
                    closeModal(DOM.confirmModal);
                }
            });
            
            // Importar histórico — actualizarado para ocultar el label cuando haya archivo seleccionado

            // Obtener una referencia al label visible (trigger) una vez
            const uploadLabel = document.querySelector('label[for="historical-file-input"]');

            //Boton de selección de archivo, muestra botones si se selecciona archivo
            DOM.historicalFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];

                if (file) {
                    // Notificación de advertencia al seleccionar un archivo
                    showAlert("⚠️ Atención: Al subir un archivo, se reemplazarán los datos del histórico existente.", "warning");

                    // Ocultar el label visible (botón "Subir Excel")
                    if (uploadLabel) uploadLabel.classList.add('hidden');

                    //Ocultar y desactivar botón de migración             
                    DOM.startReverseMigrationBtn.classList.remove('hidden');
                    DOM.startReverseMigrationBtn.disabled = true;

                    // Mostrar botones de confirmar y cancelar
                    DOM.confirmImportHistoricalBtn.classList.remove('hidden');
                    DOM.confirmImportHistoricalBtn.disabled = false;
                    DOM.cancelImportHistoricalBtn.classList.remove('hidden');
                    DOM.cancelImportHistoricalBtn.disabled = false;
                } else {
                    // Si no hay archivo seleccionado, asegurarse de mostrar el label
                    if (uploadLabel) uploadLabel.classList.remove('hidden');
                    
                    //Mostrar y activar botón de migración
                    DOM.startReverseMigrationBtn.classList.add('hidden');
                    DOM.startReverseMigrationBtn.disabled = false;
                    
                    // Ocultar botones de confirmar y cancelar
                    DOM.confirmImportHistoricalBtn.classList.add('hidden');
                    DOM.confirmImportHistoricalBtn.disabled = true;
                    DOM.cancelImportHistoricalBtn.classList.add('hidden');
                    DOM.cancelImportHistoricalBtn.disabled = true;
                }
            });

            // Cancelar la Importación del archivo histórico seleccionado — restaura el label y limpia el input
            DOM.cancelImportHistoricalBtn.addEventListener('click', () => {
                if (uploadLabel) uploadLabel.classList.remove('hidden');

                // Limpiar selección para permitir volver a elegir el mismo archivo
                DOM.historicalFileInput.value = '';

                //habilitar botón de migración inversa
                DOM.startReverseMigrationBtn.disabled = false;

                // Ocultar y deshabilitar botones
                DOM.confirmImportHistoricalBtn.classList.add('hidden');
                DOM.confirmImportHistoricalBtn.disabled = true;
                DOM.cancelImportHistoricalBtn.classList.add('hidden');
                DOM.cancelImportHistoricalBtn.disabled = true;
            });

            // Confirmar la Importación del archivo histórico seleccionado
            DOM.confirmImportHistoricalBtn.addEventListener('click', () => {
                requirePassword(async () => {
                    const file = DOM.historicalFileInput.files[0];
                    if (!file) {
                        showAlert("Por favor, selecciona un archivo Excel primero.", "warning");
                        return;
                    }

                    showLoader(true); // Mostrar el loader al iniciar el proceso
                    
                    // Ocultar el label visible (botón "Subir Excel")
                    if (uploadLabel) uploadLabel.classList.add('hidden');

                    const reader = new FileReader();
                    reader.onload = async (e) => {  // Hacer onload async para permitir await dentro
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                            const sheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[sheetName];

                            // --- INICIO: Lógica mejorada para detectar encabezados ---
                            let jsonData;
                            const titleCell = worksheet['A1'] ? worksheet['A1'].v : '';
                            if (typeof titleCell === 'string' && titleCell.toLowerCase().includes('llamadas registradas')) {
                                // Si hay título, los encabezados están en la fila 2.
                                jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 1 });
                            } else {
                                // Comportamiento por defecto: los encabezados están en la fila 1.
                                jsonData = XLSX.utils.sheet_to_json(worksheet);
                            }
                            // --- FIN: Lógica mejorada para detectar encabezados ---
                            
                            if (jsonData.length === 0) return showAlert("El archivo no contiene datos válidos.", "warning");

                            const processedData = jsonData.map(row => {  // Corregir json a jsonData
                                // Función para procesar cada valor: si es "N/A", lo convierte en un string vacío.
                                const processNA = (value) => {
                                    if (typeof value === 'string' && value.trim().toUpperCase() === 'N/A') {
                                        return '';
                                    }
                                    return value;
                                };
                                const mapKeys = (obj, keyMap) => Object.keys(obj).reduce((acc, key) => {
                                    const newKey = keyMap[key.toLowerCase().trim()] || key.toLowerCase().trim();
                                    acc[newKey] = obj[key];
                                    return acc;
                                }, {});

                                const keyMapping = { 'no.': 'no', 'duración': 'duracion', 'área': 'area', 'institución': 'institucion', 'teléfono': 'telefono', 'atendió': 'atendio' };
                                const mappedRow = mapKeys(row, keyMapping);

                                // Procesar cada campo para manejar "N/A" antes de cualquier otra lógica.
                                let fecha = processNA(mappedRow.fecha);
                                let inicio = processNA(mappedRow.inicio);
                                let fin = processNA(mappedRow.fin);
                                let duracion = processNA(mappedRow.duracion);
                                
                                if (fecha instanceof Date) {
                                    fecha = fecha.toLocaleDateString('es-ES');
                                } else if (!fecha) {
                                    fecha = ''; // Dejar vacío en lugar de asignar fecha actual
                                }
                                
                                if (inicio instanceof Date) {
                                    inicio = inicio.toLocaleTimeString('es-ES', { hour12: false });
                                } else if (!inicio) {
                                    inicio = ''; // Dejar vacío
                                }
                                
                                if (fin instanceof Date) {
                                    fin = fin.toLocaleTimeString('es-ES', { hour12: false });
                                } else if (!fin) {
                                    fin = ''; // Dejar vacío
                                }

                                if (typeof duracion === 'number') {
                                    if (duracion < 1) {
                                        duracion = Math.round(duracion * 86400); // Decimal a segundos
                                    }
                                } else if (typeof duracion === 'string') {
                                    const timeParts = duracion.split(':');
                                    if (timeParts.length === 3) {
                                        duracion = (parseInt(timeParts[0]) * 3600) +
                                                (parseInt(timeParts[1]) * 60) +
                                                parseInt(timeParts[2]);
                                    } else {
                                        duracion = parseInt(duracion) || 0;
                                    }
                                } else if (duracion instanceof Date) {
                                    duracion = (duracion.getHours() * 3600) +
                                            (duracion.getMinutes() * 60) +
                                            duracion.getSeconds();
                                } else {
                                    duracion = 0;
                                }

                                return {
                                    fecha: fecha,
                                    inicio: inicio,
                                    fin: fin,
                                    duracion: duracion || 0,
                                    area: processNA(mappedRow.area) || '',
                                    institucion: processNA(mappedRow.institucion) || '',
                                    asunto: processNA(mappedRow.asunto) || '',
                                    consulta: processNA(mappedRow.consulta) || '',
                                    nombre: processNA(mappedRow.nombre) || '',
                                    cargo: processNA(mappedRow.cargo) || '',
                                    correo: processNA(mappedRow.correo) || '',
                                    telefono: String(processNA(mappedRow.telefono) || ''),
                                    estatus: processNA(mappedRow.estatus) || 'Entrante',
                                    atendio: processNA(mappedRow.atendio) || '',
                                    comentarios: processNA(mappedRow.comentarios) || ''
                                };
                            });

                            if (processedData.length === 0) return showAlert("El archivo Excel está vacío o no es válido.", "warning");
                            
                            // Si hay datos existentes, los va a reemplazar
                            if (state.historicalCalls.length > 0) {
                                await deleteAllHistorical();
                            }

                            await importHistoricalData(processedData)

                            //Despues de subir el excel, se restauran los botones.
                            DOM.historicalFileInput.value = '';
                            if (uploadLabel) uploadLabel.classList.remove('hidden');
                            //habilitar botón de migración inversa
                            DOM.startReverseMigrationBtn.disabled = false;
                            // Ocultar y deshabilitar botones
                            DOM.confirmImportHistoricalBtn.classList.add('hidden')
                            DOM.confirmImportHistoricalBtn.disabled = true
                            DOM.cancelImportHistoricalBtn.classList.add('hidden')
                            DOM.cancelImportHistoricalBtn.disabled = true;
                        
                        } catch (error) {
                            console.error("Error al procesar el archivo:", error);
                            showAlert("Error al procesar el archivo. Asegúrese de que es un Excel válido.", "error");
                        } finally {
                            // Ocultar el loader sin importar si hubo éxito o error
                            showLoader(false);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            });
            
            // Registro de llamadas descargar
            DOM.downloadExcelBtn.addEventListener('click', () => {
                if (state.calls.length === 0) return showAlert("No hay datos para descargar.", "warning");
                const timestamp = getFormattedTimestamp();
                const fileName = `Registro de Llamadas - ${timestamp}.xlsx`;
                exportToExcelWithFormatting(state.calls, "Registro de Llamadas", fileName);
            });
            
            // Registro histórico descargar
            document.getElementById('download-historical-excel-btn').addEventListener('click', () => {
                // Obtener los datos actualmente filtrados en la tabla
                const filteredData = applyAllFilters(state.historicalCalls, 'historical');
                if (filteredData.length === 0) return showAlert("No hay datos en la tabla para descargar.", "warning");
                const timestamp = getFormattedTimestamp();
                const fileName = `Registro de Llamadas Históricas - ${timestamp}.xlsx`;
                exportToExcelWithFormatting(filteredData, "Registro Histórico", fileName);
            });
            
            // Generar Reporte Boton
            DOM.generateReportBtn.addEventListener('click', () => openModal(DOM.reportModal));
            DOM.closeReportModalBtn.addEventListener('click', () => closeModal(DOM.reportModal));
            

            // Generar PDF (CORREGIDO)
            DOM.generatePdfBtn.addEventListener('click', async () => {
                const options = {
                    includeStatus: document.getElementById('include-status').checked,
                    includeAsunto: document.getElementById('include-asunto').checked,
                    includeDay: document.getElementById('include-day').checked,
                    includeAtendio: document.getElementById('include-atendio').checked,
                    includeDynamicChart: document.getElementById('include-dynamic-chart').checked,
                    includeDynamicTable: document.getElementById('include-dynamic-table').checked
                };
                
                closeModal(DOM.reportModal);
                await generateExecutiveReport(options);
            });
            
            // slider pixeles
            DOM.chartSizeSlider.addEventListener('input', () => {
                const size = DOM.chartSizeSlider.value;
                DOM.chartSizeValue.textContent = `${size}px`;
                updateCharts();
            });

            // Iniciar modo migración
            DOM.startMigrationBtn.addEventListener('click', () => {
                toggleMigrationMode(true);
            });

            // Cancelar modo migración
            DOM.cancelMigrationBtn.addEventListener('click', () => {
                toggleMigrationMode(false);
            });

            // Confirmar migración (ahora es el botón de éxito)
            DOM.confirmMigrationBtn.addEventListener('click', () => {
                if (state.ui.selectedCallIdsToMigrate.size === 0) return;

                requirePassword(async () => {
                    await migrateSelectedCallsToHistorical();
                });
            });

            // Lógica para seleccionar/deseleccionar llamadas
            DOM.callLogTableBody.addEventListener('change', e => {
                if (e.target.classList.contains('call-migration-checkbox')) {
                    const callId = e.target.dataset.id;
                    if (e.target.checked) {
                        state.ui.selectedCallIdsToMigrate.add(callId);
                    } else {
                        state.ui.selectedCallIdsToMigrate.delete(callId);
                    }
                    DOM.confirmMigrationBtn.disabled = state.ui.selectedCallIdsToMigrate.size === 0;
                    DOM.selectAllCallsCheckbox.checked = state.ui.selectedCallIdsToMigrate.size === state.calls.length && state.calls.length > 0;
                }
            });

            // Lógica para "Seleccionar Todo"
            DOM.selectAllCallsCheckbox.addEventListener('change', e => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.call-migration-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                    const callId = checkbox.dataset.id;
                    isChecked ? state.ui.selectedCallIdsToMigrate.add(callId) : state.ui.selectedCallIdsToMigrate.delete(callId);
                });
                DOM.confirmMigrationBtn.disabled = state.ui.selectedCallIdsToMigrate.size === 0;
            });

            // --- INICIO: Lógica para Migración Inversa ---

            // Iniciar modo migración inversa
            DOM.startReverseMigrationBtn.addEventListener('click', () => {
                toggleReverseMigrationMode(true);
            });

            // Cancelar modo migración inversa
            DOM.cancelReverseMigrationBtn.addEventListener('click', () => {
                toggleReverseMigrationMode(false);
            });

            // Confirmar migración inversa
            DOM.confirmReverseMigrationBtn.addEventListener('click', () => {
                if (state.ui.selectedHistoricalCallIdsToMigrate.size === 0) return;
                requirePassword(async () => {
                    await migrateSelectedCallsToRegistry();
                });
            });

            // Lógica para seleccionar/deseleccionar llamadas del histórico
            DOM.historicalTableBody.addEventListener('change', e => {
                if (e.target.classList.contains('historical-call-migration-checkbox')) {
                    const callId = e.target.dataset.id;
                    e.target.checked ? state.ui.selectedHistoricalCallIdsToMigrate.add(callId) : state.ui.selectedHistoricalCallIdsToMigrate.delete(callId);
                    DOM.confirmReverseMigrationBtn.disabled = state.ui.selectedHistoricalCallIdsToMigrate.size === 0;
                    DOM.selectAllHistoricalCallsCheckbox.checked = state.ui.selectedHistoricalCallIdsToMigrate.size === state.historicalCalls.length && state.historicalCalls.length > 0;
                }
            });

            // Lógica para "Seleccionar Todo" en el histórico
            DOM.selectAllHistoricalCallsCheckbox.addEventListener('change', e => {
                const isChecked = e.target.checked;
                document.querySelectorAll('.historical-call-migration-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                    const callId = checkbox.dataset.id;
                    isChecked ? state.ui.selectedHistoricalCallIdsToMigrate.add(callId) : state.ui.selectedHistoricalCallIdsToMigrate.delete(callId);
                });
                DOM.confirmReverseMigrationBtn.disabled = state.ui.selectedHistoricalCallIdsToMigrate.size === 0;
            });

            // --- FIN: Lógica para Migración Inversa ---

            // =============================================
            // MÓDULO: Visualización de Detalles (Doble Clic)
            // =============================================

            //Mostrar detalles de llamada - modal
            function showDetailsModal(callItem) {
                // Ocultar el tooltip de vista rápida al abrir el modal de detalles
                if (DOM.quickViewTooltip) {
                    DOM.quickViewTooltip.classList.remove('visible');
                }

                if (!callItem) return;

                const detailsModalContent = DOM.viewDetailsModal.querySelector('#details-modal-content');

                // Rediseño del contenido del modal para una mejor visualización
                detailsModalContent.innerHTML = `
                    <div class="details-header">
                        <p class="date">Fecha: ${callItem.fecha || 'No especificada'}</p>
                        <h3 class="text-xl font-bold text-slate-800 mt-1">Institución: ${callItem.institucion || 'No especificada'}</h3> 
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6 mb-8">
                        <div class="details-section">
                            <h4 class="editable-header" id="details-horarios-header" title="Doble clic para editar">
                                <i class="fa-solid fa-clock mr-2"></i>Horarios
                            </h4>
                            <p class="text-gray-700 text-sm"><strong>Inicio:</strong> ${formatTimeWithAmPm(callItem.inicio)}</p>
                            <p class="text-gray-700 text-sm"><strong>Fin:</strong> ${formatTimeWithAmPm(callItem.fin)}</p>
                            <p class="text-gray-700 text-sm"><strong>Duración:</strong> ${formatDuration(callItem.duracion)}</p>
                        </div>
                        <div class="details-section">
                            <h4><i class="fa-solid fa-sitemap mr-2"></i>Clasificación</h4>
                            <p class="text-gray-700 text-sm"><strong>Área:</strong> ${callItem.area || 'N/A'}</p>
                            <p class="text-gray-700 text-sm"><strong>Asunto:</strong> ${callItem.asunto || 'N/A'}</p>
                            <p class="text-gray-700 text-sm"><strong>Consulta:</strong> ${callItem.consulta || 'N/A'}</p>
                        </div>
                         <div class="details-section">
                            <h4><i class="fa-solid fa-user-tie mr-2"></i>Atención</h4>
                            <p class="text-gray-700 text-sm"><strong>Atendió:</strong> ${callItem.atendio || 'N/A'}</p>
                            <p class="text-gray-700 text-sm"><strong>Estatus:</strong> <span class="font-semibold ${callItem.estatus === 'Saliente' ? 'text-green-600' : 'text-blue-600'}">${callItem.estatus || 'N/A'}</span></p>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4><i class="fa-solid fa-user mr-2"></i>Datos del Solicitante</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2">
                            <p class="text-gray-700 text-sm"><strong>Nombre:</strong> ${callItem.nombre || 'N/A'}</p>
                            <p class="text-gray-700 text-sm"><strong>Cargo:</strong> ${callItem.cargo || 'N/A'}</p>
                            <p class="text-gray-700 text-sm"><strong>Correo:</strong> ${callItem.correo || 'N/A'}</p>
                            <p class="text-gray-700 text-sm"><strong>Teléfono:</strong> ${callItem.telefono || 'N/A'}</p>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4><i class="fa-solid fa-comments mr-2"></i>Comentarios Adicionales</h4>
                        <p class="text-gray-700 italic text-sm bg-white p-3 rounded-md border">${callItem.comentarios || 'Sin comentarios.'}</p>
                    </div>
                `;

                openModal(DOM.viewDetailsModal);

                // Añadir el listener de doble clic al título de horarios
                const horariosHeader = detailsModalContent.querySelector('#details-horarios-header');
                if (horariosHeader) {
                    horariosHeader.addEventListener('dblclick', () => openEditTimestampsModal(callItem, state.ui.currentEditIsHistorical));
                }
            }

            //Edición de orarios con doble clic
            function handleRowDoubleClick(e, isHistorical) {
                if (state.isReadOnly) return; // No permitir doble clic en modo solo lectura
                const row = e.target.closest('tr');
                // IMPORTANTE: No abrir si se hace clic en un botón (editar, borrar, estatus)
                if (!row || e.target.closest('button')) {
                    return; 
                }
                // Ocultar el tooltip al iniciar el doble clic para evitar que se quede "pegado"
                if (DOM.quickViewTooltip) DOM.quickViewTooltip.classList.remove('visible');

                const callId = row.querySelector('.edit-btn')?.dataset.id;
                if (!callId) return;

                const data = isHistorical ? state.historicalCalls : state.calls;
                state.ui.currentEditIsHistorical = isHistorical; // Guardar el contexto para la edición de horarios
                const callItem = data.find(item => item.id === callId);
                showDetailsModal(callItem);
            }

            // Asignar los listeners de doble clic a las tablas
            DOM.callLogTableBody.addEventListener('dblclick', (e) => handleRowDoubleClick(e, false));
            DOM.historicalTableBody.addEventListener('dblclick', (e) => handleRowDoubleClick(e, true));
            
            // Asignar el listener para el botón de cerrar
            DOM.closeDetailsModalBtn.addEventListener('click', () => closeModal(DOM.viewDetailsModal));

            // Listener para el evento de redimensionamiento de la ventana (para el zoom)
            // Se usa debounce para evitar que la función se ejecute demasiadas veces y afecte el rendimiento.
            window.addEventListener('resize', debounce(() => {
                // Solo actualiza los gráficos si la pestaña de reportes está activa.
                const reportesTab = document.getElementById('tab-content-reportes');
                if (reportesTab && !reportesTab.classList.contains('hidden')) {
                    updateCharts();
                }
            }, 250)); // 250ms de retraso

            // Listeners para el modal de edición de horarios
            DOM.closeTimestampsModalBtn.addEventListener('click', () => closeModal(DOM.editTimestampsModal));
            DOM.cancelTimestampsBtn.addEventListener('click', () => closeModal(DOM.editTimestampsModal));
            DOM.editTimestampsForm.addEventListener('submit', saveTimestamps);
            DOM.timestampsStartTimeInput.addEventListener('change', calculateAndDisplayDuration);
            DOM.timestampsEndTimeInput.addEventListener('change', calculateAndDisplayDuration);

            // --- INICIO: Minimizar modales al hacer clic fuera ---
            DOM.callModal.addEventListener('click', (e) => {
                if (e.target === DOM.callModal) { // Clic en el fondo del modal
                    minimizeWindow('call-modal', 'Llamada en curso...', 'minimized-call-window');
                }
            });

            DOM.editModal.addEventListener('click', (e) => {
                if (e.target === DOM.editModal) { // Clic en el fondo del modal
                    minimizeWindow('edit-modal', 'Editando Llamada', 'minimized-edit-window');
                }
            });
            // --- FIN: Minimizar modales al hacer clic fuera ---

            // Cierre del modal de detalles al hacer clic fuera
            DOM.viewDetailsModal.addEventListener('click', (e) => {
                if (e.target === DOM.viewDetailsModal) {
                    // Antes de cerrar, verificar si el modal de edición de horarios está abierto
                    if (!DOM.editTimestampsModal.classList.contains('hidden')) {
                        return; // No cerrar si el modal de horarios está encima
                    }
                    closeModal(DOM.viewDetailsModal);
                }
            });
        }

        /**
         * Configura la funcionalidad del tooltip de vista rápida que aparece al pasar el ratón
         * sobre las filas de las tablas.
         */
        function setupQuickViewTooltip() {
            const tooltip = DOM.quickViewTooltip;

            // Muestra el tooltip con la información de la fila.
            const showTooltip = (e) => { 
                const row = e.target.closest('tr[data-quickview="true"]');
                if (!row) return; // Si no estamos sobre una fila válida, no hacer nada.

                const { institucion, asunto, consulta, nombre, estatus, fecha, inicio, duracion } = row.dataset;

                const statusClass = estatus.toLowerCase() === 'saliente' ? 'saliente' : 'entrante';

                // Construcción del contenido del tooltip, ahora más limpio y profesional.
                tooltip.innerHTML = `
                    <p><strong>Institución:</strong> ${institucion}</p>
                    <p><strong>Asunto:</strong> ${asunto}</p>
                    <p><strong>Consulta:</strong> ${consulta}</p>
                    <p><strong>Solicitante:</strong> ${nombre}</p>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-200">
                        <p class="text-xs text-gray-500">${formatLongDate(fecha)} - ${inicio}</p>
                        <p class="text-xs font-semibold ${statusClass === 'saliente' ? 'text-green-600' : 'text-blue-600'}"><span class="status-dot ${statusClass}"></span>${estatus}</p>
                    </div>
                    <div class="duration-highlight">${duracion}</div>
                `;
                tooltip.classList.add('visible');
            };
            
            // Oculta el tooltip.
            const hideTooltip = () => {
                tooltip.classList.remove('visible');
            };

            // Mueve el tooltip para que siga al cursor.
            const moveTooltip = (e) => {
                if (tooltip.classList.contains('visible')) {
                    // Posiciona el tooltip con un desfase para no tapar el cursor
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY + 15}px`;
                }
            };

            [DOM.callLogTableBody, DOM.historicalTableBody].forEach(tbody => {
                tbody.addEventListener('mouseover', showTooltip);
                tbody.addEventListener('mouseout', hideTooltip);
                tbody.addEventListener('mousemove', moveTooltip);
            });
        }

        /**
         * Añade un botón para alternar la visibilidad de las etiquetas en el gráfico de "Llamadas por Consulta".
         */
        function setupConsultaChartLabelToggle() {
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded ml-2';
            toggleBtn.innerHTML = '<i class="fa-solid fa-tag"></i>';
            toggleBtn.title = 'Alternar visualización de etiquetas';
        
            // Insertar el botón en el header del gráfico de consulta
            DOM.consultaChartHeader.appendChild(toggleBtn);
        
            toggleBtn.addEventListener('click', () => {
                state.consultaChartState.showLabels = !state.consultaChartState.showLabels;
                toggleBtn.classList.toggle('bg-primary', state.consultaChartState.showLabels);
                toggleBtn.classList.toggle('text-white', state.consultaChartState.showLabels);
                updateCharts(); // Re-renderizar los gráficos para aplicar el cambio
            });
        }

        // =============================================
        // MÓDULO: Inicialización
        // Descripción: Función principal que arranca la aplicación.
        // ============================================= 

        /**
         * Función de inicialización principal. Llama a todas las funciones de configuración.
         */
        function initialize() {
            initializeAuth();
            setupEventListeners();
            setupAddEditButtons();
            setupPasswordVerification();
            setupReportConfig();
            setupSummaryAlertListeners();
            setupQuickViewTooltip(); 
            setupQuickHistoryPanel();
            setupConsultaChartLabelToggle();
            
            // Configurar Select2 para todos los selects
            $('#call-form select, #edit-form select').each(function() {
                $(this).select2({
                    tags: true,
                    placeholder: "Seleccione o escriba una opción",
                    allowClear: true,
                    width: '100%' 
                }); 
            });
        }

        // Iniciar la aplicación
        initialize();

    </script>
</body> 
</html>   
